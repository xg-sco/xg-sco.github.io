

<!DOCTYPE html>
<html lang="zh-CN" >



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/smile.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#96c0d3cc">
  <meta name="author" content="肉豆蔻吖">
  <meta name="keywords" content="">
  
    <meta name="description" content="介绍SpringCloud&#x3D;分布式微服务架构的一站式解决方案, 是多种微服务架构落地技术的集合体, 俗称微服务全家桶 版本选型https:&#x2F;&#x2F;start.spring.io&#x2F;actuator&#x2F;info 通过这个网站就可以查看到匹配的cloud版本  另外推荐跟视频中保持版本一致,   cloud停更  dependencyManagement和dependenciesdependency">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="https://xiamu.icu/Java/SpringCloud/index.html">
<meta property="og:site_name" content="肉豆蔻吖">
<meta property="og:description" content="介绍SpringCloud&#x3D;分布式微服务架构的一站式解决方案, 是多种微服务架构落地技术的集合体, 俗称微服务全家桶 版本选型https:&#x2F;&#x2F;start.spring.io&#x2F;actuator&#x2F;info 通过这个网站就可以查看到匹配的cloud版本  另外推荐跟视频中保持版本一致,   cloud停更  dependencyManagement和dependenciesdependency">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xiamu.icu/assets/ac772e76a0ba40b1b876be967043cfd2.png">
<meta property="og:image" content="https://xiamu.icu/assets/867d889cef7b42a882a2c910776e7ff3.png">
<meta property="og:image" content="https://xiamu.icu/assets/a5965e1969c340a2b14b63198cc4c6e0.png">
<meta property="og:image" content="https://xiamu.icu/assets/8e8caf45f9fa42748e670b4a3507da3a.png">
<meta property="og:image" content="https://xiamu.icu/assets/4ae789dcf52d49d7ae14ffb0bbfa916e.png">
<meta property="og:image" content="https://xiamu.icu/assets/09aa523cfab741feb3a2913727648971.png">
<meta property="og:image" content="https://xiamu.icu/assets/74435800971a42caaffdf6fff36163cb.png">
<meta property="og:image" content="https://xiamu.icu/assets/76ad85017f7e4524b9ef87961f6a4091.png">
<meta property="og:image" content="https://xiamu.icu/assets/f555ce2ebee849c3860c5ea68195e522.png">
<meta property="og:image" content="https://xiamu.icu/assets/4ba024922d584d6194a6376d9e73ed0d.png">
<meta property="og:image" content="https://xiamu.icu/assets/b58195e7b2254817a346d3d1166b54eb.png">
<meta property="og:image" content="https://xiamu.icu/assets/7cf8c7dbbe724762baa40674fc487b07.png">
<meta property="og:image" content="https://xiamu.icu/assets/06bb006edecb49bfbab1e9fc84a89c4c.png">
<meta property="og:image" content="https://xiamu.icu/assets/706591d5cd1f497ebf660aff33be8ec3.png">
<meta property="og:image" content="https://xiamu.icu/assets/072f68239dcd42afb937f336fb6a5a9c.png">
<meta property="og:image" content="https://xiamu.icu/assets/8799ca55272442c19a3095e51af0ccb3.png">
<meta property="og:image" content="https://xiamu.icu/assets/b3b748dc90d44ff79f8c80a5c520d941.png">
<meta property="og:image" content="https://xiamu.icu/assets/ab240bcd64fd40e69927b41fa452fdb5.png">
<meta property="og:image" content="https://xiamu.icu/assets/306f1f033fb54e82a1e8bb7b8fb89436.png">
<meta property="og:image" content="https://xiamu.icu/assets/49ffe4aad6b44fdaa67bcde7934d0489.png">
<meta property="og:image" content="https://xiamu.icu/assets/e0bb99b041624013845ee7733e283caf.png">
<meta property="og:image" content="https://xiamu.icu/assets/33dd8e91550d4e4daf6043b7b49db73c.png">
<meta property="og:image" content="https://xiamu.icu/assets/8daf9ada7c4c4e93a2e04e8e721fbcc7.png">
<meta property="og:image" content="https://xiamu.icu/assets/656b9dc54b8744738e456aedf226f3cc.png">
<meta property="og:image" content="https://xiamu.icu/assets/e926072cc5cf4e7ab60af470a5e2103b.png">
<meta property="og:image" content="https://xiamu.icu/assets/1a0d43769745465fab9864421ddd6b02.png">
<meta property="og:image" content="https://xiamu.icu/assets/ef99a46feca9471085f1f5ce3d3c5552.png">
<meta property="og:image" content="https://xiamu.icu/assets/d9ecfe6692bb405bb47899fb0d1f86c0.png">
<meta property="og:image" content="https://xiamu.icu/assets/b89e02aa964e44b2825deec4fa349523.png">
<meta property="og:image" content="https://xiamu.icu/assets/0fe9a08b20f64e6f9d1f8570c8433eb2.png">
<meta property="og:image" content="https://xiamu.icu/assets/d71495fb90b5476fb8d7ee6dff1f6b2c.png">
<meta property="og:image" content="https://xiamu.icu/assets/50e366fb0f474385a1f1f2cff00ec73d.png">
<meta property="og:image" content="https://xiamu.icu/assets/d997d39be232474f9fc1abc377908398.png">
<meta property="og:image" content="https://xiamu.icu/assets/cee96df418964f378895205d1087ea89.png">
<meta property="og:image" content="https://xiamu.icu/assets/d68ec417767148c88558a949431505e0.png">
<meta property="og:image" content="https://xiamu.icu/assets/2413a4b9d0b14c91885e012a8498eba8.png">
<meta property="og:image" content="https://xiamu.icu/assets/dd493bea04334c06909969a8cabfcdff.png">
<meta property="og:image" content="https://xiamu.icu/assets/89deadc963e74309a613ffe2ec1b32e6.png">
<meta property="og:image" content="https://xiamu.icu/assets/c514b47d934e4708a0a977ee401a47b8.png">
<meta property="og:image" content="https://xiamu.icu/assets/cd158c5310b04f2e873b7be38782ebf8.png">
<meta property="og:image" content="https://xiamu.icu/assets/069f03b928234f6d980d4d14ce6f31d9.png">
<meta property="og:image" content="https://xiamu.icu/assets/1d15f043a5a449419dbfd1cc4e3f116e.png">
<meta property="og:image" content="https://xiamu.icu/assets/f1a48b286fd44ea68f27332857234f91.png">
<meta property="og:image" content="https://xiamu.icu/assets/71b2267529274a54b037d67a261819d3.png">
<meta property="og:image" content="https://xiamu.icu/assets/36a1c26971b046d1be8e70101a64c152.png">
<meta property="og:image" content="https://xiamu.icu/assets/e8c3ace1b69242528e52d2ebc83e4803.png">
<meta property="og:image" content="https://xiamu.icu/assets/4209ed39cca34d39a121de9e96879645.png">
<meta property="og:image" content="https://xiamu.icu/assets/85e5fc6238d3486bbb05dfaff8eae7b1.png">
<meta property="og:image" content="https://xiamu.icu/assets/440574f839b74df49e9025a42baac348.png">
<meta property="og:image" content="https://xiamu.icu/assets/8a8dc381bdbc478ca740e2774f1adfcc.png">
<meta property="og:image" content="https://xiamu.icu/assets/7676b3f28d5b49dd831b5984bc88d4ec.png">
<meta property="og:image" content="https://xiamu.icu/assets/7135810edc1d4ddbbae0c77c78fd426a.png">
<meta property="og:image" content="https://xiamu.icu/assets/397b64a7a1b54dd699750a8b348178a8.png">
<meta property="og:image" content="https://xiamu.icu/assets/c0dad9ee845248daaca95f8864ccf8ba.png">
<meta property="og:image" content="https://xiamu.icu/assets/c4ac7bbec00f4d8fb22a934758ac2160.png">
<meta property="og:image" content="https://xiamu.icu/assets/291105915ecb496085731031e0158d06.png">
<meta property="og:image" content="https://xiamu.icu/assets/edb8bc7771b14aff86dca351ebd495fc.png">
<meta property="og:image" content="https://xiamu.icu/assets/ebc19eb888864fb09e228fe304cb8dcc.png">
<meta property="og:image" content="https://xiamu.icu/assets/b876c6e7f04449e4b269d19275952e88.png">
<meta property="og:image" content="https://xiamu.icu/assets/70088f48f36d48aabafdc2a520e0a314.png">
<meta property="og:image" content="https://xiamu.icu/assets/39d25c877bd54fb196efd4a171f49aa2.png">
<meta property="og:image" content="https://xiamu.icu/assets/6b01ed855f314c939c0fbdaace98f440.png">
<meta property="og:image" content="https://xiamu.icu/assets/090c9de199a340c6ad1ceb52545abacf.png">
<meta property="og:image" content="https://xiamu.icu/assets/e7e01e8482824a8094642d125900401d.png">
<meta property="og:image" content="https://xiamu.icu/assets/f187529ff461441f8bdbdcfd00fa7a82.png">
<meta property="og:image" content="https://xiamu.icu/assets/59dc2ca181c64c81951fcc866510ba85.png">
<meta property="og:image" content="https://xiamu.icu/assets/5750442874a440e39c2fbcbc0d946052.png">
<meta property="og:image" content="https://xiamu.icu/assets/7260575cd5224982bb1f70e79983fac1.png">
<meta property="og:image" content="https://xiamu.icu/assets/5f145ab4b49c4023bf9555603c2e6292.png">
<meta property="og:image" content="https://xiamu.icu/assets/0bfb08eed714407ca8fa994c0646be27.png">
<meta property="og:image" content="https://xiamu.icu/assets/e40bf27fd90f4e1c97807c2bdf43fafa.png">
<meta property="og:image" content="https://xiamu.icu/assets/a4ef39e3ffee469cb8d59ccd22c01dac.png">
<meta property="og:image" content="https://xiamu.icu/assets/62ce407ad4e649059550c09a84a2c891.png">
<meta property="og:image" content="https://xiamu.icu/assets/e2d1e7946d444538809c8d772fe3e84e.png">
<meta property="og:image" content="https://xiamu.icu/assets/54a3005fd6a3430cb620cf01f4147ce8.png">
<meta property="og:image" content="https://xiamu.icu/assets/cd7122fd5274479b93f2cf181255ab1f.png">
<meta property="og:image" content="https://xiamu.icu/assets/ce4d6c923a354943acd2086656925056.png">
<meta property="og:image" content="https://xiamu.icu/assets/3479807a18954ac4a908fa5f95605c50.png">
<meta property="og:image" content="https://xiamu.icu/assets/b6a93bba0d3641768f6a2c6c66c8c26b.png">
<meta property="og:image" content="https://xiamu.icu/assets/6114e6833fcb404fb0732761b9457e81.png">
<meta property="og:image" content="https://xiamu.icu/assets/fa89385b23c9444f86dcf5bb47b7b09a.png">
<meta property="og:image" content="https://xiamu.icu/assets/c91b58dade91408dbfc55d3fbf092480.png">
<meta property="og:image" content="https://xiamu.icu/assets/d11fd0f8f74542558a5bdf4d992e8924.png">
<meta property="og:image" content="https://xiamu.icu/assets/f3754e8f69934b91b5b36c120fdaad97.png">
<meta property="og:image" content="https://xiamu.icu/assets/b33882824b18434cab0965f35ba9a6a1.png">
<meta property="og:image" content="https://xiamu.icu/assets/d7663fb60b79417c839fbc6dbe06e32a.png">
<meta property="og:image" content="https://xiamu.icu/assets/76c6fcfb71da43559c45f6bda0aa6379.png">
<meta property="og:image" content="https://xiamu.icu/assets/9067682e797744fd868475481891dd3f.png">
<meta property="og:image" content="https://xiamu.icu/assets/544482eb9cba4605857e2e92684c6a74.png">
<meta property="og:image" content="https://xiamu.icu/assets/3451455e487742d09d4af3035451fde1.png">
<meta property="og:image" content="https://xiamu.icu/assets/dbe5cc6204b34e58b48efc463b7543ed.png">
<meta property="og:image" content="https://xiamu.icu/assets/b82aaeb09b06457ebabd2a4fa1049df7.png">
<meta property="og:image" content="https://xiamu.icu/assets/32d26c4c89b641b191f858df0d548729.png">
<meta property="og:image" content="https://xiamu.icu/assets/7207f6eeea084c7f92029a99953c0f5b.png">
<meta property="og:image" content="https://xiamu.icu/assets/788766d72e8446bf8d9f7f970eee0fb9.png">
<meta property="og:image" content="https://xiamu.icu/assets/23734346be994adbace6a0a72a56e637.png">
<meta property="og:image" content="https://xiamu.icu/assets/0d383f1b8ff74781865f6132d603312a.png">
<meta property="og:image" content="https://xiamu.icu/assets/a72146edc4e3464396f320a776d38e6c.png">
<meta property="og:image" content="https://xiamu.icu/assets/e5e1c3b901f04160b682b8f2b0094a6e.png">
<meta property="og:image" content="https://xiamu.icu/assets/15cc8e6bc03a4002a04eb462e9d4d54d.png">
<meta property="og:image" content="https://xiamu.icu/assets/f8e0828308e84dd99f548560fb02b193.png">
<meta property="og:image" content="https://xiamu.icu/assets/c533cbb424cd4bcb8cdf3e8c819fa6b2.png">
<meta property="og:image" content="https://xiamu.icu/assets/6565f4cd27e0473f826d4e23a84f2ffb.png">
<meta property="og:image" content="https://xiamu.icu/assets/050cb51cf55644c3aa825e8459945117.png">
<meta property="og:image" content="https://xiamu.icu/assets/8cfe8d3483c04479916f1e635e49905e.png">
<meta property="og:image" content="https://xiamu.icu/assets/2b2ef685f827493ebf55b9a7385a4f4f.png">
<meta property="og:image" content="https://xiamu.icu/assets/e40a2807850e4bd0adb4ae710e98a261.png">
<meta property="og:image" content="https://xiamu.icu/assets/a8ff0478ffdb43a1a8fd6e6e19771c88.png">
<meta property="og:image" content="https://xiamu.icu/assets/46c3dddc45774eb0b20866964395d4b2.png">
<meta property="og:image" content="https://xiamu.icu/assets/57cb59fd2c224d8fae5d28c926b159cf.png">
<meta property="og:image" content="https://xiamu.icu/assets/de0301a517904c77a27fde5623da353b.png">
<meta property="og:image" content="https://xiamu.icu/assets/354ee4d1350f4c6b89b40058dd10b5f2.png">
<meta property="og:image" content="https://xiamu.icu/assets/e70faf95c80a4d09afcda332575562d0.png">
<meta property="og:image" content="https://xiamu.icu/assets/75d378be9b834ce787b40fc14afa8ed1.png">
<meta property="og:image" content="https://xiamu.icu/assets/aad0dad2b9f941bf887c6da6596f4c1d.png">
<meta property="og:image" content="https://xiamu.icu/assets/369d6a62d37045a198e9ff8d6e5929f3.png">
<meta property="og:image" content="https://xiamu.icu/assets/732e7b1320e84922a4a9cb2162530e96.png">
<meta property="og:image" content="https://xiamu.icu/assets/290125dc7561483ab6a0f4753c0f92d6.png">
<meta property="og:image" content="https://xiamu.icu/assets/f03996ade0ef4d0b87f380795da4c41a.png">
<meta property="og:image" content="https://xiamu.icu/assets/49ae0c5ea83d41e4a10edf796239e66e.png">
<meta property="og:image" content="https://xiamu.icu/assets/153091d92dd74200855f3464728ed4d3.png">
<meta property="og:image" content="https://xiamu.icu/assets/f3e0a778a2f740f2ac829ad02dc408c4.png">
<meta property="og:image" content="https://xiamu.icu/assets/d499ac3c3f0f46dba87334c5ad79eadc.png">
<meta property="og:image" content="https://xiamu.icu/assets/c16a0456c06b440480790ebfe4068d56.png">
<meta property="og:image" content="https://xiamu.icu/assets/479e605dcdc04fa5ba1914a1c3c70a9a.png">
<meta property="og:image" content="https://xiamu.icu/assets/addd63b4ea164d8dae7c4230f443f87e.png">
<meta property="og:image" content="https://xiamu.icu/assets/3d231a0680a6414185352ee9fe62a8be.png">
<meta property="og:image" content="https://xiamu.icu/assets/772b7468548343d4b87156fbd31b7dde.png">
<meta property="og:image" content="https://xiamu.icu/assets/6dae7ef917174ebcb9f27d9f197c8467.png">
<meta property="og:image" content="https://xiamu.icu/assets/d93e0d316db04247a3914b4c0f9db2ab.png">
<meta property="og:image" content="https://xiamu.icu/assets/be1af08861bc4ecdb82003c3b4c23432.png">
<meta property="og:image" content="https://xiamu.icu/assets/9215bfc6ea3c46febcd4208db733f9a7.png">
<meta property="og:image" content="https://xiamu.icu/assets/ce0abcb21fd84c6abf31e63e19fad679.png">
<meta property="og:image" content="https://xiamu.icu/assets/bd1067493d5e4903ae7629a2ea9558c6.png">
<meta property="og:image" content="https://xiamu.icu/assets/00667b845c2e4ef3b14097882093d7dc.png">
<meta property="og:image" content="https://xiamu.icu/assets/0848cbad7ec444c4bdc47b20a8a7e639.png">
<meta property="og:image" content="https://xiamu.icu/assets/a39b16c17a3f4374a8d50b610a04625e.png">
<meta property="og:image" content="https://xiamu.icu/assets/7e43e63422794a74934d004f8e1d42b8.png">
<meta property="og:image" content="https://xiamu.icu/assets/0af99369fa674727b9a298bb1a38ca8c.png">
<meta property="og:image" content="https://xiamu.icu/assets/3f20f8321c194bd39c93c74ab7a91a1e.png">
<meta property="og:image" content="https://xiamu.icu/assets/0c24dbccc37d43efa2e283a0161c99f8.png">
<meta property="og:image" content="https://xiamu.icu/assets/1aa1028d30e2400085f40e4135d85c1c.png">
<meta property="og:image" content="https://xiamu.icu/assets/de852d5fea39411e97b5466ae6a0263e.png">
<meta property="og:image" content="https://xiamu.icu/assets/a030d658e0f749598f545f6941cf9e20.png">
<meta property="og:image" content="https://xiamu.icu/assets/0fd69c86bd5a4166a2ae7d15c5e2433e.png">
<meta property="og:image" content="https://xiamu.icu/assets/968c629ada1149a586933a5ceb713cf8.png">
<meta property="og:image" content="https://xiamu.icu/assets/f68d24f642274c33aae7046b6f4c3541.png">
<meta property="og:image" content="https://xiamu.icu/assets/8e4be2e9c3be400d86dc45ca39bbaed8.png">
<meta property="og:image" content="https://xiamu.icu/assets/2fdf7cee94704a208ac16d70f296c3a6.png">
<meta property="og:image" content="https://xiamu.icu/assets/93c46e9f7741404cbc55e5a8ac39ffb9.png">
<meta property="og:image" content="https://xiamu.icu/assets/043ce6a258b145bc8ce1d55a59241e90.png">
<meta property="og:image" content="https://xiamu.icu/assets/9981cad05aca4baeaf52163fc85e41a9.png">
<meta property="og:image" content="https://xiamu.icu/assets/347910b255014f4da005660c2f93d7b0.png">
<meta property="og:image" content="https://xiamu.icu/assets/15e113254758405a9988fb31f8ab122c.png">
<meta property="og:image" content="https://xiamu.icu/assets/d779000bf422412e954f645e1ed2b2f7.png">
<meta property="og:image" content="https://xiamu.icu/assets/5422b6f09a2b4206a933c8efe07cd2c0.png">
<meta property="og:image" content="https://xiamu.icu/assets/6348b69f159b4b659d77dfdcd6a75bb9.png">
<meta property="og:image" content="https://xiamu.icu/assets/dce08b263a0b4127a5862fdced7fd76a.png">
<meta property="og:image" content="https://xiamu.icu/assets/501e42515b4b4646b8d490c5f6c5638b.png">
<meta property="og:image" content="https://xiamu.icu/assets/c3dd98bed9064072846ea072cbedbf9d.png">
<meta property="og:image" content="https://xiamu.icu/assets/64837979cb584dfe9e524281acd0ef5d.png">
<meta property="og:image" content="https://xiamu.icu/assets/ccdb48b872e54782aab3d041a26773c8.png">
<meta property="og:image" content="https://xiamu.icu/assets/aff1b2e3074a47349cc5124cd4e3fc4e.png">
<meta property="og:image" content="https://xiamu.icu/assets/ecbaa0b129554029a70ca0b3de45d34f.png">
<meta property="og:image" content="https://xiamu.icu/assets/a1bb5f5834a14f2bb7c2f4fb6beffb3c.png">
<meta property="og:image" content="https://xiamu.icu/assets/a14a10711d1f427dbaf74d790757bc45.png">
<meta property="og:image" content="https://xiamu.icu/assets/6a604fcc082c48829b03d161f95b665c.png">
<meta property="og:image" content="https://xiamu.icu/assets/8d1192547a524975b0c739547ed76d52.png">
<meta property="og:image" content="https://xiamu.icu/assets/f425919f4afd43ccb4140025547d78d1.png">
<meta property="og:image" content="https://xiamu.icu/assets/d082878f63dc44feb72ac186ffa01c37.png">
<meta property="og:image" content="https://xiamu.icu/assets/64a6880b4d8c408c9d432be38c2f8ea0.png">
<meta property="og:image" content="https://xiamu.icu/assets/186467fe1f20437bb39fcb7aef00a58c.png">
<meta property="og:image" content="https://xiamu.icu/assets/6bd67e60ab7f408ebb922ea82c7fdb52.png">
<meta property="og:image" content="https://xiamu.icu/assets/fa920c77b93745cbbf508d579ee5876f.png">
<meta property="article:published_time" content="2023-05-05T00:00:00.000Z">
<meta property="article:modified_time" content="2024-11-29T10:05:30.756Z">
<meta property="article:author" content="肉豆蔻吖">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://xiamu.icu/assets/ac772e76a0ba40b1b876be967043cfd2.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>SpringCloud - 肉豆蔻吖</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xiamu.icu","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>肉豆蔻吖</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SpringCloud"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        肉豆蔻吖
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-05-05 00:00" pubdate>
          2023年5月5日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          109k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          908 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SpringCloud</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>SpringCloud&#x3D;分布式微服务架构的一站式解决方案, 是多种微服务架构落地技术的集合体, 俗称微服务全家桶</p>
<h2 id="版本选型"><a href="#版本选型" class="headerlink" title="版本选型"></a>版本选型</h2><p><a target="_blank" rel="noopener" href="https://start.spring.io/actuator/info">https://start.spring.io/actuator/info</a></p>
<p>通过这个网站就可以查看到匹配的cloud版本</p>
<p><img src="/assets/ac772e76a0ba40b1b876be967043cfd2.png" srcset="/img/loading.gif" lazyload></p>
<p>另外推荐跟视频中保持版本一致, </p>
<p><img src="/assets/867d889cef7b42a882a2c910776e7ff3.png" srcset="/img/loading.gif" lazyload></p>
<p>cloud停更</p>
<p><img src="/assets/a5965e1969c340a2b14b63198cc4c6e0.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="dependencyManagement和dependencies"><a href="#dependencyManagement和dependencies" class="headerlink" title="dependencyManagement和dependencies"></a>dependencyManagement和dependencies</h2><p>dependencyManagement其实给父工程指定版本号, 让子工程无需指定自己的版本号, 父工程修改一处版本号, 子工程处处生效</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;!-- 子模块继承之后，提供作用：锁定版本+子modlue不用写groupId和version  --&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-comment">&lt;!--spring boot 2.2.2--&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.2.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-comment">&lt;!--spring cloud Hoxton.SR1--&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>Hoxton.SR1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-comment">&lt;!--spring cloud alibaba 2.1.0.RELEASE--&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mybatis.spring.boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<h2 id="新建模块的流程"><a href="#新建模块的流程" class="headerlink" title="新建模块的流程"></a>新建模块的流程</h2><ol>
<li>建module</li>
<li>改POM</li>
<li>写YML</li>
<li>主启动</li>
<li>业务类</li>
</ol>
<h2 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h2><p>使用RestTemplate访问restful接口非常的简单粗暴无脑(url, restMap, ResponseBean.class)这三个参数代表REST请求地址, 请求参数, HTTP响应转换成的对象类型</p>
<p>在config.ApplicationContextConfig 将RestTemplate 注入到spring容器中</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx">@<span class="hljs-title class_">Configuration</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationContextConfig</span> &#123;<br>    @<span class="hljs-title class_">Bean</span><br>    public <span class="hljs-title class_">RestTemplate</span> <span class="hljs-title function_">getRestTemplate</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用RestTemplate传递参数会自动将对象序列化成JSON对象</p>
<p>消费者</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><br>public <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">PAYMENT_URL</span> = <span class="hljs-string">&quot;http://localhost:8001&quot;</span>;<br><br>    @<span class="hljs-title class_">Resource</span><br>    private <span class="hljs-title class_">RestTemplate</span> restTemplate;<br><br>    @<span class="hljs-title class_">GetMapping</span>(<span class="hljs-string">&quot;/consumer/payment/create&quot;</span>)<br>    public <span class="hljs-title class_">CommonResult</span>&lt;<span class="hljs-title class_">Payment</span>&gt; <span class="hljs-title function_">create</span>(<span class="hljs-params">Payment payment</span>) &#123;<br>        <span class="hljs-keyword">return</span> restTemplate.<span class="hljs-title function_">postForObject</span>(<span class="hljs-variable constant_">PAYMENT_URL</span>+<span class="hljs-string">&quot;/payment/create&quot;</span>,payment, <span class="hljs-title class_">CommonResult</span>.<span class="hljs-property">class</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>生产者</p>
<p>记得添加@RequestBody注解 </p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx">@<span class="hljs-title class_">Resource</span><br>    private <span class="hljs-title class_">PaymentService</span> paymentService;<br><br>    @<span class="hljs-title class_">PostMapping</span>(<span class="hljs-string">&quot;/payment/create&quot;</span>)<br>    public <span class="hljs-title class_">CommonResult</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">@RequestBody Payment payment</span>) &#123;<br>        int result = paymentService.<span class="hljs-title function_">create</span>(payment);<br>        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">&quot;插入结果 &#123;&#125;&quot;</span>, result);<br><br>        <span class="hljs-keyword">if</span> (result &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;插入数据库成功&quot;</span>, result);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>(<span class="hljs-number">444</span>, <span class="hljs-string">&quot;插入数据库失败&quot;</span>, <span class="hljs-literal">null</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h2 id="开启services-run-dashboard"><a href="#开启services-run-dashboard" class="headerlink" title="开启services(run dashboard)"></a>开启services(<strong><strong>run dashboard</strong></strong>)</h2><p>在配置中随便拷贝一个boot工程就可以显示出来了</p>
<p><img src="/assets/8e8caf45f9fa42748e670b4a3507da3a.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/4ae789dcf52d49d7ae14ffb0bbfa916e.png" srcset="/img/loading.gif" lazyload></p>
<p>另外一种方式通过配置.idea配置文件让其显示出来</p>
<p>参考:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42641909/article/details/109361627">https://blog.csdn.net/weixin_42641909&#x2F;article&#x2F;details&#x2F;109361627</a></li>
</ul>
<h2 id="配置Eureka注册中心"><a href="#配置Eureka注册中心" class="headerlink" title="配置Eureka注册中心"></a>配置Eureka注册中心</h2><p>创建工程, 引入依赖</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;dependencies&gt;<br>        &lt;!--eureka-server--&gt;<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        &lt;!-- 引入自己定义的api通用包，可以使用<span class="hljs-title class_">Payment</span>支付<span class="hljs-title class_">Entity</span> --&gt;<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        &lt;!--boot web actuator--&gt;<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        &lt;!--一般通用配置--&gt;<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>配置application.yml</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-attr">server</span>:<br>  <span class="hljs-attr">port</span>: <span class="hljs-number">7001</span><br><br><span class="hljs-attr">eureka</span>:<br>  <span class="hljs-attr">instance</span>:<br>    <span class="hljs-attr">hostname</span>: localhost #eureka服务端的实例名称<br>  <span class="hljs-attr">client</span>:<br>    #<span class="hljs-literal">false</span>表示不向注册中心注册自己。<br>    register-<span class="hljs-keyword">with</span>-<span class="hljs-attr">eureka</span>: <span class="hljs-literal">false</span><br>    #<span class="hljs-literal">false</span>表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务<br>    fetch-<span class="hljs-attr">registry</span>: <span class="hljs-literal">false</span><br>    service-<span class="hljs-attr">url</span>:<br>      #设置与<span class="hljs-title class_">Eureka</span> <span class="hljs-title class_">Server</span>交互的地址查询服务和注册服务都需要依赖这个地址。<br>      <span class="hljs-attr">defaultZone</span>: <span class="hljs-attr">http</span>:<span class="hljs-comment">//$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span><br></code></pre></td></tr></table></figure>

<p>编写入口Main</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx">@<span class="hljs-title class_">SpringBootApplication</span><br>@<span class="hljs-title class_">EnableEurekaServer</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaMain7001</span> &#123;<br>    public <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br>        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">EurekaMain7001</span>.<span class="hljs-property">class</span>, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>值得注意的是需要添加注解@EnableEurekaServer来标识这个是eureka的服务端</p>
<p>最后启动项目, 访问<a target="_blank" rel="noopener" href="http://localhost:7001/">http://localhost:7001/</a></p>
<h2 id="引入服务的提供者到注册中心"><a href="#引入服务的提供者到注册中心" class="headerlink" title="引入服务的提供者到注册中心"></a>引入服务的提供者到注册中心</h2><p>在pom.xml中配置</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><br>&lt;dependency&gt;<br>            <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br>            <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br>        &lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p>application.yml中配置eureka</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-attr">eureka</span>:<br>  <span class="hljs-attr">client</span>:<br>    #表示是否将自己注册进<span class="hljs-title class_">EurekaServer</span>默认为<span class="hljs-literal">true</span>。<br>    register-<span class="hljs-keyword">with</span>-<span class="hljs-attr">eureka</span>: <span class="hljs-literal">true</span><br>    #是否从<span class="hljs-title class_">EurekaServer</span>抓取已有的注册信息，默认为<span class="hljs-literal">true</span>。单节点无所谓，集群必须设置为<span class="hljs-literal">true</span>才能配合ribbon使用负载均衡<br>    <span class="hljs-attr">fetchRegistry</span>: <span class="hljs-literal">true</span><br>    service-<span class="hljs-attr">url</span>:<br>      <span class="hljs-attr">defaultZone</span>: <span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:7001/eureka</span><br></code></pre></td></tr></table></figure>

<p>最后标记注解@EnableEurekaClient</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx">@<span class="hljs-title class_">SpringBootApplication</span><br>@<span class="hljs-title class_">EnableEurekaClient</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentMain8001</span> &#123;<br>    public <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br>        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">PaymentMain8001</span>.<span class="hljs-property">class</span>, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>配置完成之后需要重启服务, 就能看见CLOUD-PAYMENT-SERVICE成功的注册到了eureka中</p>
<p><img src="/assets/09aa523cfab741feb3a2913727648971.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="配置eureka集群"><a href="#配置eureka集群" class="headerlink" title="配置eureka集群"></a>配置eureka集群</h2><p>引入依赖</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;dependencies&gt;<br>        &lt;!--eureka-server--&gt;<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        &lt;!-- 引入自己定义的api通用包，可以使用<span class="hljs-title class_">Payment</span>支付<span class="hljs-title class_">Entity</span> --&gt;<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        &lt;!--boot web actuator--&gt;<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        &lt;!--一般通用配置--&gt;<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>修改配置application.yml配置文件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-attr">server</span>:<br>  <span class="hljs-attr">port</span>: <span class="hljs-number">7005</span><br><br><span class="hljs-attr">eureka</span>:<br>  <span class="hljs-attr">instance</span>:<br>    <span class="hljs-attr">hostname</span>: eureka7005.<span class="hljs-property">com</span> #eureka服务端的实例名称<br>  <span class="hljs-attr">client</span>:<br>    register-<span class="hljs-keyword">with</span>-<span class="hljs-attr">eureka</span>: <span class="hljs-literal">false</span>     #<span class="hljs-literal">false</span>表示不向注册中心注册自己。<br>    fetch-<span class="hljs-attr">registry</span>: <span class="hljs-literal">false</span>     #<span class="hljs-literal">false</span>表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务<br>    service-<span class="hljs-attr">url</span>:<br>      <span class="hljs-attr">defaultZone</span>: <span class="hljs-attr">http</span>:<span class="hljs-comment">//eureka7001.com:7001/eureka/, http://eureka7002.com:7002/eureka/, http://eureka7003.com:7003/eureka/, http://eureka7004.com:7004/eureka/</span><br></code></pre></td></tr></table></figure>

<p>一般来说服务注册中心不会自己注册自己</p>
<p>但是多个服务注册中心需要互相注册</p>
<p>1 注册 2 3 4 5</p>
<p>2 注册 1 3 4 5</p>
<p>3 注册 1 2 4 5</p>
<p>4 注册 1 2 3 5</p>
<p>5 注册 1 2 3 4</p>
<p><strong>互相注册, 相互守望</strong></p>
<p>编写程序启动类, 记得需要添加@EnableEurekaServer这个注解</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs jsx">package com.<span class="hljs-property">atguigu</span>.<span class="hljs-property">springcloud</span>;<br><br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">SpringApplication</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">autoconfigure</span>.<span class="hljs-property">SpringBootApplication</span>;<br><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">cloud</span>.<span class="hljs-property">netflix</span>.<span class="hljs-property">eureka</span>.<span class="hljs-property">server</span>.<span class="hljs-property">EnableEurekaServer</span>;<br><br>@<span class="hljs-title class_">SpringBootApplication</span><br>@<span class="hljs-title class_">EnableEurekaServer</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaMain7005</span> &#123;<br>    public <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br>        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">EurekaMain7005</span>.<span class="hljs-property">class</span>, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="将消费者注册到注册中心集群"><a href="#将消费者注册到注册中心集群" class="headerlink" title="将消费者注册到注册中心集群"></a>将消费者注册到注册中心集群</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-attr">eureka</span>:<br>  <span class="hljs-attr">client</span>:<br>    #表示是否将自己注册进<span class="hljs-title class_">EurekaServer</span>默认为<span class="hljs-literal">true</span>。<br>    register-<span class="hljs-keyword">with</span>-<span class="hljs-attr">eureka</span>: <span class="hljs-literal">true</span><br>    #是否从<span class="hljs-title class_">EurekaServer</span>抓取已有的注册信息，默认为<span class="hljs-literal">true</span>。单节点无所谓，集群必须设置为<span class="hljs-literal">true</span>才能配合ribbon使用负载均衡<br>    <span class="hljs-attr">fetchRegistry</span>: <span class="hljs-literal">true</span><br>    service-<span class="hljs-attr">url</span>:<br>      <span class="hljs-attr">defaultZone</span>: <span class="hljs-attr">http</span>:<span class="hljs-comment">//eureka7001.com:7001/eureka, http://eureka7002.com:7002/eureka, http://eureka7003.com:7003/eureka, http://eureka7004.com:7004/eureka, http://eureka7005.com:7005/eureka  # 集群版</span><br></code></pre></td></tr></table></figure>

<p>同样的提供者也是相同的方式注册到集群</p>
<h2 id="将提供者注册到注册中心集群"><a href="#将提供者注册到注册中心集群" class="headerlink" title="将提供者注册到注册中心集群"></a>将提供者注册到注册中心集群</h2><p>注意server.port不要跟其他的服务重名了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-attr">server</span>:<br>  <span class="hljs-attr">port</span>: <span class="hljs-number">8002</span><br><br><span class="hljs-attr">spring</span>:<br>  <span class="hljs-attr">application</span>:<br>    <span class="hljs-attr">name</span>: cloud-payment-service<br>  <span class="hljs-attr">datasource</span>:<br>    <span class="hljs-attr">type</span>: com.<span class="hljs-property">alibaba</span>.<span class="hljs-property">druid</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">DruidDataSource</span>            # 当前数据源操作类型<br>    driver-<span class="hljs-keyword">class</span>-<span class="hljs-attr">name</span>: com.<span class="hljs-property">mysql</span>.<span class="hljs-property">cj</span>.<span class="hljs-property">jdbc</span>.<span class="hljs-property">Driver</span>           # mysql驱动包<br>    <span class="hljs-attr">url</span>: <span class="hljs-attr">jdbc</span>:<span class="hljs-attr">mysql</span>:<span class="hljs-comment">//localhost:3306/db2019?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;setTimezone=UTC</span><br>    <span class="hljs-attr">username</span>: root<br>    <span class="hljs-attr">password</span>: <span class="hljs-number">123456</span><br><br><span class="hljs-attr">eureka</span>:<br>  <span class="hljs-attr">client</span>:<br>    #表示是否将自己注册进<span class="hljs-title class_">EurekaServer</span>默认为<span class="hljs-literal">true</span>。<br>    register-<span class="hljs-keyword">with</span>-<span class="hljs-attr">eureka</span>: <span class="hljs-literal">true</span><br>    #是否从<span class="hljs-title class_">EurekaServer</span>抓取已有的注册信息，默认为<span class="hljs-literal">true</span>。单节点无所谓，集群必须设置为<span class="hljs-literal">true</span>才能配合ribbon使用负载均衡<br>    <span class="hljs-attr">fetchRegistry</span>: <span class="hljs-literal">true</span><br>    service-<span class="hljs-attr">url</span>:<br>#      <span class="hljs-attr">defaultZone</span>: <span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:7001/eureka</span><br>      <span class="hljs-attr">defaultZone</span>: <span class="hljs-attr">http</span>:<span class="hljs-comment">//eureka7001.com:7001/eureka, http://eureka7002.com:7002/eureka, http://eureka7003.com:7003/eureka, http://eureka7004.com:7004/eureka, http://eureka7005.com:7005/eureka  # 集群版</span><br><br><span class="hljs-attr">mybatis</span>:<br>  <span class="hljs-attr">mapperLocations</span>: <span class="hljs-attr">classpath</span>:mapper<span class="hljs-comment">/*.xml</span><br><span class="hljs-comment">  type-aliases-package: com.atguigu.springcloud.entities    # 所有Entity别名类所在包</span><br></code></pre></td></tr></table></figure>

<p>消费者开启负载均衡@LoadBalanced</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx">@<span class="hljs-title class_">Configuration</span><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationContextConfig</span> &#123;<br>    @<span class="hljs-title class_">Bean</span><br>    @<span class="hljs-title class_">LoadBalanced</span><br>    public <span class="hljs-title class_">RestTemplate</span> <span class="hljs-title function_">getRestTemplate</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过http:&#x2F;&#x2F;服务名</p>
<p>进行调用</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">//    public static final String PAYMENT_URL = &quot;http://localhost:8001&quot;;</span><br>    public <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">PAYMENT_URL</span> = <span class="hljs-string">&quot;http://CLOUD-PAYMENT-SERVICE&quot;</span>;<br><br>    @<span class="hljs-title class_">Resource</span><br>    private <span class="hljs-title class_">RestTemplate</span> restTemplate;<br><br>    @<span class="hljs-title class_">GetMapping</span>(<span class="hljs-string">&quot;/consumer/payment/create&quot;</span>)<br>    public <span class="hljs-title class_">CommonResult</span>&lt;<span class="hljs-title class_">Payment</span>&gt; <span class="hljs-title function_">create</span>(<span class="hljs-params">Payment payment</span>) &#123;<br>        <span class="hljs-keyword">return</span> restTemplate.<span class="hljs-title function_">postForObject</span>(<span class="hljs-variable constant_">PAYMENT_URL</span>+<span class="hljs-string">&quot;/payment/create&quot;</span>,payment, <span class="hljs-title class_">CommonResult</span>.<span class="hljs-property">class</span>);<br>    &#125;<br><br>    @<span class="hljs-title class_">GetMapping</span>(<span class="hljs-string">&quot;/consumer/get/&#123;id&#125;&quot;</span>)<br>    public <span class="hljs-title class_">CommonResult</span> <span class="hljs-title function_">getPayment</span>(<span class="hljs-params">@PathVariable(<span class="hljs-string">&quot;id&quot;</span>) Long id</span>) &#123;<br>        <span class="hljs-keyword">return</span> restTemplate.<span class="hljs-title function_">getForObject</span>(<span class="hljs-variable constant_">PAYMENT_URL</span>+<span class="hljs-string">&quot;/payment/get/&quot;</span>+id, <span class="hljs-title class_">CommonResult</span>.<span class="hljs-property">class</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<h2 id="actuator微服务信息完善"><a href="#actuator微服务信息完善" class="headerlink" title="actuator微服务信息完善"></a>actuator微服务信息完善</h2><p>在application.yml中</p>
<p>  instance:<br>    instance-id: payment8003<br>    prefer-ip-address: true     #访问路径可以显示IP地址</p>
<p>这段信息就能显示主机名, 并且点击之后就可以显示对应的IP地址</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-attr">eureka</span>:<br>  <span class="hljs-attr">client</span>:<br>    #表示是否将自己注册进<span class="hljs-title class_">EurekaServer</span>默认为<span class="hljs-literal">true</span>。<br>    register-<span class="hljs-keyword">with</span>-<span class="hljs-attr">eureka</span>: <span class="hljs-literal">true</span><br>    #是否从<span class="hljs-title class_">EurekaServer</span>抓取已有的注册信息，默认为<span class="hljs-literal">true</span>。单节点无所谓，集群必须设置为<span class="hljs-literal">true</span>才能配合ribbon使用负载均衡<br>    <span class="hljs-attr">fetchRegistry</span>: <span class="hljs-literal">true</span><br>    service-<span class="hljs-attr">url</span>:<br>#      <span class="hljs-attr">defaultZone</span>: <span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:7001/eureka</span><br>      <span class="hljs-attr">defaultZone</span>: <span class="hljs-attr">http</span>:<span class="hljs-comment">//eureka7001.com:7001/eureka, http://eureka7002.com:7002/eureka, http://eureka7003.com:7003/eureka, http://eureka7004.com:7004/eureka, http://eureka7005.com:7005/eureka  # 集群版</span><br>  <span class="hljs-attr">instance</span>:<br>    instance-<span class="hljs-attr">id</span>: payment8003<br>    prefer-ip-<span class="hljs-attr">address</span>: <span class="hljs-literal">true</span>     #访问路径可以显示<span class="hljs-variable constant_">IP</span>地址<br></code></pre></td></tr></table></figure>

<p><img src="/assets/74435800971a42caaffdf6fff36163cb.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="配置服务发现Discovery"><a href="#配置服务发现Discovery" class="headerlink" title="配置服务发现Discovery"></a>配置服务发现Discovery</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;<br><br><span class="hljs-meta">@GetMapping(&quot;/payment/discovery&quot;)</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">discovery</span><span class="hljs-params">()</span> &#123;<br>    List&lt;String&gt; services = discoveryClient.getServices();<br>    <span class="hljs-keyword">for</span> (String service : services) &#123;<br>        log.info(<span class="hljs-string">&quot;service: &#123;&#125;&quot;</span>, service);<br>    &#125;<br><br>    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="hljs-string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);<br>    <span class="hljs-keyword">for</span> (ServiceInstance instance : instances) &#123;<br>        log.info(<span class="hljs-string">&quot;instance: &quot;</span> + instance.getServiceId() + <span class="hljs-string">&quot;\t&quot;</span> + instance.getHost() + <span class="hljs-string">&quot;\t&quot;</span> + instance.getPort() + <span class="hljs-string">&quot;\t&quot;</span> + instance.getUri());<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.discoveryClient;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接着在入口函数添加注解<code>@EnableDiscoveryClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentMain8001</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(PaymentMain8001.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试结果</p>
<p><img src="/assets/76ad85017f7e4524b9ef87961f6a4091.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Eureka自我保护"><a href="#Eureka自我保护" class="headerlink" title="Eureka自我保护"></a>Eureka自我保护</h2><p><img src="/assets/f555ce2ebee849c3860c5ea68195e522.png" srcset="/img/loading.gif" lazyload></p>
<p>当出现这个段英文时, <strong><strong>EMERGENCY! EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY’RE NOT. RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE.</strong></strong></p>
<p>就说明eureka进入了自我保护</p>
<p>可能是因为网络状态正常接收某个微服务的心跳 </p>
<p>在某时刻某一个微服务不可用了, Eureka不会立刻清理, 依旧会对该微服务的信息进行保存</p>
<h2 id="关闭自我保护"><a href="#关闭自我保护" class="headerlink" title="关闭自我保护"></a>关闭自我保护</h2><p>配置了1秒发送心跳, 超过2秒没有收到心跳就剔除这个微服务</p>
<p><strong><strong>THE SELF PRESERVATION MODE IS TURNED OFF. THIS MAY NOT PROTECT INSTANCE EXPIRY IN CASE OF NETWORK&#x2F;OTHER PROBLEMS.</strong></strong></p>
<p><img src="/assets/4ba024922d584d6194a6376d9e73ed0d.png" srcset="/img/loading.gif" lazyload></p>
<p>提供者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java">eureka:<br>  client:<br>    #表示是否将自己注册进EurekaServer默认为<span class="hljs-literal">true</span>。<br>    register-with-eureka: <span class="hljs-literal">true</span><br>    #是否从EurekaServer抓取已有的注册信息，默认为<span class="hljs-literal">true</span>。单节点无所谓，集群必须设置为<span class="hljs-literal">true</span>才能配合ribbon使用负载均衡<br>    fetchRegistry: <span class="hljs-literal">true</span><br>    service-url:<br>#      defaultZone: http:<span class="hljs-comment">//localhost:7001/eureka</span><br>      defaultZone: http:<span class="hljs-comment">//eureka7001.com:7001/eureka, http://eureka7002.com:7002/eureka, http://eureka7003.com:7003/eureka, http://eureka7004.com:7004/eureka, http://eureka7005.com:7005/eureka  # 集群版</span><br>  instance:<br>    instance-id: payment8001<br>    prefer-ip-address: <span class="hljs-literal">true</span>     #访问路径可以显示IP地址<br>    #心跳检测与续约时间<br>    #开发时设置小些，保证服务关闭后注册中心能即使剔除服务<br>    #Eureka客户端向服务端发送心跳的时间间隔，单位为秒(默认是<span class="hljs-number">30</span>秒)<br>    lease-renewal-interval-in-seconds: <span class="hljs-number">1</span><br>    #Eureka服务端在收到最后一次心跳后等待时间上限，单位为秒(默认是<span class="hljs-number">90</span>秒)，超时将剔除服务<br>    lease-expiration-duration-in-seconds: <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<p>注册中心</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">eureka:<br>  instance:<br>    hostname: eureka7001.com #eureka服务端的实例名称<br>  client:<br>    #<span class="hljs-literal">false</span>表示不向注册中心注册自己。<br>    register-with-eureka: <span class="hljs-literal">false</span><br>    #<span class="hljs-literal">false</span>表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务<br>    fetch-registry: <span class="hljs-literal">false</span><br>    service-url:<br>      #设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个地址。<br>      defaultZone: http:<span class="hljs-comment">//eureka7002.com:7002/eureka/, http://eureka7003.com:7003/eureka/, http://eureka7004.com:7004/eureka/, http://eureka7005.com:7005/eureka/</span><br>  server:<br>    #关闭自我保护机制，保证不可用服务被及时踢除<br>    enable-self-preservation: <span class="hljs-literal">false</span><br>    eviction-interval-timer-in-ms: <span class="hljs-number">2000</span><br></code></pre></td></tr></table></figure>

<h2 id="替换成zookeeper为注册中心"><a href="#替换成zookeeper为注册中心" class="headerlink" title="替换成zookeeper为注册中心"></a>替换成zookeeper为注册中心</h2><p>在centos7中启动zookeeper集群</p>
<p><img src="/assets/b58195e7b2254817a346d3d1166b54eb.png" srcset="/img/loading.gif" lazyload></p>
<p>创建一个新的微服务模块</p>
<p>中间排除了zookeeper的某个版本, 其实也可以不用, 因为我排不排除都能正常运行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;!-- SpringBoot整合Web组件 --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;<br>            &lt;groupId&gt;com.atguigu.springcloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;<br>            &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- SpringBoot整合zookeeper客户端 --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-zookeeper-discovery&lt;/artifactId&gt;<br>            &lt;!--先排除自带的zookeeper3<span class="hljs-number">.5</span><span class="hljs-number">.3</span>--&gt;<br>            &lt;exclusions&gt;<br>                &lt;exclusion&gt;<br>                    &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;<br>                    &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;<br>                &lt;/exclusion&gt;<br>            &lt;/exclusions&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--添加zookeeper3<span class="hljs-number">.5</span><span class="hljs-number">.7</span>版本--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;<br>            &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">3.5</span><span class="hljs-number">.7</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>配置application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#8004表示注册到zookeeper服务器的支付服务提供者端口号</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8004</span><br><br><span class="hljs-comment">#服务别名----注册zookeeper到注册中心名称</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-provider-payment8004</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">zookeeper:</span><br>      <span class="hljs-attr">connect-string:</span> <span class="hljs-string">hadoop202:2181,hadoop203:2181,hadoop204:2181</span><br><br></code></pre></td></tr></table></figure>

<p>编写入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentController</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String serverPort;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/payment/zk&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentzk</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;springcloud with zookeeper: &quot;</span>+serverPort+<span class="hljs-string">&quot;\t&quot;</span>+ UUID.randomUUID().toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试代码</p>
<p><img src="/assets/7cf8c7dbbe724762baa40674fc487b07.png" srcset="/img/loading.gif" lazyload></p>
<p>成功配置好了zookeeper注册中心</p>
<p><img src="/assets/06bb006edecb49bfbab1e9fc84a89c4c.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="zookeeper服务节点"><a href="#zookeeper服务节点" class="headerlink" title="zookeeper服务节点"></a>zookeeper服务节点</h2><p>zookeeper服务节点是临时节点</p>
<p>当把cloud-provider-payment8004关闭之后, zookeeper就会将cloud-provider-payment8004这个节点给删除, 当cloud-provider-payment8004重新启动之后, zookeeper就会再次把cloud-provider-payment8004注册上</p>
<p><img src="/assets/706591d5cd1f497ebf660aff33be8ec3.png" srcset="/img/loading.gif" lazyload></p>
<p>编写相对应的消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;!-- SpringBoot整合Web组件 --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;<br>            &lt;groupId&gt;com.atguigu.springcloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;<br>            &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- SpringBoot整合zookeeper客户端 --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-zookeeper-discovery&lt;/artifactId&gt;<br>            &lt;!--先排除自带的zookeeper3<span class="hljs-number">.5</span><span class="hljs-number">.3</span>--&gt;<br>            &lt;exclusions&gt;<br>                &lt;exclusion&gt;<br>                    &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;<br>                    &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;<br>                &lt;/exclusion&gt;<br>            &lt;/exclusions&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--添加zookeeper3<span class="hljs-number">.4</span><span class="hljs-number">.9</span>版本--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;<br>            &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">3.5</span><span class="hljs-number">.7</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationContextBean</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span><br>    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">getRestTemplate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderZKController</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">INVOKE_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://cloud-provider-payment8004&quot;</span>;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/consumer/payment/zk&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPaymentInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> restTemplate.getForObject(INVOKE_URL + <span class="hljs-string">&quot;/payment/zk&quot;</span>, String.class);<br>        log.info(<span class="hljs-string">&quot;消费者调用支付服务(zookeeper) =&gt; result: &#123;&#125;&quot;</span>, result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderZK80</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(OrderZK80.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">#<span class="hljs-number">8004</span>表示注册到zookeeper服务器的支付服务提供者端口号<br>server:<br>  port: <span class="hljs-number">80</span><br><br>#服务别名----注册zookeeper到注册中心名称<br>spring:<br>  application:<br>    name: cloud-consumer-order<br>  cloud:<br>    zookeeper:<br>      connect-string: hadoop202:<span class="hljs-number">2181</span>,hadoop203:<span class="hljs-number">2181</span>,hadoop204:<span class="hljs-number">2181</span><br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p><img src="/assets/072f68239dcd42afb937f336fb6a5a9c.png" srcset="/img/loading.gif" lazyload></p>
<p>启动了一个提供者和消费者</p>
<p>都能正常请求</p>
<p><img src="/assets/8799ca55272442c19a3095e51af0ccb3.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/b3b748dc90d44ff79f8c80a5c520d941.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h2><p>下载地址</p>
<p><a target="_blank" rel="noopener" href="https://developer.hashicorp.com/consul/downloads?ajs_aid=cc9039da-f9af-4a8f-86e9-a9e6e2942e03&product_intent=consul">https://developer.hashicorp.com/consul/downloads?ajs_aid&#x3D;cc9039da-f9af-4a8f-86e9-a9e6e2942e03&amp;product_intent&#x3D;consul</a></p>
<p>查看consul版本</p>
<p><img src="/assets/ab240bcd64fd40e69927b41fa452fdb5.png" srcset="/img/loading.gif" lazyload></p>
<p>输入<code>./consul agent -dev</code> 启动开发模式</p>
<p><img src="/assets/306f1f033fb54e82a1e8bb7b8fb89436.png" srcset="/img/loading.gif" lazyload></p>
<p>启动完之后可以访问<a target="_blank" rel="noopener" href="http://localhost:8500/">http://localhost:8500/</a></p>
<p><img src="/assets/49ffe4aad6b44fdaa67bcde7934d0489.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="配置Consul提供者"><a href="#配置Consul提供者" class="headerlink" title="配置Consul提供者"></a>配置Consul提供者</h2><p>pom.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br><br>        &lt;!--SpringCloud consul-server --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- SpringBoot整合Web组件 --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br><br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--日常通用jar包配置--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">###consul服务端口号<br>server:<br>  port: <span class="hljs-number">8006</span><br><br>spring:<br>  application:<br>    name: consul-provider-payment<br>  ####consul注册中心地址<br>  cloud:<br>    consul:<br>      host: localhost<br>      port: <span class="hljs-number">8500</span><br>      discovery:<br>        #hostname: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>        service-name: $&#123;spring.application.name&#125;<br></code></pre></td></tr></table></figure>

<p>Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentController</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String serverPort;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/payment/consul&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentzk</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;springcloud with consul: &quot;</span>+serverPort+<span class="hljs-string">&quot;\t&quot;</span>+ UUID.randomUUID().toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p><img src="/assets/e0bb99b041624013845ee7733e283caf.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="配置Consul消费者"><a href="#配置Consul消费者" class="headerlink" title="配置Consul消费者"></a>配置Consul消费者</h2><p>pom.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br><br>        &lt;!--SpringCloud consul-server --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- SpringBoot整合Web组件 --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br><br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--日常通用jar包配置--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">###consul服务端口号<br>server:<br>  port: <span class="hljs-number">80</span><br><br>spring:<br>  application:<br>    name: cloud-consumer-order<br>  ####consul注册中心地址<br>  cloud:<br>    consul:<br>      host: localhost<br>      port: <span class="hljs-number">8500</span><br>      discovery:<br>        #hostname: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>        service-name: $&#123;spring.application.name&#125;<br></code></pre></td></tr></table></figure>

<p>config&#x2F;ApplicationConfig </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.config;<br><br><span class="hljs-keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span><br>    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">getRestTemplate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderConsulController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">INVOKE_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://consul-provider-payment&quot;</span>; <span class="hljs-comment">//consul-provider-payment</span><br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/consumer/payment/consul&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> restTemplate.getForObject(INVOKE_URL+<span class="hljs-string">&quot;/payment/consul&quot;</span>, String.class);<br>        System.out.println(<span class="hljs-string">&quot;消费者调用支付服务(consule)---&gt;result:&quot;</span> + result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p><img src="/assets/33dd8e91550d4e4daf6043b7b49db73c.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/8daf9ada7c4c4e93a2e04e8e721fbcc7.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="三个注册中心异同点"><a href="#三个注册中心异同点" class="headerlink" title="三个注册中心异同点"></a>三个注册中心异同点</h2><p><img src="/assets/656b9dc54b8744738e456aedf226f3cc.png" srcset="/img/loading.gif" lazyload></p>
<p>CAP</p>
<p>C: Consistency(强一致性)</p>
<p>A: Availablility (可用性)</p>
<p>P: Partition tolerance(分区容错性)</p>
<p>CAP理论关注粒度是数据, 而不是整体系统设计的策略</p>
<p><img src="/assets/e926072cc5cf4e7ab60af470a5e2103b.png" srcset="/img/loading.gif" lazyload></p>
<p>AP(Eureka)</p>
<p><img src="/assets/1a0d43769745465fab9864421ddd6b02.png" srcset="/img/loading.gif" lazyload></p>
<p>CP(Zookeeper&#x2F;Consul)</p>
<p><img src="/assets/ef99a46feca9471085f1f5ce3d3c5552.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Ribbon负载均衡"><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/assets/d9ecfe6692bb405bb47899fb0d1f86c0.png" srcset="/img/loading.gif" lazyload></p>
<p>当引入了eureka的依赖之后会自动的添加上ribbon的依赖, 所以自己手动加不加依赖都可以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p>getForObject返回对象为响应体中数据转化成的对象，基本上可以理解为Json</p>
<p>getForEntity返回对象为ResponseEntity对象，包含了响应中的一些重要信息，比如响应头、响应状态码、响应体等</p>
<p>配置ribbon, 其实就是跟之前一样, 只用添加好@LoadBalanced注解, Controller就可以直接调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationContextConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span><br>    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">getRestTemplate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br><br><span class="hljs-comment">//    public static final String PAYMENT_URL = &quot;http://localhost:8001&quot;;</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PAYMENT_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://CLOUD-PAYMENT-SERVICE&quot;</span>;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/consumer/payment/create&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title function_">create</span><span class="hljs-params">(Payment payment)</span> &#123;<br>        <span class="hljs-keyword">return</span> restTemplate.postForObject(PAYMENT_URL+<span class="hljs-string">&quot;/payment/create&quot;</span>,payment, CommonResult.class);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/consumer/get/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">getPayment</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> restTemplate.getForObject(PAYMENT_URL+<span class="hljs-string">&quot;/payment/get/&quot;</span>+id, CommonResult.class);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/consumer/payment/getForEntity/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title function_">getPayment2</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        ResponseEntity&lt;CommonResult&gt; entity = restTemplate.getForEntity(PAYMENT_URL + <span class="hljs-string">&quot;/payment/get/&quot;</span> + id, CommonResult.class);<br>        <span class="hljs-keyword">if</span> (entity.getStatusCode().is2xxSuccessful()) &#123;<br>            log.info(<span class="hljs-string">&quot;Headers: &#123;&#125;, status: &#123;&#125;&quot;</span>, entity.getHeaders(), entity.getStatusCode());<br>            <span class="hljs-keyword">return</span> entity.getBody();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>&lt;&gt;(<span class="hljs-number">444</span>, <span class="hljs-string">&quot;操作失败&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>一些特定的算法</p>
<p><img src="/assets/b89e02aa964e44b2825deec4fa349523.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="配置随机的规则"><a href="#配置随机的规则" class="headerlink" title="配置随机的规则"></a>配置随机的规则</h2><p>新建package, 注意不要建在Application的当前包及其子包下了</p>
<p><img src="/assets/0fe9a08b20f64e6f9d1f8570c8433eb2.png" srcset="/img/loading.gif" lazyload></p>
<p>编写如下配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySelfRule</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> IRule <span class="hljs-title function_">myRule</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomRule</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>启动类中添加注解@RibbonClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@RibbonClient(name=&quot;CLOUD-PAYMENT-SERVICE&quot;, configuration = MySelfRule.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(OrderApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>配置完成之后规则就变成了随机的了</p>
<h2 id="负载均衡算法原理"><a href="#负载均衡算法原理" class="headerlink" title="负载均衡算法原理"></a>负载均衡算法原理</h2><p>负载均衡算法：rest接口第几次请求数 % 服务器集群总数量 &#x3D; 实际调用服务器位置下标  ，每次服务重启动后rest接口计数从1开始。</p>
<p>List<ServiceInstance> instances &#x3D; discoveryClient.getInstances(“CLOUD-PAYMENT-SERVICE”);</p>
<p>如：   List [0] instances &#x3D; 127.0.0.1:8002</p>
<p>List [1] instances &#x3D; 127.0.0.1:8001</p>
<p>8001+ 8002 组合成为集群，它们共计2台机器，集群总数为2， 按照轮询算法原理：</p>
<p>当总请求数为1时： 1 % 2 &#x3D;1 对应下标位置为1 ，则获得服务地址为127.0.0.1:8001</p>
<p>当总请求数位2时： 2 % 2 &#x3D;0 对应下标位置为0 ，则获得服务地址为127.0.0.1:8002</p>
<p>当总请求数位3时： 3 % 2 &#x3D;1 对应下标位置为1 ，则获得服务地址为127.0.0.1:8001</p>
<p>当总请求数位4时： 4 % 2 &#x3D;0 对应下标位置为0 ，则获得服务地址为127.0.0.1:8002</p>
<p>如此类推……</p>
<h2 id="使用OpenFeign"><a href="#使用OpenFeign" class="headerlink" title="使用OpenFeign"></a>使用OpenFeign</h2><p>pom.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;!--openfeign--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--eureka client--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.atguigu.springcloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;<br>            &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--web--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--一般基础通用配置--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">80</span><br><br>eureka:<br>  client:<br>    register-with-eureka: <span class="hljs-literal">false</span><br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span><br></code></pre></td></tr></table></figure>

<p>编写一个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@FeignClient(&quot;CLOUD-PAYMENT-SERVICE&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentFeignService</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span><br>    CommonResult <span class="hljs-title function_">getPayment</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>编写Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderFeignController</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> PaymentFeignService paymentFeignService;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/consumer/payment/get/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title function_">getPaymentById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> paymentFeignService.getPayment(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p><img src="/assets/d71495fb90b5476fb8d7ee6dff1f6b2c.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="修改超时时间"><a href="#修改超时时间" class="headerlink" title="修改超时时间"></a>修改超时时间</h2><p>编写提供者的超时方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/payment/feign/timeout&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentFeignTimeout</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;serverPort: &#123;&#125;&quot;</span>, serverPort);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> serverPort;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>消费者添加超时方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@FeignClient(&quot;CLOUD-PAYMENT-SERVICE&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentFeignService</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span><br>    CommonResult <span class="hljs-title function_">getPayment</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/payment/feign/timeout&quot;)</span><br>    String <span class="hljs-title function_">paymentFeignTimeout</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/consumer/payment/feign/timeout&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentFeignTimeout</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> paymentFeignService.paymentFeignTimeout();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这样测试会造成OpenFeign的超时, 默认超时时长是1秒</p>
<p><img src="/assets/50e366fb0f474385a1f1f2cff00ec73d.png" srcset="/img/loading.gif" lazyload></p>
<p>在application.yml中配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">80</span><br><br>eureka:<br>  client:<br>    register-with-eureka: <span class="hljs-literal">false</span><br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span><br><br>#设置feign客户端超时时间(OpenFeign默认支持ribbon)<br>ribbon:<br>  #指的是建立连接所用的时间，适用于网络状况正常的情况下,两端连接所用的时间<br>  ReadTimeout: <span class="hljs-number">5000</span><br>  #指的是建立连接后从服务器读取到可用资源所用的时间<br>  ConnectTimeout: <span class="hljs-number">5000</span><br></code></pre></td></tr></table></figure>

<p>这样就可以增大超时的时长了</p>
<h2 id="OpenFeign开启日志"><a href="#OpenFeign开启日志" class="headerlink" title="OpenFeign开启日志"></a>OpenFeign开启日志</h2><p>添加config[配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.config;<br><br><span class="hljs-keyword">import</span> feign.Logger;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignConfig</span><br>&#123;<br>    <span class="hljs-meta">@Bean</span><br>    Logger.Level <span class="hljs-title function_">feignLoggerLevel</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> Logger.Level.FULL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后再application.yml中进行配置</p>
<p>注意这个路径应该是OpenFeign的接口的路径</p>
<p>  com.atguigu.springcloud.services.PaymentFeignService: debug</p>
<p><img src="/assets/d997d39be232474f9fc1abc377908398.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">logging:<br>  level:<br>    # feign日志以什么级别监控哪个接口<br>    com.atguigu.springcloud.services.PaymentFeignService: debug<br></code></pre></td></tr></table></figure>

<p><img src="/assets/cee96df418964f378895205d1087ea89.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="搭建Hystrix模块"><a href="#搭建Hystrix模块" class="headerlink" title="搭建Hystrix模块"></a>搭建Hystrix模块</h2><p>pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;!--hystrix--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--eureka client--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--web--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;<br>            &lt;groupId&gt;com.atguigu.springcloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;<br>            &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">8001</span><br><br>spring:<br>  application:<br>    name: cloud-provider-hystrix-payment<br><br>eureka:<br>  client:<br>    register-with-eureka: <span class="hljs-literal">true</span><br>    fetch-registry: <span class="hljs-literal">true</span><br>    service-url:<br>      #defaultZone: http:<span class="hljs-comment">//eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span><br>      defaultZone: http:<span class="hljs-comment">//eureka7001.com:7001/eureka</span><br></code></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.service;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 正常访问，一切OK</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_OK</span><span class="hljs-params">(Integer id)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;线程池:&quot;</span>+Thread.currentThread().getName()+<span class="hljs-string">&quot;paymentInfo_OK,id: &quot;</span>+id+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;O(∩_∩)O&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 超时访问，演示降级</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_TimeOut</span><span class="hljs-params">(Integer id)</span><br>    &#123;<br>        <span class="hljs-keyword">try</span> &#123; TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;线程池:&quot;</span>+Thread.currentThread().getName()+<span class="hljs-string">&quot;paymentInfo_TimeOut,id: &quot;</span>+id+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;O(∩_∩)O，耗费3秒&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.controller;<br><br><span class="hljs-keyword">import</span> com.atguigu.springcloud.service.PaymentService;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> PaymentService paymentService;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String serverPort;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_OK</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> paymentService.paymentInfo_OK(id);<br>        log.info(<span class="hljs-string">&quot;result: &#123;&#125;&quot;</span>, result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_TimeOut</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> <span class="hljs-keyword">throws</span> InterruptedException<br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> paymentService.paymentInfo_TimeOut(id);<br>        log.info(<span class="hljs-string">&quot;result: &#123;&#125;&quot;</span>, result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>main</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span> <span class="hljs-comment">//本服务启动后会自动注册进eureka服务中</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentHystrixMain8001</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(PaymentHystrixMain8001.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="配置Hystrix的服务降级"><a href="#配置Hystrix的服务降级" class="headerlink" title="配置Hystrix的服务降级"></a>配置Hystrix的服务降级</h2><p>service中使用@HystrixCommand, fallbackMethod 指定失败之后的调用的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 正常访问，一切OK</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_OK</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;线程池:&quot;</span> + Thread.currentThread().getName() + <span class="hljs-string">&quot;paymentInfo_OK,id: &quot;</span> + id + <span class="hljs-string">&quot;\t&quot;</span> + <span class="hljs-string">&quot;O(∩_∩)O&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 超时访问，演示降级</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeOutHandler&quot;,</span><br><span class="hljs-meta">            commandProperties = &#123;</span><br><span class="hljs-meta">                    @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;3000&quot;)</span><br><span class="hljs-meta">            &#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_TimeOut</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>/<span class="hljs-number">0</span>;<br><span class="hljs-comment">//        try &#123;</span><br><span class="hljs-comment">//            TimeUnit.SECONDS.sleep(3);</span><br><span class="hljs-comment">//        &#125; catch (InterruptedException e) &#123;</span><br><span class="hljs-comment">//            e.printStackTrace();</span><br><span class="hljs-comment">//        &#125;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;线程池:&quot;</span> + Thread.currentThread().getName() + <span class="hljs-string">&quot;paymentInfo_TimeOut,id: &quot;</span> + id + <span class="hljs-string">&quot;\t&quot;</span> + <span class="hljs-string">&quot;O(∩_∩)O，耗费3秒&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_TimeOutHandler</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/(ㄒoㄒ)/调用支付接口超时或异常：\t&quot;</span>+ <span class="hljs-string">&quot;\t当前线程池名字&quot;</span> + Thread.currentThread().getName();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>入口标记@EnableCircuitBreaker注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span> <span class="hljs-comment">//本服务启动后会自动注册进eureka服务中</span><br><span class="hljs-meta">@EnableCircuitBreaker</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentHystrixMain8001</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(PaymentHystrixMain8001.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/assets/d68ec417767148c88558a949431505e0.png" srcset="/img/loading.gif" lazyload></p>
<p>当调用的业务出现异常, 超时等就会调用兜底的方法<code>paymentInfo_TimeOutHandler</code></p>
<h2 id="配置Hystrix消费者服务降级"><a href="#配置Hystrix消费者服务降级" class="headerlink" title="配置Hystrix消费者服务降级"></a>配置Hystrix消费者服务降级</h2><p>pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;!--openfeign--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--hystrix--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--eureka client--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.atguigu.springcloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;<br>            &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--web--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--一般基础通用配置--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka/</span><br><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span><br>    <span class="hljs-meta">@HystrixCommand(fallbackMethod = &quot;paymentTimeOutFallbackMethod&quot;,commandProperties = &#123;</span><br><span class="hljs-meta">            @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value=&quot;1500&quot;)</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_TimeOut</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> paymentHystrixService.paymentInfo_TimeOut(id);<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentTimeOutFallbackMethod</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;我是消费者80,对方支付系统繁忙请10秒钟后再试或者自己运行出错请检查自己,o(╥﹏╥)o&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentHystrixService</span><br>&#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span><br>    String <span class="hljs-title function_">paymentInfo_OK</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span><br>    String <span class="hljs-title function_">paymentInfo_TimeOut</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>入口函数,记得 需要标记这个@EnableHystrix这个注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableFeignClients</span><br><span class="hljs-meta">@EnableHystrix</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderHystrixMain80</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(OrderHystrixMain80.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p><img src="/assets/2413a4b9d0b14c91885e012a8498eba8.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="配置全局服务降级"><a href="#配置全局服务降级" class="headerlink" title="配置全局服务降级"></a>配置全局服务降级</h2><ol>
<li>Controller上面添加<code>@DefaultProperties(defaultFallback = &quot;payment_Global_FallbackMethod&quot;)</code></li>
<li>将</li>
</ol>
<p>&#x2F;&#x2F;    @HystrixCommand(fallbackMethod &#x3D; “paymentTimeOutFallbackMethod”,commandProperties &#x3D; {<br>&#x2F;&#x2F;            @HystrixProperty(name&#x3D;”execution.isolation.thread.timeoutInMilliseconds”,value&#x3D;”1500”)<br>&#x2F;&#x2F;    })</p>
<p>修改成<code>@HystrixCommand</code></p>
<ol>
<li>编写全局处理方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">payment_Global_FallbackMethod</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Global异常处理信息，请稍后再试，/(ㄒoㄒ)/~~&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>完整代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@DefaultProperties(defaultFallback = &quot;payment_Global_FallbackMethod&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderHystirxController</span><br>&#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> PaymentHystrixService paymentHystrixService;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/consumer/payment/hystrix/ok/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_OK</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> paymentHystrixService.paymentInfo_OK(id);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span><br><span class="hljs-comment">//    @HystrixCommand(fallbackMethod = &quot;paymentTimeOutFallbackMethod&quot;,commandProperties = &#123;</span><br><span class="hljs-comment">//            @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value=&quot;1500&quot;)</span><br><span class="hljs-comment">//    &#125;)</span><br>    <span class="hljs-meta">@HystrixCommand</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_TimeOut</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> paymentHystrixService.paymentInfo_TimeOut(id);<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentTimeOutFallbackMethod</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;我是消费者80,对方支付系统繁忙请10秒钟后再试或者自己运行出错请检查自己,o(╥﹏╥)o&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">payment_Global_FallbackMethod</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Global异常处理信息，请稍后再试，/(ㄒoㄒ)/~~&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试: </p>
<p><img src="/assets/dd493bea04334c06909969a8cabfcdff.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="将业务分开"><a href="#将业务分开" class="headerlink" title="将业务分开"></a>将业务分开</h2><p>yml配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">80</span><br><br>eureka:<br>  client:<br>    register-with-eureka: <span class="hljs-literal">false</span><br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//eureka7001.com:7001/eureka/</span><br><br>feign:<br>  hystrix:<br>    enabled: <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>让PaymentFallbackService 实现PaymentHystrixService 接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.service;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentFallbackService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentHystrixService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_OK</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;服务调用失败，提示来自：cloud-consumer-feign-order80 PaymentFallbackService paymentInfo_OK&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentInfo_TimeOut</span><span class="hljs-params">(Integer id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;服务调用失败，提示来自：cloud-consumer-feign-order80 PaymentFallbackService paymentInfo_TimeOut&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在PaymentHystrixService接口上标记注解FeignClient注解, 并且需要指定fallback 是哪一个类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;, fallback = PaymentFallbackService.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentHystrixService</span><br>&#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span><br>    String <span class="hljs-title function_">paymentInfo_OK</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span><br>    String <span class="hljs-title function_">paymentInfo_TimeOut</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p><img src="/assets/89deadc963e74309a613ffe2ec1b32e6.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h2><p>service</p>
<p>这个注解的意思是: 在10秒内, 发送了10个请求, 出现60%的错误, 就开启断路器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//=========服务熔断</span><br>    <span class="hljs-meta">@HystrixCommand(fallbackMethod = &quot;paymentCircuitBreaker_fallback&quot;,commandProperties = &#123;</span><br><span class="hljs-meta">            @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;),</span><br><span class="hljs-meta">            @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;10&quot;),</span><br><span class="hljs-meta">            @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;),</span><br><span class="hljs-meta">            @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;),</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentCircuitBreaker</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span>(id &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;******id 不能负数&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">serialNumber</span> <span class="hljs-operator">=</span> IdUtil.simpleUUID();<br><br>        <span class="hljs-keyword">return</span> Thread.currentThread().getName()+<span class="hljs-string">&quot;\t&quot;</span>+<span class="hljs-string">&quot;调用成功，流水号: &quot;</span> + serialNumber;<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentCircuitBreaker_fallback</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;id 不能负数，请稍后再试，/(ㄒoㄒ)/~~   id: &quot;</span> +id;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/payment/circuit/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">paymentCircuitBreaker</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> paymentService.paymentCircuitBreaker(id);<br>        log.info(<span class="hljs-string">&quot;****result: &quot;</span>+result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p><img src="/assets/c514b47d934e4708a0a977ee401a47b8.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/cd158c5310b04f2e873b7be38782ebf8.png" srcset="/img/loading.gif" lazyload></p>
<p>总结:</p>
<p><img src="/assets/069f03b928234f6d980d4d14ce6f31d9.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Hystrix图形化Dashboard搭建"><a href="#Hystrix图形化Dashboard搭建" class="headerlink" title="Hystrix图形化Dashboard搭建"></a>Hystrix图形化Dashboard搭建</h2><p>pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br><br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">9001</span><br></code></pre></td></tr></table></figure>

<p>入口函数,记得添加@EnableHystrixDashboard</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.hystrix.dashboard.EnableHystrixDashboard;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableHystrixDashboard</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HystrixDashboardMain9001</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(HystrixDashboardMain9001.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>配置完成之后访问<a target="_blank" rel="noopener" href="http://localhost:9001/hystrix">http://localhost:9001/hystrix</a></p>
<p><img src="/assets/1d15f043a5a449419dbfd1cc4e3f116e.png" srcset="/img/loading.gif" lazyload></p>
<p>凡是要监控一定要添加actuator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p>9001监控8001</p>
<p>填写监控地址<a target="_blank" rel="noopener" href="http://localhost:8001/hystrix.stream">http://localhost:8001/hystrix.stream</a></p>
<p>1：Delay：该参数用来控制服务器上轮询监控信息的延迟时间，默认为2000毫秒，可以通过配置该属性来降低客户端的网络和CPU消耗。</p>
<p>2：Title：该参数对应了头部标题Hystrix Stream之后的内容，默认会使用具体监控实例的URL，可以通过配置该信息来展示更合适的标题。</p>
<p><img src="/assets/f1a48b286fd44ea68f27332857234f91.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/71b2267529274a54b037d67a261819d3.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/36a1c26971b046d1be8e70101a64c152.png" srcset="/img/loading.gif" lazyload></p>
<p>Open表示断路器开启了</p>
<p>实心圆：共有两种含义。它通过颜色的变化代表了实例的健康程度，它的健康度从绿色&lt;黄色&lt;橙色&lt;红色递减。</p>
<p>该实心圆除了颜色的变化之外，它的大小也会根据实例的请求流量发生变化，流量越大该实心圆就越大。所以通过该实心圆的展示，就可以在大量的实例中快速的发现故障实例和高压力实例。</p>
<h2 id="Gateway的配置"><a href="#Gateway的配置" class="headerlink" title="Gateway的配置"></a>Gateway的配置</h2><p>pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;!--gateway--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--eureka-client--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.atguigu.springcloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;<br>            &lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--一般基础配置类--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9527</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">cloud-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">payment_routh#payment_route</span>    <span class="hljs-comment">#路由的ID，没有固定规则但要求唯一，建议配合服务名</span><br><span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:8001#匹配后提供服务的路由地址</span><br><span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/payment/get/**#断言，路径相匹配的进行路由</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">payment_routh2#payment_route</span>    <span class="hljs-comment">#路由的ID，没有固定规则但要求唯一，建议配合服务名</span><br><span class="hljs-attr">uri:</span> <span class="hljs-string">http://localhost:8001#匹配后提供服务的路由地址</span><br><span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/payment/lb/**#断言，路径相匹配的进行路由</span><br><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">cloud-gateway-service</span><br>  <span class="hljs-string">client:#服务提供者provider注册进eureka服务列表内</span><br><span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://eureka7001.com:7001/eureka</span><br></code></pre></td></tr></table></figure>

<p>入口函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GateWayMain9527</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(GateWayMain9527.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>另外第一个微服务的controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">getPayment</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;&#125;<br><span class="hljs-meta">@GetMapping(value = &quot;/payment/lb&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPaymentLB</span><span class="hljs-params">()</span>&#123;&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试, 使用8001, 9527两个端口调用都可以</p>
<p><img src="/assets/e8c3ace1b69242528e52d2ebc83e4803.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/4209ed39cca34d39a121de9e96879645.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="网关配置路由"><a href="#网关配置路由" class="headerlink" title="网关配置路由"></a>网关配置路由</h2><p>9527端口的微服务配置config</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GateWayConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RouteLocator <span class="hljs-title function_">customRouteLocator</span><span class="hljs-params">(RouteLocatorBuilder builder)</span> &#123;<br>        RouteLocatorBuilder.<span class="hljs-type">Builder</span> <span class="hljs-variable">routes</span> <span class="hljs-operator">=</span> builder.routes();<br>        routes.route(<span class="hljs-string">&quot;path_router_atguigu&quot;</span>, r -&gt; r.path(<span class="hljs-string">&quot;/video/BV18E411x7eT&quot;</span>).uri(<span class="hljs-string">&quot;https://www.bilibili.com/video/BV18E411x7eT&quot;</span>))<br>        .route(<span class="hljs-string">&quot;anime&quot;</span>, r-&gt;r.path(<span class="hljs-string">&quot;/anime&quot;</span>).uri(<span class="hljs-string">&quot;https://www.bilibili.com/anime/&quot;</span>)).build();<br>        <span class="hljs-keyword">return</span> routes.build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/assets/85e5fc6238d3486bbb05dfaff8eae7b1.png" srcset="/img/loading.gif" lazyload></p>
<p>访问<a target="_blank" rel="noopener" href="http://localhost:9527/anime">http://localhost:9527/anime</a>被转发到了B站番剧</p>
<p>虽然没有图片…</p>
<h2 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h2><p>修改9527服务的yml</p>
<p>开启动态路由</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">spring:<br>  application:<br>    name: cloud-gateway<br>  cloud:<br>    gateway:<br>      discovery:<br>        locator:<br>          enabled: <span class="hljs-literal">true</span> #开启从注册中心动态创建路由的功能，利用微服务名进行路由<br></code></pre></td></tr></table></figure>

<p>把原先的uri注释掉, 改成lb:&#x2F;&#x2F;服务名</p>
<p>uri的协议为lb, 表示启用Gateway的负载均衡功能</p>
<p>lb:&#x2F;&#x2F;serviceName 是springcloud Gateway在微服务中自动为我们创建的负载均衡uri</p>
<p>完整代码如下: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">9527</span><br><br>spring:<br>  application:<br>    name: cloud-gateway<br>  cloud:<br>    gateway:<br>      discovery:<br>        locator:<br>          enabled: <span class="hljs-literal">true</span> #开启从注册中心动态创建路由的功能，利用微服务名进行路由<br>      routes:<br>        - id: payment_routh #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名<br>#          uri: http:<span class="hljs-comment">//localhost:8001          #匹配后提供服务的路由地址</span><br>          uri: lb:<span class="hljs-comment">//cloud-payment-service #匹配后提供服务的路由地址</span><br>          predicates:<br>            - Path=/payment/get<span class="hljs-comment">/**         # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        - id: payment_routh2 #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span><br><span class="hljs-comment">#          uri: http://localhost:8001          #匹配后提供服务的路由地址</span><br><span class="hljs-comment">          uri: lb://cloud-payment-service #匹配后提供服务的路由地址</span><br><span class="hljs-comment">          predicates:</span><br><span class="hljs-comment">            - Path=/payment/lb/**         # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">eureka:</span><br><span class="hljs-comment">  instance:</span><br><span class="hljs-comment">    hostname: cloud-gateway-service</span><br><span class="hljs-comment">  client: #服务提供者provider注册进eureka服务列表内</span><br><span class="hljs-comment">    service-url:</span><br><span class="hljs-comment">      register-with-eureka: true</span><br><span class="hljs-comment">      fetch-registry: true</span><br><span class="hljs-comment">      defaultZone: http://eureka7001.com:7001/eureka</span><br></code></pre></td></tr></table></figure>

<p>配置好之后, 测试9527就负载均衡了, 请求到了8001和8002</p>
<p><img src="/assets/440574f839b74df49e9025a42baac348.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/8a8dc381bdbc478ca740e2774f1adfcc.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Gateway常用的Predicate"><a href="#Gateway常用的Predicate" class="headerlink" title="Gateway常用的Predicate"></a>Gateway常用的Predicate</h2><p>编写一个测试类获取当前时区的时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZonedDateTimeDemo</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTime</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> ZonedDateTime.now();<br>        System.out.println(now);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2023-04-30T11:01:33.030+08:00[Asia&#x2F;Shanghai]</p>
<p>然后配置yml</p>
<p>predicates下的After, 表示在这个时间点之后才能运行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">spring:<br>  application:<br>    name: cloud-gateway<br>  cloud:<br>    gateway:<br>      discovery:<br>        locator:<br>          enabled: <span class="hljs-literal">true</span> #开启从注册中心动态创建路由的功能，利用微服务名进行路由<br>      routes:<br>        - id: payment_routh #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名<br>#          uri: http:<span class="hljs-comment">//localhost:8001          #匹配后提供服务的路由地址</span><br>          uri: lb:<span class="hljs-comment">//cloud-payment-service #匹配后提供服务的路由地址</span><br>          predicates:<br>            - Path=/payment/get<span class="hljs-comment">/**         # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        - id: payment_routh2 #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span><br><span class="hljs-comment">#          uri: http://localhost:8001          #匹配后提供服务的路由地址</span><br><span class="hljs-comment">          uri: lb://cloud-payment-service #匹配后提供服务的路由地址</span><br><span class="hljs-comment">          predicates:</span><br><span class="hljs-comment">            - Path=/payment/lb/**         # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">            - After=2023-04-30T12:01:33.030+08:00[Asia/Shanghai] # 断言，路径相匹配的进行路由</span><br></code></pre></td></tr></table></figure>

<p>时间到了测试</p>
<p>时间还没到测试</p>
<p><img src="/assets/7676b3f28d5b49dd831b5984bc88d4ec.png" srcset="/img/loading.gif" lazyload></p>
<p>断言cookie</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">- id: payment_routh2 #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名<br>#          uri: http:<span class="hljs-comment">//localhost:8001          #匹配后提供服务的路由地址</span><br>          uri: lb:<span class="hljs-comment">//cloud-payment-service #匹配后提供服务的路由地址</span><br>          predicates:<br>            - Path=/payment/lb<span class="hljs-comment">/**         # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">#            - After=2023-04-30T11:01:33.030+08:00[Asia/Shanghai] # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">            - Cookie=username, roudoukouya</span><br></code></pre></td></tr></table></figure>

<p><img src="/assets/7135810edc1d4ddbbae0c77c78fd426a.png" srcset="/img/loading.gif" lazyload></p>
<p>断言请求头</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">- id: payment_routh2 #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名<br>#          uri: http:<span class="hljs-comment">//localhost:8001          #匹配后提供服务的路由地址</span><br>          uri: lb:<span class="hljs-comment">//cloud-payment-service #匹配后提供服务的路由地址</span><br>          predicates:<br>            - Path=/payment/lb<span class="hljs-comment">/**         # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">#            - After=2023-04-30T11:01:33.030+08:00[Asia/Shanghai] # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">#            - Cookie=username, roudoukouya</span><br><span class="hljs-comment">            - Header=X-Request-Id, \d+  # 请求头要有X-Request-Id属性并且值为整数的正则表达式</span><br></code></pre></td></tr></table></figure>

<p><img src="/assets/397b64a7a1b54dd699750a8b348178a8.png" srcset="/img/loading.gif" lazyload></p>
<p>断言主机名Host</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">- id: payment_routh2 #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名<br>#          uri: http:<span class="hljs-comment">//localhost:8001          #匹配后提供服务的路由地址</span><br>          uri: lb:<span class="hljs-comment">//cloud-payment-service #匹配后提供服务的路由地址</span><br>          predicates:<br>            - Path=/payment/lb<span class="hljs-comment">/**         # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">#            - After=2023-04-30T11:01:33.030+08:00[Asia/Shanghai] # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">#            - Cookie=username, roudoukouya</span><br><span class="hljs-comment">#            - Header=X-Request-Id, \d+  # 请求头要有X-Request-Id属性并且值为整数的正则表达式</span><br><span class="hljs-comment">            - Host=**.atguigu.com # 断言主机名</span><br></code></pre></td></tr></table></figure>

<p><img src="/assets/c0dad9ee845248daaca95f8864ccf8ba.png" srcset="/img/loading.gif" lazyload></p>
<p>断言方法类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">- id: payment_routh2 #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名<br>#          uri: http:<span class="hljs-comment">//localhost:8001          #匹配后提供服务的路由地址</span><br>          uri: lb:<span class="hljs-comment">//cloud-payment-service #匹配后提供服务的路由地址</span><br>          predicates:<br>            - Path=/payment/lb<span class="hljs-comment">/**         # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">#            - After=2023-04-30T11:01:33.030+08:00[Asia/Shanghai] # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">#            - Cookie=username, roudoukouya</span><br><span class="hljs-comment">#            - Header=X-Request-Id, \d+  # 请求头要有X-Request-Id属性并且值为整数的正则表达式</span><br><span class="hljs-comment">#            - Host=**.atguigu.com # 断言主机名</span><br><span class="hljs-comment">            - Method=GET # 断言方法类型</span><br></code></pre></td></tr></table></figure>

<p><img src="/assets/c4ac7bbec00f4d8fb22a934758ac2160.png" srcset="/img/loading.gif" lazyload></p>
<p>断言参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">- id: payment_routh2 #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名<br>#          uri: http:<span class="hljs-comment">//localhost:8001          #匹配后提供服务的路由地址</span><br>          uri: lb:<span class="hljs-comment">//cloud-payment-service #匹配后提供服务的路由地址</span><br>          predicates:<br>            - Path=/payment/lb<span class="hljs-comment">/**         # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">#            - After=2023-04-30T11:01:33.030+08:00[Asia/Shanghai] # 断言，路径相匹配的进行路由</span><br><span class="hljs-comment">#            - Cookie=username, roudoukouya</span><br><span class="hljs-comment">#            - Header=X-Request-Id, \d+  # 请求头要有X-Request-Id属性并且值为整数的正则表达式</span><br><span class="hljs-comment">#            - Host=**.atguigu.com # 断言主机名</span><br><span class="hljs-comment">#            - Method=GET # 断言方法类型</span><br><span class="hljs-comment">            - Query=username, \d+  # 要有参数名username并且值还要是整数才能路由</span><br></code></pre></td></tr></table></figure>

<p><img src="/assets/291105915ecb496085731031e0158d06.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="配置自定义过滤器"><a href="#配置自定义过滤器" class="headerlink" title="配置自定义过滤器"></a>配置自定义过滤器</h2><p>编写filter过滤器MyLogGateWayFilter </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.filter;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;<br><span class="hljs-keyword">import</span> org.springframework.core.Ordered;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLogGateWayFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;指定了自定义的全局过滤器 MyLogGateWayFilter&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">uname</span> <span class="hljs-operator">=</span> exchange.getRequest().getQueryParams().getFirst(<span class="hljs-string">&quot;uname&quot;</span>);<br>        <span class="hljs-keyword">if</span> (uname == <span class="hljs-literal">null</span>) &#123;<br>            log.info(<span class="hljs-string">&quot;用户名为null , 无法登录&quot;</span>);<br>            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);<br>            <span class="hljs-keyword">return</span> exchange.getResponse().setComplete();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>请求中就必须带上uname这个参数, 否则就会被406拒绝</p>
<p><img src="/assets/edb8bc7771b14aff86dca351ebd495fc.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/ebc19eb888864fb09e228fe304cb8dcc.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="配置中心Config-服务端"><a href="#配置中心Config-服务端" class="headerlink" title="配置中心Config 服务端"></a>配置中心Config 服务端</h2><p>创建<code>cloud-config-center-3344</code>项目</p>
<p>引入pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br><br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>需要提前创建一个gitee仓库, 为啥不用github, 因为我的代理垃圾呜呜呜</p>
<p>代理配置<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41731201/article/details/123527717">https://blog.csdn.net/qq_41731201&#x2F;article&#x2F;details&#x2F;123527717</a></p>
<p>yml配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">3344</span><br><br>spring:<br>  application:<br>    name:  cloud-config-center #注册进Eureka服务器的微服务名<br>  cloud:<br>    config:<br>      server:<br>        git:<br>          uri: https:<span class="hljs-comment">//gitee.com/xialonggui/springcloud-config.git</span><br>#          uri: https:<span class="hljs-comment">//gitee.com/java-mohan/springcloud-config.git</span><br>#          ####搜索目录<br>          search-paths:<br>            - springcloud-config<br>      ###读取分支<br>      label: master<br><br>#服务注册到eureka地址<br>eureka:<br>  client:<br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//eureka7001.com:7001/eureka/, http://eureka7003.com:7003/eureka/, http://eureka7004.com:7004/eureka/, http://eureka7005.com:7005/eureka/</span><br></code></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableConfigServer</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigCenterMain3344</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ConfigCenterMain3344.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p>这几种测试都可以</p>
<p>localhost:3344&#x2F;master&#x2F;config-dev.yml</p>
<p>localhost:3344&#x2F;config-dev.yml</p>
<p>localhost:3344&#x2F;config&#x2F;dev&#x2F;master</p>
<p><img src="/assets/b876c6e7f04449e4b269d19275952e88.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/70088f48f36d48aabafdc2a520e0a314.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/39d25c877bd54fb196efd4a171f49aa2.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Config客户端的配置"><a href="#Config客户端的配置" class="headerlink" title="Config客户端的配置"></a>Config客户端的配置</h2><p>创建*<code>cloud-config-client-3355</code>项目*</p>
<p>pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><br>&lt;dependencies&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br><br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>注意这里需要创建的是bootstrap.yml</p>
<blockquote>
<p>applicaiton.yml是用户级的资源配置项</p>
</blockquote>
<p>bootstrap.yml是系统级的，优先级更加高</p>
<p>Spring Cloud会创建一个“Bootstrap Context”，作为Spring应用的<code>Application Context</code>的父上下文。初始化的时候，<code>Bootstrap Context</code>负责从外部源加载配置属性并解析配置。这两个上下文共享一个从外部获取的<code>Environment</code>。</p>
<p><code>Bootstrap</code>属性有高优先级，默认情况下，它们不会被本地配置覆盖。 <code>Bootstrap context</code>和<code>Application Context</code>有着不同的约定，所以新增了一个<code>bootstrap.yml</code>文件，保证<code>Bootstrap Context</code>和<code>Application Context</code>配置的分离。</p>
<p>要将Client模块下的application.yml文件改为bootstrap.yml,这是很关键的，</p>
<p>因为bootstrap.yml是比application.yml先加载的。bootstrap.yml优先级高于application.yml</p>
<blockquote>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">3355</span><br><br>spring:<br>  application:<br>    name: config-client<br>  cloud:<br>    #Config客户端配置<br>    config:<br>      label: master #分支名称<br>      name: config #配置文件名称<br>      profile: dev #读取后缀名称   上述<span class="hljs-number">3</span>个综合：master分支上config-dev.yml的配置文件被读取http:<span class="hljs-comment">//config-3344.com:3344/master/config-dev.yml</span><br>      uri: http:<span class="hljs-comment">//localhost:3344 #配置中心地址k</span><br><br>#服务注册到eureka地址<br>eureka:<br>  client:<br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//localhost:7001/eureka</span><br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigClientController</span><br>&#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String configInfo;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/configInfo&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConfigInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> configInfo;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>入口函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigClientMain3355</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ConfigClientMain3355.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p>请求3355端口同样能获取Info的信息</p>
<p><img src="/assets/6b01ed855f314c939c0fbdaace98f440.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/090c9de199a340c6ad1ceb52545abacf.png" srcset="/img/loading.gif" lazyload></p>
<p>当gitee的配置中心的内容发生了变化, 3344可以请求可以立马反应过来,但是3355不能</p>
<p>需要重启3355才可以, 这样每次修改了配置,每次都重启就显得非常蛋疼, 所以就出现了动态刷新配置</p>
<h2 id="动态刷新之手动版"><a href="#动态刷新之手动版" class="headerlink" title="动态刷新之手动版"></a>动态刷新之手动版</h2><p>确保pom中包含</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p>yml暴露监控端点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">3355</span><br><br>spring:<br>  application:<br>    name: config-client<br>  cloud:<br>    #Config客户端配置<br>    config:<br>      label: master #分支名称<br>      name: config #配置文件名称<br>      profile: dev #读取后缀名称   上述<span class="hljs-number">3</span>个综合：master分支上config-dev.yml的配置文件被读取http:<span class="hljs-comment">//config-3344.com:3344/master/config-dev.yml</span><br>      uri: http:<span class="hljs-comment">//localhost:3344 #配置中心地址k</span><br><br>#服务注册到eureka地址<br>eureka:<br>  client:<br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//localhost:7001/eureka</span><br><br># 暴露监控端点<br>management:<br>  endpoints:<br>    web:<br>      exposure:<br>        include: <span class="hljs-string">&quot;*&quot;</span><br></code></pre></td></tr></table></figure>

<p>controller添加注解<code>@RefreshScope</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RefreshScope</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigClientController</span><br>&#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String configInfo;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/configInfo&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConfigInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> configInfo;<br>    &#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>配置完成之后重启了3355, 发现3355的请求获取info仍然没有缓过来, 3344已经缓过来了</p>
<p><img src="/assets/e7e01e8482824a8094642d125900401d.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/f187529ff461441f8bdbdcfd00fa7a82.png" srcset="/img/loading.gif" lazyload></p>
<p>我们需要给3355发送一个post请求提醒一下3355</p>
<p>“嘿, 哥们, 别睡着了”</p>
<p>POST localhost:3355&#x2F;actuator&#x2F;refresh</p>
<p>之后3355就缓过来能获取到最新的Info信息了</p>
<p><img src="/assets/59dc2ca181c64c81951fcc866510ba85.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/5750442874a440e39c2fbcbc0d946052.png" srcset="/img/loading.gif" lazyload></p>
<p>如果微服务的数量达到了很多,这样做还是很麻烦, 由此就衍生出来了SpringCloud BUS总线Bus</p>
<h2 id="Bus动态刷新全局广播配置实现"><a href="#Bus动态刷新全局广播配置实现" class="headerlink" title="Bus动态刷新全局广播配置实现"></a>Bus动态刷新全局广播配置实现</h2><p>首先需要配置RabbitMQ的环境</p>
<p><img src="/assets/7260575cd5224982bb1f70e79983fac1.png" srcset="/img/loading.gif" lazyload></p>
<p>对每一个*<code>cloud-config-center-3344</code> ,* <em><code>cloud-config-client-3355</code> ,</em> <em><code>cloud-config-client-3366</code></em></p>
<p>添加pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;!--添加消息总线RabbitMQ支持--&gt;<br>&lt;dependency&gt;<br>    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-cloud-starter-bus-amqp&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p>3344yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">3344</span><br><br>spring:<br>  application:<br>    name:  cloud-config-center #注册进Eureka服务器的微服务名<br>  cloud:<br>    config:<br>      server:<br>        git:<br>          uri: https:<span class="hljs-comment">//gitee.com/xialonggui/springcloud-config.git</span><br>#          uri: https:<span class="hljs-comment">//gitee.com/java-mohan/springcloud-config.git</span><br>#          ####搜索目录<br>          search-paths:<br>            - springcloud-config<br>      ###读取分支<br>      label: master<br>  #rabbitmq相关配置<br>  rabbitmq:<br>    host: hadoop202<br>    port: <span class="hljs-number">5672</span><br>    username: admin<br>    password: <span class="hljs-number">123</span><br><br>#服务注册到eureka地址<br>eureka:<br>  client:<br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//eureka7001.com:7001/eureka/, http://eureka7003.com:7003/eureka/, http://eureka7004.com:7004/eureka/, http://eureka7005.com:7005/eureka/</span><br><br>##rabbitmq相关配置,暴露bus刷新配置的端点<br>management:<br>  endpoints: #暴露bus刷新配置的端点<br>    web:<br>      exposure:<br>        include: <span class="hljs-string">&#x27;bus-refresh&#x27;</span><br></code></pre></td></tr></table></figure>

<p>3355yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">3355</span><br><br>spring:<br>  application:<br>    name: config-client<br>  cloud:<br>    #Config客户端配置<br>    config:<br>      label: master #分支名称<br>      name: config #配置文件名称<br>      profile: dev #读取后缀名称   上述<span class="hljs-number">3</span>个综合：master分支上config-dev.yml的配置文件被读取http:<span class="hljs-comment">//config-3344.com:3344/master/config-dev.yml</span><br>      uri: http:<span class="hljs-comment">//localhost:3344 #配置中心地址k</span><br>  #rabbitmq相关配置 <span class="hljs-number">15672</span>是Web管理界面的端口；<span class="hljs-number">5672</span>是MQ访问的端口<br>  rabbitmq:<br>    host: hadoop202<br>    port: <span class="hljs-number">5672</span><br>    username: admin<br>    password: <span class="hljs-number">123</span><br><br>#服务注册到eureka地址<br>eureka:<br>  client:<br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//localhost:7001/eureka</span><br><br># 暴露监控端点<br>management:<br>  endpoints:<br>    web:<br>      exposure:<br>        include: <span class="hljs-string">&quot;*&quot;</span><br></code></pre></td></tr></table></figure>

<p>3366yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">3366</span><br><br>spring:<br>  application:<br>    name: config-client<br>  cloud:<br>    #Config客户端配置<br>    config:<br>      label: master #分支名称<br>      name: config #配置文件名称<br>      profile: dev #读取后缀名称   上述<span class="hljs-number">3</span>个综合：master分支上config-dev.yml的配置文件被读取http:<span class="hljs-comment">//config-3344.com:3344/master/config-dev.yml</span><br>      uri: http:<span class="hljs-comment">//localhost:3344 #配置中心地址</span><br>  #rabbitmq相关配置 <span class="hljs-number">15672</span>是Web管理界面的端口；<span class="hljs-number">5672</span>是MQ访问的端口<br>  rabbitmq:<br>    host: hadoop202<br>    port: <span class="hljs-number">5672</span><br>    username: admin<br>    password: <span class="hljs-number">123</span><br><br>#服务注册到eureka地址<br>eureka:<br>  client:<br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//localhost:7001/eureka</span><br><br># 暴露监控端点<br>management:<br>  endpoints:<br>    web:<br>      exposure:<br>        include: <span class="hljs-string">&quot;*&quot;</span><br></code></pre></td></tr></table></figure>

<p>通知3344去踹醒其他微服务 POST localhost:3344&#x2F;actuator&#x2F;bus-refresh</p>
<p>localhost:3344&#x2F;config-dev.yml</p>
<p>localhost:3355&#x2F;configInfo</p>
<p>localhost:3366&#x2F;configInfo</p>
<h2 id="动态刷新顶点通知"><a href="#动态刷新顶点通知" class="headerlink" title="动态刷新顶点通知"></a>动态刷新顶点通知</h2><p>只通知3355, 不通知3366</p>
<p>指定具体某一个实例生效而不是全部</p>
<p>公式: <a href="http://localhost:配置中心端口号/actuator/bus-refresh/{destination}">http://localhost:配置中心端口号/actuator/bus-refresh/{destination}</a></p>
<p>&#x2F;bus&#x2F;refresh请求不再发送到具体的服务实例上,而是发给config server并通过destination参数类指定需要更新配置的服务或实例</p>
<p>踹醒3355, 不要惊动3366</p>
<p>POST localhost:3344&#x2F;actuator&#x2F;bus-refresh&#x2F;config-client:3355</p>
<p>此时3355更新了, 但是3366没有更新</p>
<p><img src="/assets/5f145ab4b49c4023bf9555603c2e6292.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/0bfb08eed714407ca8fa994c0646be27.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/e40bf27fd90f4e1c97807c2bdf43fafa.png" srcset="/img/loading.gif" lazyload></p>
<p>以上的配置执行的代码会在让rabbitmq的topic生成一个总线</p>
<p><img src="/assets/a4ef39e3ffee469cb8d59ccd22c01dac.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="消息驱动生产者"><a href="#消息驱动生产者" class="headerlink" title="消息驱动生产者"></a>消息驱动生产者</h2><p>创建模块*<code>cloud-stream-rabbitmq-provider8801</code>*</p>
<p>pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br><br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-stream-rabbit&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--基础配置--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">8801</span><br><br>spring:<br>  application:<br>    name: cloud-stream-provider<br>  cloud:<br>    stream:<br>      binders: # 在此处配置要绑定的rabbitmq的服务信息；<br>        defaultRabbit: # 表示定义的名称，用于于binding整合<br>          type: rabbit # 消息组件类型<br>          environment: # 设置rabbitmq的相关的环境配置<br>            spring:<br>              rabbitmq:<br>                host: hadoop202<br>                port: <span class="hljs-number">5672</span><br>                username: admin<br>                password: <span class="hljs-number">123</span><br>      bindings: # 服务的整合处理<br>        output: # 这个名字是一个通道的名称<br>          destination: studyExchange # 表示要使用的Exchange名称定义<br>          content-type: application/json # 设置消息类型，本次为json，文本则设置“text/plain”<br>          binder: defaultRabbit # 设置要绑定的消息服务的具体设置<br><br>eureka:<br>  client: # 客户端进行Eureka注册的配置<br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//localhost:7001/eureka</span><br>  instance:<br>    lease-renewal-interval-in-seconds: <span class="hljs-number">2</span> # 设置心跳的时间间隔（默认是<span class="hljs-number">30</span>秒）<br>    lease-expiration-duration-in-seconds: <span class="hljs-number">5</span> # 如果现在超过了<span class="hljs-number">5</span>秒的间隔（默认是<span class="hljs-number">90</span>秒）<br>    instance-id: send-<span class="hljs-number">8801.</span>com  # 在信息列表时显示主机名称<br>    prefer-ip-address: <span class="hljs-literal">true</span>     # 访问的路径变为IP地址<br></code></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.service;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IMessageProvider</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">send</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接口实现,类名上面不要加<code>@Service</code>注解, 这并不是像之前一样写的业务类</p>
<p>而是添加<code>@EnableBinding</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.service.impl;<br><br><span class="hljs-keyword">import</span> com.atguigu.springcloud.service.IMessageProvider;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.cloud.stream.annotation.EnableBinding;<br><span class="hljs-keyword">import</span> org.springframework.cloud.stream.messaging.Source;<br><span class="hljs-keyword">import</span> org.springframework.integration.support.MessageBuilder;<br><span class="hljs-keyword">import</span> org.springframework.messaging.MessageChannel;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@EnableBinding(Source.class)</span> <span class="hljs-comment">// 可以理解为是一个消息的发送管道的定义</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageProviderImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IMessageProvider</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> MessageChannel output; <span class="hljs-comment">// 消息的发送管道</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">send</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">serial</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();<br>        <span class="hljs-built_in">this</span>.output.send(MessageBuilder.withPayload(serial).build()); <span class="hljs-comment">// 创建并发送消息</span><br>        log.info(<span class="hljs-string">&quot;serial: &#123;&#125;&quot;</span>, serial);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.controller;<br><br><span class="hljs-keyword">import</span> com.atguigu.springcloud.service.IMessageProvider;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.annotation.Resource;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendMessageController</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IMessageProvider messageProvider;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/sendMessage&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sendMessage</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> messageProvider.send();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>入口函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamMQMain8801</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(StreamMQMain8801.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>程序运行之后exchanges会出现studyExchange</p>
<p><img src="/assets/62ce407ad4e649059550c09a84a2c891.png" srcset="/img/loading.gif" lazyload></p>
<p>生产者: localhost:8801&#x2F;sendMessage</p>
<p><img src="/assets/e2d1e7946d444538809c8d772fe3e84e.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/54a3005fd6a3430cb620cf01f4147ce8.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="消息驱动消费者"><a href="#消息驱动消费者" class="headerlink" title="消息驱动消费者"></a>消息驱动消费者</h2><p>创建模块*<code>cloud-stream-rabbitmq-consumer8802</code>*</p>
<p>pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-stream-rabbit&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--基础配置--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">8802</span><br><br>spring:<br>  application:<br>    name: cloud-stream-consumer<br>  cloud:<br>    stream:<br>      binders: # 在此处配置要绑定的rabbitmq的服务信息；<br>        defaultRabbit: # 表示定义的名称，用于于binding整合<br>          type: rabbit # 消息组件类型<br>          environment: # 设置rabbitmq的相关的环境配置<br>            spring:<br>              rabbitmq:<br>                host: hadoop202<br>                port: <span class="hljs-number">5672</span><br>                username: admin<br>                password: <span class="hljs-number">123</span><br>      bindings: # 服务的整合处理<br>        input: # 这个名字是一个通道的名称<br>          destination: studyExchange # 表示要使用的Exchange名称定义<br>          content-type: application/json # 设置消息类型，本次为对象json，如果是文本则设置“text/plain”<br>          binder: defaultRabbit # 设置要绑定的消息服务的具体设置<br><br>eureka:<br>  client: # 客户端进行Eureka注册的配置<br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//localhost:7001/eureka</span><br>  instance:<br>    lease-renewal-interval-in-seconds: <span class="hljs-number">2</span> # 设置心跳的时间间隔（默认是<span class="hljs-number">30</span>秒）<br>    lease-expiration-duration-in-seconds: <span class="hljs-number">5</span> # 如果现在超过了<span class="hljs-number">5</span>秒的间隔（默认是<span class="hljs-number">90</span>秒）<br>    instance-id: receive-<span class="hljs-number">8802.</span>com  # 在信息列表时显示主机名称<br>    prefer-ip-address: <span class="hljs-literal">true</span>     # 访问的路径变为IP地址<br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.controller;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.cloud.stream.annotation.EnableBinding;<br><span class="hljs-keyword">import</span> org.springframework.cloud.stream.annotation.StreamListener;<br><span class="hljs-keyword">import</span> org.springframework.cloud.stream.messaging.Sink;<br><span class="hljs-keyword">import</span> org.springframework.messaging.Message;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@EnableBinding(Sink.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReceiveMessageListener</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;server.port&quot;)</span><br>    <span class="hljs-keyword">private</span> String serverPort;<br><br>    <span class="hljs-meta">@StreamListener(Sink.INPUT)</span> <span class="hljs-comment">// 监听接收消息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">input</span><span class="hljs-params">(Message&lt;String&gt; message)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;消费者1号 message: &#123;&#125;&quot;</span>, message.getPayload());<br>        log.info(<span class="hljs-string">&quot;消费者1号 port: &#123;&#125;&quot;</span>, serverPort);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>入口函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamMQMain8802</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(StreamMQMain8802.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>GET localhost:8801&#x2F;sendMessage</p>
<p>8801发送消息, 8802就能接收消息</p>
<p><img src="/assets/cd7122fd5274479b93f2cf181255ab1f.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/ce4d6c923a354943acd2086656925056.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="分组消费"><a href="#分组消费" class="headerlink" title="分组消费"></a>分组消费</h2><p>仿造*<code>cloud-stream-rabbitmq-consumer8802</code><em>相同的模块</em><code>cloud-stream-rabbitmq-consumer8803</code>*</p>
<p>可以看见当8801发送了一条消息, 8802和8803都会接收到这个消息, 如果是在订单模块的话, 同样的订单被处理了两次,这显然不是我们想要的</p>
<p><img src="/assets/3479807a18954ac4a908fa5f95605c50.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/b6a93bba0d3641768f6a2c6c66c8c26b.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/6114e6833fcb404fb0732761b9457e81.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/fa89385b23c9444f86dcf5bb47b7b09a.png" srcset="/img/loading.gif" lazyload></p>
<p>8802和8803的队列名称不一样, 需要把这两个归为同一个组</p>
<p>给8802和8803的yml添加group配置, group的值需要保持一致</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">8802</span><br><br>spring:<br>  application:<br>    name: cloud-stream-consumer<br>  cloud:<br>    stream:<br>      binders: # 在此处配置要绑定的rabbitmq的服务信息；<br>        defaultRabbit: # 表示定义的名称，用于于binding整合<br>          type: rabbit # 消息组件类型<br>          environment: # 设置rabbitmq的相关的环境配置<br>            spring:<br>              rabbitmq:<br>                host: hadoop202<br>                port: <span class="hljs-number">5672</span><br>                username: admin<br>                password: <span class="hljs-number">123</span><br>      bindings: # 服务的整合处理<br>        input: # 这个名字是一个通道的名称<br>          destination: studyExchange # 表示要使用的Exchange名称定义<br>          content-type: application/json # 设置消息类型，本次为对象json，如果是文本则设置“text/plain”<br>          binder: defaultRabbit # 设置要绑定的消息服务的具体设置<br>          group: atguiguA<br><br>eureka:<br>  client: # 客户端进行Eureka注册的配置<br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//localhost:7001/eureka</span><br>  instance:<br>    lease-renewal-interval-in-seconds: <span class="hljs-number">2</span> # 设置心跳的时间间隔（默认是<span class="hljs-number">30</span>秒）<br>    lease-expiration-duration-in-seconds: <span class="hljs-number">5</span> # 如果现在超过了<span class="hljs-number">5</span>秒的间隔（默认是<span class="hljs-number">90</span>秒）<br>    instance-id: receive-<span class="hljs-number">8802.</span>com  # 在信息列表时显示主机名称<br>    prefer-ip-address: <span class="hljs-literal">true</span>     # 访问的路径变为IP地址<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">8803</span><br><br>spring:<br>  application:<br>    name: cloud-stream-consumer<br>  cloud:<br>    stream:<br>      binders: # 在此处配置要绑定的rabbitmq的服务信息；<br>        defaultRabbit: # 表示定义的名称，用于于binding整合<br>          type: rabbit # 消息组件类型<br>          environment: # 设置rabbitmq的相关的环境配置<br>            spring:<br>              rabbitmq:<br>                host: hadoop202<br>                port: <span class="hljs-number">5672</span><br>                username: admin<br>                password: <span class="hljs-number">123</span><br>      bindings: # 服务的整合处理<br>        input: # 这个名字是一个通道的名称，在分析具体源代码的时候会进行说明<br>          destination: studyExchange # 表示要使用的Exchange名称定义<br>          content-type: application/json # 设置消息类型，本次为对象json，如果是文本则设置“text/plain”<br>          binder: defaultRabbit # 设置要绑定的消息服务的具体设置<br>          group: atguiguA<br><br>eureka:<br>  client: # 客户端进行Eureka注册的配置<br>    service-url:<br>      defaultZone: http:<span class="hljs-comment">//localhost:7001/eureka</span><br>  instance:<br>    lease-renewal-interval-in-seconds: <span class="hljs-number">2</span> # 设置心跳的时间间隔（默认是<span class="hljs-number">30</span>秒）<br>    lease-expiration-duration-in-seconds: <span class="hljs-number">5</span> # 如果现在超过了<span class="hljs-number">5</span>秒的间隔（默认是<span class="hljs-number">90</span>秒）<br>    instance-id: receive-<span class="hljs-number">8803.</span>com  # 在信息列表时显示主机名称<br>    prefer-ip-address: <span class="hljs-literal">true</span>     # 访问的路径变为IP地址<br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p>8801发送了两次请求, 8802和8803都分别接收到了一次</p>
<p><img src="/assets/c91b58dade91408dbfc55d3fbf092480.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/d11fd0f8f74542558a5bdf4d992e8924.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/f3754e8f69934b91b5b36c120fdaad97.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>停止8802和8803服务</p>
<p>然后去除掉8802的group: atguiguA</p>
<p>保留8803的group: atguiguA</p>
<p>8801发送了4条消息, 先启动8802, 8802没有接收消息, 然后启动8803, 全部在8803接收到了</p>
<p>总结: <code>添加了group就自动支持了持久化</code></p>
<p><img src="/assets/b33882824b18434cab0965f35ba9a6a1.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/d7663fb60b79417c839fbc6dbe06e32a.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Sleuth之zipkin搭建安装"><a href="#Sleuth之zipkin搭建安装" class="headerlink" title="Sleuth之zipkin搭建安装"></a>Sleuth之zipkin搭建安装</h2><p><a target="_blank" rel="noopener" href="https://zipkin.io/pages/quickstart">https://zipkin.io/pages/quickstart</a></p>
<p>直接点击<a target="_blank" rel="noopener" href="https://search.maven.org/remote_content?g=io.zipkin&a=zipkin-server&v=LATEST&c=exec">latest release</a>点击下载zipkin</p>
<p><img src="/assets/76c6fcfb71da43559c45f6bda0aa6379.png" srcset="/img/loading.gif" lazyload></p>
<p>下载完成之后直接在控制台输入</p>
<p><code>java -jar zipkin-server-2.24.1-exec.jar</code></p>
<p>然后在浏览器中访问<a target="_blank" rel="noopener" href="http://127.0.0.1:9411/zipkin/"><code>http://127.0.0.1:9411/zipkin/</code></a></p>
<p>这样就搭建完成了</p>
<h2 id="Nacos的下载"><a href="#Nacos的下载" class="headerlink" title="Nacos的下载"></a>Nacos的下载</h2><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos">https://github.com/alibaba/nacos</a></p>
<p>Nacos &#x3D; Eureka + Config + Bus</p>
<p>下载完成之后解压, 直接使用命令<code>bin/startup.cmd</code>就可以运行</p>
<p><img src="/assets/9067682e797744fd868475481891dd3f.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/544482eb9cba4605857e2e92684c6a74.png" srcset="/img/loading.gif" lazyload></p>
<p>运行完成之后浏览器输入<a target="_blank" rel="noopener" href="http://localhost:8848/nacos">http://localhost:8848/nacos</a>进入控制台</p>
<p>用户名和密码都是nacos</p>
<h2 id="将服务注册到nacos"><a href="#将服务注册到nacos" class="headerlink" title="将服务注册到nacos"></a>将服务注册到nacos</h2><p>新建*<code>cloudalibaba-provider-payment9001</code>*模块</p>
<p>父POM</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencyManagement&gt;<br>        &lt;dependencies&gt;<br>&lt;!--spring cloud alibaba <span class="hljs-number">2.1</span><span class="hljs-number">.0</span>.RELEASE--&gt;<br>            &lt;dependency&gt;<br>                &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;<br>                &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;<br>                &lt;version&gt;<span class="hljs-number">2.1</span><span class="hljs-number">.0</span>.RELEASE&lt;/version&gt;<br>                &lt;type&gt;pom&lt;/type&gt;<br>                &lt;scope&gt;<span class="hljs-keyword">import</span>&lt;/scope&gt;<br>            &lt;/dependency&gt;<br>&lt;/dependencies&gt;<br>    &lt;/dependencyManagement&gt;<br></code></pre></td></tr></table></figure>

<p>子pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;!--SpringCloud ailibaba nacos --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- SpringBoot整合Web组件 --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--日常通用jar包配置--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;test&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">9001</span><br><br>spring:<br>  application:<br>    name: nacos-payment-provider<br>  cloud:<br>    nacos:<br>      discovery:<br>        server-addr: localhost:<span class="hljs-number">8848</span> #配置Nacos地址<br><br>management:<br>  endpoints:<br>    web:<br>      exposure:<br>        include: <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentController</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;server.port&quot;)</span><br>    <span class="hljs-keyword">private</span> String serverPort;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/payment/nacos/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPayment</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;nacos registry, serverPort: &quot;</span>+ serverPort+<span class="hljs-string">&quot;\t id&quot;</span>+id;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>入口函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentMain9001</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(PaymentMain9001.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试GET localhost:9001&#x2F;payment&#x2F;nacos&#x2F;1</p>
<p><img src="/assets/3451455e487742d09d4af3035451fde1.png" srcset="/img/loading.gif" lazyload></p>
<p>服务列表中出现了刚刚注册的微服务</p>
<p><img src="/assets/dbe5cc6204b34e58b48efc463b7543ed.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Nacos的负载均衡"><a href="#Nacos的负载均衡" class="headerlink" title="Nacos的负载均衡"></a>Nacos的负载均衡</h2><p>与之对应的,创建出来*<code>cloudalibaba-provider-payment9002</code>*模块</p>
<p>再创建一个消费者<code>cloudalibaba-consumer-nacos-order83</code></p>
<p>pom</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-comment">&lt;!--引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cloud-api-commons<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$</span><span class="hljs-template-variable">&#123;project.version&#125;</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-comment">&lt;!-- SpringBoot整合Web组件--&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">server</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">port</span><span class="hljs-punctuation">:</span> <span class="hljs-string">83</span><br><br><span class="hljs-attribute">spring</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">application</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">nacos-order-consumer</span><br>  <span class="hljs-attribute">cloud</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">nacos</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-attribute">discovery</span><span class="hljs-punctuation">:</span><br>        <span class="hljs-attribute">server-addr</span><span class="hljs-punctuation">:</span> <span class="hljs-string">localhost:8848</span><br><br><span class="hljs-comment">#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)</span><br><span class="hljs-attribute">service-url</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">nacos-user-service</span><span class="hljs-punctuation">:</span> <span class="hljs-string">http://nacos-payment-provider</span><br></code></pre></td></tr></table></figure>

<p>config</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Configuration</span><br>public class ApplicationContextBean &#123;<br>    <span class="hljs-variable">@Bean</span><br>    <span class="hljs-variable">@LoadBalanced</span><br>    public RestTemplate <span class="hljs-built_in">getRestTemplate</span>() &#123;<br>        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderNacosController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@Value(<span class="hljs-string">&quot;service-url.nacos-user-service&quot;</span>)</span><br>    <span class="hljs-keyword">private</span> String serverURL;<br><br>    <span class="hljs-meta">@GetMapping(value = <span class="hljs-string">&quot;consumer/payment/nacos/&#123;id&#125;&quot;</span>)</span><br>    <span class="hljs-keyword">public</span> String getPayment(<span class="hljs-meta">@PathVariable(<span class="hljs-string">&quot;id&quot;</span>)</span> Integer id)<br>    &#123;<br>        <span class="hljs-keyword">return</span> restTemplate.getForObject(serverURL + <span class="hljs-string">&quot;/payment/nacos/&quot;</span> + id, String.<span class="hljs-keyword">class</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>入口函数</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@SpringBootApplication</span><br><span class="hljs-variable">@EnableDiscoveryClient</span><br>public class OrderNacosMain83 &#123;<br>    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) &#123;<br>        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(OrderNacosMain83.class, args);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>nacos中的依赖自带了ribbon, 所以能够支持负载均衡</p>
<p><img src="/assets/b82aaeb09b06457ebabd2a4fa1049df7.png" srcset="/img/loading.gif" lazyload></p>
<p>代码测试</p>
<p>GET localhost:83&#x2F;consumer&#x2F;payment&#x2F;nacos&#x2F;1</p>
<p>一次9001,一次9002, 负载均衡实现</p>
<p><img src="/assets/32d26c4c89b641b191f858df0d548729.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/7207f6eeea084c7f92029a99953c0f5b.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Nacos的CP和AP的切换"><a href="#Nacos的CP和AP的切换" class="headerlink" title="Nacos的CP和AP的切换"></a>Nacos的CP和AP的切换</h2><p>Nacos默认是AP, 可以使用如下请求切换成CP</p>
<p>curl -X PUT ‘$NACOS_SERVER:8848&#x2F;nacos&#x2F;v1&#x2F;ns&#x2F;operator&#x2F;switches?entry&#x3D;serverMode&amp;value&#x3D;CP’</p>
<p><img src="/assets/788766d72e8446bf8d9f7f970eee0fb9.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Nacos的配置中心"><a href="#Nacos的配置中心" class="headerlink" title="Nacos的配置中心"></a>Nacos的配置中心</h2><p>创建模块*<code>cloudalibaba-config-nacos-client3377</code>*</p>
<p>pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-comment">&lt;!--nacos-config--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--nacos-discovery--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--web + actuator--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--一般基础配置--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>bootstrap.yml</p>
<p>注意这个file-extension: yml#指定yaml格式的配置</p>
<p>这个yml跟nacos-config-client-dev.yml这个后缀名要保持一致</p>
<p>要么都叫yaml, 要么都叫yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># nacos配置</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">3377</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nacos-config-client</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848#Nacos服务注册中心地址</span><br><span class="hljs-attr">config:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848#Nacos作为配置中心地址</span><br><span class="hljs-attr">file-extension:</span> <span class="hljs-string">yml#指定yaml格式的配置</span><br><br><span class="hljs-comment"># $&#123;spring.application.name&#125;-$&#123;spring.profile.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</span><br><span class="hljs-comment">#nacos-config-client-dev.yml</span><br></code></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">  profiles:</span><br><span class="hljs-symbol">    active:</span> dev<span class="hljs-meta">#表示开发环境</span><br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 开启自动刷新</span><br><span class="hljs-meta">@RefreshScope</span> <span class="hljs-comment">//在控制器类加入@RefreshScope注解使当前类下的配置支持Nacos的动态刷新功能。</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigClientController</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String configInfo;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/config/info&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConfigInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> configInfo;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>main</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NacosConfigClientMain3377</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(NacosConfigClientMain3377.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建好模块运行</p>
<p>在nacos的配置列表创建配置</p>
<p><img src="/assets/23734346be994adbace6a0a72a56e637.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">config:<br>    info: 富哥vivo50看看实力?<br></code></pre></td></tr></table></figure>

<p>代码测试</p>
<p>GET localhost:3377&#x2F;config&#x2F;info</p>
<p><img src="/assets/0d383f1b8ff74781865f6132d603312a.png" srcset="/img/loading.gif" lazyload></p>
<p>以上这些代码是支持动态刷新的, 但是记得Controller头上要添加<code>@RefreshScope</code>注解才会开启自动刷新</p>
<h2 id="Nacos的DataID配置"><a href="#Nacos的DataID配置" class="headerlink" title="Nacos的DataID配置"></a>Nacos的DataID配置</h2><p>创建第二个配置文件<code>nacos-config-client-test.yml</code></p>
<p>配置了什么就是什么环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">config:<br>    info: 看看你的<br></code></pre></td></tr></table></figure>

<p><img src="/assets/a72146edc4e3464396f320a776d38e6c.png" srcset="/img/loading.gif" lazyload></p>
<p>将3377的application.yml配置文件换成test</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">spring:</span><br><span class="hljs-symbol">  profiles:</span><br><span class="hljs-meta">#    active: dev #表示开发环境</span><br><span class="hljs-symbol">active:</span> test<span class="hljs-meta">#表示测试环境</span><br></code></pre></td></tr></table></figure>

<p>postman测试, 成功读取到了test环境的info</p>
<p><img src="/assets/e5e1c3b901f04160b682b8f2b0094a6e.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Nacos的group分组方案"><a href="#Nacos的group分组方案" class="headerlink" title="Nacos的group分组方案"></a>Nacos的group分组方案</h2><p>创建两个group</p>
<p><code>nacos-config-client-info.yml</code>  <code>TEST_GROUP</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">config:<br>    info: nacos-config-client-info.yml TEST_GROUP<br></code></pre></td></tr></table></figure>

<p><code>nacos-config-client-info.yml</code>  <code>DEV_GROUP</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">config:<br>    info: nacos-config-client-info.yml DEV_GROUP<br></code></pre></td></tr></table></figure>

<p><img src="/assets/15cc8e6bc03a4002a04eb462e9d4d54d.png" srcset="/img/loading.gif" lazyload></p>
<p>然后修改application.yml和bootstrap.yml</p>
<p>bootstrap.yml添加group</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"># nacos配置<br>server:<br>  port: <span class="hljs-number">3377</span><br><br>spring:<br>  application:<br>    name: nacos-config-client<br>  cloud:<br>    nacos:<br>      discovery:<br>        server-addr: localhost:<span class="hljs-number">8848</span> #Nacos服务注册中心地址<br>      config:<br>        server-addr: localhost:<span class="hljs-number">8848</span> #Nacos作为配置中心地址<br>        file-extension: yml #指定yaml格式的配置<br>        group: TEST_GROUP<br><br># $&#123;spring.application.name&#125;-$&#123;spring.profile.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;<br>#nacos-config-client-dev.yml<br></code></pre></td></tr></table></figure>

<p>application.yml切换active</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">spring:<br>  profiles:<br>#    active: dev # 表示开发环境<br>#    active: test # 表示测试环境<br>    active: info # 表示测试环境<br></code></pre></td></tr></table></figure>

<p>当处于DEV组的时候代码测试</p>
<p><img src="/assets/f8e0828308e84dd99f548560fb02b193.png" srcset="/img/loading.gif" lazyload></p>
<p>当处于TEST组的时候代码测试</p>
<p><img src="/assets/c533cbb424cd4bcb8cdf3e8c819fa6b2.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Nacos的命名空间namespace"><a href="#Nacos的命名空间namespace" class="headerlink" title="Nacos的命名空间namespace"></a>Nacos的命名空间namespace</h2><p>创建一个命名空间dev, 然后创建几个不同环境的配置文件</p>
<p><img src="/assets/6565f4cd27e0473f826d4e23a84f2ffb.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/050cb51cf55644c3aa825e8459945117.png" srcset="/img/loading.gif" lazyload></p>
<p>bootstrap.yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"># nacos配置<br>server:<br>  port: <span class="hljs-number">3377</span><br><br>spring:<br>  application:<br>    name: nacos-config-client<br>  cloud:<br>    nacos:<br>      discovery:<br>        server-addr: localhost:<span class="hljs-number">8848</span> #Nacos服务注册中心地址<br>      config:<br>        server-addr: localhost:<span class="hljs-number">8848</span> #Nacos作为配置中心地址<br>        file-extension: yml #指定yaml格式的配置<br>        group: TEST_GROUP<br>        namespace: 80f0fdbc-e41a-4b42-8f0b-53b460d261d1<br><br># $&#123;spring.application.name&#125;-$&#123;spring.profile.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;<br>#nacos-config-client-dev.yml<br></code></pre></td></tr></table></figure>

<p>application.yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">spring:<br>  profiles:<br>    active: dev # 表示开发环境<br>#    active: test # 表示测试环境<br>#    active: info # 表示测试环境<br></code></pre></td></tr></table></figure>

<p>代码测试: </p>
<p><img src="/assets/8cfe8d3483c04479916f1e635e49905e.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Nacos持久化切换配置"><a href="#Nacos持久化切换配置" class="headerlink" title="Nacos持久化切换配置"></a>Nacos持久化切换配置</h2><p>之前用的版本是1.1.4, 貌似不是很适配mysql8,所以我换了个版本</p>
<p><img src="/assets/2b2ef685f827493ebf55b9a7385a4f4f.png" srcset="/img/loading.gif" lazyload></p>
<p>数据库中运行nacos-mysql.sql文件, 数据库创建名称是nacos</p>
<p><img src="/assets/e40a2807850e4bd0adb4ae710e98a261.png" srcset="/img/loading.gif" lazyload></p>
<p>然后解开配置文件中的相关配置,让nacos切换成mysql数据库</p>
<p><img src="/assets/a8ff0478ffdb43a1a8fd6e6e19771c88.png" srcset="/img/loading.gif" lazyload></p>
<p>由于1.4.5的启动方式是默认用的集群模式启动的</p>
<p>此时我们为了简单,可以直接先用单机模式(单机启动)启动一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">./startup.cmd -m standalone<br></code></pre></td></tr></table></figure>

<p>启动完成登录进入,随便创建一个配置文件, 到数据库查看, 发现创建出来文件成功的保存到了数据库中</p>
<p><img src="/assets/46c3dddc45774eb0b20866964395d4b2.png" srcset="/img/loading.gif" lazyload></p>
<p>此时的持久化操作配置就完成了</p>
<h2 id="搭建Nacos集群环境"><a href="#搭建Nacos集群环境" class="headerlink" title="搭建Nacos集群环境"></a>搭建Nacos集群环境</h2><p>我的linux用的是mysql5.7版本,所以这懒得切换了直接用的是1.1.4版本</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases/tag/1.4.5">https://github.com/alibaba/nacos/releases/tag</a></p>
<p>下载nacos</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ wget https://github.com/alibaba/nacos/releases/download/2.2.2/nacos-server-1.1.4.tar.gz<br></code></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ tar -zxvf nacos-server-1.1.4.tar.gz -C /opt/module/<br>$ <span class="hljs-built_in">cd</span> /opt/module/nacos/conf<br></code></pre></td></tr></table></figure>

<p>进入mysql,导入nacos的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ mysql -uroot -p<br>mysql&gt; create database nacos;<br>mysql&gt; use nacos;<br><span class="hljs-comment"># 这个命令要在/opt/module/nacos/conf目录下进入的mysql才能直接执行</span><br><span class="hljs-comment"># source /opt/module/nacos/conf/nacos-mysql.sql 否则要写全路径</span><br>mysql&gt; <span class="hljs-built_in">source</span> nacos-mysql.sql<br><span class="hljs-comment"># 查看导入的SQL文件</span><br>mysql&gt; show tables;<br><span class="hljs-comment"># 退出mysql</span><br>mysql&gt; <span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>

<p>修改application.properties</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ vim application.properties<br><br><span class="hljs-comment">#*************** Config Module Related Configurations ***************#</span><br><span class="hljs-comment">### If use MySQL as datasource:</span><br>spring.datasource.platform=mysql<br><br><span class="hljs-comment">### Count of DB:</span><br>db.num=1<br><br><span class="hljs-comment">### Connect URL of DB:</span><br>db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=<span class="hljs-literal">true</span>&amp;useUnicode=<span class="hljs-literal">true</span>&amp;useSSL=<span class="hljs-literal">false</span>&amp;serverTimezone=UTC<br>db.user.0=root<br>db.password.0=123456<br></code></pre></td></tr></table></figure>

<p>配置cluster</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">cp</span> cluster.conf.example cluster.conf<br>$ hostname -i<br>192.168.1.202<br><span class="hljs-comment"># 记下这个IP, 配置这个IP</span><br>$ vim cluster.conf<br><br><span class="hljs-comment">#it is ip</span><br><span class="hljs-comment">#example</span><br><span class="hljs-comment">#192.168.16.101:8847</span><br><span class="hljs-comment">#192.168.16.102</span><br><span class="hljs-comment">#192.168.16.103</span><br>192.168.1.202:3333<br>192.168.1.202:4444<br>192.168.1.202:5555<br></code></pre></td></tr></table></figure>

<p>修改启动脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">57 <span class="hljs-keyword">while</span> <span class="hljs-built_in">getopts</span> <span class="hljs-string">&quot;:m:f:s:p:&quot;</span> opt<br>58 <span class="hljs-keyword">do</span><br>59     <span class="hljs-keyword">case</span> <span class="hljs-variable">$opt</span> <span class="hljs-keyword">in</span><br>60         m)<br>61             MODE=<span class="hljs-variable">$OPTARG</span>;;<br>62         f)<br>63             FUNCTION_MODE=<span class="hljs-variable">$OPTARG</span>;;<br>64         s)<br>65             SERVER=<span class="hljs-variable">$OPTARG</span>;;<br>66         p)<br>67             PORT=<span class="hljs-variable">$OPTARG</span>;;<br>68         ?)<br>69         <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Unknown parameter&quot;</span><br>70         <span class="hljs-built_in">exit</span> 1;;<br>71     <span class="hljs-keyword">esac</span><br>72 <span class="hljs-keyword">done</span><br>...<br>134 <span class="hljs-built_in">nohup</span> <span class="hljs-variable">$JAVA</span> -Dserver.port=<span class="hljs-variable">$&#123;PORT&#125;</span> <span class="hljs-variable">$&#123;JAVA_OPT&#125;</span> nacos.nacos &gt;&gt; <span class="hljs-variable">$&#123;BASE_DIR&#125;</span>/logs/start.out 2&gt;&amp;1 &amp;<br><br></code></pre></td></tr></table></figure>

<p><img src="/assets/57cb59fd2c224d8fae5d28c926b159cf.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/de0301a517904c77a27fde5623da353b.png" srcset="/img/loading.gif" lazyload></p>
<p>启动集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ /opt/module/nacos/bin/startup.sh -p 3333<br>$ /opt/module/nacos/bin/startup.sh -p 4444<br>$ /opt/module/nacos/bin/startup.sh -p 5555<br>$ ps -ef | grep nacos | grep -v grep | <span class="hljs-built_in">wc</span> -l<br>3<br><span class="hljs-comment"># 此时说明启动了三台nacos</span><br></code></pre></td></tr></table></figure>

<p>配置nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">pwd</span><br>/opt/module/nginx/conf<br>$ vim nginx.conf<br><br>http &#123;<br>		upstream cluster &#123;<br>		        server 127.0.0.1:3333;<br>		        server 127.0.0.1:4444;<br>		        server 127.0.0.1:5555;<br>		    &#125;<br><br>    server &#123;<br>        listen       1111;<br>        server_name  localhost;<br><br>        location / &#123;<br>            <span class="hljs-comment">#root   html;</span><br>            <span class="hljs-comment">#index  index.html index.htm;</span><br>            proxy_pass http://cluster;<br>        &#125;<br>		&#125;<br>&#125;<br><br>$ sudo systemctl stop nginx<br>$ sudo systemctl start nginx<br></code></pre></td></tr></table></figure>

<p>之后浏览器访问<a target="_blank" rel="noopener" href="http://192.168.1.202:1111/nacos">http://192.168.1.202:1111/nacos</a></p>
<p><img src="/assets/354ee4d1350f4c6b89b40058dd10b5f2.png" srcset="/img/loading.gif" lazyload></p>
<p>说明集群配置成功</p>
<p>将*<code>cloudalibaba-provider-payment9001</code>* 微服务注册注册到nacos</p>
<p>修改yml,换成nginx的地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">server:<br>  port: 9001<br><br>spring:<br>  application:<br>    name: nacos-payment-provider<br>  cloud:<br>    nacos:<br>      discovery:<br><span class="hljs-comment">#        server-addr: localhost:8848 #配置Nacos地址</span><br>        server-addr: 192.168.1.202:1111 <span class="hljs-comment"># 换成nginx的1111端口，做集群</span><br><br>management:<br>  endpoints:<br>    web:<br>      exposure:<br>        include: <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure>

<p>可以看见服务列表中出现了刚刚注册进去的微服务</p>
<p><img src="/assets/e70faf95c80a4d09afcda332575562d0.png" srcset="/img/loading.gif" lazyload></p>
<p>总结</p>
<p><img src="/assets/75d378be9b834ce787b40fc14afa8ed1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="下载Sentinel"><a href="#下载Sentinel" class="headerlink" title="下载Sentinel"></a>下载Sentinel</h2><p>下载地址: <a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases/tag/1.7.0">https://github.com/alibaba/Sentinel/releases/tag/1.7.0</a></p>
<p>下载之后直接使用命令运行<code>java -jar .\sentinel-dashboard-1.7.0.jar</code></p>
<p>浏览器访问<a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080/</a></p>
<p>账号密码都是sentinel</p>
<h2 id="初始化监控"><a href="#初始化监控" class="headerlink" title="初始化监控"></a>初始化监控</h2><p>创建*<code>cloudalibaba-sentinel-service8401</code>*模块</p>
<p>pom</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs bash">&lt;dependencies&gt;<br>        &lt;!--SpringCloud ailibaba nacos --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;<br>            &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--SpringCloud ailibaba sentinel --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--openfeign--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- SpringBoot整合Web组件+actuator --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--日常通用jar包配置--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;cn.hutool&lt;/groupId&gt;<br>            &lt;artifactId&gt;hutool-all&lt;/artifactId&gt;<br>            &lt;version&gt;4.6.3&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;<span class="hljs-built_in">test</span>&lt;/scope&gt;<br>        &lt;/dependency&gt;<br><br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">server:<br>  port: 8401<br><br>spring:<br>  application:<br>    name: cloudalibaba-sentinel-service<br>  cloud:<br>    nacos:<br>      discovery:<br>        <span class="hljs-comment">#Nacos服务注册中心地址</span><br>        server-addr: localhost:8848<br>    sentinel:<br>      transport:<br>        <span class="hljs-comment">#配置Sentinel dashboard地址</span><br>        dashboard: localhost:8080<br>        <span class="hljs-comment">#默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口</span><br>        port: 8719<br><br>management:<br>  endpoints:<br>    web:<br>      exposure:<br>        include: <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure>

<p>Controller</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">package com.atguigu.springcloud.alibaba.controller;<br><br>import org.springframework.web.bind.annotation.GetMapping;<br>import org.springframework.web.bind.annotation.RestController;<br><br>@RestController<br>public class FlowLimitController &#123;<br>    @GetMapping(<span class="hljs-string">&quot;/testA&quot;</span>)<br>    public String <span class="hljs-function"><span class="hljs-title">testA</span></span>()<br>    &#123;<br>        <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;------testA&quot;</span>;<br>    &#125;<br><br>    @GetMapping(<span class="hljs-string">&quot;/testB&quot;</span>)<br>    public String <span class="hljs-function"><span class="hljs-title">testB</span></span>()<br>    &#123;<br>        <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;------testB&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>入口函数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">@EnableDiscoveryClient<br>@SpringBootApplication<br>public class MainApp8401 &#123;<br>    public static void main(String[] args) &#123;<br>        SpringApplication.run(MainApp8401.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>记得先要启动nacos把服务注册上去,同时也要启动sentinel在后台挂着</p>
<p><img src="/assets/aad0dad2b9f941bf887c6da6596f4c1d.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="流控-QPS直接失败"><a href="#流控-QPS直接失败" class="headerlink" title="流控 - QPS直接失败"></a>流控 - QPS直接失败</h2><p>对A进行流控</p>
<p><img src="/assets/369d6a62d37045a198e9ff8d6e5929f3.png" srcset="/img/loading.gif" lazyload></p>
<p>单机阈值设置成1, 表示一秒只能请求一次,多了就会限流</p>
<p>QPS的意思是: 每秒钟的请求数量</p>
<p><img src="/assets/732e7b1320e84922a4a9cb2162530e96.png" srcset="/img/loading.gif" lazyload></p>
<p>限流就会提示Blocked by Sentinel (flow limiting)</p>
<p><img src="/assets/290125dc7561483ab6a0f4753c0f92d6.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="流控-线程数直接失败"><a href="#流控-线程数直接失败" class="headerlink" title="流控 - 线程数直接失败"></a>流控 - 线程数直接失败</h2><p>配置流控规则线程数规则,单机阈值为1</p>
<p><img src="/assets/f03996ade0ef4d0b87f380795da4c41a.png" srcset="/img/loading.gif" lazyload></p>
<p>然后修改Controller业务代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">@RestController<br>public class FlowLimitController &#123;<br>    @GetMapping(<span class="hljs-string">&quot;/testA&quot;</span>)<br>    public String <span class="hljs-function"><span class="hljs-title">testA</span></span>()<br>    &#123;<br>        try &#123;<br>            Thread.<span class="hljs-built_in">sleep</span>(2000);<br>        &#125; catch (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;------testA&quot;</span>;<br>    &#125;<br><br>    @GetMapping(<span class="hljs-string">&quot;/testB&quot;</span>)<br>    public String <span class="hljs-function"><span class="hljs-title">testB</span></span>()<br>    &#123;<br>        <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;------testB&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>让请求testA睡上两秒,来了一堆,请求, 但是实际处理线程的数量只有一个</p>
<p>第一个来了的可以立马处理, 第二个第三个.…后面来得请求就不能得到立刻处理, 所以被限流</p>
<p><img src="/assets/49ae0c5ea83d41e4a10edf796239e66e.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/153091d92dd74200855f3464728ed4d3.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/f3e0a778a2f740f2ac829ad02dc408c4.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="流控-关联"><a href="#流控-关联" class="headerlink" title="流控 -关联"></a>流控 -关联</h2><p>有点像连坐</p>
<p>当B犯事了, A也就被限流了</p>
<p><img src="/assets/d499ac3c3f0f46dba87334c5ad79eadc.png" srcset="/img/loading.gif" lazyload></p>
<p>修改业务类Controller</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">@RestController<br>public class FlowLimitController &#123;<br>    @GetMapping(<span class="hljs-string">&quot;/testA&quot;</span>)<br>    public String <span class="hljs-function"><span class="hljs-title">testA</span></span>()<br>    &#123;<br>        <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;------testA&quot;</span>;<br>    &#125;<br><br>    @GetMapping(<span class="hljs-string">&quot;/testB&quot;</span>)<br>    public String <span class="hljs-function"><span class="hljs-title">testB</span></span>()<br>    &#123;<br>        <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;------testB&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用postman进行测试</p>
<p>循环2000次请求, 间隔1毫秒</p>
<p><img src="/assets/c16a0456c06b440480790ebfe4068d56.png" srcset="/img/loading.gif" lazyload></p>
<p>然后切换到testA给A发送请求, 此时的B已经被限流了 </p>
<p>由于这个限流规则是关联的, 所以A也被限流了</p>
<p><img src="/assets/479e605dcdc04fa5ba1914a1c3c70a9a.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="流控-预热效果"><a href="#流控-预热效果" class="headerlink" title="流控 - 预热效果"></a>流控 - 预热效果</h2><p><img src="/assets/addd63b4ea164d8dae7c4230f443f87e.png" srcset="/img/loading.gif" lazyload></p>
<p>对着浏览器狂点, 前5秒的阈值是10&#x2F;3&#x3D;3, 五秒之后的阈值就慢慢的预热到了10</p>
<blockquote>
<p>默认 coldFactor 为 3，即请求QPS从(threshold &#x2F; 3) 开始，经多少预热时长才逐渐升至设定的 QPS 阈值。</p>
</blockquote>
<blockquote>
<p>案例，阀值为10+预热时长设置5秒。<br>系统初始化的阀值为10 &#x2F; 3 约等于3,即阀值刚开始为3；然后过了5秒后阀值才慢慢升高恢复到10</p>
</blockquote>
<p><img src="/assets/3d231a0680a6414185352ee9fe62a8be.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="流控-排队等待"><a href="#流控-排队等待" class="headerlink" title="流控 - 排队等待"></a>流控 - 排队等待</h2><p>配置如下流控规则, 单机阈值是1, 每次只能处理一个请求, 多了的请求就在后面排队等待</p>
<p>等待的时间超过了20秒, 就会超时</p>
<p><img src="/assets/772b7468548343d4b87156fbd31b7dde.png" srcset="/img/loading.gif" lazyload></p>
<p>模拟并发请求</p>
<p><img src="/assets/6dae7ef917174ebcb9f27d9f197c8467.png" srcset="/img/loading.gif" lazyload></p>
<p>可以发现testB控制每一秒处理一个请求</p>
<p><img src="/assets/d93e0d316db04247a3914b4c0f9db2ab.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="降级-RT"><a href="#降级-RT" class="headerlink" title="降级-RT"></a>降级-RT</h2><p><img src="/assets/be1af08861bc4ecdb82003c3b4c23432.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/9215bfc6ea3c46febcd4208db733f9a7.png" srcset="/img/loading.gif" lazyload></p>
<p>配置降级规则</p>
<p><img src="/assets/ce0abcb21fd84c6abf31e63e19fad679.png" srcset="/img/loading.gif" lazyload></p>
<p>在200毫秒内的响应时间没有响应, 断路器将会在未来的1秒内打开(保险丝跳闸),微服务就不可用了</p>
<p>使用postman发送多个请求,间隔0毫秒</p>
<p><img src="/assets/bd1067493d5e4903ae7629a2ea9558c6.png" srcset="/img/loading.gif" lazyload></p>
<p>由于testD的请求是1秒中才处理完一个请求, 1秒钟比200毫秒的阈值要大, 所以会被降级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">@GetMapping(<span class="hljs-string">&quot;/testD&quot;</span>)<br>    public String <span class="hljs-function"><span class="hljs-title">testD</span></span>()<br>    &#123;<br>        //暂停几秒钟线程<br>        try &#123; TimeUnit.SECONDS.<span class="hljs-built_in">sleep</span>(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;<br>        log.info(<span class="hljs-string">&quot;testD 测试RT&quot;</span>);<br>        <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;------testD&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><img src="/assets/00667b845c2e4ef3b14097882093d7dc.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="降级-异常比例"><a href="#降级-异常比例" class="headerlink" title="降级 - 异常比例"></a>降级 - 异常比例</h2><p>Controller</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript">    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/testD&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">testD</span>(<span class="hljs-params"></span>)<br>    &#123;<br><span class="hljs-comment">//暂停几秒钟线程</span><br><span class="hljs-comment">//        try &#123; TimeUnit.SECONDS.sleep(1); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="hljs-comment">//        log.info(&quot;testD测试RT&quot;);</span><br>int a = <span class="hljs-number">1</span>/<span class="hljs-number">0</span>;<br>log.<span class="hljs-title function_">info</span>(<span class="hljs-string">&quot;testD 测试异常比例&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;------testD&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><img src="/assets/0848cbad7ec444c4bdc47b20a8a7e639.png" srcset="/img/loading.gif" lazyload></p>
<p>代码测试</p>
<p>发送大量请求,每一次请求都会触发一个异常 , 每秒的请求的数量大于了5,并且异常的比例大于了20%,这必然会触发降级</p>
<p><img src="/assets/a39b16c17a3f4374a8d50b610a04625e.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/7e43e63422794a74934d004f8e1d42b8.png" srcset="/img/loading.gif" lazyload></p>
<p>当stop大量请求之后 , 服务降级就恢复了</p>
<p><img src="/assets/0af99369fa674727b9a298bb1a38ca8c.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="降级-异常数"><a href="#降级-异常数" class="headerlink" title="降级 - 异常数"></a>降级 - 异常数</h2><p>Controller</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/testE&quot;</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">testE</span>(<span class="hljs-params"></span>)<br>&#123;<br>log.<span class="hljs-title function_">info</span>(<span class="hljs-string">&quot;testE 测试异常比例&quot;</span>);<br>    int age = <span class="hljs-number">10</span>/<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;------testE 测试异常比例&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>配置降级规则</p>
<p><img src="/assets/3f20f8321c194bd39c93c74ab7a91a1e.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/0c24dbccc37d43efa2e283a0161c99f8.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>时间窗口期一定要大于等于60秒</p>
</blockquote>
<p>代码测试, 连续点击send发送五次请求, 就会触发熔断降级, 因为每一次请求都是会触发异常的</p>
<p><img src="/assets/1aa1028d30e2400085f40e4135d85c1c.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="热点Key"><a href="#热点Key" class="headerlink" title="热点Key"></a>热点Key</h2><p>热点规则</p>
<p>注意资源名配置的应该是testHotKey, 而不是&#x2F;testHotKey, 跟sentinel的<code>SentinelResource</code>的value保持一致</p>
<p>参数索引表示是第0个参数(下面Controller中的参数p1), 单机阈值表示QPS每秒请求的数量是1,请求多了就会在1秒的窗口时间降级处理</p>
<p><img src="/assets/de852d5fea39411e97b5466ae6a0263e.png" srcset="/img/loading.gif" lazyload></p>
<p>Controller</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">@GetMapping(<span class="hljs-string">&quot;/testHotKey&quot;</span>)<br>    @SentinelResource(value = <span class="hljs-string">&quot;testHotKey&quot;</span>, blockHandler = <span class="hljs-string">&quot;dealHandler_testHotKey&quot;</span>)<br>    public String testHotKey(@RequestParam(value = <span class="hljs-string">&quot;p1&quot;</span>, required = <span class="hljs-literal">false</span>) String p1,<br>                             @RequestParam(value = <span class="hljs-string">&quot;p2&quot;</span>, required = <span class="hljs-literal">false</span>) String p2) &#123;<br>        <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;------testHotKey&quot;</span>;<br>    &#125;<br><br>    public String dealHandler_testHotKey(String p1, String p2, BlockException exception) &#123;<br>        <span class="hljs-built_in">return</span> <span class="hljs-string">&quot;-----dealHandler_testHotKey&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>代码测试: </p>
<p>localhost:8401&#x2F;testHotKey?p1&#x3D;1             限流</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8401/testHotKey?p1=1&p2=1">localhost:8401&#x2F;testHotKey?p1&#x3D;1&amp;p2&#x3D;1</a>  限流</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8401/testHotKey?p2=1">localhost:8401&#x2F;testHotKey?p2&#x3D;1</a>             不限流</p>
<p>狂点send,当QPS超过秒就马上被限流</p>
<p><img src="/assets/a030d658e0f749598f545f6941cf9e20.png" srcset="/img/loading.gif" lazyload></p>
<p>修改热点规则</p>
<p><img src="/assets/0fd69c86bd5a4166a2ae7d15c5e2433e.png" srcset="/img/loading.gif" lazyload></p>
<p>当参数值等于p1&#x3D;5的时候,限流的阈值就不再是1了,而是两百</p>
<p>瞎点send也是—–testHotKey</p>
<p><img src="/assets/968c629ada1149a586933a5ceb713cf8.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="SentinelResource配置"><a href="#SentinelResource配置" class="headerlink" title="SentinelResource配置"></a>SentinelResource配置</h2><p>在<code>cloudalibaba-sentinel-service8401</code>模块</p>
<p>pom添加common</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">&lt;dependency&gt;&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;<br>            &lt;groupId&gt;com.atguigu.springcloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-variable">$&#123;project.version&#125;</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p>编写一个新的Controller</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">@RestController<br>public class RateLimitController<br>&#123;<br>    @GetMapping(<span class="hljs-string">&quot;/byResource&quot;</span>)<br>    @SentinelResource(value = <span class="hljs-string">&quot;byResource&quot;</span>,blockHandler = <span class="hljs-string">&quot;handleException&quot;</span>)<br>    public CommonResult <span class="hljs-function"><span class="hljs-title">byResource</span></span>()<br>    &#123;<br>        <span class="hljs-built_in">return</span> new CommonResult(200,<span class="hljs-string">&quot;按资源名称限流测试OK&quot;</span>,new Payment(2020L,<span class="hljs-string">&quot;serial001&quot;</span>));<br>    &#125;<br>    public CommonResult handleException(BlockException exception)<br>    &#123;<br>        <span class="hljs-built_in">return</span> new CommonResult(444,exception.getClass().getCanonicalName()+<span class="hljs-string">&quot;\t 服务不可用&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>添加流控规则</p>
<p>资源名可以写请求的mapping,也可以填写Sentinel的value</p>
<p><img src="/assets/f68d24f642274c33aae7046b6f4c3541.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/8e4be2e9c3be400d86dc45ca39bbaed8.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/2fdf7cee94704a208ac16d70f296c3a6.png" srcset="/img/loading.gif" lazyload></p>
<p>同样的可以按照url进行限流</p>
<p>编写Controller</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">@GetMapping(<span class="hljs-string">&quot;/rateLimit/byUrl&quot;</span>)<br>    @SentinelResource(value = <span class="hljs-string">&quot;byUrl&quot;</span>)<br>    public CommonResult <span class="hljs-function"><span class="hljs-title">byUrl</span></span>()<br>    &#123;<br>        <span class="hljs-built_in">return</span> new CommonResult(200,<span class="hljs-string">&quot;按url限流测试OK&quot;</span>,new Payment(2020L,<span class="hljs-string">&quot;serial002&quot;</span>));<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>添加配置</p>
<p><img src="/assets/93c46e9f7741404cbc55e5a8ac39ffb9.png" srcset="/img/loading.gif" lazyload></p>
<p>代码测试, 同样可以达到限流的效果</p>
<p><img src="/assets/043ce6a258b145bc8ce1d55a59241e90.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="客户自定义限流处理逻辑"><a href="#客户自定义限流处理逻辑" class="headerlink" title="客户自定义限流处理逻辑"></a>客户自定义限流处理逻辑</h2><p>编写handler</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">public class CustomerBlockHandler &#123;<br>    public static CommonResult handleException(BlockException exception)&#123;<br>        <span class="hljs-built_in">return</span> new CommonResult(4444,<span class="hljs-string">&quot;自定义的限流处理信息......CustomerBlockHandler&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编写Controller</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash">/**<br>     * 自定义通用的限流处理逻辑，<br>     blockHandlerClass = CustomerBlockHandler.class<br>     blockHandler = handleException2<br>     上述配置：找CustomerBlockHandler类里的handleException2方法进行兜底处理<br>     */<br>    /**<br>     * 自定义通用的限流处理逻辑<br>     */<br>    @GetMapping(<span class="hljs-string">&quot;/rateLimit/customerBlockHandler&quot;</span>)<br>    @SentinelResource(value = <span class="hljs-string">&quot;customerBlockHandler&quot;</span>,<br>            blockHandlerClass = CustomerBlockHandler.class,<br>            blockHandler = <span class="hljs-string">&quot;handleException&quot;</span>)<br>    public CommonResult <span class="hljs-function"><span class="hljs-title">customerBlockHandler</span></span>()<br>    &#123;<br>        <span class="hljs-built_in">return</span> new CommonResult(200,<span class="hljs-string">&quot;按客户自定义限流处理逻辑&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>添加配置</p>
<p><img src="/assets/9981cad05aca4baeaf52163fc85e41a9.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/347910b255014f4da005660c2f93d7b0.png" srcset="/img/loading.gif" lazyload></p>
<p>代码测试: </p>
<p><img src="/assets/15e113254758405a9988fb31f8ab122c.png" srcset="/img/loading.gif" lazyload></p>
<p>当每秒请求的数量大于1了, 通过<code>@SentinelResource</code>注解中的<code>blockHandlerClass</code>属性指定将由哪一个类来处理异常, <code>blockHandler</code> 指定哪一个类的哪一个方法</p>
<p>这样做的好处就是可以将业务代码和自定义的处理方法进行解构, 而不会混在一起,还可以实现全局统一的处理异常</p>
<h2 id="服务熔断-Ribbon"><a href="#服务熔断-Ribbon" class="headerlink" title="服务熔断-Ribbon"></a>服务熔断-Ribbon</h2><p>创建<code>cloudalibaba-provider-payment9003``cloudalibaba-provider-payment9004</code>模块</p>
<p>pom</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">&lt;dependencies&gt;<br>        &lt;!--SpringCloud ailibaba nacos --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;<br>            &lt;groupId&gt;com.atguigu.springcloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-variable">$&#123;project.version&#125;</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- SpringBoot整合Web组件 --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--日常通用jar包配置--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;<span class="hljs-built_in">test</span>&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">server:<br>  port: 9003<br><br>spring:<br>  application:<br>    name: nacos-payment-provider<br>  cloud:<br>    nacos:<br>      discovery:<br>        server-addr: localhost:8848 <span class="hljs-comment">#配置Nacos地址</span><br><br>management:<br>  endpoints:<br>    web:<br>      exposure:<br>        include: <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">@RestController<br>public class PaymentController &#123;<br>    @Value(<span class="hljs-string">&quot;<span class="hljs-variable">$&#123;server.port&#125;</span>&quot;</span>)<br>    private String serverPort;<br><br>    public static HashMap&lt;Long, Payment&gt; hashMap = new HashMap&lt;&gt;();<br>    static<br>    &#123;<br>        hashMap.put(1L,new Payment(1L,<span class="hljs-string">&quot;28a8c1e3bc2742d8848569891fb42181&quot;</span>));<br>        hashMap.put(2L,new Payment(2L,<span class="hljs-string">&quot;bba8c1e3bc2742d8848569891ac32182&quot;</span>));<br>        hashMap.put(3L,new Payment(3L,<span class="hljs-string">&quot;6ua8c1e3bc2742d8848569891xt92183&quot;</span>));<br>    &#125;<br><br>    @GetMapping(value = <span class="hljs-string">&quot;/paymentSQL/&#123;id&#125;&quot;</span>)<br>    public CommonResult&lt;Payment&gt; paymentSQL(@PathVariable(<span class="hljs-string">&quot;id&quot;</span>) Long <span class="hljs-built_in">id</span>)<br>    &#123;<br>        Payment payment = hashMap.get(<span class="hljs-built_in">id</span>);<br>        CommonResult&lt;Payment&gt; result = new CommonResult(200,<span class="hljs-string">&quot;from mysql,serverPort:  &quot;</span>+serverPort,payment);<br>        <span class="hljs-built_in">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>入口函数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">@SpringBootApplication<br>@EnableDiscoveryClient<br>public class PaymentMain9003 &#123;<br>    public static void main(String[] args) &#123;<br>        SpringApplication.run(PaymentMain9003.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后创建<code>cloudalibaba-consumer-nacos-order84</code>模块</p>
<p>pom</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">&lt;dependencies&gt;<br>        &lt;!--SpringCloud ailibaba nacos --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--SpringCloud ailibaba sentinel --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.atguigu.springcloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;cloud-api-commons&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-variable">$&#123;project.version&#125;</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br>        &lt;!-- SpringBoot整合Web组件 --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br>        &lt;!--日常通用jar包配置--&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;<br>            &lt;scope&gt;runtime&lt;/scope&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;<br>            &lt;artifactId&gt;lombok&lt;/artifactId&gt;<br>            &lt;optional&gt;<span class="hljs-literal">true</span>&lt;/optional&gt;<br>        &lt;/dependency&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;<br>            &lt;scope&gt;<span class="hljs-built_in">test</span>&lt;/scope&gt;<br>        &lt;/dependency&gt;<br>    &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">84</span><br><br>spring:<br>  application:<br>    name: nacos-order-consumer<br>  cloud:<br>    nacos:<br>      discovery:<br>        server-addr: localhost:<span class="hljs-number">8848</span><br>    sentinel:<br>      transport:<br>        #配置Sentinel dashboard地址<br>        dashboard: localhost:<span class="hljs-number">8080</span><br>        #默认<span class="hljs-number">8719</span>端口，假如被占用会自动从<span class="hljs-number">8719</span>开始依次+<span class="hljs-number">1</span>扫描,直至找到未被占用的端口<br>        port: <span class="hljs-number">8719</span><br><br>#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)<br>service-url:<br>  nacos-user-service: http:<span class="hljs-comment">//nacos-payment-provider</span><br></code></pre></td></tr></table></figure>

<p>config</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationContextConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@LoadBalanced</span><br>    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">getRestTemplate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CircleBreakerController</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SERVICE_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://nacos-payment-provider&quot;</span>;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span><br>    <span class="hljs-meta">@SentinelResource(value = &quot;fallback&quot;)</span><br><br>    <span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title function_">fallback</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span><br>    &#123;<br>        CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="hljs-string">&quot;/paymentSQL/&quot;</span>+id, CommonResult.class,id);<br><br>        <span class="hljs-keyword">if</span> (id == <span class="hljs-number">4</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span> (<span class="hljs-string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result.getData() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span> (<span class="hljs-string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>入口函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderNacosMain84</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(OrderNacosMain84.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>请求1正常</p>
<p><img src="/assets/d779000bf422412e954f645e1ed2b2f7.png" srcset="/img/loading.gif" lazyload></p>
<p>请求4显示非法参数异常</p>
<p><img src="/assets/5422b6f09a2b4206a933c8efe07cd2c0.png" srcset="/img/loading.gif" lazyload></p>
<p>请求5显示空指针异常</p>
<p><img src="/assets/6348b69f159b4b659d77dfdcd6a75bb9.png" srcset="/img/loading.gif" lazyload></p>
<p>可以发现当出现Error的时候, 出现的提示信息有点太多了,不够友好</p>
<h2 id="Sentinel服务熔断只配置fallback"><a href="#Sentinel服务熔断只配置fallback" class="headerlink" title="Sentinel服务熔断只配置fallback"></a>Sentinel服务熔断只配置fallback</h2><p>修改controller为</p>
<p>在CommonResult方法上给<code>@SentinelResource</code>注解添加fallback</p>
<p>当方法内部出现了异常, 就会去执行指定的fallback</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CircleBreakerController</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SERVICE_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://nacos-payment-provider&quot;</span>;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span><br><span class="hljs-comment">//    @SentinelResource(value = &quot;fallback&quot;)</span><br>    <span class="hljs-meta">@SentinelResource(value = &quot;fallback&quot;,fallback = &quot;handlerFallback&quot;)</span> <span class="hljs-comment">//fallback负责业务异常</span><br>    <span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title function_">fallback</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span><br>    &#123;<br>        CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="hljs-string">&quot;/paymentSQL/&quot;</span>+id, CommonResult.class,id);<br><br>        <span class="hljs-keyword">if</span> (id == <span class="hljs-number">4</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span> (<span class="hljs-string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result.getData() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span> (<span class="hljs-string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">handlerFallback</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span>  Long id,Throwable e)</span> &#123;<br>        <span class="hljs-type">Payment</span> <span class="hljs-variable">payment</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Payment</span>(id,<span class="hljs-string">&quot;null&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>&lt;&gt;(<span class="hljs-number">444</span>,<span class="hljs-string">&quot;兜底异常handlerFallback,exception内容  &quot;</span>+e.getMessage(),payment);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码测试, 这样的错误信息看起来比之前的更为友好一些</p>
<p><img src="/assets/dce08b263a0b4127a5862fdced7fd76a.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/assets/501e42515b4b4646b8d490c5f6c5638b.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Sentinel服务熔断只配置blockHandler"><a href="#Sentinel服务熔断只配置blockHandler" class="headerlink" title="Sentinel服务熔断只配置blockHandler"></a>Sentinel服务熔断只配置blockHandler</h2><p>修改controller</p>
<p>配置<code>@SentinelResource</code>注解拥有<code>blockHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CircleBreakerController</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SERVICE_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://nacos-payment-provider&quot;</span>;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span><br><span class="hljs-comment">//    @SentinelResource(value = &quot;fallback&quot;)</span><br><span class="hljs-comment">//    @SentinelResource(value = &quot;fallback&quot;,fallback = &quot;handlerFallback&quot;) //fallback负责业务异常</span><br>    <span class="hljs-meta">@SentinelResource(value = &quot;fallback&quot;,blockHandler = &quot;blockHandler&quot;)</span> <span class="hljs-comment">//blockHandler负责在sentinel里面配置的降级限流</span><br>    <span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title function_">fallback</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span><br>    &#123;<br>        CommonResult&lt;Payment&gt; result = restTemplate.getForObject(SERVICE_URL + <span class="hljs-string">&quot;/paymentSQL/&quot;</span>+id, CommonResult.class,id);<br><br>        <span class="hljs-keyword">if</span> (id == <span class="hljs-number">4</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span> (<span class="hljs-string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result.getData() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span> (<span class="hljs-string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">handlerFallback</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span>  Long id,Throwable e)</span> &#123;<br>        <span class="hljs-type">Payment</span> <span class="hljs-variable">payment</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Payment</span>(id,<span class="hljs-string">&quot;null&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>&lt;&gt;(<span class="hljs-number">444</span>,<span class="hljs-string">&quot;兜底异常handlerFallback,exception内容  &quot;</span>+e.getMessage(),payment);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">blockHandler</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span>  Long id, BlockException blockException)</span> &#123;<br>        <span class="hljs-type">Payment</span> <span class="hljs-variable">payment</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Payment</span>(id,<span class="hljs-string">&quot;null&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>&lt;&gt;(<span class="hljs-number">445</span>,<span class="hljs-string">&quot;blockHandler-sentinel限流,无此流水: blockException  &quot;</span>+blockException.getMessage(),payment);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>配置Sentinel降级</p>
<p><img src="/assets/c3dd98bed9064072846ea072cbedbf9d.png" srcset="/img/loading.gif" lazyload></p>
<p>狂点发送异常请求, 此时请求异常数过大进入熔断降级</p>
<p><img src="/assets/64837979cb584dfe9e524281acd0ef5d.png" srcset="/img/loading.gif" lazyload></p>
<p>未进入降级状态, 显示Java运行的异常</p>
<p><img src="/assets/ccdb48b872e54782aab3d041a26773c8.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Sentinel服务熔断fallback和blockHandler都配置"><a href="#Sentinel服务熔断fallback和blockHandler都配置" class="headerlink" title="Sentinel服务熔断fallback和blockHandler都配置"></a>Sentinel服务熔断fallback和blockHandler都配置</h2><p>修改controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CircleBreakerController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SERVICE_URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://nacos-payment-provider&quot;</span>;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/consumer/fallback/&#123;id&#125;&quot;)</span><br>    <span class="hljs-comment">//@SentinelResource(value = &quot;fallback&quot;)</span><br>    <span class="hljs-comment">//@SentinelResource(value = &quot;fallback&quot;,fallback = &quot;handlerFallback&quot;) //fallback负责业务异常</span><br><span class="hljs-comment">//    @SentinelResource(value = &quot;fallback&quot;,blockHandler = &quot;blockHandler&quot;) //blockHandler负责在sentinel里面配置的降级限流</span><br>    <span class="hljs-meta">@SentinelResource(value = &quot;fallback&quot;, fallback = &quot;handlerFallback&quot;, blockHandler = &quot;blockHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title function_">fallback</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-type">CommonResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> restTemplate.getForObject(SERVICE_URL + <span class="hljs-string">&quot;/paymentSQL/&quot;</span> + id, CommonResult.class, id);<br><br>        <span class="hljs-keyword">if</span> (id == <span class="hljs-number">4</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;IllegalArgumentException,非法参数异常....&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result.getData() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">handlerFallback</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span>  Long id,Throwable e)</span> &#123;<br>        <span class="hljs-type">Payment</span> <span class="hljs-variable">payment</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Payment</span>(id,<span class="hljs-string">&quot;null&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>&lt;&gt;(<span class="hljs-number">444</span>,<span class="hljs-string">&quot;fallback,无此流水,exception  &quot;</span>+e.getMessage(),payment);<br>    &#125;<br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">blockHandler</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span>  Long id,BlockException blockException)</span> &#123;<br>        <span class="hljs-type">Payment</span> <span class="hljs-variable">payment</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Payment</span>(id,<span class="hljs-string">&quot;null&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>&lt;&gt;(<span class="hljs-number">445</span>,<span class="hljs-string">&quot;blockHandler-sentinel限流,无此流水: blockException  &quot;</span>+blockException.getMessage(),payment);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>添加限流规则</p>
<p><img src="/assets/aff1b2e3074a47349cc5124cd4e3fc4e.png" srcset="/img/loading.gif" lazyload></p>
<p>请求4, 会出现Java运行异常</p>
<p><img src="/assets/ecbaa0b129554029a70ca0b3de45d34f.png" srcset="/img/loading.gif" lazyload></p>
<p>多次请求则被限流控制</p>
<p><img src="/assets/a1bb5f5834a14f2bb7c2f4fb6beffb3c.png" srcset="/img/loading.gif" lazyload></p>
<p>同样的请求id为5也是一样的</p>
<p><img src="/assets/a14a10711d1f427dbaf74d790757bc45.png" srcset="/img/loading.gif" lazyload></p>
<p>多次请求</p>
<p><img src="/assets/6a604fcc082c48829b03d161f95b665c.png" srcset="/img/loading.gif" lazyload></p>
<p>如果同时配置了blockHandler和fallback </p>
<p>方法内部出现了异常则会走fallback 兜底方法 </p>
<p>请求多了达到了限流则会走blockHandler处理</p>
<h2 id="Sentinel服务熔断exceptionsToIgnore"><a href="#Sentinel服务熔断exceptionsToIgnore" class="headerlink" title="Sentinel服务熔断exceptionsToIgnore"></a>Sentinel服务熔断exceptionsToIgnore</h2><p>修改controller为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SentinelResource(value = &quot;fallback&quot;,</span><br><span class="hljs-meta">            fallback = &quot;handlerFallback&quot;,</span><br><span class="hljs-meta">            blockHandler = &quot;blockHandler&quot;,</span><br><span class="hljs-meta">            exceptionsToIgnore = &#123;IllegalArgumentException.class&#125;)</span><br></code></pre></td></tr></table></figure>

<p>这个<code>exceptionsToIgnore</code> 的意思就是如果出现了<code>IllegalArgumentException</code>异常</p>
<p>就不会进入fallback兜底的方法, 没有服务降级的效果了</p>
<p>代码测试: </p>
<p><img src="/assets/8d1192547a524975b0c739547ed76d52.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Sentinel服务熔断OpenFeign"><a href="#Sentinel服务熔断OpenFeign" class="headerlink" title="Sentinel服务熔断OpenFeign"></a>Sentinel服务熔断OpenFeign</h2><p>pom添加依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;!--SpringCloud openfeign --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;<br>            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"># 激活Sentinel对Feign的支持<br>feign:<br>  sentinel:<br>    enabled: <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>编写service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;nacos-payment-provider&quot;, fallback = PaymentFallbackService.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentService</span> &#123;<br>    <span class="hljs-meta">@GetMapping(value = &quot;/paymentSQL/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title function_">paymentSQL</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentFallbackService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title function_">paymentSQL</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonResult</span>&lt;&gt;(<span class="hljs-number">444</span>, <span class="hljs-string">&quot;服务降级返回,没有该流水信息&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Payment</span>(id, <span class="hljs-string">&quot;errorSerial......&quot;</span>));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//==================OpenFeign</span><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> PaymentService paymentService;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/consumer/openfeign/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult&lt;Payment&gt; <span class="hljs-title function_">paymentSQL</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span>(id == <span class="hljs-number">4</span>)<br>        &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;没有该id&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> paymentService.paymentSQL(id);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>代码测试: </p>
<p><img src="/assets/f425919f4afd43ccb4140025547d78d1.png" srcset="/img/loading.gif" lazyload></p>
<p>然后关闭payment提供者微服务, 再次请求, 观察84微服务自动降级, 不会被耗死</p>
<p><img src="/assets/d082878f63dc44feb72ac186ffa01c37.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="规则持久化"><a href="#规则持久化" class="headerlink" title="规则持久化"></a>规则持久化</h2><p>修改<code>cloudalibaba-sentinel-service8401</code></p>
<p>pom</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;!--SpringCloud ailibaba sentinel-datasource-nacos --&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;<br>            &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;<br>        &lt;/dependency&gt;<br></code></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">8401</span><br><br>spring:<br>  application:<br>    name: cloudalibaba-sentinel-service<br>  cloud:<br>    nacos:<br>      discovery:<br>        #Nacos服务注册中心地址<br>        server-addr: localhost:<span class="hljs-number">8848</span><br>    sentinel:<br>      transport:<br>        #配置Sentinel dashboard地址<br>        dashboard: localhost:<span class="hljs-number">8080</span><br>        #默认<span class="hljs-number">8719</span>端口，假如被占用会自动从<span class="hljs-number">8719</span>开始依次+<span class="hljs-number">1</span>扫描,直至找到未被占用的端口<br>        port: <span class="hljs-number">8719</span><br>      datasource:<br>        ds1:<br>          nacos:<br>            server-addr: localhost:<span class="hljs-number">8848</span><br>            dataId: cloudalibaba-sentinel-service<br>            groupId: DEFAULT_GROUP<br>            data-type: json<br>            rule-type: flow<br><br>management:<br>  endpoints:<br>    web:<br>      exposure:<br>        include: <span class="hljs-string">&#x27;*&#x27;</span><br></code></pre></td></tr></table></figure>

<p>然后在nacos的配置列表添加配置</p>
<p>DataId <code>cloudalibaba-sentinel-service</code></p>
<p>内容配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">[<br>    &#123;<br>        <span class="hljs-string">&quot;resource&quot;</span>: <span class="hljs-string">&quot;/rateLimit/byUrl&quot;</span>,<br>        <span class="hljs-string">&quot;limitApp&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,<br>        <span class="hljs-string">&quot;grade&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;count&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;strategy&quot;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;controlBehavior&quot;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;clusterMode&quot;</span>: <span class="hljs-literal">false</span><br>    &#125;<br>]<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">resource：资源名称；<br>limitApp：来源应用；<br>grade：阈值类型，<span class="hljs-number">0</span>表示线程数，<span class="hljs-number">1</span>表示QPS；<br>count：单机阈值；<br>strategy：流控模式，<span class="hljs-number">0</span>表示直接，<span class="hljs-number">1</span>表示关联，<span class="hljs-number">2</span>表示链路；<br>controlBehavior：流控效果，<span class="hljs-number">0</span>表示快速失败，<span class="hljs-number">1</span>表示Warm Up，<span class="hljs-number">2</span>表示排队等待；<br>clusterMode：是否集群。<br></code></pre></td></tr></table></figure>

<p><img src="/assets/64a6880b4d8c408c9d432be38c2f8ea0.png" srcset="/img/loading.gif" lazyload></p>
<p>然后启动8401访问localhost:8401&#x2F;rateLimit&#x2F;byUrl</p>
<p><img src="/assets/186467fe1f20437bb39fcb7aef00a58c.png" srcset="/img/loading.gif" lazyload></p>
<p>多次刷新, 说明流控配置起效了</p>
<p><img src="/assets/6bd67e60ab7f408ebb922ea82c7fdb52.png" srcset="/img/loading.gif" lazyload></p>
<p>上Sentinel查看一下, 刚刚配置的json配置生效了, 这个流控规则是nacos读取json配置文件给我们加载进来的</p>
<p><img src="/assets/fa920c77b93745cbbf508d579ee5876f.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h2><p>这部分懒得做笔记了</p>
<p>核心注解<code>@GlobalTransactional</code></p>
<p>粘上一段核心代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span><br>&#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> OrderDao orderDao;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StorageService storageService;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> AccountService accountService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建订单-&gt;调用库存服务扣减库存-&gt;调用账户服务扣减账户余额-&gt;修改订单状态</span><br><span class="hljs-comment">     * 简单说：</span><br><span class="hljs-comment">     * 下订单-&gt;减库存-&gt;减余额-&gt;改状态</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@GlobalTransactional(name = &quot;fsp-create-order&quot;,rollbackFor = Exception.class)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">(Order order)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;-------&gt;下单开始&quot;</span>);<br>        <span class="hljs-comment">//本应用创建订单</span><br>        orderDao.create(order);<br><br>        <span class="hljs-comment">//远程调用库存服务扣减库存</span><br>        log.info(<span class="hljs-string">&quot;-------&gt;order-service中扣减库存开始&quot;</span>);<br>        storageService.decrease(order.getProductId(),order.getCount());<br>        log.info(<span class="hljs-string">&quot;-------&gt;order-service中扣减库存结束&quot;</span>);<br><br>        <span class="hljs-comment">//远程调用账户服务扣减余额</span><br>        log.info(<span class="hljs-string">&quot;-------&gt;order-service中扣减余额开始&quot;</span>);<br>        accountService.decrease(order.getUserId(),order.getMoney());<br>        log.info(<span class="hljs-string">&quot;-------&gt;order-service中扣减余额结束&quot;</span>);<br><br>        <span class="hljs-comment">//修改订单状态为已完成</span><br>        log.info(<span class="hljs-string">&quot;-------&gt;order-service中修改订单状态开始&quot;</span>);<br>        orderDao.update(order.getUserId(),<span class="hljs-number">0</span>);<br>        log.info(<span class="hljs-string">&quot;-------&gt;order-service中修改订单状态结束&quot;</span>);<br><br>        log.info(<span class="hljs-string">&quot;-------&gt;下单结束&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong><strong>Failed to fetch schema of <code>order</code>的解决办法</strong></strong></p>
<p>jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;orders</p>
<p>jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;orders?useInformationSchema&#x3D;false</p>
<p>给所有的微服务都添加上?useInformationSchema&#x3D;false, 然后重启</p>
<p>参考: </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/L1Ha1Y1/article/details/108681489">https://blog.csdn.net/L1Ha1Y1/article/details/108681489</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java/" class="category-chain-item">Java</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java/">#Java</a>
      
        <a href="/tags/SpringCloud/">#SpringCloud</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SpringCloud</div>
      <div>https://xiamu.icu/Java/SpringCloud/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>肉豆蔻吖</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年5月5日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/Java/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%9E%E6%88%98/" title="云原生实战">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">云原生实战</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/Java/%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%90%86/" title="配置代理">
                        <span class="hidden-mobile">配置代理</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"Haq24NRgHl4QheEi7oVqtAsM-gzGzoHsz","appKey":"kGbxzGaSiqqlFPxg24Tk3dVN","path":"window.location.pathname","placeholder":"来都来了, 不留下点啥吗?","avatar":"retro","meta":["nick","mail","link"],"requiredFields":["nick","mail"],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":true,"serverURLs":"","emojiCDN":"https://valinecdn.bili33.top","emojiMaps":{"Tieba-New2":"/Tieba-New/image_emoticon.png","Tieba-New3":"/Tieba-New/image_emoticon10.png","Tieba-New4":"/Tieba-New/image_emoticon100.png","Tieba-New5":"/Tieba-New/image_emoticon101.png","Tieba-New6":"/Tieba-New/image_emoticon102.png","Tieba-New7":"/Tieba-New/image_emoticon103.png","Tieba-New8":"/Tieba-New/image_emoticon104.png","Tieba-New9":"/Tieba-New/image_emoticon105.png","Tieba-New10":"/Tieba-New/image_emoticon106.png","Tieba-New11":"/Tieba-New/image_emoticon107.png","Tieba-New12":"/Tieba-New/image_emoticon108.png","Tieba-New13":"/Tieba-New/image_emoticon109.png","Tieba-New14":"/Tieba-New/image_emoticon11.png","Tieba-New15":"/Tieba-New/image_emoticon110.png","Tieba-New16":"/Tieba-New/image_emoticon111.png","Tieba-New17":"/Tieba-New/image_emoticon112.png","Tieba-New18":"/Tieba-New/image_emoticon113.png","Tieba-New19":"/Tieba-New/image_emoticon114.png","Tieba-New20":"/Tieba-New/image_emoticon115.png","Tieba-New21":"/Tieba-New/image_emoticon116.png","Tieba-New22":"/Tieba-New/image_emoticon117.png","Tieba-New23":"/Tieba-New/image_emoticon118.png","Tieba-New24":"/Tieba-New/image_emoticon119.png","Tieba-New25":"/Tieba-New/image_emoticon12.png","Tieba-New26":"/Tieba-New/image_emoticon120.png","Tieba-New27":"/Tieba-New/image_emoticon121.png","Tieba-New28":"/Tieba-New/image_emoticon122.png","Tieba-New29":"/Tieba-New/image_emoticon123.png","Tieba-New30":"/Tieba-New/image_emoticon124.png","Tieba-New31":"/Tieba-New/image_emoticon13.png","Tieba-New32":"/Tieba-New/image_emoticon14.png","Tieba-New33":"/Tieba-New/image_emoticon15.png","Tieba-New34":"/Tieba-New/image_emoticon16.png","Tieba-New35":"/Tieba-New/image_emoticon17.png","Tieba-New36":"/Tieba-New/image_emoticon18.png","Tieba-New37":"/Tieba-New/image_emoticon19.png","Tieba-New38":"/Tieba-New/image_emoticon2.png","Tieba-New39":"/Tieba-New/image_emoticon20.png","Tieba-New40":"/Tieba-New/image_emoticon21.png","Tieba-New41":"/Tieba-New/image_emoticon22.png","Tieba-New42":"/Tieba-New/image_emoticon23.png","Tieba-New43":"/Tieba-New/image_emoticon24.png","Tieba-New44":"/Tieba-New/image_emoticon25.png","Tieba-New45":"/Tieba-New/image_emoticon26.png","Tieba-New46":"/Tieba-New/image_emoticon27.png","Tieba-New47":"/Tieba-New/image_emoticon28.png","Tieba-New48":"/Tieba-New/image_emoticon29.png","Tieba-New49":"/Tieba-New/image_emoticon3.png","Tieba-New50":"/Tieba-New/image_emoticon30.png","Tieba-New51":"/Tieba-New/image_emoticon31.png","Tieba-New52":"/Tieba-New/image_emoticon32.png","Tieba-New53":"/Tieba-New/image_emoticon33.png","Tieba-New54":"/Tieba-New/image_emoticon34.png","Tieba-New55":"/Tieba-New/image_emoticon35.png","Tieba-New56":"/Tieba-New/image_emoticon36.png","Tieba-New57":"/Tieba-New/image_emoticon37.png","Tieba-New58":"/Tieba-New/image_emoticon38.png","Tieba-New59":"/Tieba-New/image_emoticon39.png","Tieba-New60":"/Tieba-New/image_emoticon4.png","Tieba-New61":"/Tieba-New/image_emoticon40.png","Tieba-New62":"/Tieba-New/image_emoticon41.png","Tieba-New63":"/Tieba-New/image_emoticon42.png","Tieba-New64":"/Tieba-New/image_emoticon43.png","Tieba-New65":"/Tieba-New/image_emoticon44.png","Tieba-New66":"/Tieba-New/image_emoticon45.png","Tieba-New67":"/Tieba-New/image_emoticon46.png","Tieba-New68":"/Tieba-New/image_emoticon47.png","Tieba-New69":"/Tieba-New/image_emoticon48.png","Tieba-New70":"/Tieba-New/image_emoticon49.png","Tieba-New71":"/Tieba-New/image_emoticon5.png","Tieba-New72":"/Tieba-New/image_emoticon50.png","Tieba-New73":"/Tieba-New/image_emoticon6.png","Tieba-New74":"/Tieba-New/image_emoticon66.png","Tieba-New75":"/Tieba-New/image_emoticon67.png","Tieba-New76":"/Tieba-New/image_emoticon68.png","Tieba-New77":"/Tieba-New/image_emoticon69.png","Tieba-New78":"/Tieba-New/image_emoticon7.png","Tieba-New79":"/Tieba-New/image_emoticon70.png","Tieba-New80":"/Tieba-New/image_emoticon71.png","Tieba-New81":"/Tieba-New/image_emoticon72.png","Tieba-New82":"/Tieba-New/image_emoticon73.png","Tieba-New83":"/Tieba-New/image_emoticon74.png","Tieba-New84":"/Tieba-New/image_emoticon75.png","Tieba-New85":"/Tieba-New/image_emoticon76.png","Tieba-New86":"/Tieba-New/image_emoticon77.png","Tieba-New87":"/Tieba-New/image_emoticon78.png","Tieba-New88":"/Tieba-New/image_emoticon79.png","Tieba-New89":"/Tieba-New/image_emoticon8.png","Tieba-New90":"/Tieba-New/image_emoticon80.png","Tieba-New91":"/Tieba-New/image_emoticon81.png","Tieba-New92":"/Tieba-New/image_emoticon82.png","Tieba-New93":"/Tieba-New/image_emoticon83.png","Tieba-New94":"/Tieba-New/image_emoticon84.png","Tieba-New95":"/Tieba-New/image_emoticon85.png","Tieba-New96":"/Tieba-New/image_emoticon86.png","Tieba-New97":"/Tieba-New/image_emoticon87.png","Tieba-New98":"/Tieba-New/image_emoticon88.png","Tieba-New99":"/Tieba-New/image_emoticon89.png","Tieba-New100":"/Tieba-New/image_emoticon9.png","Tieba-New101":"/Tieba-New/image_emoticon90.png","Tieba-New102":"/Tieba-New/image_emoticon91.png","Tieba-New103":"/Tieba-New/image_emoticon92.png","Tieba-New104":"/Tieba-New/image_emoticon93.png","Tieba-New105":"/Tieba-New/image_emoticon94.png","Tieba-New106":"/Tieba-New/image_emoticon95.png","Tieba-New107":"/Tieba-New/image_emoticon96.png","Tieba-New108":"/Tieba-New/image_emoticon97.png","Tieba-New109":"/Tieba-New/image_emoticon98.png","Tieba-New110":"/Tieba-New/image_emoticon99.png"},"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      湘ICP备2021007554号-1
    </a>
  </span>
  
</div>

  
  
</div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script>
  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/custom.js"></script>
<script src="/js/sakura.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <!-- 全局配置aplayer播放器 -->
  <div class="aplayer" 
    data-id="5237049130" 
    data-server="netease"   
    data-type="playlist" 
    data-fixed="true" 
    data-autoplay="false" 
    data-order="list" 
    data-volume="0.5" 
    data-theme="#1da496" 
    data-preload="auto"
    >
  </div>

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
