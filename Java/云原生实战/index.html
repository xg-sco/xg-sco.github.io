

<!DOCTYPE html>
<html lang="zh-CN" >



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/smile.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#96c0d3cc">
  <meta name="author" content="肉豆蔻吖">
  <meta name="keywords" content="">
  
    <meta name="description" content="云平台上阿里云购买服务器 , 直接选购按量付费 12345678# 安装nginxyum install nginxsystemctl start nginx# 设置开机自启动systemctl enable nginx# 记得启动完成nginx之后需要在安全组与之对应的端口放开, 否则就无法访问 关闭所有端口 容器化VPC私有网络同一VPC下的网络是互通的, 不同的VPC下的网络不是互通的直接购">
<meta property="og:type" content="article">
<meta property="og:title" content="云原生实战">
<meta property="og:url" content="https://xiamu.icu/Java/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="肉豆蔻吖">
<meta property="og:description" content="云平台上阿里云购买服务器 , 直接选购按量付费 12345678# 安装nginxyum install nginxsystemctl start nginx# 设置开机自启动systemctl enable nginx# 记得启动完成nginx之后需要在安全组与之对应的端口放开, 否则就无法访问 关闭所有端口 容器化VPC私有网络同一VPC下的网络是互通的, 不同的VPC下的网络不是互通的直接购">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xiamu.icu/assets/a5710bfafab847aa88e66a7cfc7d2761.png">
<meta property="og:image" content="https://xiamu.icu/assets/5980f7c1ed5847a5924ccf85f534a2ff.png">
<meta property="og:image" content="https://xiamu.icu/assets/d8f4b5716fa14696a596175ad0bab66d.png">
<meta property="og:image" content="https://xiamu.icu/assets/1556da2698224265af925b6a4b97a731.png">
<meta property="og:image" content="https://xiamu.icu/assets/300432a7daf5406e811a567b17d09c04.png">
<meta property="og:image" content="https://xiamu.icu/assets/9e2e17c607004aed9e4b351ebf9f0dd1.png">
<meta property="og:image" content="https://xiamu.icu/assets/cf9aa19710594e62a729fe863dec6380.png">
<meta property="og:image" content="https://xiamu.icu/assets/77871e7edb6e4aa299773c6fa67d4acc.png">
<meta property="og:image" content="https://xiamu.icu/assets/d525b2b4d4814177bc358049765ffa41.png">
<meta property="og:image" content="https://xiamu.icu/assets/189ceae3b5ab4dd693d26898f9204889.png">
<meta property="og:image" content="https://xiamu.icu/assets/c7541d480f85442c81f62ebfc122845c.png">
<meta property="og:image" content="https://xiamu.icu/assets/a96bbb9709c84ed6abbd5ed26c238233.png">
<meta property="og:image" content="https://xiamu.icu/assets/25797a742c4248e587c51afda9d17cd1.png">
<meta property="og:image" content="https://xiamu.icu/assets/b9019914051a494380912d606729a4aa.png">
<meta property="og:image" content="https://xiamu.icu/assets/4e2aaf67b797461e9fea414c3bc1ff40.png">
<meta property="og:image" content="https://xiamu.icu/assets/b96766ad39744f088eed4bd226e4ea48.png">
<meta property="og:image" content="https://xiamu.icu/assets/d881fb26d968469f9b676f1aa31f7831.png">
<meta property="og:image" content="https://xiamu.icu/assets/ad54922c5d284c0a900e6346f472caa9.png">
<meta property="og:image" content="https://xiamu.icu/assets/db52c3e54aeb4e748d27d7db5060ad63.png">
<meta property="og:image" content="https://xiamu.icu/assets/61990623f8c5494a909aee79d0c47ea4.png">
<meta property="og:image" content="https://xiamu.icu/assets/8930fcf66052446891333dc3b2872324.png">
<meta property="og:image" content="https://xiamu.icu/assets/f817227b8ed9434aa12a67d964b65e86.png">
<meta property="og:image" content="https://xiamu.icu/assets/c9283379e2694ec0b2d6f9605682b0ad.png">
<meta property="og:image" content="https://xiamu.icu/assets/243f23a107724730980359bd7e207430.png">
<meta property="og:image" content="https://xiamu.icu/assets/d3d6f73df5954644b8099c1e9ddf907c.png">
<meta property="og:image" content="https://xiamu.icu/assets/87f6ef285fb6419ba37ba7057722594f.png">
<meta property="og:image" content="https://xiamu.icu/assets/e23bdeabf5524882b28231ee251041de.png">
<meta property="og:image" content="https://xiamu.icu/assets/af3a4b5335d0471998076a4aea42289f.png">
<meta property="og:image" content="https://xiamu.icu/assets/934083c7c84f44e8a7f7855810ae2e77.png">
<meta property="og:image" content="https://xiamu.icu/assets/b28a0a4a821042a5a26b5389576f8ebd.png">
<meta property="og:image" content="https://xiamu.icu/assets/ddf429a115ad4845829c394a376b689e.png">
<meta property="og:image" content="https://xiamu.icu/assets/56e6adc7a50646959748dbcf82f285eb.png">
<meta property="og:image" content="https://xiamu.icu/assets/bf49a160de3b4571b3bedce013de3b49.png">
<meta property="og:image" content="https://xiamu.icu/assets/9091c81f795c40709e1c0a19b4547826.png">
<meta property="og:image" content="https://xiamu.icu/assets/636db32f688a48fa9507a42ca6efd3b8.png">
<meta property="og:image" content="https://xiamu.icu/assets/ed038fe4c2f4402e97563b20a40c73c3.png">
<meta property="og:image" content="https://xiamu.icu/assets/98c65a2536854e53873b4f00bffd4838.png">
<meta property="og:image" content="https://xiamu.icu/assets/b6c9eea929b8422190a6cdcc0fe247bb.png">
<meta property="og:image" content="https://xiamu.icu/assets/7bece05b9fcb44ca99f59d42862d69d5.png">
<meta property="og:image" content="https://xiamu.icu/assets/c8292999e3184419950f4940636d1999.png">
<meta property="og:image" content="https://xiamu.icu/assets/ed15bb064c6e46f99efd24ce63bc9e0a.png">
<meta property="og:image" content="https://xiamu.icu/assets/10c6c1bce91446f9bc906a5906d9ff1d.png">
<meta property="og:image" content="https://xiamu.icu/assets/006d4ec02fc34aefb058cae16a826797.png">
<meta property="og:image" content="https://xiamu.icu/assets/938aecd6d7664dffb9b817b505afc6ed.png">
<meta property="og:image" content="https://xiamu.icu/assets/153cdf8c2605429eaddedc01c1cbad18.png">
<meta property="og:image" content="https://xiamu.icu/assets/66da06d9b28c42d8874760488a25afd8.png">
<meta property="og:image" content="https://xiamu.icu/assets/09f7b70d90474f0d825a9d2c28642cc0.png">
<meta property="og:image" content="https://xiamu.icu/assets/48cb101e260f488681c0c5c94ca3b152.png">
<meta property="og:image" content="https://xiamu.icu/assets/67ce5e728b6f4dfeba54627fd3c5ae4f.png">
<meta property="og:image" content="https://xiamu.icu/assets/b5704269a0bf44e2af99ea229326f8fc.png">
<meta property="og:image" content="https://xiamu.icu/assets/99ebbb14af89483a99871ab63b75dbb1.png">
<meta property="og:image" content="https://xiamu.icu/assets/e9776f16b5c74c45976f11391ada36c1.png">
<meta property="og:image" content="https://xiamu.icu/assets/016c5f633b53418f9139821d2c223d5b.png">
<meta property="og:image" content="https://xiamu.icu/assets/808f59570d474c11aa4568f8573fe1f3.png">
<meta property="og:image" content="https://xiamu.icu/assets/28acf0befb354679bc6497d2859af399.png">
<meta property="og:image" content="https://xiamu.icu/assets/f28ac29da567457d9ea376de185d8c1c.png">
<meta property="og:image" content="https://xiamu.icu/assets/b791571395df4f828437fd274e41befe.png">
<meta property="og:image" content="https://xiamu.icu/assets/3ba0fd6544b749adbd2040ca98749fc5.png">
<meta property="og:image" content="https://xiamu.icu/assets/8519cf6403674f7b8038a07d70379db6.png">
<meta property="og:image" content="https://xiamu.icu/assets/af1d2fb432984a848b766144d2e4a5a2.png">
<meta property="og:image" content="https://xiamu.icu/assets/056b04c5da2243eea5b5895744f53c57.png">
<meta property="og:image" content="https://xiamu.icu/assets/bb85ecb218c34cf998f53025c25a6e80.png">
<meta property="og:image" content="https://xiamu.icu/assets/fd1f4fd5ef39464d901a7ccaa978b751.png">
<meta property="og:image" content="https://xiamu.icu/assets/d2faa4a2cc9a4d218b0ea6c8af7f8649.png">
<meta property="og:image" content="https://xiamu.icu/assets/3950ed52bdc94e7497ebb76ebbea3bb2.png">
<meta property="og:image" content="https://xiamu.icu/assets/34ad9f4e2cc04f2cbf3f9a256be9bce4.png">
<meta property="og:image" content="https://xiamu.icu/assets/bb35ceca35f149159a4ec50c6e9eb551.png">
<meta property="og:image" content="https://xiamu.icu/assets/563acd2b837d43e4aed2b254b82c5094.png">
<meta property="og:image" content="https://xiamu.icu/assets/d95ad954f0dc41ae91ca1a4c4c357aff.png">
<meta property="og:image" content="https://xiamu.icu/assets/3e429a26baa84bd597329a66608a597a.png">
<meta property="og:image" content="https://xiamu.icu/assets/ed2ad053235a4ba1a11cbccf3aaf8e68.png">
<meta property="og:image" content="https://xiamu.icu/assets/9ff28ccf73e6448fa8b3ce4b24be376e.png">
<meta property="og:image" content="https://xiamu.icu/assets/b4461f2d3bda4b1db208845a5f79a599.png">
<meta property="og:image" content="https://xiamu.icu/assets/d12e1c6342c044f087585da99fc7eb37.png">
<meta property="og:image" content="https://xiamu.icu/assets/a1045c2b2bc94240ac3c37f5464b77b8.png">
<meta property="og:image" content="https://xiamu.icu/assets/79582f0ab47b45d9ae50837b442c9c26.png">
<meta property="og:image" content="https://xiamu.icu/assets/fc27b12239924ec28edfb806f62bf055.png">
<meta property="og:image" content="https://xiamu.icu/assets/ec621cd46b0547ee8ecff557afc8fbf9.png">
<meta property="og:image" content="https://xiamu.icu/assets/c47374866f1044138b5ce1b0d3a10e5e.png">
<meta property="og:image" content="https://xiamu.icu/assets/acc9e368b52a444480c5a0ce00be45a2.png">
<meta property="og:image" content="https://xiamu.icu/assets/7da2ef78ded64f9181c313845b8ccb5b.png">
<meta property="og:image" content="https://xiamu.icu/assets/52e65d42d3234254b25445b264e44e1a.png">
<meta property="og:image" content="https://xiamu.icu/assets/ef1cce12af1f4719993ad617918f21eb.png">
<meta property="og:image" content="https://xiamu.icu/assets/1da8a3780caf4b4b92577d065f2ac65b.png">
<meta property="og:image" content="https://xiamu.icu/assets/8ce7e272686941e0bbec16725a311d2f.png">
<meta property="og:image" content="https://xiamu.icu/assets/c4eff4837711400c8dfd7b7bd269ccd7.png">
<meta property="og:image" content="https://xiamu.icu/assets/6961f1e0cfbc4874a6e0f15d644d13f5.png">
<meta property="og:image" content="https://xiamu.icu/assets/5fbfe14e94cf4da2bd499fedc3eade61.png">
<meta property="og:image" content="https://xiamu.icu/assets/df36c8a02d35469c919fa3fc235cdfbc.png">
<meta property="og:image" content="https://xiamu.icu/assets/fe829d54a833481cbe37a810d0a249e1.png">
<meta property="og:image" content="https://xiamu.icu/assets/31103416f88945a9bf8135a96696b0c1.png">
<meta property="og:image" content="https://xiamu.icu/assets/d3fbb0bab1ef4a73950ec6317ac3e54c.png">
<meta property="og:image" content="https://xiamu.icu/assets/1c998cabfd5344e99225c6da15f22b7e.png">
<meta property="og:image" content="https://xiamu.icu/assets/c360ccc4da60432887e624db3b7c89b9.png">
<meta property="og:image" content="https://xiamu.icu/assets/28f5c4167b40426ca975e373c4ed80c1.png">
<meta property="og:image" content="https://xiamu.icu/assets/d4c30781cbe842ef93f74c80b81b936a.png">
<meta property="og:image" content="https://xiamu.icu/assets/b084a843c85648589ffd520ce24beeac.png">
<meta property="og:image" content="https://xiamu.icu/assets/1bf9925f4cbf4f6a9273ab5117c66bd0.png">
<meta property="og:image" content="https://xiamu.icu/assets/e0a28305b796462e920e2abe138a6412.png">
<meta property="og:image" content="https://xiamu.icu/assets/b0fd367d19154d1d8c805a2a3f711575.png">
<meta property="og:image" content="https://xiamu.icu/assets/996a9a8388e5457d98da1bf29700b6f7.png">
<meta property="og:image" content="https://xiamu.icu/assets/b31ca872afb44b619908bace1e91041a.png">
<meta property="og:image" content="https://xiamu.icu/assets/942282d616fa40fdbae40e74ab30ffba.png">
<meta property="og:image" content="https://xiamu.icu/assets/5858f2532a0648bcaeb9a16c35e2c9f7.png">
<meta property="og:image" content="https://xiamu.icu/assets/6fad754af467464dafec747a1cf86ea4.png">
<meta property="og:image" content="https://xiamu.icu/assets/a78a84c942244508bd96f9166ca3b75a.png">
<meta property="og:image" content="https://xiamu.icu/assets/2f1f303b3d7449a7929fdb21f6d2efd6.png">
<meta property="og:image" content="https://xiamu.icu/assets/9393eef2f8d74ae7a8120a665f3cc9bf.png">
<meta property="og:image" content="https://xiamu.icu/assets/b1582595da2e47c2a7b934c8642cbb10.png">
<meta property="og:image" content="https://xiamu.icu/assets/3f6ae8588faa4e699ea11f9700c85f31.png">
<meta property="og:image" content="https://xiamu.icu/assets/811912cb7c544a22bfd955fbdd3edeab.png">
<meta property="og:image" content="https://xiamu.icu/assets/8e9c755cad1f4482bfac20c8332e1d5b.png">
<meta property="og:image" content="https://xiamu.icu/assets/e6a1fb9d5040432cb40811e3e84718a3.png">
<meta property="og:image" content="https://xiamu.icu/assets/47357ad04a994ffdbb3ae75d620c35cd.png">
<meta property="og:image" content="https://xiamu.icu/assets/2b85a7a8354d433e915e69d262f2a2be.png">
<meta property="og:image" content="https://xiamu.icu/assets/578be5e4ffcb45b582fae57d0ab98f1e.png">
<meta property="og:image" content="https://xiamu.icu/assets/2c3f6a1a0c3d48db9ae2bab8c38c2282.png">
<meta property="og:image" content="https://xiamu.icu/assets/69efe8fdc10f45348dd272815b78cc97.png">
<meta property="og:image" content="https://xiamu.icu/assets/3df9ca1abde04999b088683b2fbcd9f2.png">
<meta property="og:image" content="https://xiamu.icu/assets/9c1af19e318b4eb0a9d9a4b519a2024a.png">
<meta property="og:image" content="https://xiamu.icu/assets/15c3fd44f42e46d2add818b12966e81d.png">
<meta property="og:image" content="https://xiamu.icu/assets/51681a418f714dca95dbbc0b2b2ee4f3.png">
<meta property="og:image" content="https://xiamu.icu/assets/8f18ab52ca5143f2bdbb556ea9309892.png">
<meta property="og:image" content="https://xiamu.icu/assets/32b00db2e40a42a6ab62aee7901f6d82.png">
<meta property="og:image" content="https://xiamu.icu/assets/9f7d68f279c74a13bcff9a35ad94770b.png">
<meta property="og:image" content="https://xiamu.icu/assets/053ebdc0a90549f4ac70e6a050d0e6e2.png">
<meta property="og:image" content="https://xiamu.icu/assets/f1593d5b62094a3cb44ad62a51fe9110.png">
<meta property="og:image" content="https://xiamu.icu/assets/4e5e9d0e9f17488f811731d0e047e7d3.png">
<meta property="og:image" content="https://xiamu.icu/assets/498f4a5b397548cab68deb455f919479.png">
<meta property="og:image" content="https://xiamu.icu/assets/d880c885efb844e58c85ea218d7271b8.png">
<meta property="og:image" content="https://xiamu.icu/assets/607296241747478780648166d59278c2.png">
<meta property="og:image" content="https://xiamu.icu/assets/69d779f7bbb34c1a879d59caeb1e3039.png">
<meta property="og:image" content="https://xiamu.icu/assets/eb39e3009d8d48a499637463c1dd35fd.png">
<meta property="og:image" content="https://xiamu.icu/assets/b9c5eb2de9cb437da61f5e794f834147.png">
<meta property="og:image" content="https://xiamu.icu/assets/9af0d5b5eaf245a98d30ce773b187ef3.png">
<meta property="og:image" content="https://xiamu.icu/assets/fa8d3943270f4dc68461ff35f5e06323.png">
<meta property="og:image" content="https://xiamu.icu/assets/0d49ed6fdcce4a07951adc357266522d.png">
<meta property="og:image" content="https://xiamu.icu/assets/75ab9752f90749c3a51f0567b3bc9bb3.png">
<meta property="og:image" content="https://xiamu.icu/assets/21124ee1fc9e4d6890e82704df4d000e.png">
<meta property="og:image" content="https://xiamu.icu/assets/203ee718c32146aaaf35e41533614960.png">
<meta property="og:image" content="https://xiamu.icu/assets/e0306470871f44808b91b641b2d70f82.png">
<meta property="og:image" content="https://xiamu.icu/assets/d9255f973fce46278b522642d7f18cd6.png">
<meta property="og:image" content="https://xiamu.icu/assets/3589fc4471b3421b938d67f23495a7a7.png">
<meta property="og:image" content="https://xiamu.icu/assets/55fc21866d7d44859d779a67cd7a8a61.png">
<meta property="og:image" content="https://xiamu.icu/assets/b74d2980a74f47e28a8b7c4b5d2241b7.png">
<meta property="og:image" content="https://xiamu.icu/assets/c50d684604594bcd83dfbe9aa8678806.png">
<meta property="og:image" content="https://xiamu.icu/assets/cce1190d13974a10a48fb58d21277aa8.png">
<meta property="og:image" content="https://xiamu.icu/assets/f2ad1160e3b243d5a103c1d8e46b0da6.png">
<meta property="og:image" content="https://xiamu.icu/assets/75980db468834d0e8feeef1371701bfc.png">
<meta property="og:image" content="https://xiamu.icu/assets/9212c38999dc45fc81c9f590a60bfbda.png">
<meta property="og:image" content="https://xiamu.icu/assets/84ec430242104064b5e616ec6c8ba3cf.png">
<meta property="og:image" content="https://xiamu.icu/assets/f34d8c562ca04ebab6818025dc2a7060.png">
<meta property="og:image" content="https://xiamu.icu/assets/9e7c789754ce4cdea583dc5d05503d6a.png">
<meta property="og:image" content="https://xiamu.icu/assets/17f9b93e8f8541f496f5d7a2894fca8e.png">
<meta property="og:image" content="https://xiamu.icu/assets/314fa6623b864ea092dd42328fee8a82.png">
<meta property="og:image" content="https://xiamu.icu/assets/8538dc7ffef441fa933c3603f83d854a.png">
<meta property="og:image" content="https://xiamu.icu/assets/339c0852a95c49d6bf97837219b1c20a.png">
<meta property="og:image" content="https://xiamu.icu/assets/546c1ec826034064a25dd46291f970a3.png">
<meta property="og:image" content="https://xiamu.icu/assets/ad1f8b1ea763437d89ba33d30fac54cf.png">
<meta property="og:image" content="https://xiamu.icu/assets/d3853720f991421f9b4ea248952f0abb.png">
<meta property="og:image" content="https://xiamu.icu/assets/b25f0363815c4347bac8e5febd9bdd29.png">
<meta property="og:image" content="https://xiamu.icu/assets/ae69de0f32214b21bc1c0f5faf2fb58c.png">
<meta property="og:image" content="https://xiamu.icu/assets/f2905a14e94a4e499e8c04d9fe542d8d.png">
<meta property="og:image" content="https://xiamu.icu/assets/7decef743511431c8bc74284c037369d.png">
<meta property="og:image" content="https://xiamu.icu/assets/aa5c24e382fe4cc0892d94dadb554125.png">
<meta property="og:image" content="https://xiamu.icu/assets/91abb48b7c104c398502927a1702e6d6.png">
<meta property="og:image" content="https://xiamu.icu/assets/ab2474a03f034641ae07054e91e8b808.png">
<meta property="og:image" content="https://xiamu.icu/assets/34aba25030984df0b7b0ad2dc4c4f2bd.png">
<meta property="og:image" content="https://xiamu.icu/assets/0f54ef6cee35412c98a75fc5a3f08f23.png">
<meta property="og:image" content="https://xiamu.icu/assets/4db3c1db360542f0bb5c1b10d4b6f590.png">
<meta property="og:image" content="https://xiamu.icu/assets/2bfea46694ae4b4abe17511837c889e4.png">
<meta property="og:image" content="https://xiamu.icu/assets/6411be14f95049fd818bbe45a845d87d.png">
<meta property="og:image" content="https://xiamu.icu/assets/2befa30176b744b8b6f878dd748adad3.png">
<meta property="og:image" content="https://xiamu.icu/assets/3c7b00d58ace4040a0fa0aa690c1213c.png">
<meta property="og:image" content="https://xiamu.icu/assets/d7b24a728ae94bbeae64932e2e9913ca.png">
<meta property="og:image" content="https://xiamu.icu/assets/45b01961c9944443a8fa1a573740e95f.png">
<meta property="og:image" content="https://xiamu.icu/assets/c29d7276428844939b72ba4e9e4ed44a.png">
<meta property="og:image" content="https://xiamu.icu/assets/ea14837b92bd4887860c3323cc144d47.png">
<meta property="og:image" content="https://xiamu.icu/assets/1ec2268024c34f3397da800d7126918d.png">
<meta property="og:image" content="https://xiamu.icu/assets/57afae57a3924d0ea083b175701a161f.png">
<meta property="og:image" content="https://xiamu.icu/assets/947a5310c9bb4c81b7e319d9e3b5e61f.png">
<meta property="og:image" content="https://xiamu.icu/assets/c9a3ae855b624c8383fd50083a3f03b5.png">
<meta property="og:image" content="https://xiamu.icu/assets/756acb5acffa4c2a9660d570e2d913fc.png">
<meta property="og:image" content="https://xiamu.icu/assets/053c8267d15d4799bfe39ea82c51eece.png">
<meta property="og:image" content="https://xiamu.icu/assets/263c2dd032524bd0aed491969cbd36ef.png">
<meta property="og:image" content="https://xiamu.icu/assets/c8ab361ad21c4e8a8fd2047541ebdea4.png">
<meta property="og:image" content="https://xiamu.icu/assets/6b02f0a23df247fc8838ddbdb3c2a51b.png">
<meta property="og:image" content="https://xiamu.icu/assets/a57119cde9c0476791462e4f9b2c3871.png">
<meta property="og:image" content="https://xiamu.icu/assets/943c557cdfc6445d934c48927fc2ac03.png">
<meta property="og:image" content="https://xiamu.icu/assets/30fe8dda75d94bd9897bedf3d3c10459.png">
<meta property="og:image" content="https://xiamu.icu/assets/606b918e1e2e42bea38343be12598965.png">
<meta property="og:image" content="https://xiamu.icu/assets/52f48a32e84b4c029f0f0294188e86aa.png">
<meta property="og:image" content="https://xiamu.icu/assets/b69f24a0164c4abc8fb627069f819226.png">
<meta property="og:image" content="https://xiamu.icu/assets/d354224e66bf4d869dc1586cac52d7f6.png">
<meta property="og:image" content="https://xiamu.icu/assets/d3730340e19648fcae8c273a94a9693c.png">
<meta property="og:image" content="https://xiamu.icu/assets/1477f7b9ec1d4e5093557fb189bf6b11.png">
<meta property="og:image" content="https://xiamu.icu/assets/f7e5227d150542cf8ee44a793203a07a.png">
<meta property="og:image" content="https://xiamu.icu/assets/aa96f69e44ab438c935b85c2345aef16.png">
<meta property="og:image" content="https://xiamu.icu/assets/d3ebcc01095e4f148d643d2318d16824.png">
<meta property="og:image" content="https://xiamu.icu/assets/ceab447d42fd4a3e8891705451d4c4c2.png">
<meta property="og:image" content="https://xiamu.icu/assets/836b570dbb4c4f37b1a470f0ed4251d1.png">
<meta property="og:image" content="https://xiamu.icu/assets/03abc3572ee84a34ba741c62e0b74778.png">
<meta property="og:image" content="https://xiamu.icu/assets/bdc5cedde28e465bb295245e85965b32.png">
<meta property="og:image" content="https://xiamu.icu/assets/98cd720cf9484f5f81ca52d073b52d69.png">
<meta property="og:image" content="https://xiamu.icu/assets/628ad1e77d7f499b8ef3ae2bb3bb0c31.png">
<meta property="og:image" content="https://xiamu.icu/assets/ac027d7d95fa46d0852a80aa056e963d.png">
<meta property="og:image" content="https://xiamu.icu/assets/b0256bec2953407ab5f9078d6b4ae0ee.png">
<meta property="og:image" content="https://xiamu.icu/assets/777dc402be4943c9aba7ad9e597d265f.png">
<meta property="og:image" content="https://xiamu.icu/assets/f08b4eae414d4632a66a4219db3b1e49.png">
<meta property="og:image" content="https://xiamu.icu/assets/c64e84fcb02b4879ba7f4ace7d0e5f8a.png">
<meta property="og:image" content="https://xiamu.icu/assets/d1e245379a5a4f19bea1ef8b579f1454.png">
<meta property="og:image" content="https://xiamu.icu/assets/fb387906e6144d4bac1b25ad602b1dfb.png">
<meta property="og:image" content="https://xiamu.icu/assets/f2ebb7dfa2d04964a603ec6ab42f7ca8.png">
<meta property="og:image" content="https://xiamu.icu/assets/729d9b95246146ed8c4e47455a216221.png">
<meta property="og:image" content="https://xiamu.icu/assets/cd8103e42c2d4b489b34e41911dd51f7.png">
<meta property="og:image" content="https://xiamu.icu/assets/ec77dac191d64dbe926e078bbd547fac.png">
<meta property="og:image" content="https://xiamu.icu/assets/1f34cfd3fc144104afd9d96a3e5020b4.png">
<meta property="og:image" content="https://xiamu.icu/assets/034dcadb085e427daf4c257f1a8ee3cb.png">
<meta property="og:image" content="https://xiamu.icu/assets/95a9d17a80ef472ba02b3f923b8d8b1f.png">
<meta property="og:image" content="https://xiamu.icu/assets/6aa784e255284153b0e6a58044e4de52.png">
<meta property="og:image" content="https://xiamu.icu/assets/e63643e26756429fb7e2845f6ea99ce7.png">
<meta property="og:image" content="https://xiamu.icu/assets/670ad33ff22e4028b9bcb8830eb40790.png">
<meta property="og:image" content="https://xiamu.icu/assets/c5c042a4ec28486c86175e6c65ab1883.png">
<meta property="og:image" content="https://xiamu.icu/assets/d05600e4402745a5a188c13244fd9650.png">
<meta property="og:image" content="https://xiamu.icu/assets/60b2423747a34b1bae446eaa159cddaf.png">
<meta property="og:image" content="https://xiamu.icu/assets/c72b23bf722542a49cc3da03e372c9e3.png">
<meta property="og:image" content="https://xiamu.icu/assets/f2962f2e55e64272b7ae835f6de28b47.png">
<meta property="og:image" content="https://xiamu.icu/assets/d8c3ec0746c241a08654f1def24577eb.png">
<meta property="og:image" content="https://xiamu.icu/assets/48bb9408323243c98c609ac533520f1c.png">
<meta property="og:image" content="https://xiamu.icu/assets/01f355c5616e4f2c9847e8fb9f7f106f.png">
<meta property="og:image" content="https://xiamu.icu/assets/02c089f5f56a455685c1a4f5d434e890.png">
<meta property="og:image" content="https://xiamu.icu/assets/e68f78abf0774188b41a83fa041de7cb.png">
<meta property="og:image" content="https://xiamu.icu/assets/8babec576c824d61b70102e01194063c.png">
<meta property="og:image" content="https://xiamu.icu/assets/9ec95d31610548ea86143dd1c3fbb49d.png">
<meta property="og:image" content="https://xiamu.icu/assets/ca52e50dc834446f99e82f02c53c0c2f.png">
<meta property="og:image" content="https://xiamu.icu/assets/a50d77b662cd467fa3a4a757033f9bda.png">
<meta property="og:image" content="https://xiamu.icu/assets/d3dcae5cd5134b3eba46049e29997112.png">
<meta property="og:image" content="https://xiamu.icu/assets/3bac765128904cd9aa561b421e24e440.png">
<meta property="og:image" content="https://xiamu.icu/assets/8c0f6769b38b45ae91a1fc5be9c1d0a8.png">
<meta property="og:image" content="https://xiamu.icu/assets/303e1bc672df4212ae414bdf2c95d19a.png">
<meta property="og:image" content="https://xiamu.icu/assets/b600de6d8b044f0385871918e59e058f.png">
<meta property="og:image" content="https://xiamu.icu/assets/0d7cfc4a1d214e45aa799a1e899f7651.png">
<meta property="og:image" content="https://xiamu.icu/assets/8932d07cb2c045e6a408bb8fa540abfa.png">
<meta property="og:image" content="https://xiamu.icu/assets/b6d15f88f83d4956af98dc6390e064f0.png">
<meta property="og:image" content="https://xiamu.icu/assets/4de6b45db70e41b2963d099d137680aa.png">
<meta property="og:image" content="https://xiamu.icu/assets/cfd9b8e78845494a8aa8de29894e2530.png">
<meta property="og:image" content="https://xiamu.icu/assets/9bf2903e6b1b4c47bd3c68430addb2f1.png">
<meta property="og:image" content="https://xiamu.icu/assets/ab334bafbcb24e34a15e71d40247025f.png">
<meta property="og:image" content="https://xiamu.icu/assets/070e59d18ad049f1b1ede2e1ef94729f.png">
<meta property="og:image" content="https://xiamu.icu/assets/e0f7533ae6bc42868291fca836305647.png">
<meta property="og:image" content="https://xiamu.icu/assets/e56cb6d667424e43a53b362aaa6dbdd3.png">
<meta property="og:image" content="https://xiamu.icu/assets/b836f0f668424be4b0e2fff34d914d17.png">
<meta property="og:image" content="https://xiamu.icu/assets/89e220fe2a54404a8f6649af2db84cad.png">
<meta property="article:published_time" content="2023-05-07T19:11:22.000Z">
<meta property="article:modified_time" content="2024-12-04T14:19:24.331Z">
<meta property="article:author" content="肉豆蔻吖">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="云原生">
<meta property="article:tag" content="kubenetes">
<meta property="article:tag" content="kubesphere">
<meta property="article:tag" content="Jenkins">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://xiamu.icu/assets/a5710bfafab847aa88e66a7cfc7d2761.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>云原生实战 - 肉豆蔻吖</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xiamu.icu","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>肉豆蔻吖</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="云原生实战"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        肉豆蔻吖
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-05-07 19:11" pubdate>
          2023年5月7日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          127k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1059 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">云原生实战</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="云平台"><a href="#云平台" class="headerlink" title="云平台"></a>云平台</h2><p>上<a target="_blank" rel="noopener" href="https://aliyun.com/">阿里云</a>购买服务器 , 直接选购按量付费</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 安装nginx</span><br>yum install nginx<br>systemctl start nginx<br><br><span class="hljs-comment"># 设置开机自启动</span><br>systemctl <span class="hljs-built_in">enable</span> nginx<br><br><span class="hljs-comment"># 记得启动完成nginx之后需要在安全组与之对应的端口放开, 否则就无法访问</span><br></code></pre></td></tr></table></figure>
<p>关闭所有端口<br><img src="/assets/a5710bfafab847aa88e66a7cfc7d2761.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="容器化"><a href="#容器化" class="headerlink" title="容器化"></a>容器化</h2><h2 id="VPC私有网络"><a href="#VPC私有网络" class="headerlink" title="VPC私有网络"></a>VPC私有网络</h2><p>同一VPC下的网络是互通的, 不同的VPC下的网络不是互通的<br><img src="/assets/5980f7c1ed5847a5924ccf85f534a2ff.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/d8f4b5716fa14696a596175ad0bab66d.png" srcset="/img/loading.gif" lazyload><br>直接购买三台服务器<img src="/assets/1556da2698224265af925b6a4b97a731.png" srcset="/img/loading.gif" lazyload><br>为多台服务器分配私有VPC, 选择刚刚创建的私有网络, 记得要勾选分配IPv4地址<br><img src="/assets/300432a7daf5406e811a567b17d09c04.png" srcset="/img/loading.gif" lazyload></p>
<p>三台服务器的在私网都是互通的<br><img src="/assets/9e2e17c607004aed9e4b351ebf9f0dd1.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/cf9aa19710594e62a729fe863dec6380.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Docker配置"><a href="#Docker配置" class="headerlink" title="Docker配置"></a>Docker配置</h2><p>移除以前的docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo yum remove docker \<br>                  docker-client \<br>                  docker-client-latest \<br>                  docker-common \<br>                  docker-latest \<br>                  docker-latest-logrotate \<br>                  docker-logrotate \<br>                  docker-engine<br></code></pre></td></tr></table></figure>

<p>配置yum源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo yum install -y yum-utils<br>sudo yum-config-manager \<br>--add-repo \<br>http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br></code></pre></td></tr></table></figure>


<p>安装docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo yum install -y docker-ce docker-ce-cli containerd.io<br><br><br><span class="hljs-comment">#以下是在安装k8s的时候使用</span><br>yum install -y docker-ce-20.10.7 docker-ce-cli-20.10.7  containerd.io-1.4.6<br></code></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">enable</span> docker --now<br></code></pre></td></tr></table></figure>

<p>配置<a target="_blank" rel="noopener" href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">阿里云</a>加速器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo <span class="hljs-built_in">mkdir</span> -p /etc/docker<br>sudo <span class="hljs-built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="hljs-string">&#x27;EOF&#x27;</span><br>&#123;<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://ylmjgfp5.mirror.aliyuncs.com&quot;</span>]<br>&#125;<br>EOF<br>sudo systemctl daemon-reload<br>sudo systemctl restart docker<br></code></pre></td></tr></table></figure>

<h2 id="搭建Kubernetes集群"><a href="#搭建Kubernetes集群" class="headerlink" title="搭建Kubernetes集群"></a>搭建Kubernetes集群</h2><p>创建一个VPC私有网络<br><img src="/assets/77871e7edb6e4aa299773c6fa67d4acc.png" srcset="/img/loading.gif" lazyload><br>创建交换机<br><img src="/assets/d525b2b4d4814177bc358049765ffa41.png" srcset="/img/loading.gif" lazyload><br>12345Xia<br>创建三台服务器实例<br><img src="/assets/189ceae3b5ab4dd693d26898f9204889.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h3><p>基础环境, 每一台机器都要执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 各个机器设置自己的域名</span><br>hostnamectl set-hostname k8s-node1<br>hostnamectl set-hostname k8s-node2<br>hostnamectl set-hostname k8s-master<br><br><span class="hljs-comment"># 将 SELinux 设置为 permissive 模式（相当于将其禁用）</span><br>sudo setenforce 0<br>sudo sed -i <span class="hljs-string">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> /etc/selinux/config<br><br><span class="hljs-comment">#关闭swap</span><br>swapoff -a  <br>sed -ri <span class="hljs-string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab<br><br><span class="hljs-comment">#允许 iptables 检查桥接流量</span><br><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class="hljs-string">br_netfilter</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class="hljs-string">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="hljs-string">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="hljs-string">EOF</span><br>sudo sysctl --system<br></code></pre></td></tr></table></figure>
<h3 id="安装kubelet、kubeadm、kubectl"><a href="#安装kubelet、kubeadm、kubectl" class="headerlink" title="安装kubelet、kubeadm、kubectl"></a>安装kubelet、kubeadm、kubectl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class="hljs-string">[kubernetes]</span><br><span class="hljs-string">name=Kubernetes</span><br><span class="hljs-string">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="hljs-string">enabled=1</span><br><span class="hljs-string">gpgcheck=0</span><br><span class="hljs-string">repo_gpgcheck=0</span><br><span class="hljs-string">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="hljs-string">   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="hljs-string">exclude=kubelet kubeadm kubectl</span><br><span class="hljs-string">EOF</span><br><br><br>sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes<br><br>sudo systemctl <span class="hljs-built_in">enable</span> --now kubelet<br></code></pre></td></tr></table></figure>
<blockquote>
<p>kubelet 现在每隔几秒就会重启，因为它陷入了一个等待 kubeadm 指令的死循环</p>
</blockquote>
<p>使用<code>systemctl status kubelet</code>查看状态, 一会重启, 一起启动<br><img src="/assets/c7541d480f85442c81f62ebfc122845c.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="初始化主节点"><a href="#初始化主节点" class="headerlink" title="初始化主节点"></a>初始化主节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#所有机器添加master域名映射，以下需要修改为自己的</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;172.31.0.204  cluster-endpoint&quot;</span> &gt;&gt; /etc/hosts<br><br><br><br><span class="hljs-comment">#主节点初始化(只要主节点输入这段命令, 其他节点不需要输入)</span><br>kubeadm init \<br>--apiserver-advertise-address=172.31.0.204 \<br>--control-plane-endpoint=cluster-endpoint \<br>--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \<br>--kubernetes-version v1.20.9 \<br>--service-cidr=10.96.0.0/16 \<br>--pod-network-cidr=192.168.0.0/16<br><br><span class="hljs-comment">#所有网络范围不重叠</span><br></code></pre></td></tr></table></figure>

<p>下载完成之后主节点会出现如下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">Your Kubernetes control-plane has initialized successfully!<br><br>To start using your cluster, you need to run the following as a regular user:<br><br>  <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>  sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>  sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br><br>Alternatively, <span class="hljs-keyword">if</span> you are the root user, you can run:<br><br>  <span class="hljs-built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf<br><br>You should now deploy a pod network to the cluster.<br>Run <span class="hljs-string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:<br>  https://kubernetes.io/docs/concepts/cluster-administration/addons/<br><br>You can now <span class="hljs-built_in">join</span> any number of control-plane nodes by copying certificate authorities<br>and service account keys on each node and <span class="hljs-keyword">then</span> running the following as root:<br><br>  kubeadm <span class="hljs-built_in">join</span> cluster-endpoint:6443 --token 1zh4aw.zsett7epmg4ka8g6 \<br>    --discovery-token-ca-cert-hash sha256:ac3d763eeb14a03d137c501f392346773b9a5e36d2b262789aa4c98d1c27dda6 \<br>    --control-plane <br><br>Then you can <span class="hljs-built_in">join</span> any number of worker nodes by running the following on each as root:<br><br>kubeadm <span class="hljs-built_in">join</span> cluster-endpoint:6443 --token 1zh4aw.zsett7epmg4ka8g6 \<br>    --discovery-token-ca-cert-hash sha256:ac3d763eeb14a03d137c501f392346773b9a5e36d2b262789aa4c98d1c27dda6 <br></code></pre></td></tr></table></figure>

<p><img src="/assets/a96bbb9709c84ed6abbd5ed26c238233.png" srcset="/img/loading.gif" lazyload></p>
<p>然后在主节点输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br></code></pre></td></tr></table></figure>

<p>常用命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看集群所有节点</span><br>kubectl get nodes<br><br><span class="hljs-comment">#根据配置文件，给集群创建资源</span><br>kubectl apply -f xxxx.yaml<br><br><span class="hljs-comment">#查看集群部署了哪些应用？</span><br>docker ps   ===   kubectl get pods -A<br><span class="hljs-comment"># 运行中的应用在docker里面叫容器，在k8s里面叫Pod</span><br><span class="hljs-comment"># 查看运行的pod</span><br>kubectl get pods -A<br></code></pre></td></tr></table></figure>

<p>安装网络组件(主节点输入)<br><a target="_blank" rel="noopener" href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/self-managed-onprem/onpremises#install-calico-with-kubernetes-api-datastore-more-than-50-nodes">calico</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl https://docs.projectcalico.org/v3.20/manifests/calico.yaml -O<br><br>kubectl apply -f calico.yaml<br><br><span class="hljs-comment"># 查看运行的pod</span><br>kubectl get pods -A<br></code></pre></td></tr></table></figure>

<p>加入主节点(node1, node2输入)</p>
<blockquote>
<p>这行命令在24小时有效<br>新令牌(可以重新生成最新的令牌)<br>kubeadm token create –print-join-command</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubeadm <span class="hljs-built_in">join</span> cluster-endpoint:6443 --token 1zh4aw.zsett7epmg4ka8g6 \<br>    --discovery-token-ca-cert-hash sha256:ac3d763eeb14a03d137c501f392346773b9a5e36d2b262789aa4c98d1c27dda6 <br></code></pre></td></tr></table></figure>

<p>然后在主节点查看一下所有的节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看一下所有的节点</span><br>kubectl get nodes<br><br><span class="hljs-comment"># 查看一下应用状态</span><br>kubectl get pod -A<br></code></pre></td></tr></table></figure>

<p>补充一个linux命令, 每一秒刷新一次查看应用的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">watch -n 1 kubectl get pod -A<br></code></pre></td></tr></table></figure>

<p>集群的自我修复能力测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 重启云服务器</span><br>reboot<br><br><span class="hljs-comment"># 再次查看状态</span><br>kubectl get pod -A<br></code></pre></td></tr></table></figure>
<p><img src="/assets/25797a742c4248e587c51afda9d17cd1.png" srcset="/img/loading.gif" lazyload></p>
<p>部署dashboard</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml<br></code></pre></td></tr></table></figure>
<p>设置访问端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard<br></code></pre></td></tr></table></figure>
<p>将 type: ClusterIP 改为 type: NodePort</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get svc -A |grep kubernetes-dashboard<br><span class="hljs-comment">## 找到端口，在安全组放行</span><br></code></pre></td></tr></table></figure>
<p><img src="/assets/b9019914051a494380912d606729a4aa.png" srcset="/img/loading.gif" lazyload><br>需要在安全组中放行30077端口<br><img src="/assets/4e2aaf67b797461e9fea414c3bc1ff40.png" srcset="/img/loading.gif" lazyload><br>访问： https:&#x2F;&#x2F;集群任意IP:端口      <a target="_blank" rel="noopener" href="https://47.106.11.25:30077/">https://47.106.11.25:30077</a></p>
<p>如果chrome出现了<strong>你的连接不是专用连接</strong><br>可以在页面输入<code>thisisunsafe</code><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/sdfsdfasfddsafwesd/article/details/109379788">你的连接不是专用连接的解决办法</a></p>
<p>创建访问账号</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#创建访问账号，准备一个yaml文件； vi dash.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">admin-user</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">admin-user</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cluster-admin</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">admin-user</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f dash.yaml<br></code></pre></td></tr></table></figure>

<p>获取令牌</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#获取访问令牌</span><br>kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath=<span class="hljs-string">&quot;&#123;.secrets[0].name&#125;&quot;</span>) -o go-template=<span class="hljs-string">&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</span><br></code></pre></td></tr></table></figure>
<p>token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">eyJhbGciOiJSUzI1NiIsImtpZCI6IjVTb0ItUllsSEU5cjZkbXg0RlVEMmlnQnRHRzJLcHRDOFBXVi1yX3VxZEkifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWpocnd6Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiIxNDc0YTFlZS03NGE5LTRjZWUtOWZjNS1lNjU2Y2I0ZmE4NjYiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.cIVZrURSJXK9iTy9CM5lH5PbyqOihS1w61sgqiIF0bAfjpNrqBqlbniZXKWKcbtwEjiK5OVI7XWWgKgW7sCMkEVU_vpbOqwu62JuhLJDAXE1KBKruz-UW4PfTzYENCCTfdCozngLBok0VTEsyB9GRH_V3n1mhBKpsc3Ya0wstXH2u9nyDx4nOZkmy9PrWZXY9WIVFlN9OQ-1BouW_RtFE69sMxAcL2p2wpW-qlr76kgNOUD8oghS1BkAETKkRlChQEZKuWYlORpvy56JphZXIrGYPIVOfl0FALxb7baLkiahYS5UiZNvTMvmO0ii6OaSpZXY_blwMvBubU5B3s_g0A<br></code></pre></td></tr></table></figure>

<p>dashboard<br><img src="/assets/b96766ad39744f088eed4bd226e4ea48.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="云原生实战"><a href="#云原生实战" class="headerlink" title="云原生实战"></a>云原生实战</h2><h3 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h3><p>使用命令创建命名空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看命名空间</span><br>kubectl get ns<br>kubectl get namespace<br><br><span class="hljs-comment"># 查看所有应用</span><br>kubectl get pods -A<br><span class="hljs-comment"># 这个查看的是default的应用</span><br>kubectl get pods<br><br><span class="hljs-comment"># 查看pod</span><br>kubectl get pod -n kubernetes-dashboard<br><br><span class="hljs-comment"># 创建命名空间</span><br>kubectl create ns hello<br>kubectl get ns<br><br><span class="hljs-comment"># 删除命名空间</span><br>kubectl delete ns hello<br><br></code></pre></td></tr></table></figure>

<p>使用yaml的方式创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 通过yaml的方式创建命名空间</span><br>vi hello.yaml<br><br>apiVersion: v1<br>kind: Namespace<br>metadata:<br>  name: hello<br><br>kubectl apply -f hello.yaml<br><br><span class="hljs-comment"># 删除yaml方式创建的命名空间</span><br>kubectl delete -f hello.yaml <br></code></pre></td></tr></table></figure>
<h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p>在kubernetes中运行的应用就叫pod<br>一个pod中可以运行多个容器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建nginx的pod</span><br>kubectl run mynginx --image=nginx<br><br><span class="hljs-comment"># 查看default的pod</span><br>kubectl get pod<br><br><span class="hljs-comment"># 查看所有的pod</span><br>kubectl get pod -A<br><br><span class="hljs-comment"># 也可以指定查看default的pod, 不指定默认查看的就是default</span><br>kubectl get pod -n default<br><br><span class="hljs-comment"># 描述mynginx的详细信息</span><br>kubectl describe pod mynginx<br><br>Events:<br>  Type    Reason     Age    From               Message<br>  ----    ------     ----   ----               -------<br>  Normal  Scheduled  7m29s  default-scheduler  Successfully assigned default/mynginx to k8s-node2<br>  Normal  Pulling    7m28s  kubelet            Pulling image <span class="hljs-string">&quot;nginx&quot;</span><br>  Normal  Pulled     7m20s  kubelet            Successfully pulled image <span class="hljs-string">&quot;nginx&quot;</span> <span class="hljs-keyword">in</span> 8.585906172s<br>  Normal  Created    7m19s  kubelet            Created container mynginx<br>  Normal  Started    7m19s  kubelet            Started container mynginx<br><span class="hljs-comment"># 这里Scheduled说明了nginx创建在了k8s-node2</span><br><br><span class="hljs-comment"># STATUS显示Running表示创建的应用正在运行了</span><br>[root@k8s-master ~]<span class="hljs-comment"># kubectl get pod </span><br>NAME      READY   STATUS    RESTARTS   AGE<br>mynginx   1/1     Running   0          3m47s<br><br><span class="hljs-comment"># 到k8s-node2上查看nginx容器</span><br>docker ps | grep mynginx<br><br><span class="hljs-comment"># 删除pod</span><br>kubectl delete pod mynginx<br><span class="hljs-comment"># 完整的写法可以指定命名空间</span><br>kubectl delete pod mynginx -n xxx<br><br><span class="hljs-comment"># 查看日志</span><br>kubectl logs mynginx<br><span class="hljs-comment"># 持续监控日志</span><br>kubectl logs -f mynginx<br><br><span class="hljs-comment"># 查看更完善的信息, 可以查看应用运行的IP</span><br><span class="hljs-comment"># 每一个pod - k8s都会分配一个ip</span><br>kubectl get pod -owide<br>kubectl get pod -o wide<br>NAME      READY   STATUS    RESTARTS   AGE     IP                NODE        NOMINATED NODE   READINESS GATES<br>mynginx   1/1     Running   0          3m38s   192.168.169.133   k8s-node2   &lt;none&gt;           &lt;none&gt;<br><br><span class="hljs-comment"># 使用pod的ip+pod里面运行容器的端口</span><br><span class="hljs-comment"># 请求一下IP(任何一个k8s都可以请求)</span><br>curl 192.168.169.133 <br><br><span class="hljs-comment"># 进入容器</span><br>kubectl <span class="hljs-built_in">exec</span> -it mynginx -- /bin/bash<br><br><span class="hljs-comment"># 随便改点啥</span><br><span class="hljs-built_in">cd</span> /usr/share/nginx/html/<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;roudoukouya&quot;</span> &gt; index.html <br><span class="hljs-built_in">exit</span><br>[root@k8s-master ~]<span class="hljs-comment"># curl 192.168.169.133</span><br>roudoukouya<br></code></pre></td></tr></table></figure>

<p>使用yaml方式创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi pod.yaml<br><br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  labels:<br>    run: mynginx<br>  name: mynginx<br>spec:<br>  containers:<br>  - image: nginx<br>    name: mynginx<br><br><span class="hljs-comment"># 创建</span><br>kubectl apply -f pod.yaml<br><br><span class="hljs-comment"># 描述, 这次容器还是创建在了node2上</span><br>kubectl describe pod mynginx<br> Normal  Scheduled  72s   default-scheduler  Successfully assigned default/mynginx to k8s-node2<br><br><span class="hljs-comment"># 删除yaml</span><br>kubectl delete -f pod.yaml <br><br><span class="hljs-comment"># 再次查看一下</span><br>kubectl get pod<br><br></code></pre></td></tr></table></figure>

<p>web页面创建pod<br><img src="/assets/d881fb26d968469f9b676f1aa31f7831.png" srcset="/img/loading.gif" lazyload><br>填写yaml创建, 点击上传<br><img src="/assets/ad54922c5d284c0a900e6346f472caa9.png" srcset="/img/loading.gif" lazyload></p>
<p>多个容器的情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi multicontainer-pod.yaml<br><br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  labels:<br>    run: myapp<br>  name: myapp<br>spec:<br>  containers:<br>  - image: nginx<br>    name: nginx<br>  - image: tomcat:8.5.68<br>    name: tomcat<br><br><span class="hljs-comment"># 创建</span><br>kubectl apply -f multicontainer-pod.yaml <br><br><span class="hljs-comment"># 描述详细信息</span><br>kubectl describe pod myapp<br><br><span class="hljs-comment"># 查看容器分配的IP</span><br>kubectl get pod -o wide<br>curl 192.168.36.67:80<br>curl 192.168.36.67:8080<br><br><span class="hljs-comment"># 尝试创建两个nginx在同一个pod中</span><br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  labels:<br>    run: myapp02<br>  name: myapp02<br>spec:<br>  containers:<br>  - image: nginx<br>    name: nginx01<br>  - image: nginx<br>    name: nginx02<br><br><span class="hljs-comment"># 查看pod, 显示error, 并且没有同时启动两个nginx</span><br>kubectl get pod<br>myapp02   1/2     Error     1          52s<br><br><span class="hljs-comment"># 查看日志, 很明显nginx02的要启动的端口被占用了, 所有nginx02启动不起来</span><br>kubectl logs myapp02 nginx01<br>kubectl logs myapp02 nginx02<br>(98: Address already <span class="hljs-keyword">in</span> use)<br></code></pre></td></tr></table></figure>

<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 先删除之前创建的pod</span><br>kubectl delete pod myapp myapp02 mynginx<br><br><span class="hljs-comment"># 创建nginx pod</span><br>kubectl run mynginx  --image=nginx<br><br>kubectl create deployment mytomcat --image=tomcat:8.5.68<br><br><span class="hljs-comment"># 监控pod</span><br>watch -n 1 kubectl get pod<br><br><span class="hljs-comment"># 删除刚刚创建的两个应用</span><br>kubectl delete pod mynginx<br>kubectl delete pod mytomcat-6f5f895f4f-6m68l<br>kubectl delete pod mytomcat-6f5f895f4f-bprxz<br><br><span class="hljs-comment"># 可以发现每一次删除tomcat, k8s都会再次创建出来一个新的应用</span><br><span class="hljs-comment"># k8s的自愈能力</span><br><br><span class="hljs-comment"># 删除由deployment创建的应用</span><br>kubectl get deploy<br>kubectl delete deploy mytomcat<br>kubectl delete deployment my-dep-01<br></code></pre></td></tr></table></figure>

<p>多副本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建多副本的应用, replicas指定副本的数量</span><br><span class="hljs-comment"># 这样可以创建多个应用, 平均分配在各个机器上</span><br>kubectl create deploy my-dep --image=nginx --replicas=3<br><br><span class="hljs-comment"># 查看完善信息</span><br>kubectl get pod -o wide<br></code></pre></td></tr></table></figure>
<p>使用web表单创建多副本<br><img src="/assets/db52c3e54aeb4e748d27d7db5060ad63.png" srcset="/img/loading.gif" lazyload><br>也可以在web页面使用yaml创建</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-dep</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-dep</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">my-dep</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">my-dep</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br></code></pre></td></tr></table></figure>
<p><img src="/assets/61990623f8c5494a909aee79d0c47ea4.png" srcset="/img/loading.gif" lazyload></p>
<p>扩缩容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建</span><br>kubectl create deploy my-dep --image=nginx --replicas=3<br><br><span class="hljs-comment"># 扩缩容</span><br>kubectl scale deploy/my-dep --replicas=5<br>kubectl scale deploy/my-dep --replicas=2<br><br><span class="hljs-comment"># 监控</span><br>watch -n 1 kubectl get pod<br><br><span class="hljs-comment"># 获取deploy</span><br>kubectl get deploy<br>kubectl get deployment<br><br><span class="hljs-comment"># 修改yaml的方式来修改replicas副本数量</span><br>kubectl edit deploy my-dep<br><br>spec:<br>  progressDeadlineSeconds: 600<br>  replicas: 2<br><br><span class="hljs-comment"># 保存退出</span><br>:wq<br><br></code></pre></td></tr></table></figure>
<p><img src="/assets/8930fcf66052446891333dc3b2872324.png" srcset="/img/loading.gif" lazyload></p>
<p>自愈&amp;故障转移</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># master节点</span><br>kubectl get pod -o wide<br>my-dep-5b7868d854-8dbvz  k8s-node1 ...<br><br><span class="hljs-comment"># 在node1查看</span><br>docker ps | grep my-dep-5b7868d854-8dbvz<br>66ba6931e335   nginx ...<br><br><span class="hljs-comment"># 停止这个容器</span><br>docker stop 66ba6931e335<br><span class="hljs-comment"># 可以发现, 虽然停止了容器, 但是过了一会, 容器就自愈又重启了</span><br><br><span class="hljs-comment"># 监控</span><br>kubectl get pod -w<br><br><span class="hljs-comment"># 然后将node1节点给关机, 五分钟之后就可以监控到会把node1中应用转移到了node2</span><br></code></pre></td></tr></table></figure>

<p>滚动更新</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 把yaml文件展示出来</span><br>kubectl get deploy my-dep -oyaml<br><br><span class="hljs-comment"># 监控</span><br>kubectl get pod -w<br><br><span class="hljs-comment"># 自动更新, 将会启动一个新的版本的容器, 然后停止旧版本的容器</span><br>kubectl <span class="hljs-built_in">set</span> image deploy/my-dep nginx=nginx:1.16.1 --record<br><br><span class="hljs-comment"># 再次查看yaml, nginx镜像被替换成了指定的版本</span><br>kubectl get deploy my-dep -oyaml<br>    spec:<br>      containers:<br>      - image: nginx:1.16.1<br></code></pre></td></tr></table></figure>

<p>版本回退</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看历史版本</span><br>kubectl rollout <span class="hljs-built_in">history</span> deployment/my-dep<br><br>REVISION  CHANGE-CAUSE<br>1         &lt;none&gt;<br>2         kubectl <span class="hljs-built_in">set</span> image deploy/my-dep nginx=nginx:1.16.1 --record=<span class="hljs-literal">true</span><br><br><span class="hljs-comment"># 回退到第一个版本</span><br>kubectl rollout undo deploy/my-dep --to-revision=1<br><br><span class="hljs-comment"># 查看当前nginx的版本, 此时是最新的nginx版本</span><br>kubectl get deploy/my-dep -oyaml | grep image<br><br>                f:imagePullPolicy: &#123;&#125;<br>                f:image: &#123;&#125;<br>      - image: nginx<br>        imagePullPolicy: Always<br><br><br></code></pre></td></tr></table></figure>
<p>工作负载<br><img src="/assets/f817227b8ed9434aa12a67d964b65e86.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>ClusterIP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看容器的详细信息</span><br>kubectl get pod -owide<br><br><span class="hljs-comment"># 访问IP, 可以通过不同的IP访问到不同的nginx</span><br>[root@k8s-master ~]<span class="hljs-comment"># curl 192.168.36.95</span><br>3333<br>[root@k8s-master ~]<span class="hljs-comment"># curl 192.168.169.153</span><br>1111<br>[root@k8s-master ~]<span class="hljs-comment"># curl 192.168.36.94</span><br>2222<br><br><span class="hljs-comment"># 将应用内的nginx的80端口暴露出去到8000端口</span><br>kubectl expose deploy my-dep --port=8000 --target-port=80<br><br><span class="hljs-comment"># 查看一下CLUSTER-IP</span><br>kubectl get service<br><br><span class="hljs-comment"># 集群内访问CLUSTER-IP, 这个service会负载均衡将请求分配</span><br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>1111<br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>3333<br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>2222<br><br><span class="hljs-comment"># 同样的在容器内部也是也可以请求service IP的</span><br>root@my-dep-5b7868d854-74qft:/usr/share/nginx/html<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>3333<br>root@my-dep-5b7868d854-74qft:/usr/share/nginx/html<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>2222<br>root@my-dep-5b7868d854-74qft:/usr/share/nginx/html<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>1111<br><br><span class="hljs-comment"># 在容器内部也可以通过域名来访问(域名的格式是 服务名.命名空间.svc)</span><br>root@my-dep-5b7868d854-74qft:/usr/share/nginx/html<span class="hljs-comment"># curl my-dep.default.svc:8000</span><br>3333<br>root@my-dep-5b7868d854-74qft:/usr/share/nginx/html<span class="hljs-comment"># curl my-dep.default.svc:8000</span><br>2222<br>root@my-dep-5b7868d854-74qft:/usr/share/nginx/html<span class="hljs-comment"># curl my-dep.default.svc:8000</span><br>1111<br><br><span class="hljs-comment"># 但是域名在k8s的终端上是不能访问的</span><br>[root@k8s-master ~]<span class="hljs-comment"># curl my-dep.default.svc:8000</span><br>curl: (6) Could not resolve host: my-dep.default.svc; Unknown error<br><br><span class="hljs-comment"># 创建mytomcat应用</span><br>kubectl create deploy my-tomcat --image=tomcat<br><br><span class="hljs-comment"># 查看service</span><br>kubectl get service<br><br><span class="hljs-comment"># 测试service的服务发现</span><br><span class="hljs-comment"># 将deployment缩放成2个容器, 再次curl测试, 此时就只会显示1111, 2222两种情况, </span><br><span class="hljs-comment"># 而不会显示3333</span><br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>1111<br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>2222<br><br><span class="hljs-comment"># 如果再缩放成3个容器, 再次curl测试, 这时, 将会出现</span><br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>1111<br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>2222<br>[root@k8s-master ~]<span class="hljs-comment"># curl 10.96.69.174:8000</span><br>...<br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;<br>...<br><br><br></code></pre></td></tr></table></figure>

<p>NodePort</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看service</span><br>kubectl get svc<br><br><span class="hljs-comment"># 删除service</span><br>kubectl delete svc my-dep<br><br><span class="hljs-comment"># 创建service为NodePort</span><br>kubectl expose deploy my-dep --port=8000 --target-port=80 --<span class="hljs-built_in">type</span>=NodePort<br><br><span class="hljs-comment"># 查看应用是否启动</span><br>kubectl get pod<br><br><span class="hljs-comment"># 查看service的IP</span><br>kubectl get service<br><br></code></pre></td></tr></table></figure>
<p>NodePort范围在 30000-32767 之间<br><img src="/assets/c9283379e2694ec0b2d6f9605682b0ad.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/243f23a107724730980359bd7e207430.png" srcset="/img/loading.gif" lazyload><br>每个浏览器访问的服务器的结果不一致, 这是由负载均衡平均分配的请求</p>
<h3 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h3><p><img src="/assets/d3d6f73df5954644b8099c1e9ddf907c.png" srcset="/img/loading.gif" lazyload><br>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.47.0/deploy/static/provider/baremetal/deploy.yaml<br><br><span class="hljs-comment">#修改镜像</span><br>vi deploy.yaml<br><span class="hljs-comment">#将image的值改为如下值：</span><br>registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/ingress-nginx-controller:v0.46.0<br><br><span class="hljs-comment"># 加载yaml配置文件</span><br>kubectl apply -f deploy.yaml <br><br><span class="hljs-comment"># 检查安装的结果</span><br>kubectl get pod,svc -n ingress-nginx<br><br>NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE<br>service/ingress-nginx-controller             NodePort    10.96.216.183   &lt;none&gt;        80:30391/TCP,443:30303/TCP   4s<br>service/ingress-nginx-controller-admission   ClusterIP   10.96.139.106   &lt;none&gt;        443/TCP                      4s<br><br><span class="hljs-comment"># 最后别忘记把svc暴露的端口要放行</span><br></code></pre></td></tr></table></figure>
<p>然后访问<br>80:30391&#x2F;TCP,443:30303&#x2F;TCP<br>80端口访问30391, 443端口访问30303<br><a target="_blank" rel="noopener" href="http://47.107.101.255:30391/">http://47.107.101.255:30391/</a><br><a target="_blank" rel="noopener" href="https://47.107.101.255:30303/">https://47.107.101.255:30303/</a><br><img src="/assets/87f6ef285fb6419ba37ba7057722594f.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/e23bdeabf5524882b28231ee251041de.png" srcset="/img/loading.gif" lazyload><br>虽然访问到了404,但是这也说明了成功的访问到了nginx </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看service</span><br>kubectl get svc -A<br><br><span class="hljs-comment"># 查看nodes</span><br>kubectl get nodes<br><br><span class="hljs-comment"># 编写yaml</span><br>vi test.yaml<br><br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: hello-server<br>spec:<br>  replicas: 2<br>  selector:<br>    matchLabels:<br>      app: hello-server<br>  template:<br>    metadata:<br>      labels:<br>        app: hello-server<br>    spec:<br>      containers:<br>      - name: hello-server<br>        image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/hello-server<br>        ports:<br>        - containerPort: 9000<br>---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    app: nginx-demo<br>  name: nginx-demo<br>spec:<br>  replicas: 2<br>  selector:<br>    matchLabels:<br>      app: nginx-demo<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx-demo<br>    spec:<br>      containers:<br>      - image: nginx<br>        name: nginx<br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  labels:<br>    app: nginx-demo<br>  name: nginx-demo<br>spec:<br>  selector:<br>    app: nginx-demo<br>  ports:<br>  - port: 8000<br>    protocol: TCP<br>    targetPort: 80<br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  labels:<br>    app: hello-server<br>  name: hello-server<br>spec:<br>  selector:<br>    app: hello-server<br>  ports:<br>  - port: 8000<br>    protocol: TCP<br>    targetPort: 9000<br><br><span class="hljs-comment"># 应用yaml文件</span><br>kubectl apply -f test.yaml<br><br><span class="hljs-comment"># 查看service的IP</span><br>kubectl get svc<br>NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE<br>hello-server   ClusterIP   10.96.185.158   &lt;none&gt;        8000/TCP         19s<br>nginx-demo     ClusterIP   10.96.3.222     &lt;none&gt;        8000/TCP         19s<br><br><span class="hljs-comment"># 请求service的IP</span><br>curl 10.96.3.222:8000<br>curl 10.96.185.158:8000<br><br><br></code></pre></td></tr></table></figure>

<p>域名访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 再次编写配置文件</span><br>vi ingress-rule.yaml<br><br>apiVersion: networking.k8s.io/v1<br>kind: Ingress  <br>metadata:<br>  name: ingress-host-bar<br>spec:<br>  ingressClassName: nginx<br>  rules:<br>  - host: <span class="hljs-string">&quot;hello.atguigu.com&quot;</span><br>    http:<br>      paths:<br>      - pathType: Prefix<br>        path: <span class="hljs-string">&quot;/&quot;</span><br>        backend:<br>          service:<br>            name: hello-server<br>            port:<br>              number: 8000<br>  - host: <span class="hljs-string">&quot;demo.atguigu.com&quot;</span><br>    http:<br>      paths:<br>      - pathType: Prefix<br>        path: <span class="hljs-string">&quot;/nginx&quot;</span>  <span class="hljs-comment"># 把请求会转给下面的服务，下面的服务一定要能处理这个路径，不能处理就是404</span><br>        backend:<br>          service:<br>            name: nginx-demo  <span class="hljs-comment">## java，比如使用路径重写，去掉前缀nginx</span><br>            port:<br>              number: 8000<br><br><span class="hljs-comment"># 应用配置文件</span><br>kubectl apply -f ingress-rule.yaml<br><br><span class="hljs-comment"># 查看ingress, 查看绑定的域名</span><br>kubectl get ingress<br>NAME               CLASS   HOSTS                                ADDRESS   PORTS   AGE<br>ingress-host-bar   nginx   hello.atguigu.com,demo.atguigu.com             80      33s<br><br><span class="hljs-comment"># 查看端口</span><br>kubectl get pod,svc -n ingress-nginx<br>NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE<br>service/ingress-nginx-controller             NodePort    10.96.216.183   &lt;none&gt;        80:30391/TCP,443:30303/TCP   12h<br>service/ingress-nginx-controller-admission   ClusterIP   10.96.139.106   &lt;none&gt;        443/TCP                      12h<br><br><span class="hljs-comment"># 然后再windows的hosts配置文件进行修改</span><br>C:\Windows\System32\drivers\etc<br><br>47.107.101.255 hello.atguigu.com<br>47.107.101.255 demo.atguigu.com<br><br></code></pre></td></tr></table></figure>
<p>当请求的域名前缀是hello, 把请求转给hello-service<br>当请求的域名前缀是demo, 把请求转给nginx-demo<br>然后浏览器访问<br><a target="_blank" rel="noopener" href="http://hello.atguigu.com:30391/">http://hello.atguigu.com:30391/</a><br><a target="_blank" rel="noopener" href="http://demo.atguigu.com:30391/">http://demo.atguigu.com:30391/</a><br><img src="/assets/af3a4b5335d0471998076a4aea42289f.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/934083c7c84f44e8a7f7855810ae2e77.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看ingress</span><br>kubectl get ing<br><br><span class="hljs-comment"># 编辑ingress, 将path修改成/nginx</span><br>kubectl edit ing ingress-host-bar<br><br>  - host: demo.atguigu.com<br>    http:<br>      paths:<br>      - backend:<br>          service:<br>            name: nginx-demo<br>            port:<br>              number: 8000<br>        path: /nginx<br>        pathType: Prefix<br><br>:wq<br><br><span class="hljs-comment"># 再次访问浏览器</span><br><br></code></pre></td></tr></table></figure>
<p>请求<a target="_blank" rel="noopener" href="http://demo.atguigu.com:30391/nginx">http://demo.atguigu.com:30391</a><br><img src="/assets/b28a0a4a821042a5a26b5389576f8ebd.png" srcset="/img/loading.gif" lazyload><br>请求<a target="_blank" rel="noopener" href="http://demo.atguigu.com:30391/nginx">http://demo.atguigu.com:30391/nginx</a><br><img src="/assets/ddf429a115ad4845829c394a376b689e.png" srcset="/img/loading.gif" lazyload><br>第二个请求是带有nginx版本号的<br>第一个请求是nginx没有版本号的, 因为第一个请求是被ingress的nginx管理了<br>第二个请求则是被nginx-demo管理的<br><img src="/assets/56e6adc7a50646959748dbcf82f285eb.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 当进入nginx容器进行修改</span><br><span class="hljs-built_in">cd</span> /usr/share/nginx/html/<br><br>/usr/share/nginx/html<span class="hljs-comment"># echo roudoukouya &gt; nginx</span><br><br><span class="hljs-comment"># 再次请求, 这次请求将会把nginx文件给下载下来</span><br></code></pre></td></tr></table></figure>
<p><img src="/assets/bf49a160de3b4571b3bedce013de3b49.png" srcset="/img/loading.gif" lazyload></p>
<p>路径重写</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi ingress-rule.yaml<br><br>apiVersion: networking.k8s.io/v1<br>kind: Ingress  <br>metadata:<br>  annotations:<br>    nginx.ingress.kubernetes.io/rewrite-target: /<span class="hljs-variable">$2</span><br>  name: ingress-host-bar<br>spec:<br>  ingressClassName: nginx<br>  rules:<br>  - host: <span class="hljs-string">&quot;hello.atguigu.com&quot;</span><br>    http:<br>      paths:<br>      - pathType: Prefix<br>        path: <span class="hljs-string">&quot;/&quot;</span><br>        backend:<br>          service:<br>            name: hello-server<br>            port:<br>              number: 8000<br>  - host: <span class="hljs-string">&quot;demo.atguigu.com&quot;</span><br>    http:<br>      paths:<br>      - pathType: Prefix<br>        path: <span class="hljs-string">&quot;/nginx(/|$)(.*)&quot;</span>  <span class="hljs-comment"># 把请求会转给下面的服务，下面的服务一定要能处理这个路径，不能处理就是404</span><br>        backend:<br>          service:<br>            name: nginx-demo  <span class="hljs-comment">## java，比如使用路径重写，去掉前缀nginx</span><br>            port:<br>              number: 8000<br><br><span class="hljs-comment"># 删除配置文件创建的service</span><br>kubectl delete -f ingress-rule.yaml <br><span class="hljs-comment"># 再次创建</span><br>kubectl apply -f ingress-rule.yaml <br><br><span class="hljs-comment"># 查看一下</span><br>kubectl get ing<br></code></pre></td></tr></table></figure>
<p>此时访问<a target="_blank" rel="noopener" href="http://demo.atguigu.com:30391/nginx">http://demo.atguigu.com:30391/nginx</a><br>将会把路径重写成<a target="_blank" rel="noopener" href="http://demo.atguigu.com:30391/nginx">http://demo.atguigu.com:30391/</a> 直接访问nginx的根目录的默认欢迎页<br><img src="/assets/9091c81f795c40709e1c0a19b4547826.png" srcset="/img/loading.gif" lazyload><br>流量限制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 再次修改hosts文件</span><br>47.107.101.255 hello.atguigu.com<br>47.107.101.255 demo.atguigu.com<br>47.107.101.255 haha.atguigu.com<br><br><span class="hljs-comment"># 创建一个新的yaml文件</span><br>vi ingress-rule-2.yaml <br><br>apiVersion: networking.k8s.io/v1<br>kind: Ingress<br>metadata:<br>  name: ingress-limit-rate<br>  annotations:<br>    nginx.ingress.kubernetes.io/limit-rps: <span class="hljs-string">&quot;1&quot;</span><br>spec:<br>  ingressClassName: nginx<br>  rules:<br>  - host: <span class="hljs-string">&quot;haha.atguigu.com&quot;</span><br>    http:<br>      paths:<br>      - pathType: Exact<br>        path: <span class="hljs-string">&quot;/&quot;</span><br>        backend:<br>          service:<br>            name: nginx-demo<br>            port:<br>              number: 8000<br><br><span class="hljs-comment"># 应用yaml</span><br>kubectl apply -f ingress-rule-2.yaml<br><br><span class="hljs-comment"># 查看是否应用成功</span><br>kubectl get ing<br></code></pre></td></tr></table></figure>
<p>浏览器请求<a target="_blank" rel="noopener" href="http://haha.atguigu.com:30391/">http://haha.atguigu.com:30391/</a><br><img src="/assets/636db32f688a48fa9507a42ca6efd3b8.png" srcset="/img/loading.gif" lazyload><br>疯狂按F5<br><img src="/assets/ed038fe4c2f4402e97563b20a40c73c3.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="NFS环境搭建"><a href="#NFS环境搭建" class="headerlink" title="NFS环境搭建"></a>NFS环境搭建</h2><h3 id="PV-amp-PVC"><a href="#PV-amp-PVC" class="headerlink" title="PV&amp;PVC"></a>PV&amp;PVC</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">########################################## 所有节点都安装</span><br>yum install -y nfs-utils<br><br><span class="hljs-comment">########################################## 主节点</span><br><span class="hljs-comment"># nfs主节点</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot;</span> &gt; /etc/exports<br><br><span class="hljs-built_in">mkdir</span> -p /nfs/data<br>systemctl <span class="hljs-built_in">enable</span> rpcbind --now<br>systemctl <span class="hljs-built_in">enable</span> nfs-server --now<br><span class="hljs-comment"># 配置生效</span><br>exportfs -r<br><br><span class="hljs-comment"># 查看暴露出去路径</span><br>exportfs<br><br><span class="hljs-comment">########################################## 子节点</span><br><span class="hljs-comment"># 换成master的私有IP地址</span><br>ip addr<br><span class="hljs-comment"># 查看master暴露出来可以挂载的路径</span><br>showmount -e 172.31.0.204<br><br><span class="hljs-comment"># 执行以下命令挂载 nfs 服务器上的共享目录到本机路径 /root/nfsmount</span><br><span class="hljs-built_in">mkdir</span> -p /nfs/data<br><br><span class="hljs-comment"># 这也换成master的私有IP地址</span><br>mount -t nfs 172.31.0.204:/nfs/data /nfs/data<br><br><span class="hljs-comment"># 写入一个测试文件</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello nfs server&quot;</span> &gt; /nfs/data/test.txt<br><br><span class="hljs-comment"># 每个节点都查看一下, 说明了这个测试文件在每个节点上都保存拥有了</span><br><span class="hljs-built_in">cat</span> /nfs/data/test.txt<br></code></pre></td></tr></table></figure>

<p>原始方式挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi deploy.yaml<br><br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    app: nginx-pv-demo<br>  name: nginx-pv-demo<br>spec:<br>  replicas: 2<br>  selector:<br>    matchLabels:<br>      app: nginx-pv-demo<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx-pv-demo<br>    spec:<br>      containers:<br>      - image: nginx<br>        name: nginx<br>        volumeMounts:<br>        - name: html<br>          mountPath: /usr/share/nginx/html<br>      volumes:<br>        - name: html<br>          nfs:<br>            server: 172.31.0.204<br>            path: /nfs/data/nginx-pv<br><br><span class="hljs-comment"># 应用配置文件</span><br>kubectl apply -f deploy.yaml <br><br><span class="hljs-comment"># 描述</span><br>kubectl describe pod nginx-pv-demo-5f8d846496-fjph9<br><span class="hljs-comment"># 此时是挂载失败了, 要先创建把/nfs/data/nginx-pv创建出来才能进行挂载</span><br><span class="hljs-comment"># Output: mount.nfs: mounting 172.31.0.204:/nfs/data/nginx-pv failed, reason given by server: No such file or directory</span><br><br><span class="hljs-comment"># 创建nginx-pv</span><br><span class="hljs-built_in">cd</span> /nfs/data/<br><span class="hljs-built_in">mkdir</span> -p nginx-pv<br><br><span class="hljs-comment"># 删除</span><br>kubectl delete deploy nginx-pv-demo<br><br><span class="hljs-comment"># 创建</span><br><span class="hljs-built_in">cd</span> ~<br>kubectl apply -f deploy.yaml <br><br><span class="hljs-comment"># 查看容器的名称</span><br>kubectl get pod<br><br><span class="hljs-comment"># 随便往映射文件中写入文本</span><br><span class="hljs-built_in">echo</span> roudoukouya &gt; /nfs/data/nginx-pv/index.html<br><br><span class="hljs-comment"># 进入容器</span><br>kubectl <span class="hljs-built_in">exec</span> -it nginx-pv-demo-5f8d846496-cwjsd -- /bin/bash<br><span class="hljs-built_in">cat</span> /usr/share/nginx/html/index.html<br><span class="hljs-comment"># roudoukouya</span><br>kubectl <span class="hljs-built_in">exec</span> -it nginx-pv-demo-5f8d846496-n795r --/bin/bash<br><span class="hljs-built_in">cat</span> /usr/share/nginx/html/index.html<br><span class="hljs-comment"># roudoukouya</span><br></code></pre></td></tr></table></figure>

<p><img src="/assets/98c65a2536854e53873b4f00bffd4838.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 删除deploy部署的deploy</span><br>kubectl delete -f deploy.yaml <br><br><span class="hljs-comment">#nfs主节点</span><br><span class="hljs-built_in">mkdir</span> -p /nfs/data/01<br><span class="hljs-built_in">mkdir</span> -p /nfs/data/02<br><span class="hljs-built_in">mkdir</span> -p /nfs/data/03<br><br><span class="hljs-comment"># 创建pv配置文件</span><br>vi pv.yaml<br><br>apiVersion: v1<br>kind: PersistentVolume<br>metadata:<br>  name: pv01-10m<br>spec:<br>  capacity:<br>    storage: 10M<br>  accessModes:<br>    - ReadWriteMany<br>  storageClassName: nfs<br>  nfs:<br>    path: /nfs/data/01<br>    server: 172.31.0.204<br>---<br>apiVersion: v1<br>kind: PersistentVolume<br>metadata:<br>  name: pv02-1gi<br>spec:<br>  capacity:<br>    storage: 1Gi<br>  accessModes:<br>    - ReadWriteMany<br>  storageClassName: nfs<br>  nfs:<br>    path: /nfs/data/02<br>    server: 172.31.0.204<br>---<br>apiVersion: v1<br>kind: PersistentVolume<br>metadata:<br>  name: pv03-3gi<br>spec:<br>  capacity:<br>    storage: 3Gi<br>  accessModes:<br>    - ReadWriteMany<br>  storageClassName: nfs<br>  nfs:<br>    path: /nfs/data/03<br>    server: 172.31.0.204<br><br><span class="hljs-comment"># 应用</span><br>kubectl apply -f pv.yaml<br><br><span class="hljs-comment"># 查看pv</span><br>kubectl get pv<br>kubectl get persistentvolume<br><span class="hljs-comment"># NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="hljs-comment"># pv01-10m   10M        RWX            Retain           Available           nfs                     26s</span><br><span class="hljs-comment"># pv02-1gi   1Gi        RWX            Retain           Available           nfs                     26s</span><br><span class="hljs-comment"># pv03-3gi   3Gi        RWX            Retain           Available           nfs                     26s</span><br><br><span class="hljs-comment"># 创建pvc配置文件</span><br>vi pvc.yaml<br><br>kind: PersistentVolumeClaim<br>apiVersion: v1<br>metadata:<br>  name: nginx-pvc<br>spec:<br>  accessModes:<br>    - ReadWriteMany<br>  resources:<br>    requests:<br>      storage: 200Mi<br>  storageClassName: nfs<br><br><span class="hljs-comment"># 应用</span><br>kubectl apply -f pvc.yaml<br><br><span class="hljs-comment"># 查看pv</span><br>kubectl get persistentvolume<br><span class="hljs-comment"># NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="hljs-comment"># pv01-10m   10M        RWX            Retain           Available                       nfs                     3m25s</span><br><span class="hljs-comment"># pv02-1gi   1Gi        RWX            Retain           Bound       default/nginx-pvc   nfs                     3m25s</span><br><span class="hljs-comment"># pv03-3gi   3Gi        RWX            Retain           Available                       nfs                     3m25s</span><br><br><span class="hljs-comment"># 删除pvc.yaml配置文件绑定的资源</span><br>kubectl delete -f pvc.yaml<br><br><span class="hljs-comment"># 查看</span><br>kubectl get persistentvolume<br><span class="hljs-comment"># NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="hljs-comment"># pv01-10m   10M        RWX            Retain           Available                       nfs                     5m33s</span><br><span class="hljs-comment"># pv02-1gi   1Gi        RWX            Retain           Released    default/nginx-pvc   nfs                     5m33s</span><br><span class="hljs-comment"># pv03-3gi   3Gi        RWX            Retain           Available                       nfs                     5m33s</span><br><br><span class="hljs-comment"># 应用</span><br>kubectl apply -f pvc.yaml <br><br><span class="hljs-comment"># 查看</span><br>kubectl get persistentvolume<br><span class="hljs-comment"># NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="hljs-comment"># pv01-10m   10M        RWX            Retain           Available                       nfs                     6m27s</span><br><span class="hljs-comment"># pv02-1gi   1Gi        RWX            Retain           Released    default/nginx-pvc   nfs                     6m27s</span><br><span class="hljs-comment"># pv03-3gi   3Gi        RWX            Retain           Bound       default/nginx-pvc   nfs                     6m27s</span><br><br><br><span class="hljs-comment"># 创建yaml</span><br>vi dep02.yaml<br><br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    app: nginx-deploy-pvc<br>  name: nginx-deploy-pvc<br>spec:<br>  replicas: 2<br>  selector:<br>    matchLabels:<br>      app: nginx-deploy-pvc<br>  template:<br>    metadata:<br>      labels:<br>        app: nginx-deploy-pvc<br>    spec:<br>      containers:<br>      - image: nginx<br>        name: nginx<br>        volumeMounts:<br>        - name: html<br>          mountPath: /usr/share/nginx/html<br>      volumes:<br>        - name: html<br>          persistentVolumeClaim:<br>            claimName: nginx-pvc<br><br><span class="hljs-comment"># 应用</span><br>kubectl apply -f dep02.yaml<br><br><br>kubectl get pv,pvc<br><span class="hljs-comment"># NAME                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="hljs-comment"># persistentvolume/pv01-10m   10M        RWX            Retain           Available                       nfs                     9m13s</span><br><span class="hljs-comment"># persistentvolume/pv02-1gi   1Gi        RWX            Retain           Released    default/nginx-pvc   nfs                     9m13s</span><br><span class="hljs-comment"># persistentvolume/pv03-3gi   3Gi        RWX            Retain           Bound       default/nginx-pvc   nfs                     9m13s</span><br><br><span class="hljs-comment"># NAME                              STATUS   VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="hljs-comment"># persistentvolumeclaim/nginx-pvc   Bound    pv03-3gi   3Gi        RWX            nfs            3m30s</span><br></code></pre></td></tr></table></figure>

<h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建一个配置文件</span><br>vi redis.conf<br><br>appendonly <span class="hljs-built_in">yes</span><br><br>kubectl create cm redis-conf --from-file=redis.conf<br><br>kubectl get cm<br><br><span class="hljs-built_in">rm</span> -rf redis.conf <br><br>kubectl get cm redis-conf -oyaml<br><br>apiVersion: v1<br>data:<br>  redis.conf: |<br>    appendonly <span class="hljs-built_in">yes</span><br>kind: ConfigMap<br>metadata:<br>  creationTimestamp: <span class="hljs-string">&quot;2023-05-13T03:40:47Z&quot;</span><br>  managedFields:<br>  - apiVersion: v1<br>    fieldsType: FieldsV1<br>    fieldsV1:<br>      f:data:<br>        .: &#123;&#125;<br>        f:redis.conf: &#123;&#125;<br>    manager: kubectl-create<br>    operation: Update<br>    time: <span class="hljs-string">&quot;2023-05-13T03:40:47Z&quot;</span><br>  name: redis-conf<br>  namespace: default<br>  resourceVersion: <span class="hljs-string">&quot;58168&quot;</span><br>  uid: 7efa1eac-ad15-4b21-9322-7a2c92886e74<br><br><br>vi redis.yaml<br><br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: redis<br>spec:<br>  containers:<br>  - name: redis<br>    image: redis<br>    <span class="hljs-built_in">command</span>:<br>      - redis-server<br>      - <span class="hljs-string">&quot;/redis-master/redis.conf&quot;</span>  <span class="hljs-comment">#指的是redis容器内部的位置</span><br>    ports:<br>    - containerPort: 6379<br>    volumeMounts:<br>    - mountPath: /data<br>      name: data<br>    - mountPath: /redis-master<br>      name: config<br>  volumes:<br>    - name: data<br>      emptyDir: &#123;&#125;<br>    - name: config<br>      configMap:<br>        name: redis-conf<br>        items:<br>        - key: redis.conf<br>          path: redis.conf<br><br><span class="hljs-comment"># 创建pod</span><br>kubectl apply -f redis.yaml<br><br><span class="hljs-comment"># 查看pod</span><br>kubectl get pod<br><br><span class="hljs-comment"># 进入redis容器</span><br>kubectl <span class="hljs-built_in">exec</span> -it redis -- bash<br><span class="hljs-built_in">cat</span> /redis-master/redis.conf <br><span class="hljs-comment"># appendonly yes</span><br><br><br>kubectl get cm<br><br><span class="hljs-comment"># 编辑配置文件(添加一行requirepass)</span><br>kubectl edit cm redis-conf<br><br>apiVersion: v1<br>data:<br>  redis.conf: |<br>    appendonly <span class="hljs-built_in">yes</span><br>    requirepass 123456<br><br><span class="hljs-comment"># 再次进入redis容器, 可以发现刚刚编辑的requirepass, 过了一会就出现了在redis.conf中</span><br>kubectl <span class="hljs-built_in">exec</span> -it redis -- bash<br><span class="hljs-built_in">cat</span> /redis-master/redis.conf <br><span class="hljs-comment"># appendonly yes</span><br><span class="hljs-comment"># requirepass 123456</span><br><br><span class="hljs-comment"># 检查默认配置, 默认配置并没有生效requirepass, 这需要重新创建一个pod, 就会出现requirepass</span><br>kubectl <span class="hljs-built_in">exec</span> -it redis -- redis-cli<br>CONFIG GET appendonly<br><span class="hljs-comment"># 1) &quot;appendonly&quot;</span><br><span class="hljs-comment"># 2) &quot;yes&quot;</span><br><br>CONFIG GET requirepass<br><span class="hljs-comment"># 1) &quot;requirepass&quot;</span><br><span class="hljs-comment"># 2) &quot;&quot;</span><br></code></pre></td></tr></table></figure>
<h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><blockquote>
<p>Secret 对象类型用来保存敏感信息，例如密码、OAuth 令牌和 SSH 密钥。 将这些信息放在 secret 中比放在 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">Pod</a> 的定义或者 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-image">容器镜像</a> 中来说更加安全和灵活。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 登录docker</span><br>docker login<br><br><span class="hljs-comment"># 退出docker</span><br>docker <span class="hljs-built_in">logout</span><br><br><span class="hljs-comment"># 然后输入账号密码</span><br>Username:<br>Password:<br><br><span class="hljs-comment"># 提交镜像</span><br>docker commit b43e2104abd6 roudoukou/k8s-<span class="hljs-built_in">test</span><br><span class="hljs-comment"># 返回的sha256验证码</span><br><span class="hljs-comment"># sha256:ba6d93505b636cfc0746b0489c8f2c840b5ec1a66b2c667e8d4b165be02369b0</span><br><br><span class="hljs-comment"># 将镜像推送上docker-hub</span><br>docker push roudoukou/k8s-<span class="hljs-built_in">test</span><br><br><span class="hljs-comment"># 拉取镜像 </span><br>docker pull leifengyang/guignginx:v1.0<br><br><span class="hljs-comment"># 创建配置文件</span><br>vi mypod.yaml<br><br>apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: private-nginx<br>spec:<br>  containers:<br>  - name: private-nginx<br>    image: leifengyang/guignginx:v1.0<br>  imagePullSecrets:<br>  - name: leifengyang-docker<br><br><span class="hljs-comment"># 应用</span><br>kubectl apply -f mypod.yaml<br><br>kubectl get pod<br><br>kubectl delete -f mypod.yaml<br><br><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create secret docker-registry leifengyang-docker \<br>--docker-username=leifengyang \<br>--docker-password=Lfy123456 \<br>--docker-email=534096094@qq.com<br><br>kubectl get secret<br><br>kubectl get secret leifengyang-docker -oyaml<br><br></code></pre></td></tr></table></figure>
<p>创建了secret之后, 可以通过账号密码来下载私有的容器镜像</p>
<h2 id="KubeSphere"><a href="#KubeSphere" class="headerlink" title="KubeSphere"></a>KubeSphere</h2><h3 id="1-kubenetes上安装kubesphere"><a href="#1-kubenetes上安装kubesphere" class="headerlink" title="1. kubenetes上安装kubesphere"></a>1. kubenetes上安装kubesphere</h3><h4 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h4><p>所有节点安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo yum remove docker*<br>sudo yum install -y yum-utils<br><br><span class="hljs-comment">#配置docker的yum地址</span><br>sudo yum-config-manager \<br>--add-repo \<br>http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br><br><br><span class="hljs-comment">#安装指定版本</span><br>sudo yum install -y docker-ce-20.10.7 docker-ce-cli-20.10.7 containerd.io-1.4.6<br><br><span class="hljs-comment">#	启动&amp;开机启动docker</span><br>systemctl <span class="hljs-built_in">enable</span> docker --now<br><br><span class="hljs-comment"># docker加速配置</span><br>sudo <span class="hljs-built_in">mkdir</span> -p /etc/docker<br>sudo <span class="hljs-built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="hljs-string">&#x27;EOF&#x27;</span><br>&#123;<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://ylmjgfp5.mirror.aliyuncs.com&quot;</span>]<br>&#125;<br>EOF<br>sudo systemctl daemon-reload<br>sudo systemctl restart docker<br></code></pre></td></tr></table></figure>
<h4 id="安装kubenetes"><a href="#安装kubenetes" class="headerlink" title="安装kubenetes"></a>安装kubenetes</h4><blockquote>
<p>每个机器使用内网ip互通</p>
</blockquote>
<blockquote>
<p>每个机器配置自己的hostname，不能用localhost</p>
</blockquote>
<p>每个节点都设置hostname, 然后关闭虚拟化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#设置每个机器自己的hostname</span><br>hostnamectl set-hostname k8s-master<br>hostnamectl set-hostname k8s-node1<br>hostnamectl set-hostname k8s-node2<br><br><span class="hljs-comment"># 将 SELinux 设置为 permissive 模式（相当于将其禁用）</span><br>sudo setenforce 0<br>sudo sed -i <span class="hljs-string">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> /etc/selinux/config<br><br><span class="hljs-comment">#关闭swap</span><br>swapoff -a  <br>sed -ri <span class="hljs-string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab<br><br><span class="hljs-comment">#允许 iptables 检查桥接流量</span><br><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class="hljs-string">br_netfilter</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class="hljs-string">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="hljs-string">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="hljs-string">EOF</span><br>sudo sysctl --system<br></code></pre></td></tr></table></figure>
<h4 id="安装kubelet、kubeadm、kubectl-1"><a href="#安装kubelet、kubeadm、kubectl-1" class="headerlink" title="安装kubelet、kubeadm、kubectl"></a>安装kubelet、kubeadm、kubectl</h4><p>每个节点都执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 配置k8s的yum源地址</span><br><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class="hljs-string">[kubernetes]</span><br><span class="hljs-string">name=Kubernetes</span><br><span class="hljs-string">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="hljs-string">enabled=1</span><br><span class="hljs-string">gpgcheck=0</span><br><span class="hljs-string">repo_gpgcheck=0</span><br><span class="hljs-string">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="hljs-string">   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="hljs-string">EOF</span><br><br><br><span class="hljs-comment"># 安装 kubelet，kubeadm，kubectl</span><br>sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9<br><br><span class="hljs-comment"># 启动kubelet</span><br>sudo systemctl <span class="hljs-built_in">enable</span> --now kubelet<br><br><span class="hljs-comment"># 所有机器配置master域名</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;172.31.0.204  k8s-master&quot;</span> &gt;&gt; /etc/hosts<br></code></pre></td></tr></table></figure>
<h4 id="初始化master节点"><a href="#初始化master节点" class="headerlink" title="初始化master节点"></a>初始化master节点</h4><p>只需要在主节点master执行(node节点不要执行, 需要替换成master的IP)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubeadm init \<br>--apiserver-advertise-address=172.31.0.204 \<br>--control-plane-endpoint=k8s-master \<br>--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \<br>--kubernetes-version v1.20.9 \<br>--service-cidr=10.96.0.0/16 \<br>--pod-network-cidr=192.168.0.0/16<br></code></pre></td></tr></table></figure>

<p>如果部署手误了, 可以使用如下命令重置, 然后重新部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubeadm reset<br></code></pre></td></tr></table></figure>

<h4 id="记录关键信息"><a href="#记录关键信息" class="headerlink" title="记录关键信息"></a>记录关键信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs bash">Your Kubernetes control-plane has initialized successfully!<br><br>To start using your cluster, you need to run the following as a regular user:<br><br>  <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>  sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>  sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br><br>Alternatively, <span class="hljs-keyword">if</span> you are the root user, you can run:<br><br>  <span class="hljs-built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf<br><br>You should now deploy a pod network to the cluster.<br>Run <span class="hljs-string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:<br>  https://kubernetes.io/docs/concepts/cluster-administration/addons/<br><br>You can now <span class="hljs-built_in">join</span> any number of control-plane nodes by copying certificate authorities<br>and service account keys on each node and <span class="hljs-keyword">then</span> running the following as root:<br><br>  kubeadm <span class="hljs-built_in">join</span> k8s-master:6443 --token 5ybzw0.jtbnx7tbb0t83tp9 \<br>    --discovery-token-ca-cert-hash sha256:f83a1db517489e43d02c836953d0cf680ea6a9a0c816567522635df8669c00c2 \<br>    --control-plane <br><br>Then you can <span class="hljs-built_in">join</span> any number of worker nodes by running the following on each as root:<br><br>kubeadm <span class="hljs-built_in">join</span> k8s-master:6443 --token 5ybzw0.jtbnx7tbb0t83tp9 \<br>    --discovery-token-ca-cert-hash sha256:f83a1db517489e43d02c836953d0cf680ea6a9a0c816567522635df8669c00c2 <br></code></pre></td></tr></table></figure>

<p>master节点输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br></code></pre></td></tr></table></figure>
<h4 id="安装Calico网络插件"><a href="#安装Calico网络插件" class="headerlink" title="安装Calico网络插件"></a>安装Calico网络插件</h4><p>只用在master节点输入这个</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curl https://docs.projectcalico.org/v3.20/manifests/calico.yaml -O</span><br><span class="hljs-comment"># 使用下面这个版本, emm, 卡这个bug卡了一个晚上了</span><br>curl https://docs.projectcalico.org/v3.8/manifests/calico.yaml -O<br><br>kubectl apply -f calico.yaml<br><br><span class="hljs-comment"># 查看运行的pod</span><br>kubectl get pods -A<br><br></code></pre></td></tr></table></figure>

<p>所有的node节点输入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 把node节点加入到master</span><br>kubeadm <span class="hljs-built_in">join</span> k8s-master:6443 --token 5ybzw0.jtbnx7tbb0t83tp9 \<br>    --discovery-token-ca-cert-hash sha256:f83a1db517489e43d02c836953d0cf680ea6a9a0c816567522635df8669c00c2 <br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看节点</span><br>kubectl get nodes<br></code></pre></td></tr></table></figure>

<h4 id="nfs文件系统-安装nfs-server"><a href="#nfs文件系统-安装nfs-server" class="headerlink" title="nfs文件系统 - 安装nfs-server"></a>nfs文件系统 - 安装nfs-server</h4><p>每个节点安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 在每个机器。</span><br>yum install -y nfs-utils<br></code></pre></td></tr></table></figure>
<p>master下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 在master 执行以下命令 </span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot;</span> &gt; /etc/exports<br><br><br><span class="hljs-comment"># 执行以下命令，启动 nfs 服务;创建共享目录</span><br><span class="hljs-built_in">mkdir</span> -p /nfs/data<br><br><br><span class="hljs-comment"># 在master执行</span><br>systemctl <span class="hljs-built_in">enable</span> rpcbind<br>systemctl <span class="hljs-built_in">enable</span> nfs-server<br>systemctl start rpcbind<br>systemctl start nfs-server<br><br><span class="hljs-comment"># 使配置生效</span><br>exportfs -r<br><br><br><span class="hljs-comment">#检查配置是否生效</span><br>exportfs<br></code></pre></td></tr></table></figure>
<h4 id="nfs文件系统-配置nfs-client（选做）"><a href="#nfs文件系统-配置nfs-client（选做）" class="headerlink" title="nfs文件系统 - 配置nfs-client（选做）"></a>nfs文件系统 - 配置nfs-client（选做）</h4><p>所有node节点下执行(需要替换成master的IP)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">showmount -e 172.31.0.204<br><br><span class="hljs-built_in">mkdir</span> -p /nfs/data<br><br>mount -t nfs 172.31.0.204:/nfs/data /nfs/data<br></code></pre></td></tr></table></figure>
<h4 id="nfs文件系统-配置默认存储"><a href="#nfs文件系统-配置默认存储" class="headerlink" title="nfs文件系统 - 配置默认存储"></a>nfs文件系统 - 配置默认存储</h4><blockquote>
<p>配置动态供应的默认存储类</p>
</blockquote>
<p>master下执行(需要替换成自己的master IP 172.31.0.204)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi sc.yaml<br></code></pre></td></tr></table></figure>
<p>sc.yaml(要替换成master的 IP)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 创建了一个存储类</span><br>apiVersion: storage.k8s.io/v1<br>kind: StorageClass<br>metadata:<br>  name: nfs-storage<br>  annotations:<br>    storageclass.kubernetes.io/is-default-class: <span class="hljs-string">&quot;true&quot;</span><br>provisioner: k8s-sigs.io/nfs-subdir-external-provisioner<br>parameters:<br>  archiveOnDelete: <span class="hljs-string">&quot;true&quot;</span>  <span class="hljs-comment">## 删除pv的时候，pv的内容是否要备份</span><br><br>---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nfs-client-provisioner<br>  labels:<br>    app: nfs-client-provisioner<br>  <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>  namespace: default<br>spec:<br>  replicas: 1<br>  strategy:<br>    <span class="hljs-built_in">type</span>: Recreate<br>  selector:<br>    matchLabels:<br>      app: nfs-client-provisioner<br>  template:<br>    metadata:<br>      labels:<br>        app: nfs-client-provisioner<br>    spec:<br>      serviceAccountName: nfs-client-provisioner<br>      containers:<br>        - name: nfs-client-provisioner<br>          image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/nfs-subdir-external-provisioner:v4.0.2<br>          <span class="hljs-comment"># resources:</span><br>          <span class="hljs-comment">#    limits:</span><br>          <span class="hljs-comment">#      cpu: 10m</span><br>          <span class="hljs-comment">#    requests:</span><br>          <span class="hljs-comment">#      cpu: 10m</span><br>          volumeMounts:<br>            - name: nfs-client-root<br>              mountPath: /persistentvolumes<br>          <span class="hljs-built_in">env</span>:<br>            - name: PROVISIONER_NAME<br>              value: k8s-sigs.io/nfs-subdir-external-provisioner<br>            - name: NFS_SERVER<br>              value: 172.31.0.204 <span class="hljs-comment">## 指定自己nfs服务器地址</span><br>            - name: NFS_PATH  <br>              value: /nfs/data  <span class="hljs-comment">## nfs服务器共享的目录</span><br>      volumes:<br>        - name: nfs-client-root<br>          nfs:<br>            server: 172.31.0.204<br>            path: /nfs/data<br>---<br>apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  name: nfs-client-provisioner<br>  <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>  namespace: default<br>---<br>kind: ClusterRole<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: nfs-client-provisioner-runner<br>rules:<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;nodes&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;persistentvolumes&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;persistentvolumeclaims&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;storage.k8s.io&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;storageclasses&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;events&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>]<br>---<br>kind: ClusterRoleBinding<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: run-nfs-client-provisioner<br>subjects:<br>  - kind: ServiceAccount<br>    name: nfs-client-provisioner<br>    <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>    namespace: default<br>roleRef:<br>  kind: ClusterRole<br>  name: nfs-client-provisioner-runner<br>  apiGroup: rbac.authorization.k8s.io<br>---<br>kind: Role<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: leader-locking-nfs-client-provisioner<br>  <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>  namespace: default<br>rules:<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;endpoints&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>]<br>---<br>kind: RoleBinding<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: leader-locking-nfs-client-provisioner<br>  <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>  namespace: default<br>subjects:<br>  - kind: ServiceAccount<br>    name: nfs-client-provisioner<br>    <span class="hljs-comment"># replace with namespace where provisioner is deployed</span><br>    namespace: default<br>roleRef:<br>  kind: Role<br>  name: leader-locking-nfs-client-provisioner<br>  apiGroup: rbac.authorization.k8s.io<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f sc.yaml <br><br><span class="hljs-comment"># 查看storageclass</span><br><span class="hljs-comment"># 确认配置是否生效</span><br>kubectl get sc<br><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get sc<br><br><span class="hljs-comment"># 创建pvc申请书</span><br>vi pvc.yaml<br><br>kind: PersistentVolumeClaim<br>apiVersion: v1<br>metadata:<br>  name: nginx-pvc<br>spec:<br>  accessModes:<br>    - ReadWriteMany<br>  resources:<br>    requests:<br>      storage: 200Mi<br><br><span class="hljs-comment"># 应用</span><br>kubectl apply -f pvc.yaml<br><br>kubectl get pvc<br><br>kubectl get pv<br></code></pre></td></tr></table></figure>
<h4 id="metrics-server"><a href="#metrics-server" class="headerlink" title="metrics-server"></a>metrics-server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi metrics.yaml<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  labels:<br>    k8s-app: metrics-server<br>  name: metrics-server<br>  namespace: kube-system<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRole<br>metadata:<br>  labels:<br>    k8s-app: metrics-server<br>    rbac.authorization.k8s.io/aggregate-to-admin: <span class="hljs-string">&quot;true&quot;</span><br>    rbac.authorization.k8s.io/aggregate-to-edit: <span class="hljs-string">&quot;true&quot;</span><br>    rbac.authorization.k8s.io/aggregate-to-view: <span class="hljs-string">&quot;true&quot;</span><br>  name: system:aggregated-metrics-reader<br>rules:<br>- apiGroups:<br>  - metrics.k8s.io<br>  resources:<br>  - pods<br>  - nodes<br>  verbs:<br>  - get<br>  - list<br>  - watch<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRole<br>metadata:<br>  labels:<br>    k8s-app: metrics-server<br>  name: system:metrics-server<br>rules:<br>- apiGroups:<br>  - <span class="hljs-string">&quot;&quot;</span><br>  resources:<br>  - pods<br>  - nodes<br>  - nodes/stats<br>  - namespaces<br>  - configmaps<br>  verbs:<br>  - get<br>  - list<br>  - watch<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: RoleBinding<br>metadata:<br>  labels:<br>    k8s-app: metrics-server<br>  name: metrics-server-auth-reader<br>  namespace: kube-system<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: Role<br>  name: extension-apiserver-authentication-reader<br>subjects:<br>- kind: ServiceAccount<br>  name: metrics-server<br>  namespace: kube-system<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  labels:<br>    k8s-app: metrics-server<br>  name: metrics-server:system:auth-delegator<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: system:auth-delegator<br>subjects:<br>- kind: ServiceAccount<br>  name: metrics-server<br>  namespace: kube-system<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  labels:<br>    k8s-app: metrics-server<br>  name: system:metrics-server<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: system:metrics-server<br>subjects:<br>- kind: ServiceAccount<br>  name: metrics-server<br>  namespace: kube-system<br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  labels:<br>    k8s-app: metrics-server<br>  name: metrics-server<br>  namespace: kube-system<br>spec:<br>  ports:<br>  - name: https<br>    port: 443<br>    protocol: TCP<br>    targetPort: https<br>  selector:<br>    k8s-app: metrics-server<br>---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    k8s-app: metrics-server<br>  name: metrics-server<br>  namespace: kube-system<br>spec:<br>  selector:<br>    matchLabels:<br>      k8s-app: metrics-server<br>  strategy:<br>    rollingUpdate:<br>      maxUnavailable: 0<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: metrics-server<br>    spec:<br>      containers:<br>      - args:<br>        - --cert-dir=/tmp<br>        - --kubelet-insecure-tls<br>        - --secure-port=4443<br>        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname<br>        - --kubelet-use-node-status-port<br>        image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/metrics-server:v0.4.3<br>        imagePullPolicy: IfNotPresent<br>        livenessProbe:<br>          failureThreshold: 3<br>          httpGet:<br>            path: /livez<br>            port: https<br>            scheme: HTTPS<br>          periodSeconds: 10<br>        name: metrics-server<br>        ports:<br>        - containerPort: 4443<br>          name: https<br>          protocol: TCP<br>        readinessProbe:<br>          failureThreshold: 3<br>          httpGet:<br>            path: /readyz<br>            port: https<br>            scheme: HTTPS<br>          periodSeconds: 10<br>        securityContext:<br>          readOnlyRootFilesystem: <span class="hljs-literal">true</span><br>          runAsNonRoot: <span class="hljs-literal">true</span><br>          runAsUser: 1000<br>        volumeMounts:<br>        - mountPath: /tmp<br>          name: tmp-dir<br>      nodeSelector:<br>        kubernetes.io/os: linux<br>      priorityClassName: system-cluster-critical<br>      serviceAccountName: metrics-server<br>      volumes:<br>      - emptyDir: &#123;&#125;<br>        name: tmp-dir<br>---<br>apiVersion: apiregistration.k8s.io/v1<br>kind: APIService<br>metadata:<br>  labels:<br>    k8s-app: metrics-server<br>  name: v1beta1.metrics.k8s.io<br>spec:<br>  group: metrics.k8s.io<br>  groupPriorityMinimum: 100<br>  insecureSkipTLSVerify: <span class="hljs-literal">true</span><br>  service:<br>    name: metrics-server<br>    namespace: kube-system<br>  version: v1beta1<br>  versionPriority: 100<br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f metrics.yaml<br><br>kubectl get pod -A<br><br>kubectl top nodes<br><br><span class="hljs-comment"># 查看pod占用的内存, CPU</span><br>kubectl top pods<br><br>kubectl top pods -A<br></code></pre></td></tr></table></figure>
<h4 id="安装KubeSphere"><a href="#安装KubeSphere" class="headerlink" title="安装KubeSphere"></a>安装KubeSphere</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y wget<br><br>yum install -y vim<br><br><span class="hljs-comment"># 下载配置文件, 或者使用下面提供的两个配置文件</span><br>wget https://github.com/kubesphere/ks-installer/releases/download/v3.1.1/kubesphere-installer.yaml<br><br>wget https://github.com/kubesphere/ks-installer/releases/download/v3.1.1/cluster-configuration.yaml<br><br><span class="hljs-comment"># 建议用vi粘贴代码进去, 之后再用vim编辑代码</span><br>vi kubesphere-installer.yaml<br><br><span class="hljs-comment"># 修改配置文件(将false改为true, 下面提供的配置文件已经修改好了, 可以直接粘贴)</span><br>vi cluster-configuration.yaml<br><br></code></pre></td></tr></table></figure>

<p>kubesphere-installer.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apiextensions.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">CustomResourceDefinition</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">clusterconfigurations.installer.kubesphere.io</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">installer.kubesphere.io</span><br>  <span class="hljs-attr">versions:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v1alpha1</span><br>    <span class="hljs-attr">served:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">storage:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">scope:</span> <span class="hljs-string">Namespaced</span><br>  <span class="hljs-attr">names:</span><br>    <span class="hljs-attr">plural:</span> <span class="hljs-string">clusterconfigurations</span><br>    <span class="hljs-attr">singular:</span> <span class="hljs-string">clusterconfiguration</span><br>    <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterConfiguration</span><br>    <span class="hljs-attr">shortNames:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">cc</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubesphere-system</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ks-installer</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubesphere-system</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ks-installer</span><br><span class="hljs-attr">rules:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">apps</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">extensions</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">batch</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">apiregistration.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">apiextensions.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">tenant.kubesphere.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">certificates.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">devops.kubesphere.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">monitoring.coreos.com</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">logging.kubesphere.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">jaegertracing.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">storage.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">admissionregistration.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">policy</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">autoscaling</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">networking.istio.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">config.istio.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">iam.kubesphere.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">notification.kubesphere.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">auditing.kubesphere.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">events.kubesphere.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">core.kubefed.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">installer.kubesphere.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">storage.kubesphere.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">security.istio.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">monitoring.kiali.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">kiali.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">networking.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">kubeedge.kubesphere.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">types.kubefed.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;*&#x27;</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ks-installer</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ks-installer</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubesphere-system</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ks-installer</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ks-installer</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubesphere-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">ks-install</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">ks-install</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">ks-install</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">ks-installer</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">installer</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">kubesphere/ks-installer:v3.1.1</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">&quot;Always&quot;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;1&quot;</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">1Gi</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">20m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/localtime</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">host-time</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/localtime</span><br>          <span class="hljs-attr">type:</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">host-time</span><br><br></code></pre></td></tr></table></figure>

<p>cluster-configuration.yaml (已经将false改成true了, endpointIps需要换成对应的master的IP)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">installer.kubesphere.io/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterConfiguration</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ks-installer</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubesphere-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">v3.1.1</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">persistence:</span><br>    <span class="hljs-attr">storageClass:</span> <span class="hljs-string">&quot;&quot;</span>        <span class="hljs-comment"># If there is no default StorageClass in your cluster, you need to specify an existing StorageClass here.</span><br>  <span class="hljs-attr">authentication:</span><br>    <span class="hljs-attr">jwtSecret:</span> <span class="hljs-string">&quot;&quot;</span>           <span class="hljs-comment"># Keep the jwtSecret consistent with the Host Cluster. Retrieve the jwtSecret by executing &quot;kubectl -n kubesphere-system get cm kubesphere-config -o yaml | grep -v &quot;apiVersion&quot; | grep jwtSecret&quot; on the Host Cluster.</span><br>  <span class="hljs-attr">local_registry:</span> <span class="hljs-string">&quot;&quot;</span>        <span class="hljs-comment"># Add your private registry address if it is needed.</span><br>  <span class="hljs-attr">etcd:</span><br>    <span class="hljs-attr">monitoring:</span> <span class="hljs-literal">true</span>       <span class="hljs-comment"># Enable or disable etcd monitoring dashboard installation. You have to create a Secret for etcd before you enable it.</span><br>    <span class="hljs-attr">endpointIps:</span> <span class="hljs-number">172.31</span><span class="hljs-number">.0</span><span class="hljs-number">.204</span>  <span class="hljs-comment"># etcd cluster EndpointIps. It can be a bunch of IPs here.</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">2379</span>              <span class="hljs-comment"># etcd port.</span><br>    <span class="hljs-attr">tlsEnable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">common:</span><br>    <span class="hljs-attr">redis:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">openldap:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">minioVolumeSize:</span> <span class="hljs-string">20Gi</span> <span class="hljs-comment"># Minio PVC size.</span><br>    <span class="hljs-attr">openldapVolumeSize:</span> <span class="hljs-string">2Gi</span>   <span class="hljs-comment"># openldap PVC size.</span><br>    <span class="hljs-attr">redisVolumSize:</span> <span class="hljs-string">2Gi</span> <span class="hljs-comment"># Redis PVC size.</span><br>    <span class="hljs-attr">monitoring:</span><br>      <span class="hljs-comment"># type: external   # Whether to specify the external prometheus stack, and need to modify the endpoint at the next line.</span><br>      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span> <span class="hljs-comment"># Prometheus endpoint to get metrics data.</span><br>    <span class="hljs-attr">es:</span>   <span class="hljs-comment"># Storage backend for logging, events and auditing.</span><br>      <span class="hljs-comment"># elasticsearchMasterReplicas: 1   # The total number of master nodes. Even numbers are not allowed.</span><br>      <span class="hljs-comment"># elasticsearchDataReplicas: 1     # The total number of data nodes.</span><br>      <span class="hljs-attr">elasticsearchMasterVolumeSize:</span> <span class="hljs-string">4Gi</span>   <span class="hljs-comment"># The volume size of Elasticsearch master nodes.</span><br>      <span class="hljs-attr">elasticsearchDataVolumeSize:</span> <span class="hljs-string">20Gi</span>    <span class="hljs-comment"># The volume size of Elasticsearch data nodes.</span><br>      <span class="hljs-attr">logMaxAge:</span> <span class="hljs-number">7</span>                     <span class="hljs-comment"># Log retention time in built-in Elasticsearch. It is 7 days by default.</span><br>      <span class="hljs-attr">elkPrefix:</span> <span class="hljs-string">logstash</span>              <span class="hljs-comment"># The string making up index names. The index name will be formatted as ks-&lt;elk_prefix&gt;-log.</span><br>      <span class="hljs-attr">basicAuth:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">externalElasticsearchUrl:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">externalElasticsearchPort:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">console:</span><br>    <span class="hljs-attr">enableMultiLogin:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># Enable or disable simultaneous logins. It allows different users to log in with the same account at the same time.</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">30880</span><br>  <span class="hljs-attr">alerting:</span>                <span class="hljs-comment"># (CPU: 0.1 Core, Memory: 100 MiB) It enables users to customize alerting policies to send messages to receivers in time with different time intervals and alerting levels to choose from.</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>         <span class="hljs-comment"># Enable or disable the KubeSphere Alerting System.</span><br>    <span class="hljs-comment"># thanosruler:</span><br>    <span class="hljs-comment">#   replicas: 1</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  <span class="hljs-attr">auditing:</span>                <span class="hljs-comment"># Provide a security-relevant chronological set of records，recording the sequence of activities happening on the platform, initiated by different tenants.</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>         <span class="hljs-comment"># Enable or disable the KubeSphere Auditing Log System. </span><br>  <span class="hljs-attr">devops:</span>                  <span class="hljs-comment"># (CPU: 0.47 Core, Memory: 8.6 G) Provide an out-of-the-box CI/CD system based on Jenkins, and automated workflow tools including Source-to-Image &amp; Binary-to-Image.</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>             <span class="hljs-comment"># Enable or disable the KubeSphere DevOps System.</span><br>    <span class="hljs-attr">jenkinsMemoryLim:</span> <span class="hljs-string">2Gi</span>      <span class="hljs-comment"># Jenkins memory limit.</span><br>    <span class="hljs-attr">jenkinsMemoryReq:</span> <span class="hljs-string">1500Mi</span>   <span class="hljs-comment"># Jenkins memory request.</span><br>    <span class="hljs-attr">jenkinsVolumeSize:</span> <span class="hljs-string">8Gi</span>     <span class="hljs-comment"># Jenkins volume size.</span><br>    <span class="hljs-attr">jenkinsJavaOpts_Xms:</span> <span class="hljs-string">512m</span>  <span class="hljs-comment"># The following three fields are JVM parameters.</span><br>    <span class="hljs-attr">jenkinsJavaOpts_Xmx:</span> <span class="hljs-string">512m</span><br>    <span class="hljs-attr">jenkinsJavaOpts_MaxRAM:</span> <span class="hljs-string">2g</span><br>  <span class="hljs-attr">events:</span>                  <span class="hljs-comment"># Provide a graphical web console for Kubernetes Events exporting, filtering and alerting in multi-tenant Kubernetes clusters.</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>         <span class="hljs-comment"># Enable or disable the KubeSphere Events System.</span><br>    <span class="hljs-attr">ruler:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">logging:</span>                 <span class="hljs-comment"># (CPU: 57 m, Memory: 2.76 G) Flexible logging functions are provided for log query, collection and management in a unified console. Additional log collectors can be added, such as Elasticsearch, Kafka and Fluentd.</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>         <span class="hljs-comment"># Enable or disable the KubeSphere Logging System.</span><br>    <span class="hljs-attr">logsidecar:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">metrics_server:</span>                    <span class="hljs-comment"># (CPU: 56 m, Memory: 44.35 MiB) It enables HPA (Horizontal Pod Autoscaler).</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>                   <span class="hljs-comment"># Enable or disable metrics-server.</span><br>  <span class="hljs-attr">monitoring:</span><br>    <span class="hljs-attr">storageClass:</span> <span class="hljs-string">&quot;&quot;</span>                 <span class="hljs-comment"># If there is an independent StorageClass you need for Prometheus, you can specify it here. The default StorageClass is used by default.</span><br>    <span class="hljs-comment"># prometheusReplicas: 1          # Prometheus replicas are responsible for monitoring different segments of data source and providing high availability.</span><br>    <span class="hljs-attr">prometheusMemoryRequest:</span> <span class="hljs-string">400Mi</span>   <span class="hljs-comment"># Prometheus request memory.</span><br>    <span class="hljs-attr">prometheusVolumeSize:</span> <span class="hljs-string">20Gi</span>       <span class="hljs-comment"># Prometheus PVC size.</span><br>    <span class="hljs-comment"># alertmanagerReplicas: 1          # AlertManager Replicas.</span><br>  <span class="hljs-attr">multicluster:</span><br>    <span class="hljs-attr">clusterRole:</span> <span class="hljs-string">none</span>  <span class="hljs-comment"># host | member | none  # You can install a solo cluster, or specify it as the Host or Member Cluster.</span><br>  <span class="hljs-attr">network:</span><br>    <span class="hljs-attr">networkpolicy:</span> <span class="hljs-comment"># Network policies allow network isolation within the same cluster, which means firewalls can be set up between certain instances (Pods).</span><br>      <span class="hljs-comment"># Make sure that the CNI network plugin used by the cluster supports NetworkPolicy. There are a number of CNI network plugins that support NetworkPolicy, including Calico, Cilium, Kube-router, Romana and Weave Net.</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># Enable or disable network policies.</span><br>    <span class="hljs-attr">ippool:</span> <span class="hljs-comment"># Use Pod IP Pools to manage the Pod network address space. Pods to be created can be assigned IP addresses from a Pod IP Pool.</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">calico</span> <span class="hljs-comment"># Specify &quot;calico&quot; for this field if Calico is used as your CNI plugin. &quot;none&quot; means that Pod IP Pools are disabled.</span><br>    <span class="hljs-attr">topology:</span> <span class="hljs-comment"># Use Service Topology to view Service-to-Service communication based on Weave Scope.</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">none</span> <span class="hljs-comment"># Specify &quot;weave-scope&quot; for this field to enable Service Topology. &quot;none&quot; means that Service Topology is disabled.</span><br>  <span class="hljs-attr">openpitrix:</span> <span class="hljs-comment"># An App Store that is accessible to all platform tenants. You can use it to manage apps across their entire lifecycle.</span><br>    <span class="hljs-attr">store:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># Enable or disable the KubeSphere App Store.</span><br>  <span class="hljs-attr">servicemesh:</span>         <span class="hljs-comment"># (0.3 Core, 300 MiB) Provide fine-grained traffic management, observability and tracing, and visualized traffic topology.</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>     <span class="hljs-comment"># Base component (pilot). Enable or disable KubeSphere Service Mesh (Istio-based).</span><br>  <span class="hljs-attr">kubeedge:</span>          <span class="hljs-comment"># Add edge nodes to your cluster and deploy workloads on edge nodes.</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>   <span class="hljs-comment"># Enable or disable KubeEdge.</span><br>    <span class="hljs-attr">cloudCore:</span><br>      <span class="hljs-attr">nodeSelector:</span> &#123;<span class="hljs-attr">&quot;node-role.kubernetes.io/worker&quot;:</span> <span class="hljs-string">&quot;&quot;</span>&#125;<br>      <span class="hljs-attr">tolerations:</span> []<br>      <span class="hljs-attr">cloudhubPort:</span> <span class="hljs-string">&quot;10000&quot;</span><br>      <span class="hljs-attr">cloudhubQuicPort:</span> <span class="hljs-string">&quot;10001&quot;</span><br>      <span class="hljs-attr">cloudhubHttpsPort:</span> <span class="hljs-string">&quot;10002&quot;</span><br>      <span class="hljs-attr">cloudstreamPort:</span> <span class="hljs-string">&quot;10003&quot;</span><br>      <span class="hljs-attr">tunnelPort:</span> <span class="hljs-string">&quot;10004&quot;</span><br>      <span class="hljs-attr">cloudHub:</span><br>        <span class="hljs-attr">advertiseAddress:</span> <span class="hljs-comment"># At least a public IP address or an IP address which can be accessed by edge nodes must be provided.</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span>            <span class="hljs-comment"># Note that once KubeEdge is enabled, CloudCore will malfunction if the address is not provided.</span><br>        <span class="hljs-attr">nodeLimit:</span> <span class="hljs-string">&quot;100&quot;</span><br>      <span class="hljs-attr">service:</span><br>        <span class="hljs-attr">cloudhubNodePort:</span> <span class="hljs-string">&quot;30000&quot;</span><br>        <span class="hljs-attr">cloudhubQuicNodePort:</span> <span class="hljs-string">&quot;30001&quot;</span><br>        <span class="hljs-attr">cloudhubHttpsNodePort:</span> <span class="hljs-string">&quot;30002&quot;</span><br>        <span class="hljs-attr">cloudstreamNodePort:</span> <span class="hljs-string">&quot;30003&quot;</span><br>        <span class="hljs-attr">tunnelNodePort:</span> <span class="hljs-string">&quot;30004&quot;</span><br>    <span class="hljs-attr">edgeWatcher:</span><br>      <span class="hljs-attr">nodeSelector:</span> &#123;<span class="hljs-attr">&quot;node-role.kubernetes.io/worker&quot;:</span> <span class="hljs-string">&quot;&quot;</span>&#125;<br>      <span class="hljs-attr">tolerations:</span> []<br>      <span class="hljs-attr">edgeWatcherAgent:</span><br>        <span class="hljs-attr">nodeSelector:</span> &#123;<span class="hljs-attr">&quot;node-role.kubernetes.io/worker&quot;:</span> <span class="hljs-string">&quot;&quot;</span>&#125;<br>        <span class="hljs-attr">tolerations:</span> []<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 应用完之后耐心等等</span><br>kubectl apply -f kubesphere-installer.yaml<br><br>kubectl apply -f cluster-configuration.yaml<br><br><span class="hljs-comment"># 添加secret</span><br>kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs  --from-file=etcd-client-ca.crt=/etc/kubernetes/pki/etcd/ca.crt  --from-file=etcd-client.crt=/etc/kubernetes/pki/apiserver-etcd-client.crt  --from-file=etcd-client.key=/etc/kubernetes/pki/apiserver-etcd-client.key<br><br><span class="hljs-comment"># 监控日志</span><br>kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l app=ks-install -o jsonpath=<span class="hljs-string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f<br><br><span class="hljs-comment"># Console: http://172.31.0.204:30880</span><br><span class="hljs-comment"># Account: admin</span><br><span class="hljs-comment"># Password: P@88w0rd</span><br><br><span class="hljs-comment"># 描述</span><br>kubectl describe pod -n pod名 命名空间<br>kubectl describe pod pod名 -n 命名空间<br></code></pre></td></tr></table></figure>
<p>集群密码: 12345Xia<br>需要开放30000-32767端口, 这个是NodePort默认端口</p>
<h3 id="2-Linux单节点部署KubeSphere"><a href="#2-Linux单节点部署KubeSphere" class="headerlink" title="2. Linux单节点部署KubeSphere"></a>2. Linux单节点部署KubeSphere</h3><blockquote>
<p>centos7.9 4C8G 配置主机名 安全组开放30000&#x2F;32767</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.kubesphere.io/zh/docs/v3.3/quick-start/all-in-one-on-linux/">官方文档</a></p>
<h4 id="准备kubeKey"><a href="#准备kubeKey" class="headerlink" title="准备kubeKey"></a>准备kubeKey</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 设置一下主机名</span><br>hostnamectl set-hostname node1<br><br><span class="hljs-built_in">export</span> KKZONE=cn<br><br>curl -sfL https://get-kk.kubesphere.io | VERSION=v3.0.7 sh -<br><br><span class="hljs-built_in">chmod</span> +x kk<br></code></pre></td></tr></table></figure>
<h4 id="使用KubeKey引导安装集群"><a href="#使用KubeKey引导安装集群" class="headerlink" title="使用KubeKey引导安装集群"></a>使用KubeKey引导安装集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">./kk create cluster --with-kubernetes v1.22.12 --with-kubesphere v3.3.2<br><br><span class="hljs-comment"># 中间输入一下yes</span><br><span class="hljs-built_in">yes</span><br><br><span class="hljs-comment"># 验证结果</span><br>kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l <span class="hljs-string">&#x27;app in (ks-install, ks-installer)&#x27;</span> -o jsonpath=<span class="hljs-string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f<br><br></code></pre></td></tr></table></figure>
<p>如果见到如下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">10:41:13 CST [ERRO] node1: conntrack is required.<br>10:41:13 CST [ERRO] node1: socat is required.<br><br><span class="hljs-comment"># 请先安装conntrack, socat, 缺什么安装什么, 安装完成之后再执行kk脚本</span><br>yum install -y conntrack<br>yum install -y socat<br></code></pre></td></tr></table></figure>

<p>安装完成之后出现</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs clean">#####################################################<br>###              Welcome to KubeSphere!           ###<br>#####################################################<br><br>Console: http:<span class="hljs-comment">//172.31.0.2:30880</span><br>Account: admin<br>Password: P@<span class="hljs-number">88</span>w0rd<br>NOTES：<br>  <span class="hljs-number">1.</span> After you log into the console, please check the<br>     monitoring status <span class="hljs-keyword">of</span> service components <span class="hljs-keyword">in</span><br>     <span class="hljs-string">&quot;Cluster Management&quot;</span>. If any service is not<br>     ready, please wait patiently until all components <br>     are up and running.<br>  <span class="hljs-number">2.</span> Please change the default password after login.<br><br>#####################################################<br>https:<span class="hljs-comment">//kubesphere.io             2023-05-21 12:04:23</span><br>#####################################################<br><span class="hljs-number">12</span>:<span class="hljs-number">04</span>:<span class="hljs-number">24</span> CST success: [node1]<br><span class="hljs-number">12</span>:<span class="hljs-number">04</span>:<span class="hljs-number">24</span> CST Pipeline[CreateClusterPipeline] execute successfully<br>Installation is complete.<br><br>Please check the result using the command:<br><br>        kubectl logs -n kubesphere-<span class="hljs-keyword">system</span> $(kubectl get pod -n kubesphere-<span class="hljs-keyword">system</span> -l <span class="hljs-string">&#x27;app in (ks-install, ks-installer)&#x27;</span> -o jsonpath=<span class="hljs-string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f<br></code></pre></td></tr></table></figure>
<p>这种方式安装是最小安装, 如果想开启其他功能可以在自定义资源进行开启<br><img src="/assets/b6c9eea929b8422190a6cdcc0fe247bb.png" srcset="/img/loading.gif" lazyload></p>
<p>另外遇到的一个bug</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用kk脚本之后, 出现的recognize &quot;/etc/kubernetes/network-plugin.yaml&quot;</span><br>error: unable to recognize <span class="hljs-string">&quot;/etc/kubernetes/network-plugin.yaml&quot;</span>: no matches <span class="hljs-keyword">for</span> kind <span class="hljs-string">&quot;PodDisruptionBudget&quot;</span> <span class="hljs-keyword">in</span> version <span class="hljs-string">&quot;policy/v1&quot;</span><br><br><span class="hljs-comment"># 额, 其实我也不知道怎么解决, github找的一个issue, 但是不会解决</span><br><span class="hljs-comment"># https://github.com/kubesphere/kubesphere/issues/5272</span><br><span class="hljs-comment"># 卸载kubenetes(光卸载还不够, 最好还是重装系统), 参考官方文档重新安装吧</span><br><span class="hljs-comment"># https://www.kubesphere.io/zh/docs/v3.3/quick-start/all-in-one-on-linux/</span><br><br></code></pre></td></tr></table></figure>
<h3 id="3-Linux多节点部署KubeSphere"><a href="#3-Linux多节点部署KubeSphere" class="headerlink" title="3. Linux多节点部署KubeSphere"></a>3. Linux多节点部署KubeSphere</h3><p><a target="_blank" rel="noopener" href="https://www.kubesphere.io/zh/docs/v3.3/installing-on-linux/introduction/multioverview/">多节点安装</a></p>
<blockquote>
<p>两台centos7.9 2C4G(没钱了) 配置主机名 安全组开放30000&#x2F;32767</p>
</blockquote>
<h4 id="准备kubeKey-1"><a href="#准备kubeKey-1" class="headerlink" title="准备kubeKey"></a>准备kubeKey</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 设置一下主机名</span><br>hostnamectl set-hostname master<br>hostnamectl set-hostname node1<br><br><span class="hljs-comment"># master节点执行</span><br><span class="hljs-built_in">export</span> KKZONE=cn<br><br>curl -sfL https://get-kk.kubesphere.io | VERSION=v3.0.7 sh -<br><br><span class="hljs-built_in">chmod</span> +x kk<br></code></pre></td></tr></table></figure>
<h4 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 指定kubernetes和kubesphere版本</span><br>./kk create config --with-kubernetes v1.22.12 --with-kubesphere v3.3.2<br></code></pre></td></tr></table></figure>
<h4 id="编辑配置文件"><a href="#编辑配置文件" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h4><p>vi config-sample.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br>apiVersion: kubekey.kubesphere.io/v1alpha2<br>kind: Cluster<br>metadata:<br>  name: sample<br>spec:<br>  hosts:<br>  - &#123;name: master, address: 172.31.0.2, internalAddress: 172.31.0.2, user: root, password: <span class="hljs-string">&quot;12345@Xia&quot;</span>&#125;<br>  - &#123;name: node1, address: 172.31.0.3, internalAddress: 172.31.0.3, user: root, password: <span class="hljs-string">&quot;12345@Xia&quot;</span>&#125;<br>  roleGroups:<br>    etcd:<br>    - master<br>    control-plane: <br>    - master<br>    worker:<br>    - master<br>    - node1<br>  controlPlaneEndpoint:<br>    <span class="hljs-comment">## Internal loadbalancer for apiservers </span><br>    <span class="hljs-comment"># internalLoadbalancer: haproxy</span><br><br>    domain: lb.kubesphere.local<br>    address: <span class="hljs-string">&quot;&quot;</span><br>    port: 6443<br>  kubernetes:<br>    version: v1.22.12<br>    clusterName: cluster.local<br>    autoRenewCerts: <span class="hljs-literal">true</span><br>    containerManager: docker<br>  etcd:<br>    <span class="hljs-built_in">type</span>: kubekey<br>  network:<br>    plugin: calico<br>    kubePodsCIDR: 10.233.64.0/18<br>    kubeServiceCIDR: 10.233.0.0/18<br>    <span class="hljs-comment">## multus support. https://github.com/k8snetworkplumbingwg/multus-cni</span><br>    multusCNI:<br>      enabled: <span class="hljs-literal">false</span><br>  registry:<br>    privateRegistry: <span class="hljs-string">&quot;&quot;</span><br>    namespaceOverride: <span class="hljs-string">&quot;&quot;</span><br>    registryMirrors: []<br>    insecureRegistries: []<br>  addons: []<br><br><br><br>---<br>apiVersion: installer.kubesphere.io/v1alpha1<br>kind: ClusterConfiguration<br>metadata:<br>  name: ks-installer<br>  namespace: kubesphere-system<br>  labels:<br>    version: v3.3.2<br>spec:<br>  persistence:<br>    storageClass: <span class="hljs-string">&quot;&quot;</span><br>  authentication:<br>    jwtSecret: <span class="hljs-string">&quot;&quot;</span><br>  zone: <span class="hljs-string">&quot;&quot;</span><br>  local_registry: <span class="hljs-string">&quot;&quot;</span><br>  namespace_override: <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-comment"># dev_tag: &quot;&quot;</span><br>  etcd:<br>    monitoring: <span class="hljs-literal">false</span><br>    endpointIps: localhost<br>    port: 2379<br>    tlsEnable: <span class="hljs-literal">true</span><br>  common:<br>    core:<br>      console:<br>        enableMultiLogin: <span class="hljs-literal">true</span><br>        port: 30880<br>        <span class="hljs-built_in">type</span>: NodePort<br>    <span class="hljs-comment"># apiserver:</span><br>    <span class="hljs-comment">#  resources: &#123;&#125;</span><br>    <span class="hljs-comment"># controllerManager:</span><br>    <span class="hljs-comment">#  resources: &#123;&#125;</span><br>    redis:<br>      enabled: <span class="hljs-literal">false</span><br>      volumeSize: 2Gi<br>    openldap:<br>      enabled: <span class="hljs-literal">false</span><br>      volumeSize: 2Gi<br>    minio:<br>      volumeSize: 20Gi<br>    monitoring:<br>      <span class="hljs-comment"># type: external</span><br>      endpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090<br>      GPUMonitoring:<br>        enabled: <span class="hljs-literal">false</span><br>    gpu:<br>      kinds:<br>      - resourceName: <span class="hljs-string">&quot;nvidia.com/gpu&quot;</span><br>        resourceType: <span class="hljs-string">&quot;GPU&quot;</span><br>        default: <span class="hljs-literal">true</span><br>    es:<br>      <span class="hljs-comment"># master:</span><br>      <span class="hljs-comment">#   volumeSize: 4Gi</span><br>      <span class="hljs-comment">#   replicas: 1</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>      <span class="hljs-comment"># data:</span><br>      <span class="hljs-comment">#   volumeSize: 20Gi</span><br>      <span class="hljs-comment">#   replicas: 1</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>      logMaxAge: 7<br>      elkPrefix: logstash<br>      basicAuth:<br>        enabled: <span class="hljs-literal">false</span><br>        username: <span class="hljs-string">&quot;&quot;</span><br>        password: <span class="hljs-string">&quot;&quot;</span><br>      externalElasticsearchHost: <span class="hljs-string">&quot;&quot;</span><br>      externalElasticsearchPort: <span class="hljs-string">&quot;&quot;</span><br>  alerting:<br>    enabled: <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># thanosruler:</span><br>    <span class="hljs-comment">#   replicas: 1</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  auditing:<br>    enabled: <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># operator:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># webhook:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  devops:<br>    enabled: <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># resources: &#123;&#125;</span><br>    jenkinsMemoryLim: 8Gi<br>    jenkinsMemoryReq: 4Gi<br>    jenkinsVolumeSize: 8Gi<br>  events:<br>    enabled: <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># operator:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># exporter:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># ruler:</span><br>    <span class="hljs-comment">#   enabled: true</span><br>    <span class="hljs-comment">#   replicas: 2</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  logging:<br>    enabled: <span class="hljs-literal">false</span><br>    logsidecar:<br>      enabled: <span class="hljs-literal">true</span><br>      replicas: 2<br>      <span class="hljs-comment"># resources: &#123;&#125;</span><br>  metrics_server:<br>    enabled: <span class="hljs-literal">false</span><br>  monitoring:<br>    storageClass: <span class="hljs-string">&quot;&quot;</span><br>    node_exporter:<br>      port: 9100<br>      <span class="hljs-comment"># resources: &#123;&#125;</span><br>    <span class="hljs-comment"># kube_rbac_proxy:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># kube_state_metrics:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># prometheus:</span><br>    <span class="hljs-comment">#   replicas: 1</span><br>    <span class="hljs-comment">#   volumeSize: 20Gi</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment">#   operator:</span><br>    <span class="hljs-comment">#     resources: &#123;&#125;</span><br>    <span class="hljs-comment"># alertmanager:</span><br>    <span class="hljs-comment">#   replicas: 1</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment"># notification_manager:</span><br>    <span class="hljs-comment">#   resources: &#123;&#125;</span><br>    <span class="hljs-comment">#   operator:</span><br>    <span class="hljs-comment">#     resources: &#123;&#125;</span><br>    <span class="hljs-comment">#   proxy:</span><br>    <span class="hljs-comment">#     resources: &#123;&#125;</span><br>    gpu:<br>      nvidia_dcgm_exporter:<br>        enabled: <span class="hljs-literal">false</span><br>        <span class="hljs-comment"># resources: &#123;&#125;</span><br>  multicluster:<br>    clusterRole: none<br>  network:<br>    networkpolicy:<br>      enabled: <span class="hljs-literal">false</span><br>    ippool:<br>      <span class="hljs-built_in">type</span>: none<br>    topology:<br>      <span class="hljs-built_in">type</span>: none<br>  openpitrix:<br>    store:<br>      enabled: <span class="hljs-literal">false</span><br>  servicemesh:<br>    enabled: <span class="hljs-literal">false</span><br>    istio:<br>      components:<br>        ingressGateways:<br>        - name: istio-ingressgateway<br>          enabled: <span class="hljs-literal">false</span><br>        cni:<br>          enabled: <span class="hljs-literal">false</span><br>  edgeruntime:<br>    enabled: <span class="hljs-literal">false</span><br>    kubeedge:<br>      enabled: <span class="hljs-literal">false</span><br>      cloudCore:<br>        cloudHub:<br>          advertiseAddress:<br>            - <span class="hljs-string">&quot;&quot;</span><br>        service:<br>          cloudhubNodePort: <span class="hljs-string">&quot;30000&quot;</span><br>          cloudhubQuicNodePort: <span class="hljs-string">&quot;30001&quot;</span><br>          cloudhubHttpsNodePort: <span class="hljs-string">&quot;30002&quot;</span><br>          cloudstreamNodePort: <span class="hljs-string">&quot;30003&quot;</span><br>          tunnelNodePort: <span class="hljs-string">&quot;30004&quot;</span><br>        <span class="hljs-comment"># resources: &#123;&#125;</span><br>        <span class="hljs-comment"># hostNetWork: false</span><br>      iptables-manager:<br>        enabled: <span class="hljs-literal">true</span><br>        mode: <span class="hljs-string">&quot;external&quot;</span><br>        <span class="hljs-comment"># resources: &#123;&#125;</span><br>      <span class="hljs-comment"># edgeService:</span><br>      <span class="hljs-comment">#   resources: &#123;&#125;</span><br>  terminal:<br>    <span class="hljs-built_in">timeout</span>: 600<br><br><br><br></code></pre></td></tr></table></figure>
<p><img src="/assets/7bece05b9fcb44ca99f59d42862d69d5.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="使用配置文件创建集群"><a href="#使用配置文件创建集群" class="headerlink" title="使用配置文件创建集群"></a>使用配置文件创建集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 这个只需要在master节点上安装就可以了</span><br>./kk create cluster -f config-sample.yaml<br><br><span class="hljs-comment"># 中途输入yes</span><br><span class="hljs-built_in">yes</span><br><br><span class="hljs-comment"># 然后耐心等等， 大概十多分钟</span><br><br><span class="hljs-comment"># 缺什么安装什么</span><br>12:36:51 CST [ERRO] master: conntrack is required.<br>12:36:51 CST [ERRO] master: socat is required.<br>12:36:51 CST [ERRO] node1: conntrack is required.<br>12:36:51 CST [ERRO] node1: socat is required.<br><br><span class="hljs-comment"># 每个节点都安装</span><br>yum install -y conntrack<br>yum install -y socat<br></code></pre></td></tr></table></figure>
<p>见到这一段就说明安装成功了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#####################################################</span><br><span class="hljs-comment">###              Welcome to KubeSphere!           ###</span><br><span class="hljs-comment">#####################################################</span><br><br>Console: http://172.31.0.2:30880<br>Account: admin<br>Password: P@88w0rd<br>NOTES：<br>  1. After you <span class="hljs-built_in">log</span> into the console, please check the<br>     monitoring status of service components <span class="hljs-keyword">in</span><br>     <span class="hljs-string">&quot;Cluster Management&quot;</span>. If any service is not<br>     ready, please <span class="hljs-built_in">wait</span> patiently until all components <br>     are up and running.<br>  2. Please change the default password after login.<br><br><span class="hljs-comment">#####################################################</span><br>https://kubesphere.io             2023-05-21 12:04:23<br><span class="hljs-comment">#####################################################</span><br>12:04:24 CST success: [node1]<br>12:04:24 CST Pipeline[CreateClusterPipeline] execute successfully<br>Installation is complete.<br><br>Please check the result using the <span class="hljs-built_in">command</span>:<br><br>        kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l <span class="hljs-string">&#x27;app in (ks-install, ks-installer)&#x27;</span> -o jsonpath=<span class="hljs-string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f<br></code></pre></td></tr></table></figure>
<p>访问一下30880端口<br><img src="/assets/c8292999e3184419950f4940636d1999.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="多租户系统实战"><a href="#多租户系统实战" class="headerlink" title="多租户系统实战"></a>多租户系统实战</h2><p><img src="/assets/ed15bb064c6e46f99efd24ce63bc9e0a.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="中间件部署实战"><a href="#中间件部署实战" class="headerlink" title="中间件部署实战"></a>中间件部署实战</h2><blockquote>
<p>应用部署需要关注的信息【应用部署三要素】<br>1、应用的部署方式<br>2、应用的数据挂载（数据，配置文件）<br>3、应用的可访问性</p>
</blockquote>
<p><img src="/assets/10c6c1bce91446f9bc906a5906d9ff1d.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="部署MySQL"><a href="#部署MySQL" class="headerlink" title="部署MySQL"></a>部署MySQL</h3><h4 id="mysql容器启动"><a href="#mysql容器启动" class="headerlink" title="mysql容器启动"></a>mysql容器启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -p 3306:3306 --name mysql-01 \<br>-v /mydata/mysql/log:/var/log/mysql \<br>-v /mydata/mysql/data:/var/lib/mysql \<br>-v /mydata/mysql/conf:/etc/mysql/conf.d \<br>-e MYSQL_ROOT_PASSWORD=root \<br>--restart=always \<br>-d mysql:5.7 <br></code></pre></td></tr></table></figure>
<h4 id="mysql配置示例"><a href="#mysql配置示例" class="headerlink" title="mysql配置示例"></a>mysql配置示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">[client]<br>default-character-set=utf8mb4<br> <br>[mysql]<br>default-character-set=utf8mb4<br> <br>[mysqld]<br>init_connect=<span class="hljs-string">&#x27;SET collation_connection = utf8mb4_unicode_ci&#x27;</span><br>init_connect=<span class="hljs-string">&#x27;SET NAMES utf8mb4&#x27;</span><br>character-set-server=utf8mb4<br>collation-server=utf8mb4_unicode_ci<br>skip-character-set-client-handshake<br>skip-name-resolve<br>lower_case_table_names=1<br></code></pre></td></tr></table></figure>
<h4 id="mysql部署分析"><a href="#mysql部署分析" class="headerlink" title="mysql部署分析"></a>mysql部署分析</h4><p><img src="/assets/006d4ec02fc34aefb058cae16a826797.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>1、集群内部，直接通过应用的  【服务名.项目名】 直接访问<br>        mysql -uroot -h<strong>his-mysql-glgf.his</strong> -p<br>2、集群外部，</p>
</blockquote>
<p><img src="/assets/938aecd6d7664dffb9b817b505afc6ed.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><p>创建mysql容器<br>创建配置文件<br><img src="/assets/153cdf8c2605429eaddedc01c1cbad18.png" srcset="/img/loading.gif" lazyload><br>键是配置文件的名称<br>值是配置文件的内容<br><img src="/assets/66da06d9b28c42d8874760488a25afd8.png" srcset="/img/loading.gif" lazyload><br>持久卷的声明<br><img src="/assets/09f7b70d90474f0d825a9d2c28642cc0.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/48cb101e260f488681c0c5c94ca3b152.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/67ce5e728b6f4dfeba54627fd3c5ae4f.png" srcset="/img/loading.gif" lazyload><br>工作负载<br><img src="/assets/b5704269a0bf44e2af99ea229326f8fc.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/99ebbb14af89483a99871ab63b75dbb1.png" srcset="/img/loading.gif" lazyload></p>
<p>配置一个环境变量<br><code>MYSQL_ROOT_PASSWORD</code><br><code>123456</code><br><img src="/assets/e9776f16b5c74c45976f11391ada36c1.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/016c5f633b53418f9139821d2c223d5b.png" srcset="/img/loading.gif" lazyload><br>读写<code>/var/lib/mysql</code><br><img src="/assets/808f59570d474c11aa4568f8573fe1f3.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/28acf0befb354679bc6497d2859af399.png" srcset="/img/loading.gif" lazyload><br>只读<code>/etc/mysql/conf.d</code><br><img src="/assets/f28ac29da567457d9ea376de185d8c1c.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/b791571395df4f828437fd274e41befe.png" srcset="/img/loading.gif" lazyload></p>
<p>登录mysql<br><img src="/assets/3ba0fd6544b749adbd2040ca98749fc5.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/8519cf6403674f7b8038a07d70379db6.png" srcset="/img/loading.gif" lazyload></p>
<p>查看命名空间<br><img src="/assets/af1d2fb432984a848b766144d2e4a5a2.png" srcset="/img/loading.gif" lazyload></p>
<p>因为自动生成的服务会出现suxm这几个随机的字符, 所以我们可以手动创建服务<br><img src="/assets/056b04c5da2243eea5b5895744f53c57.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/bb85ecb218c34cf998f53025c25a6e80.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/fd1f4fd5ef39464d901a7ccaa978b751.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/d2faa4a2cc9a4d218b0ea6c8af7f8649.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/3950ed52bdc94e7497ebb76ebbea3bb2.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/34ad9f4e2cc04f2cbf3f9a256be9bce4.png" srcset="/img/loading.gif" lazyload><br>刚刚是采用的内部域名创建的, 这次采用虚拟IP的方式创建<br><img src="/assets/bb35ceca35f149159a4ec50c6e9eb551.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/563acd2b837d43e4aed2b254b82c5094.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/d95ad954f0dc41ae91ca1a4c4c357aff.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/3e429a26baa84bd597329a66608a597a.png" srcset="/img/loading.gif" lazyload><br>之后会暴露一个端口, 只用IP加端口就可以连接上mysql了<br><img src="/assets/ed2ad053235a4ba1a11cbccf3aaf8e68.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="部署Redis"><a href="#部署Redis" class="headerlink" title="部署Redis"></a>部署Redis</h3><h4 id="redis容器启动"><a href="#redis容器启动" class="headerlink" title="redis容器启动"></a>redis容器启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建配置文件</span><br><span class="hljs-comment">## 1、准备redis配置文件内容</span><br><span class="hljs-built_in">mkdir</span> -p /mydata/redis/conf &amp;&amp; vim /mydata/redis/conf/redis.conf<br><br><br><span class="hljs-comment">##配置示例</span><br>appendonly <span class="hljs-built_in">yes</span><br>port 6379<br><span class="hljs-built_in">bind</span> 0.0.0.0<br><br><br><span class="hljs-comment">#docker启动redis</span><br>docker run -d -p 6379:6379 --restart=always \<br>-v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf \<br>-v  /mydata/redis-01/data:/data \<br> --name redis-01 redis:6.2.5 \<br> redis-server /etc/redis/redis.conf<br></code></pre></td></tr></table></figure>
<h4 id="redis部署分析"><a href="#redis部署分析" class="headerlink" title="redis部署分析"></a>redis部署分析</h4><p><img src="/assets/9ff28ccf73e6448fa8b3ce4b24be376e.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h4><p>创建配置<br><img src="/assets/b4461f2d3bda4b1db208845a5f79a599.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/d12e1c6342c044f087585da99fc7eb37.png" srcset="/img/loading.gif" lazyload><br>创建工作负载<br><img src="/assets/a1045c2b2bc94240ac3c37f5464b77b8.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/79582f0ab47b45d9ae50837b442c9c26.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/fc27b12239924ec28edfb806f62bf055.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/ec621cd46b0547ee8ecff557afc8fbf9.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/c47374866f1044138b5ce1b0d3a10e5e.png" srcset="/img/loading.gif" lazyload><br>命令<code>redis-server</code><br>参数<code>/etc/redis/redis.conf</code><br><img src="/assets/acc9e368b52a444480c5a0ce00be45a2.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/7da2ef78ded64f9181c313845b8ccb5b.png" srcset="/img/loading.gif" lazyload><br>然后创建存储卷<br><img src="/assets/52e65d42d3234254b25445b264e44e1a.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/ef1cce12af1f4719993ad617918f21eb.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/1da8a3780caf4b4b92577d065f2ac65b.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/8ce7e272686941e0bbec16725a311d2f.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/c4eff4837711400c8dfd7b7bd269ccd7.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/6961f1e0cfbc4874a6e0f15d644d13f5.png" srcset="/img/loading.gif" lazyload><br>查看一下容器内的配置文件是否加载进去了<br><img src="/assets/5fbfe14e94cf4da2bd499fedc3eade61.png" srcset="/img/loading.gif" lazyload><br>当然也可以自己手动创建服务, 因为自动生成会多几个字符<br><img src="/assets/df36c8a02d35469c919fa3fc235cdfbc.png" srcset="/img/loading.gif" lazyload><br>删除刚刚创建出来的redis服务<br><img src="/assets/fe829d54a833481cbe37a810d0a249e1.png" srcset="/img/loading.gif" lazyload><br>然后创建, 指定工作负载<br><img src="/assets/31103416f88945a9bf8135a96696b0c1.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/d3fbb0bab1ef4a73950ec6317ac3e54c.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/1c998cabfd5344e99225c6da15f22b7e.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/c360ccc4da60432887e624db3b7c89b9.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/28f5c4167b40426ca975e373c4ed80c1.png" srcset="/img/loading.gif" lazyload><br>刚刚创建的是内部网络, 这次来创建虚拟IP地址访问<br><img src="/assets/d4c30781cbe842ef93f74c80b81b936a.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/b084a843c85648589ffd520ce24beeac.png" srcset="/img/loading.gif" lazyload><br>记得勾选外部访问<br><img src="/assets/1bf9925f4cbf4f6a9273ab5117c66bd0.png" srcset="/img/loading.gif" lazyload><br>之后会暴露出来一个端口, 可以使用该端口进行外部远程连接redis<br><img src="/assets/e0a28305b796462e920e2abe138a6412.png" srcset="/img/loading.gif" lazyload><br>将redis的副本数量修改成3, 然后可以发现存储卷的数量也变成了3份<br><img src="/assets/b0fd367d19154d1d8c805a2a3f711575.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/996a9a8388e5457d98da1bf29700b6f7.png" srcset="/img/loading.gif" lazyload><br>当调整mysql副本数量, 存储卷仍然是1个, 这是因为mysql的存储卷是事先创建出来, 而不是创建服务时创建的存储卷, 当调整了副本的数量, 存储卷的数量也不会发生变化<br>一般来说都是在创建服务指定工作负载的时候来创建一个新的存储卷, 而不是事先创建一个存储卷<br><img src="/assets/b31ca872afb44b619908bace1e91041a.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/942282d616fa40fdbae40e74ab30ffba.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="部署ElasticSearch"><a href="#部署ElasticSearch" class="headerlink" title="部署ElasticSearch"></a>部署ElasticSearch</h3><h4 id="es容器启动"><a href="#es容器启动" class="headerlink" title="es容器启动"></a>es容器启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建数据目录</span><br><span class="hljs-built_in">mkdir</span> -p /mydata/es-01 &amp;&amp; <span class="hljs-built_in">chmod</span> 777 -R /mydata/es-01<br><br><span class="hljs-comment"># 容器启动</span><br>docker run --restart=always -d -p 9200:9200 -p 9300:9300 \<br>-e <span class="hljs-string">&quot;discovery.type=single-node&quot;</span> \<br>-e ES_JAVA_OPTS=<span class="hljs-string">&quot;-Xms512m -Xmx512m&quot;</span> \<br>-v es-config:/usr/share/elasticsearch/config \<br>-v /mydata/es-01/data:/usr/share/elasticsearch/data \<br>--name es-01 \<br>elasticsearch:7.13.4<br></code></pre></td></tr></table></figure>
<h4 id="es部署分析"><a href="#es部署分析" class="headerlink" title="es部署分析"></a>es部署分析</h4><p><img src="/assets/5858f2532a0648bcaeb9a16c35e2c9f7.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>注意： 子路径挂载，配置修改后，k8s不会对其Pod内的相关配置文件进行热更新，需要自己重启Pod</p>
</blockquote>
<h4 id="应用商店"><a href="#应用商店" class="headerlink" title="应用商店"></a>应用商店</h4><blockquote>
<p>可以使用 dev-zhao 登录，从应用商店部署</p>
</blockquote>
<h4 id="应用仓库"><a href="#应用仓库" class="headerlink" title="应用仓库"></a>应用仓库</h4><blockquote>
<p>使用企业空间管理员（wuhan-boss）登录，设置应用仓库</p>
</blockquote>
<blockquote>
<p>学习Helm即可，去helm的应用市场添加一个仓库地址，比如：bitnami</p>
</blockquote>
<h4 id="部署-2"><a href="#部署-2" class="headerlink" title="部署"></a>部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 只需要在node1上执行一下就行了, 其实一会也会手动删除这个容器</span><br><br><span class="hljs-comment"># 创建数据目录</span><br><span class="hljs-built_in">mkdir</span> -p /mydata/es-01 &amp;&amp; <span class="hljs-built_in">chmod</span> 777 -R /mydata/es-01<br><br><span class="hljs-comment"># 容器启动</span><br>docker run --restart=always -d -p 9200:9200 -p 9300:9300 \<br>-e <span class="hljs-string">&quot;discovery.type=single-node&quot;</span> \<br>-e ES_JAVA_OPTS=<span class="hljs-string">&quot;-Xms512m -Xmx512m&quot;</span> \<br>-v es-config:/usr/share/elasticsearch/config \<br>-v /mydata/es-01/data:/usr/share/elasticsearch/data \<br>--name es-01 \<br>elasticsearch:7.13.4<br><br><span class="hljs-comment"># 查看</span><br>docker ps | grep es-01<br><br><span class="hljs-comment"># 再给次权限</span><br><span class="hljs-built_in">chmod</span> 777 -R /mydata/es-01<br><br><span class="hljs-comment"># 进入容器</span><br>docker <span class="hljs-built_in">exec</span> -it es-01 /bin/bash<br><br><span class="hljs-built_in">pwd</span><br><span class="hljs-comment"># /usr/share/elasticsearch</span><br><br><span class="hljs-built_in">cd</span> config/<br><span class="hljs-comment"># elasticsearch.keystore  jvm.options    log4j2.file.properties  role_mapping.yml  users</span><br><span class="hljs-comment"># elasticsearch.yml       jvm.options.d  log4j2.properties       roles.yml         users_roles</span><br><br><span class="hljs-built_in">cat</span> elasticsearch.yml<br>cluster.name: <span class="hljs-string">&quot;docker-cluster&quot;</span><br>network.host: 0.0.0.0<br><br><span class="hljs-built_in">cat</span> jvm.options<br><span class="hljs-comment">################################################################</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## JVM configuration</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">################################################################</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## WARNING: DO NOT EDIT THIS FILE. If you want to override the</span><br><span class="hljs-comment">## JVM options in this file, or set any additional options, you</span><br><span class="hljs-comment">## should create one or more files in the jvm.options.d</span><br><span class="hljs-comment">## directory containing your adjustments.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## See https://www.elastic.co/guide/en/elasticsearch/reference/current/jvm-options.html</span><br><span class="hljs-comment">## for more information.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">################################################################</span><br><br><br><br><span class="hljs-comment">################################################################</span><br><span class="hljs-comment">## IMPORTANT: JVM heap size</span><br><span class="hljs-comment">################################################################</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## The heap size is automatically configured by Elasticsearch</span><br><span class="hljs-comment">## based on the available memory in your system and the roles</span><br><span class="hljs-comment">## each node is configured to fulfill. If specifying heap is</span><br><span class="hljs-comment">## required, it should be done through a file in jvm.options.d,</span><br><span class="hljs-comment">## and the min and max should be set to the same value. For</span><br><span class="hljs-comment">## example, to set the heap to 4 GB, create a new file in the</span><br><span class="hljs-comment">## jvm.options.d directory containing these lines:</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## -Xms4g</span><br><span class="hljs-comment">## -Xmx4g</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## See https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</span><br><span class="hljs-comment">## for more information</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">################################################################</span><br><br><br><span class="hljs-comment">################################################################</span><br><span class="hljs-comment">## Expert settings</span><br><span class="hljs-comment">################################################################</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">## All settings below here are considered expert settings. Do</span><br><span class="hljs-comment">## not adjust them unless you understand what you are doing. Do</span><br><span class="hljs-comment">## not edit them in this file; instead, create a new file in the</span><br><span class="hljs-comment">## jvm.options.d directory containing your adjustments.</span><br><span class="hljs-comment">##</span><br><span class="hljs-comment">################################################################</span><br><br><span class="hljs-comment">## GC configuration</span><br>8-13:-XX:+UseConcMarkSweepGC<br>8-13:-XX:CMSInitiatingOccupancyFraction=75<br>8-13:-XX:+UseCMSInitiatingOccupancyOnly<br><br><span class="hljs-comment">## G1GC Configuration</span><br><span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> G1 GC is only supported on JDK version 10 or later</span><br><span class="hljs-comment"># to use G1GC, uncomment the next two lines and update the version on the</span><br><span class="hljs-comment"># following three lines to your version of the JDK</span><br><span class="hljs-comment"># 10-13:-XX:-UseConcMarkSweepGC</span><br><span class="hljs-comment"># 10-13:-XX:-UseCMSInitiatingOccupancyOnly</span><br>14-:-XX:+UseG1GC<br><br><span class="hljs-comment">## JVM temporary directory</span><br>-Djava.io.tmpdir=<span class="hljs-variable">$&#123;ES_TMPDIR&#125;</span><br><br><span class="hljs-comment">## heap dumps</span><br><br><span class="hljs-comment"># generate a heap dump when an allocation from the Java heap fails; heap dumps</span><br><span class="hljs-comment"># are created in the working directory of the JVM unless an alternative path is</span><br><span class="hljs-comment"># specified</span><br>-XX:+HeapDumpOnOutOfMemoryError<br><br><span class="hljs-comment"># specify an alternative path for heap dumps; ensure the directory exists and</span><br><span class="hljs-comment"># has sufficient space</span><br>-XX:HeapDumpPath=data<br><br><span class="hljs-comment"># specify an alternative path for JVM fatal error logs</span><br>-XX:ErrorFile=logs/hs_err_pid%p.log<br><br><span class="hljs-comment">## JDK 8 GC logging</span><br>8:-XX:+PrintGCDetails<br>8:-XX:+PrintGCDateStamps<br>8:-XX:+PrintTenuringDistribution<br>8:-XX:+PrintGCApplicationStoppedTime<br>8:-Xloggc:logs/gc.log<br>8:-XX:+UseGCLogFileRotation<br>8:-XX:NumberOfGCLogFiles=32<br>8:-XX:GCLogFileSize=64m<br><br><span class="hljs-comment"># JDK 9+ GC logging</span><br>9-:-Xlog:gc*,gc+age=trace,safepoint:file=logs/gc.log:utctime,pid,tags:filecount=32,filesize=64m<br><br><br></code></pre></td></tr></table></figure>

<p>创建一个管理员账户<br><img src="/assets/6fad754af467464dafec747a1cf86ea4.png" srcset="/img/loading.gif" lazyload><br>然后将管理员拉进企业空间<br><img src="/assets/a78a84c942244508bd96f9166ca3b75a.png" srcset="/img/loading.gif" lazyload><br>创建es配置文件<br><img src="/assets/2f1f303b3d7449a7929fdb21f6d2efd6.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/9393eef2f8d74ae7a8120a665f3cc9bf.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/b1582595da2e47c2a7b934c8642cbb10.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/3f6ae8588faa4e699ea11f9700c85f31.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/811912cb7c544a22bfd955fbdd3edeab.png" srcset="/img/loading.gif" lazyload><br>版本填写<code>elasticsearch:7.13.4</code><br><img src="/assets/8e9c755cad1f4482bfac20c8332e1d5b.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/e6a1fb9d5040432cb40811e3e84718a3.png" srcset="/img/loading.gif" lazyload><br><code>discovery.type</code> <code>single-node</code><br><code>ES_JAVA_OPTS</code> <code>-Xms512m -Xmx512m</code><br><img src="/assets/47357ad04a994ffdbb3ae75d620c35cd.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/2b85a7a8354d433e915e69d262f2a2be.png" srcset="/img/loading.gif" lazyload><br><code>/usr/share/elasticsearch/config/elasticsearch.yml</code><br><img src="/assets/578be5e4ffcb45b582fae57d0ab98f1e.png" srcset="/img/loading.gif" lazyload><br><code>/usr/share/elasticsearch/config/jvm.options</code><br><img src="/assets/2c3f6a1a0c3d48db9ae2bab8c38c2282.png" srcset="/img/loading.gif" lazyload><br>不知道kubesphere哪里抽风了, 这里没有选择创建pvc模板, 只好先提前创建一个pvc了, 或者直接使用临时的pvc</p>
<blockquote>
<p>如果有添加存储模板, 就选择添加存储模板<br><code>/usr/share/elasticsearch/data</code></p>
</blockquote>
<p><img src="/assets/69efe8fdc10f45348dd272815b78cc97.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 服务创建完成之后就可以删除这个容器了</span><br>docker ps | grep es-01<br><br>docker <span class="hljs-built_in">rm</span> -f es-01<br><br><span class="hljs-comment"># 之后kubesphere会自己创建一个 </span><br><br><br></code></pre></td></tr></table></figure>
<p><img src="/assets/3df9ca1abde04999b088683b2fbcd9f2.png" srcset="/img/loading.gif" lazyload><br>创建工作负载<br><img src="/assets/9c1af19e318b4eb0a9d9a4b519a2024a.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/15c3fd44f42e46d2add818b12966e81d.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/51681a418f714dca95dbbc0b2b2ee4f3.png" srcset="/img/loading.gif" lazyload><br>创建外网访问的的NodeIP<br><img src="/assets/8f18ab52ca5143f2bdbb556ea9309892.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/32b00db2e40a42a6ab62aee7901f6d82.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/9f7d68f279c74a13bcff9a35ad94770b.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/053ebdc0a90549f4ac70e6a050d0e6e2.png" srcset="/img/loading.gif" lazyload><br>打开浏览器访问<a target="_blank" rel="noopener" href="http://47.106.11.25:32348/">http://47.106.11.25:32348/</a><br><img src="/assets/f1593d5b62094a3cb44ad62a51fe9110.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="应用商店的安装"><a href="#应用商店的安装" class="headerlink" title="应用商店的安装"></a>应用商店的安装</h3><p>可以通过开启<a target="_blank" rel="noopener" href="https://kubesphere.io/zh/docs/v3.3/pluggable-components/app-store/#%E5%9C%A8%E5%AE%89%E8%A3%85%E5%90%8E%E5%90%AF%E7%94%A8%E5%BA%94%E7%94%A8%E5%95%86%E5%BA%97">应用商店</a>的方式来安装应用, 简单粗暴, 不过应用商店的应用比较少<br><img src="/assets/4e5e9d0e9f17488f811731d0e047e7d3.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/498f4a5b397548cab68deb455f919479.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/d880c885efb844e58c85ea218d7271b8.png" srcset="/img/loading.gif" lazyload><br>开启数据持久化<br>设置账号密码<br><img src="/assets/607296241747478780648166d59278c2.png" srcset="/img/loading.gif" lazyload><br>还可以开启外网访问<br><img src="/assets/69d779f7bbb34c1a879d59caeb1e3039.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/eb39e3009d8d48a499637463c1dd35fd.png" srcset="/img/loading.gif" lazyload></p>
<p>然后放开端口, 这里存粹是省事, 没有用自己的集群, 用的青云白送的10小时kubesphere<br><img src="/assets/b9c5eb2de9cb437da61f5e794f834147.png" srcset="/img/loading.gif" lazyload><br>访问<a target="_blank" rel="noopener" href="https://rabbitmq-snpokhhn.c.kubesphere.cloud:30443/">https://rabbitmq-snpokhhn.c.kubesphere.cloud:30443</a><br><img src="/assets/9af0d5b5eaf245a98d30ce773b187ef3.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="通过应用仓库部署"><a href="#通过应用仓库部署" class="headerlink" title="通过应用仓库部署"></a>通过应用仓库部署</h3><blockquote>
<p>使用这种方式来部署也很方便</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://helm.sh/">https://helm.sh/</a><br><img src="/assets/fa8d3943270f4dc68461ff35f5e06323.png" srcset="/img/loading.gif" lazyload><br>搜索redis<br><img src="/assets/0d49ed6fdcce4a07951adc357266522d.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 仓库地址</span><br>https://charts.bitnami.com/bitnami<br></code></pre></td></tr></table></figure>
<p>先切换到企业空间, 添加应用仓库bitnami<br><img src="/assets/75ab9752f90749c3a51f0567b3bc9bb3.png" srcset="/img/loading.gif" lazyload><br>然后再创建应用<br><img src="/assets/21124ee1fc9e4d6890e82704df4d000e.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/203ee718c32146aaaf35e41533614960.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/e0306470871f44808b91b641b2d70f82.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/d9255f973fce46278b522642d7f18cd6.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/3589fc4471b3421b938d67f23495a7a7.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="本地部署ruoyi项目"><a href="#本地部署ruoyi项目" class="headerlink" title="本地部署ruoyi项目"></a>本地部署ruoyi项目</h2><p>本地下载<a target="_blank" rel="noopener" href="https://nacos.io/">nacos</a><br>修改bin&#x2F;application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#*************** Config Module Related Configurations ***************#</span><br><span class="hljs-comment">### If use MySQL as datasource:</span><br><span class="hljs-comment">### Deprecated configuration property, it is recommended to use `spring.sql.init.platform` replaced.</span><br><span class="hljs-comment"># spring.datasource.platform=mysql</span><br><span class="hljs-attr">spring.sql.init.platform</span>=<span class="hljs-string">mysql</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### Count of DB:</span><br><span class="hljs-attr">db.num</span>=<span class="hljs-string">1</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### Connect URL of DB:</span><br><span class="hljs-attr">db.url.0</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/nacos1?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span><br><span class="hljs-attr">db.user.0</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">db.password.0</span>=<span class="hljs-string">123456</span><br></code></pre></td></tr></table></figure>

<p>开启mysql并且执行该sql文件<br><img src="/assets/55fc21866d7d44859d779a67cd7a8a61.png" srcset="/img/loading.gif" lazyload><br>然后单机启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">startup.cmd -m standalone<br></code></pre></td></tr></table></figure>
<p>修改localhost:8848中配置中心的mysql地址和redis地址就可以了</p>
<h2 id="上云部署ruoyi项目"><a href="#上云部署ruoyi项目" class="headerlink" title="上云部署ruoyi项目"></a>上云部署ruoyi项目</h2><h3 id="部署mysql"><a href="#部署mysql" class="headerlink" title="部署mysql"></a>部署mysql</h3><p>创建数据库<code>ry-cloud</code>并导入数据脚本ry_2021xxxx.sql（必须），quartz.sql（可选）<br>创建数据库<code>ry-config</code>并导入数据脚本ry_config_2021xxxx.sql（必须）<br>将如下的sql文件都执行到k8s部署的mysql容器上<br><img src="/assets/b74d2980a74f47e28a8b7c4b5d2241b7.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="部署nacos"><a href="#部署nacos" class="headerlink" title="部署nacos"></a>部署nacos</h3><p><img src="/assets/c50d684604594bcd83dfbe9aa8678806.png" srcset="/img/loading.gif" lazyload><br>创建nacos服务<br><img src="/assets/cce1190d13974a10a48fb58d21277aa8.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/f2ad1160e3b243d5a103c1d8e46b0da6.png" srcset="/img/loading.gif" lazyload><br>创建镜像<code>nacos/nacos-server:v2.0.3</code><br><img src="/assets/75980db468834d0e8feeef1371701bfc.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/9212c38999dc45fc81c9f590a60bfbda.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/84ec430242104064b5e616ec6c8ba3cf.png" srcset="/img/loading.gif" lazyload><br>补充, 添加一个环境变量, 让nacos单节点启动<br><code>MODE</code> <code>standalone</code><br><img src="/assets/f34d8c562ca04ebab6818025dc2a7060.png" srcset="/img/loading.gif" lazyload></p>
<p>暂时不用挂载配置文件<br><img src="/assets/9e7c789754ce4cdea583dc5d05503d6a.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/17f9b93e8f8541f496f5d7a2894fca8e.png" srcset="/img/loading.gif" lazyload><br>这就说明了可以通过 <code>ping 副本名.服务名.企业空间.svc.cluster.local</code><br><code>ping his-nacos-v1-0.his-nacos.his.svc.cluster.local</code><br><code>ping his-nacos-v1-1.his-nacos.his.svc.cluster.local</code><br>cluster集群配置中也可以不用指定IP, 直接指定这个域名<br><img src="/assets/314fa6623b864ea092dd42328fee8a82.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/8538dc7ffef441fa933c3603f83d854a.png" srcset="/img/loading.gif" lazyload><br>然后删除这个nacos服务, 因为刚刚创建的并没有挂载配置文件<br><img src="/assets/339c0852a95c49d6bf97837219b1c20a.png" srcset="/img/loading.gif" lazyload><br>接下来正式部署nacos</p>
<blockquote>
<p>由于mysql可以使用his-mysql-node.his这个主机名直接连接上, 所以nacos网关的mysql的jdbc连接也采用这个主机名称</p>
</blockquote>
<p><img src="/assets/546c1ec826034064a25dd46291f970a3.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/ad1f8b1ea763437d89ba33d30fac54cf.png" srcset="/img/loading.gif" lazyload></p>
<p>一个踩坑, Nacos 2.0.3开启持久化 application.properties<br>得使用<code>spring.datasource.platform</code>, 不然单机模式下启动的并没有做到真正的持久化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">spring.datasource.platform=mysql<br><span class="hljs-comment"># spring.sql.init.platform=mysql</span><br></code></pre></td></tr></table></figure>

<p>application.properties</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><code class="hljs roboconf"><span class="hljs-comment">#</span><br><span class="hljs-comment"># Copyright 1999-2021 Alibaba Group Holding Ltd.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment"># you may not use this file except in compliance with the License.</span><br><span class="hljs-comment"># You may obtain a copy of the License at</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment"># See the License for the specific language governing permissions and</span><br><span class="hljs-comment"># limitations under the License.</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-comment">#*************** Spring Boot Related Configurations ***************#</span><br><span class="hljs-comment">### Default web context path:</span><br>server.servlet.contextPath=/nacos<br><span class="hljs-comment">### Include message field</span><br>server.error.include-message=ALWAYS<br><span class="hljs-comment">### Default web server port:</span><br>server.port=8848<br><br><span class="hljs-comment">#*************** Network Related Configurations ***************#</span><br><span class="hljs-comment">### If prefer hostname over ip for Nacos server addresses in cluster.conf:</span><br><span class="hljs-comment"># nacos.inetutils.prefer-hostname-over-ip=false</span><br><br><span class="hljs-comment">### Specify local server&#x27;s IP:</span><br><span class="hljs-comment"># nacos.inetutils.ip-address=</span><br><br><br><span class="hljs-comment">#*************** Config Module Related Configurations ***************#</span><br><span class="hljs-comment">### If use MySQL as datasource:</span><br><span class="hljs-comment">### Deprecated configuration property, it is recommended to use `spring.sql.init.platform` replaced.</span><br>spring.datasource.platform=mysql<br><span class="hljs-comment"># spring.sql.init.platform=mysql</span><br><br><span class="hljs-comment">### Count of DB:</span><br>db.num=1<br><br><span class="hljs-comment">### Connect URL of DB:</span><br>db.url.0=jdbc:mysql://his-mysql-node.his:3306/ry-config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC<br>db.user.0=root<br>db.password.0=123456<br><br><span class="hljs-comment">### Connection pool configuration: hikariCP</span><br>db.pool.config.connectionTimeout=30000<br>db.pool.config.validationTimeout=10000<br>db.pool.config.maximumPoolSize=20<br>db.pool.config.minimumIdle=2<br><br><span class="hljs-comment">#*************** Naming Module Related Configurations ***************#</span><br><br><span class="hljs-comment">### If enable data warmup. If set to false, the server would accept request without local data preparation:</span><br><span class="hljs-comment"># nacos.naming.data.warmup=true</span><br><br><span class="hljs-comment">### If enable the instance auto expiration, kind like of health check of instance:</span><br><span class="hljs-comment"># nacos.naming.expireInstance=true</span><br><br><span class="hljs-comment">### Add in 2.0.0</span><br><span class="hljs-comment">### The interval to clean empty service, unit: milliseconds.</span><br><span class="hljs-comment"># nacos.naming.clean.empty-service.interval=60000</span><br><br><span class="hljs-comment">### The expired time to clean empty service, unit: milliseconds.</span><br><span class="hljs-comment"># nacos.naming.clean.empty-service.expired-time=60000</span><br><br><span class="hljs-comment">### The interval to clean expired metadata, unit: milliseconds.</span><br><span class="hljs-comment"># nacos.naming.clean.expired-metadata.interval=5000</span><br><br><span class="hljs-comment">### The expired time to clean metadata, unit: milliseconds.</span><br><span class="hljs-comment"># nacos.naming.clean.expired-metadata.expired-time=60000</span><br><br><span class="hljs-comment">### The delay time before push task to execute from service changed, unit: milliseconds.</span><br><span class="hljs-comment"># nacos.naming.push.pushTaskDelay=500</span><br><br><span class="hljs-comment">### The timeout for push task execute, unit: milliseconds.</span><br><span class="hljs-comment"># nacos.naming.push.pushTaskTimeout=5000</span><br><br><span class="hljs-comment">### The delay time for retrying failed push task, unit: milliseconds.</span><br><span class="hljs-comment"># nacos.naming.push.pushTaskRetryDelay=1000</span><br><br><span class="hljs-comment">### Since 2.0.3</span><br><span class="hljs-comment">### The expired time for inactive client, unit: milliseconds.</span><br><span class="hljs-comment"># nacos.naming.client.expired.time=180000</span><br><br><span class="hljs-comment">#*************** CMDB Module Related Configurations ***************#</span><br><span class="hljs-comment">### The interval to dump external CMDB in seconds:</span><br><span class="hljs-comment"># nacos.cmdb.dumpTaskInterval=3600</span><br><br><span class="hljs-comment">### The interval of polling data change event in seconds:</span><br><span class="hljs-comment"># nacos.cmdb.eventTaskInterval=10</span><br><br><span class="hljs-comment">### The interval of loading labels in seconds:</span><br><span class="hljs-comment"># nacos.cmdb.labelTaskInterval=300</span><br><br><span class="hljs-comment">### If turn on data loading task:</span><br><span class="hljs-comment"># nacos.cmdb.loadDataAtStart=false</span><br><br><br><span class="hljs-comment">#*************** Metrics Related Configurations ***************#</span><br><span class="hljs-comment">### Metrics for prometheus</span><br><span class="hljs-comment">#management.endpoints.web.exposure.include=*</span><br><br><span class="hljs-comment">### Metrics for elastic search</span><br>management.metrics.export.elastic.enabled=false<br><span class="hljs-comment">#management.metrics.export.elastic.host=http://localhost:9200</span><br><br><span class="hljs-comment">### Metrics for influx</span><br>management.metrics.export.influx.enabled=false<br><span class="hljs-comment">#management.metrics.export.influx.db=springboot</span><br><span class="hljs-comment">#management.metrics.export.influx.uri=http://localhost:8086</span><br><span class="hljs-comment">#management.metrics.export.influx.auto-create-db=true</span><br><span class="hljs-comment">#management.metrics.export.influx.consistency=one</span><br><span class="hljs-comment">#management.metrics.export.influx.compressed=true</span><br><br><span class="hljs-comment">#*************** Access Log Related Configurations ***************#</span><br><span class="hljs-comment">### If turn on the access log:</span><br>server.tomcat.accesslog.enabled=true<br><br><span class="hljs-comment">### The access log pattern:</span><br>server.tomcat.accesslog.pattern=%h %l %u %t &quot;%r&quot; %s %b %D %&#123;<span class="hljs-attribute">User-Agent&#125;i %&#123;Request-Source&#125;i</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">### The directory of access log</span>:<br>server<span class="hljs-variable">.tomcat</span><span class="hljs-variable">.basedir</span>=file:.<br><br>#*************** Access Control Related Configurations ***************#<br>### If enable spring security, this option is deprecated in 1.2.0:<br>#spring<span class="hljs-variable">.security</span><span class="hljs-variable">.enabled</span>=false<br><br>### The ignore urls of auth<br>nacos<span class="hljs-variable">.security</span><span class="hljs-variable">.ignore</span><span class="hljs-variable">.urls</span>=/,/error,/**/*<span class="hljs-variable">.css</span>,/**/*<span class="hljs-variable">.js</span>,/**/*<span class="hljs-variable">.html</span>,/**/*<span class="hljs-variable">.map</span>,/**/*<span class="hljs-variable">.svg</span>,/**/*<span class="hljs-variable">.png</span>,/**/*<span class="hljs-variable">.ico</span>,/console-ui/public/**,/v1/auth/**,/v1/console/health/**,/actuator/**,/v1/console/server/**<br><br>### The auth system to use, currently only &#x27;nacos&#x27; and &#x27;ldap&#x27; is supported:<br>nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.system</span><span class="hljs-variable">.type</span>=nacos<br><br>### If turn on auth system:<br>nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.enabled</span>=false<br><br>### Turn on/off caching of auth information. By turning on this switch, the update of auth information would have a 15 seconds delay.<br>nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.caching</span><span class="hljs-variable">.enabled</span>=true<br><br>### Since 1.4.1, Turn on/off white auth for user-agent: nacos-server, only for upgrade from old version.<br>nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.enable</span><span class="hljs-variable">.userAgentAuthWhite</span>=false<br><br>### Since 1.4.1, worked when nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.enabled</span>=true and nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.enable</span><span class="hljs-variable">.userAgentAuthWhite</span>=false.<br>### The two properties is the white list for auth and used by identity the request from other server.<br>nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.server</span><span class="hljs-variable">.identity</span><span class="hljs-variable">.key</span>=<br>nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.server</span><span class="hljs-variable">.identity</span><span class="hljs-variable">.value</span>=<br><br>### worked when nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.system</span><span class="hljs-variable">.type</span>=nacos<br>### The token expiration in seconds:<br>nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.plugin</span><span class="hljs-variable">.nacos</span><span class="hljs-variable">.token</span><span class="hljs-variable">.cache</span><span class="hljs-variable">.enable</span>=false<br>nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.plugin</span><span class="hljs-variable">.nacos</span><span class="hljs-variable">.token</span><span class="hljs-variable">.expire</span><span class="hljs-variable">.seconds</span>=18000<br>### The default token (Base64 String):<br>nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.plugin</span><span class="hljs-variable">.nacos</span><span class="hljs-variable">.token</span><span class="hljs-variable">.secret</span><span class="hljs-variable">.key</span>=<br><br>### worked when nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.system</span><span class="hljs-variable">.type</span>=ldap，&#123;0&#125; is Placeholder,replace login username<br>#nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.ldap</span><span class="hljs-variable">.url</span>=ldap://localhost:389<br>#nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.ldap</span><span class="hljs-variable">.basedc</span>=dc=example,dc=org<br>#nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.ldap</span><span class="hljs-variable">.userDn</span>=cn=admin,$&#123;nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.ldap</span><span class="hljs-variable">.basedc</span>&#125;<br>#nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.ldap</span><span class="hljs-variable">.password</span>=admin<br>#nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.ldap</span><span class="hljs-variable">.userdn</span>=cn=&#123;0&#125;,dc=example,dc=org<br>#nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.ldap</span><span class="hljs-variable">.filter</span><span class="hljs-variable">.prefix</span>=uid<br>#nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.auth</span><span class="hljs-variable">.ldap</span><span class="hljs-variable">.case</span><span class="hljs-variable">.sensitive</span>=true<br><br><br>#*************** Istio Related Configurations ***************#<br>### If turn on the MCP server:<br>nacos<span class="hljs-variable">.istio</span><span class="hljs-variable">.mcp</span><span class="hljs-variable">.server</span><span class="hljs-variable">.enabled</span>=false<br><br>#*************** Core Related Configurations ***************#<br><br>### set the WorkerID manually<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.snowflake</span><span class="hljs-variable">.worker-id</span>=<br><br>### Member-MetaData<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.member</span><span class="hljs-variable">.meta</span><span class="hljs-variable">.site</span>=<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.member</span><span class="hljs-variable">.meta</span><span class="hljs-variable">.adweight</span>=<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.member</span><span class="hljs-variable">.meta</span><span class="hljs-variable">.weight</span>=<br><br>### MemberLookup<br>### Addressing pattern category, If set, the priority is highest<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.member</span><span class="hljs-variable">.lookup</span><span class="hljs-variable">.type</span>=[file,address-server]<br>## Set the cluster list with a configuration file or command-line argument<br># nacos<span class="hljs-variable">.member</span><span class="hljs-variable">.list</span>=192.168.16.101:8847?raft_port=8807,192.168.16.101?raft_port=8808,192.168.16.101:8849?raft_port=8809<br>## for AddressServerMemberLookup<br># Maximum number of retries to query the address server upon initialization<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.address-server</span><span class="hljs-variable">.retry</span>=5<br>## Server domain name address of [address-server] mode<br># address<span class="hljs-variable">.server</span><span class="hljs-variable">.domain</span>=jmenv<span class="hljs-variable">.tbsite</span><span class="hljs-variable">.net</span><br>## Server port of [address-server] mode<br># address<span class="hljs-variable">.server</span><span class="hljs-variable">.port</span>=8080<br>## Request address of [address-server] mode<br># address<span class="hljs-variable">.server</span><span class="hljs-variable">.url</span>=/nacos/serverlist<br><br>#*************** JRaft Related Configurations ***************#<br><br>### Sets the Raft cluster election timeout, default value is 5 second<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.raft</span><span class="hljs-variable">.data</span><span class="hljs-variable">.election_timeout_ms</span>=5000<br>### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minute<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.raft</span><span class="hljs-variable">.data</span><span class="hljs-variable">.snapshot_interval_secs</span>=30<br>### raft internal worker threads<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.raft</span><span class="hljs-variable">.data</span><span class="hljs-variable">.core_thread_num</span>=8<br>### Number of threads required for raft business request processing<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.raft</span><span class="hljs-variable">.data</span><span class="hljs-variable">.cli_service_thread_num</span>=4<br>### raft linear read strategy. Safe linear reads are used by default, that is, the Leader tenure is confirmed by heartbeat<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.raft</span><span class="hljs-variable">.data</span><span class="hljs-variable">.read_index_type</span>=ReadOnlySafe<br>### rpc request timeout, default 5 seconds<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.raft</span><span class="hljs-variable">.data</span><span class="hljs-variable">.rpc_request_timeout_ms</span>=5000<br><br>#*************** Distro Related Configurations ***************#<br><br>### Distro data sync delay time, when sync task delayed, task will be merged for same data key. Default 1 second.<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.distro</span><span class="hljs-variable">.data</span><span class="hljs-variable">.sync</span><span class="hljs-variable">.delayMs</span>=1000<br><br>### Distro data sync timeout for one sync data, default 3 seconds.<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.distro</span><span class="hljs-variable">.data</span><span class="hljs-variable">.sync</span><span class="hljs-variable">.timeoutMs</span>=3000<br><br>### Distro data sync retry delay time when sync data failed or timeout, same behavior with delayMs, default 3 seconds.<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.distro</span><span class="hljs-variable">.data</span><span class="hljs-variable">.sync</span><span class="hljs-variable">.retryDelayMs</span>=3000<br><br>### Distro data verify interval time, verify synced data whether expired for a interval. Default 5 seconds.<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.distro</span><span class="hljs-variable">.data</span><span class="hljs-variable">.verify</span><span class="hljs-variable">.intervalMs</span>=5000<br><br>### Distro data verify timeout for one verify, default 3 seconds.<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.distro</span><span class="hljs-variable">.data</span><span class="hljs-variable">.verify</span><span class="hljs-variable">.timeoutMs</span>=3000<br><br>### Distro data load retry delay when load snapshot data failed, default 30 seconds.<br># nacos<span class="hljs-variable">.core</span><span class="hljs-variable">.protocol</span><span class="hljs-variable">.distro</span><span class="hljs-variable">.data</span><span class="hljs-variable">.load</span><span class="hljs-variable">.retryDelayMs</span>=30000<br><br>### enable to support prometheus service discovery<br>#nacos<span class="hljs-variable">.prometheus</span><span class="hljs-variable">.metrics</span><span class="hljs-variable">.enabled</span>=true<br><br>### Since 2.3<br>#*************** Grpc Configurations ***************#<br><br>## sdk grpc(between nacos server and client) configuration<br>## Sets the maximum message size allowed to be received on the server.<br>#nacos<span class="hljs-variable">.remote</span><span class="hljs-variable">.server</span><span class="hljs-variable">.grpc</span><span class="hljs-variable">.sdk</span><span class="hljs-variable">.max-inbound-message-size</span>=10485760<br><br>## Sets the time(milliseconds) without read activity before sending a keepalive ping. The typical default is two hours.<br>#nacos<span class="hljs-variable">.remote</span><span class="hljs-variable">.server</span><span class="hljs-variable">.grpc</span><span class="hljs-variable">.sdk</span><span class="hljs-variable">.keep-alive-time</span>=7200000<br><br>## Sets a time(milliseconds) waiting for read activity after sending a keepalive ping. Defaults to 20 seconds.<br>#nacos<span class="hljs-variable">.remote</span><span class="hljs-variable">.server</span><span class="hljs-variable">.grpc</span><span class="hljs-variable">.sdk</span><span class="hljs-variable">.keep-alive-timeout</span>=20000<br><br><br>## Sets a time(milliseconds) that specify the most aggressive keep-alive time clients are permitted to configure. The typical default is 5 minutes<br>#nacos<span class="hljs-variable">.remote</span><span class="hljs-variable">.server</span><span class="hljs-variable">.grpc</span><span class="hljs-variable">.sdk</span><span class="hljs-variable">.permit-keep-alive-time</span>=300000<br><br>## cluster grpc(inside the nacos server) configuration<br>#nacos<span class="hljs-variable">.remote</span><span class="hljs-variable">.server</span><span class="hljs-variable">.grpc</span><span class="hljs-variable">.cluster</span><span class="hljs-variable">.max-inbound-message-size</span>=10485760<br><br>## Sets the time(milliseconds) without read activity before sending a keepalive ping. The typical default is two hours.<br>#nacos<span class="hljs-variable">.remote</span><span class="hljs-variable">.server</span><span class="hljs-variable">.grpc</span><span class="hljs-variable">.cluster</span><span class="hljs-variable">.keep-alive-time</span>=7200000<br><br>## Sets a time(milliseconds) waiting for read activity after sending a keepalive ping. Defaults to 20 seconds.<br>#nacos<span class="hljs-variable">.remote</span><span class="hljs-variable">.server</span><span class="hljs-variable">.grpc</span><span class="hljs-variable">.cluster</span><span class="hljs-variable">.keep-alive-timeout</span>=20000<br><br>## Sets a time(milliseconds) that specify the most aggressive keep-alive time clients are permitted to configure. The typical default is 5 minutes<br>#nacos<span class="hljs-variable">.remote</span><span class="hljs-variable">.server</span><span class="hljs-variable">.grpc</span><span class="hljs-variable">.cluster</span><span class="hljs-variable">.permit-keep-alive-time</span>=300000<br><br></code></pre></td></tr></table></figure>

<p>cluster.conf</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">#</span><br><span class="hljs-comment"># Copyright 1999-2021 Alibaba Group Holding Ltd.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment"># you may not use this file except in compliance with the License.</span><br><span class="hljs-comment"># You may obtain a copy of the License at</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment"># See the License for the specific language governing permissions and</span><br><span class="hljs-comment"># limitations under the License.</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-comment">#it is ip</span><br><span class="hljs-comment">#example</span><br><span class="hljs-attribute">his</span>-nacos-v1-<span class="hljs-number">0</span>.his-nacos.his.svc.cluster.local:<span class="hljs-number">8848</span><br><span class="hljs-attribute">his</span>-nacos-v1-<span class="hljs-number">1</span>.his-nacos.his.svc.cluster.local:<span class="hljs-number">8848</span><br><span class="hljs-attribute">his</span>-nacos-v1-<span class="hljs-number">2</span>.his-nacos.his.svc.cluster.local:<span class="hljs-number">8848</span><br></code></pre></td></tr></table></figure>
<p>TIPS: 单节点部署不用挂载cluster.conf, 后面的部署可能会出现bug<br><img src="/assets/d3853720f991421f9b4ea248952f0abb.png" srcset="/img/loading.gif" lazyload><br>然后创建一个有状态服务<br><img src="/assets/b25f0363815c4347bac8e5febd9bdd29.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/ae69de0f32214b21bc1c0f5faf2fb58c.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/f2905a14e94a4e499e8c04d9fe542d8d.png" srcset="/img/loading.gif" lazyload><br>指定nacos的版本<code>nacos/nacos-server:v2.0.3</code><br><img src="/assets/7decef743511431c8bc74284c037369d.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/aa5c24e382fe4cc0892d94dadb554125.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/91abb48b7c104c398502927a1702e6d6.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/ab2474a03f034641ae07054e91e8b808.png" srcset="/img/loading.gif" lazyload><br>只读<code>/home/nacos/conf/application.properties</code>子路径填写<code>application.properties</code><br><img src="/assets/34aba25030984df0b7b0ad2dc4c4f2bd.png" srcset="/img/loading.gif" lazyload><br>只读<code>/home/nacos/conf/cluster.conf</code>子路径填写<code>cluster.conf</code><br><img src="/assets/0f54ef6cee35412c98a75fc5a3f08f23.png" srcset="/img/loading.gif" lazyload><br>接着创建一个对外暴露端口的nacos<br><img src="/assets/4db3c1db360542f0bb5c1b10d4b6f590.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/2bfea46694ae4b4abe17511837c889e4.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/6411be14f95049fd818bbe45a845d87d.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/2befa30176b744b8b6f878dd748adad3.png" srcset="/img/loading.gif" lazyload><br>配置完成之后可以访问<a target="_blank" rel="noopener" href="http://139.198.115.124:31695/nacos">http://139.198.115.124:31695/nacos</a><br><img src="/assets/3c7b00d58ace4040a0fa0aa690c1213c.png" srcset="/img/loading.gif" lazyload></p>
<p>接着创建prod命名空间<br><img src="/assets/d7b24a728ae94bbeae64932e2e9913ca.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/45b01961c9944443a8fa1a573740e95f.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="maven打包"><a href="#maven打包" class="headerlink" title="maven打包"></a>maven打包</h3><p>跳过测试然后打包<br><img src="/assets/c29d7276428844939b72ba4e9e4ed44a.png" srcset="/img/loading.gif" lazyload><br>本地运行打好的jar包<code>java -jar ruoyi-auth.jar</code><br>出现报错charset</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Caused by: java.nio.charset.MalformedInputException: Input length = 1<br></code></pre></td></tr></table></figure>
<p>需要指定一下编码集<br><code>java -Dfile.encoding=utf8 -jar ruoyi-auth.jar</code><br>将打包的jar整理成如下格式上传到服务器</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cmake">.<br>├── ruoyi-auth<br>│   ├── Dockerfile<br>│   └── <span class="hljs-keyword">target</span><br>│       └── ruoyi-auth.jar<br>├── ruoyi-<span class="hljs-keyword">file</span><br>│   ├── Dockerfile<br>│   └── <span class="hljs-keyword">target</span><br>│       └── ruoyi-modules-<span class="hljs-keyword">file</span>.jar<br>├── ruoyi-gateway<br>│   ├── Dockerfile<br>│   └── <span class="hljs-keyword">target</span><br>│       └── ruoyi-gateway.jar<br>├── ruoyi-gen<br>│   ├── Dockerfile<br>│   └── <span class="hljs-keyword">target</span><br>│       └── ruoyi-modules-gen.jar<br>├── ruoyi-job<br>│   ├── Dockerfile<br>│   └── <span class="hljs-keyword">target</span><br>│       └── ruoyi-modules-job.jar<br>├── ruoyi-monitor<br>│   ├── Dockerfile<br>│   └── <span class="hljs-keyword">target</span><br>│       └── ruoyi-visual-monitor.jar<br>└── ruoyi-system<br>    ├── Dockerfile<br>    └── <span class="hljs-keyword">target</span><br>        └── ruoyi-modules-system.jar<br></code></pre></td></tr></table></figure>
<p>Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> openjdk:<span class="hljs-number">8</span>-jdk<br><span class="hljs-keyword">LABEL</span><span class="language-bash"> maintainer=leifengyang</span><br><br><br><span class="hljs-comment">#docker run -e PARAMS=&quot;--server.port 9090&quot;</span><br><span class="hljs-keyword">ENV</span> PARAMS=<span class="hljs-string">&quot;--server.port=8080 --spring.profiles.active=prod --spring.cloud.nacos.discovery.server-addr=his-nacos.his:8848 --spring.cloud.nacos.config.server-addr=his-nacos.his:8848 --spring.cloud.nacos.config.namespace=prod --spring.cloud.nacos.config.file-extension=yml&quot;</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span> &gt;/etc/timezone</span><br><br><span class="hljs-keyword">COPY</span><span class="language-bash"> target/*.jar /app.jar</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;java -Dfile.encoding=utf8 -Djava.security.egd=file:/dev/./urandom -jar app.jar <span class="hljs-variable">$&#123;PARAMS&#125;</span>&quot;</span>]</span><br></code></pre></td></tr></table></figure>
<h3 id="开通阿里云容器镜像服务"><a href="#开通阿里云容器镜像服务" class="headerlink" title="开通阿里云容器镜像服务"></a>开通阿里云容器镜像服务</h3><p><img src="/assets/ea14837b92bd4887860c3323cc144d47.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 登录阿里云容器镜像仓库</span><br>$ sudo docker login --username=肉豆蔻吖 registry.cn-shenzhen.aliyuncs.com<br><br>12345Xia<br></code></pre></td></tr></table></figure>
<p>创建一个命名空间<br><img src="/assets/1ec2268024c34f3397da800d7126918d.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 拉取</span><br>$ docker pull registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi:[镜像版本号]<br><br><span class="hljs-comment"># 推送</span><br>$ docker login --username=肉豆蔻吖 registry.cn-shenzhen.aliyuncs.com<br>$ docker tag [ImageId] registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi:[镜像版本号]<br>$ docker push registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi:[镜像版本号]<br></code></pre></td></tr></table></figure>

<h3 id="docker打包-推送"><a href="#docker打包-推送" class="headerlink" title="docker打包, 推送"></a>docker打包, 推送</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 打包成镜像</span><br><span class="hljs-built_in">cd</span> ruoyi-file/<br>docker build -t ruoyi-file:v1 -f Dockerfile .<br><br><span class="hljs-comment"># 可以简写不写Dockerfile</span><br><span class="hljs-built_in">cd</span> ruoyi-gateway/<br>docker build -t ruoyi-gateway:v1 .<br><br><span class="hljs-built_in">cd</span> ruoyi-gen/<br>docker build -t ruoyi-gen:v1 .<br><br><span class="hljs-built_in">cd</span> ruoyi-job/<br>docker build -t ruoyi-job:v1 .<br><br><span class="hljs-built_in">cd</span> ruoyi-monitor/  <br>docker build -t ruoyi-monitor:v1 .<br><br><span class="hljs-built_in">cd</span> ruoyi-system/<br>docker build -t ruoyi-system:v1 .<br><br><span class="hljs-built_in">cd</span> ruoyi-auth/<br>docker build -t ruoyi-auth:v1 .<br><br><span class="hljs-comment"># 登录</span><br>docker login --username=肉豆蔻吖 registry.cn-shenzhen.aliyuncs.com<br><br><span class="hljs-comment"># 查看镜像</span><br>[root@k8s-master ruoyi-system]<span class="hljs-comment"># docker images | grep ruoyi</span><br>ruoyi-auth                                                                 v1         0db642b44949   4 seconds ago   617MB<br>ruoyi-system                                                               v1         c0b63feca088   8 minutes ago    632MB<br>ruoyi-monitor                                                              v1         b0f479101e96   10 minutes ago   592MB<br>ruoyi-job                                                                  v1         fd3bcefdb9d0   10 minutes ago   629MB<br>ruoyi-gen                                                                  v1         df9dae1e1581   10 minutes ago   628MB<br>ruoyi-gateway                                                              v1         1a37fc67241f   13 minutes ago   625MB<br>ruoyi-file                                                                 v1         85a54d4c38ea   15 minutes ago   622MB<br><br><span class="hljs-comment"># 命名</span><br>docker tag c0b63feca088 registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-system:v1<br>docker tag b0f479101e96 registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-monitor:v1<br>docker tag fd3bcefdb9d0 registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-job:v1<br>docker tag df9dae1e1581 registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-gen:v1<br>docker tag 1a37fc67241f registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-gateway:v1<br>docker tag 85a54d4c38ea registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-file:v1<br>docker tag 0db642b44949 registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-auth:v1<br><br><span class="hljs-comment"># 查看镜像</span><br>[root@k8s-master ruoyi-system]<span class="hljs-comment"># docker images | grep ruoyi</span><br>ruoyi-auth                                                                 v1         0db642b44949   49 seconds ago   617MB<br>registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-auth               v1         0db642b44949   49 seconds ago   617MB<br>ruoyi-system                                                               v1         c0b63feca088   12 hours ago     632MB<br>registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-system             v1         c0b63feca088   12 hours ago     632MB<br>ruoyi-monitor                                                              v1         b0f479101e96   12 hours ago     592MB<br>registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-monitor            v1         b0f479101e96   12 hours ago     592MB<br>registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-job                v1         fd3bcefdb9d0   12 hours ago     629MB<br>ruoyi-job                                                                  v1         fd3bcefdb9d0   12 hours ago     629MB<br>ruoyi-gen                                                                  v1         df9dae1e1581   12 hours ago     628MB<br>registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-gen                v1         df9dae1e1581   12 hours ago     628MB<br>ruoyi-gateway                                                              v1         1a37fc67241f   12 hours ago     625MB<br>registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-gateway            v1         1a37fc67241f   12 hours ago     625MB<br>ruoyi-file                                                                 v1         85a54d4c38ea   12 hours ago     622MB<br>registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-file               v1         85a54d4c38ea   12 hours ago     622MB<br><br><span class="hljs-comment"># 推送</span><br>docker push registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-auth:v1<br>docker push registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-system:v1<br>docker push registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-monitor:v1<br>docker push registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-job:v1<br>docker push registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-gen:v1<br>docker push registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-gateway:v1<br>docker push registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-file:v1<br></code></pre></td></tr></table></figure>
<h3 id="kubesphere部署微服务"><a href="#kubesphere部署微服务" class="headerlink" title="kubesphere部署微服务"></a>kubesphere部署微服务</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># 拉取镜像</span><br>docker pull registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-auth:v1<br>docker pull registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-system:v1<br>docker pull registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-monitor:v1<br>docker pull registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-job:v1<br>docker pull registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-gen:v1<br>docker pull registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-gateway:v1<br>docker pull registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-file:v1<br></code></pre></td></tr></table></figure>
<p>创建无状态服务<br><img src="/assets/57afae57a3924d0ea083b175701a161f.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/947a5310c9bb4c81b7e319d9e3b5e61f.png" srcset="/img/loading.gif" lazyload><br>选择这个镜像<code>registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-monitor:v1</code><br><img src="/assets/c9a3ae855b624c8383fd50083a3f03b5.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/756acb5acffa4c2a9660d570e2d913fc.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/053c8267d15d4799bfe39ea82c51eece.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/263c2dd032524bd0aed491969cbd36ef.png" srcset="/img/loading.gif" lazyload>部署完成之后查看日志,没有报错就ok<br><img src="/assets/c8ab361ad21c4e8a8fd2047541ebdea4.png" srcset="/img/loading.gif" lazyload><br>然后以相同的方式部署其他的微服务</p>
<h3 id="kubesphere部署前端"><a href="#kubesphere部署前端" class="headerlink" title="kubesphere部署前端"></a>kubesphere部署前端</h3><p>前端UI进行打包<br>将target的路径<code>localhost</code>修改成<code>ruoyi-gateway.his</code><br><img src="/assets/6b02f0a23df247fc8838ddbdb3c2a51b.png" srcset="/img/loading.gif" lazyload><br>然后进行打包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm run build:prod<br></code></pre></td></tr></table></figure>
<p>然后将打包好的dist文件拖拽到nginx中html目录下<br>修改nginx.conf 的<code>server_name</code>为_ (表示可以处理任何IP代理的请求, 因为部署到k8s的pod的IP随时可能会发生变化 ,这个地方不能写死了, 一旦有请求进来了, 不管是发给哪一个pod的IP, 都进行处理)<br><code>proxy_pass</code>指定代理网关<code>http://ruoyi-gateway.his:8080/;</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs bash">worker_processes  1;<br><br>events &#123;<br>    worker_connections  1024;<br>&#125;<br><br>http &#123;<br>    include       mime.types;<br>    default_type  application/octet-stream;<br>    sendfile        on;<br>    keepalive_timeout  65;<br><br>    server &#123;<br>        listen       80;<br>        server_name  _;<br><br>        location / &#123;<br>            root   /home/ruoyi/projects/ruoyi-ui;<br>            try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html;<br>            index  index.html index.htm;<br>        &#125;<br><br>        location /prod-api/&#123;<br>            proxy_set_header Host <span class="hljs-variable">$http_host</span>;<br>            proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>            proxy_set_header REMOTE-HOST <span class="hljs-variable">$remote_addr</span>;<br>            proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>            proxy_pass http://ruoyi-gateway.his:8080/;<br>        &#125;<br><br>        <span class="hljs-comment"># 避免actuator暴露</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_uri</span> ~ <span class="hljs-string">&quot;/actuator&quot;</span>) &#123;<br>            <span class="hljs-built_in">return</span> 403;<br>        &#125;<br><br>        error_page   500 502 503 504  /50x.html;<br>        location = /50x.html &#123;<br>            root   html;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="/assets/a57119cde9c0476791462e4f9b2c3871.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 下载解压工具</span><br>yum install -y unzip zip<br><br><span class="hljs-comment"># 解压nginx</span><br>unzip nginx<br><br><span class="hljs-built_in">cd</span> nginx<br><br><span class="hljs-comment"># docker打包</span><br>docker build -t registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-ui:v1 -f dockerfile .<br><br><span class="hljs-comment"># 推送</span><br>docker push registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-ui:v1<br></code></pre></td></tr></table></figure>
<p>然后kubesphere创建服务<br>应用负载 - 服务 - 创建 - 无状态服务<br><img src="/assets/943c557cdfc6445d934c48927fc2ac03.png" srcset="/img/loading.gif" lazyload><br><code>registry.cn-shenzhen.aliyuncs.com/roudoukou-ruoyi/ruoyi-ui:v1</code><br><img src="/assets/30fe8dda75d94bd9897bedf3d3c10459.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/606b918e1e2e42bea38343be12598965.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/52f48a32e84b4c029f0f0294188e86aa.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="部署的效果图"><a href="#部署的效果图" class="headerlink" title="部署的效果图"></a>部署的效果图</h3><p><img src="/assets/b69f24a0164c4abc8fb627069f819226.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="一个补充"><a href="#一个补充" class="headerlink" title="一个补充"></a>一个补充</h3><p>在服务器重启之后, nacos的启动会依赖mysql<br>会出现一种情况, 当nacos的pod启动的时候, 但是mysql的pod还没有启动<br>这样就会照成nacos的启动失败, 然后导致其他的微服务连接不上nacos, 最后导致的结果就是出现好几个微服务都不能正常启动<br>这个时候就可以给nacos添加一个存活探针<br><img src="/assets/d354224e66bf4d869dc1586cac52d7f6.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="上云部署尚医通"><a href="#上云部署尚医通" class="headerlink" title="上云部署尚医通"></a>上云部署尚医通</h2><h3 id="部署mongodb"><a href="#部署mongodb" class="headerlink" title="部署mongodb"></a>部署mongodb</h3><p><img src="/assets/d3730340e19648fcae8c273a94a9693c.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/1477f7b9ec1d4e5093557fb189bf6b11.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/f7e5227d150542cf8ee44a793203a07a.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/aa96f69e44ab438c935b85c2345aef16.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/d3ebcc01095e4f148d643d2318d16824.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="部署sentinel"><a href="#部署sentinel" class="headerlink" title="部署sentinel"></a>部署sentinel</h3><p><img src="/assets/ceab447d42fd4a3e8891705451d4c4c2.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/836b570dbb4c4f37b1a470f0ed4251d1.png" srcset="/img/loading.gif" lazyload><br><code>leifengyang/sentinel:1.8.2</code><br><img src="/assets/03abc3572ee84a34ba741c62e0b74778.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/bdc5cedde28e465bb295245e85965b32.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="中间件配置"><a href="#中间件配置" class="headerlink" title="中间件配置"></a>中间件配置</h3><table>
<thead>
<tr>
<th>中间件</th>
<th>集群内地址</th>
<th>外部访问地址</th>
</tr>
</thead>
<tbody><tr>
<td>Nacos</td>
<td>his-nacos.his:8848</td>
<td><a target="_blank" rel="noopener" href="http://139.198.127.220:31695/">http://139.198.127.220:31695/</a>nacos</td>
</tr>
<tr>
<td>MySQL</td>
<td>his-mysql-node.his:3306</td>
<td>139.198.127.220:32264</td>
</tr>
<tr>
<td>Redis</td>
<td>his-redis-node.his:6379</td>
<td>139.198.127.220:32756</td>
</tr>
<tr>
<td>Sentinel</td>
<td>his-sentinel.his:8080</td>
<td></td>
</tr>
<tr>
<td>MongoDB</td>
<td>mongodb.his:<strong>27017</strong></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>RabbitMQ</td>
<td>his-rabbitmq.his:5672</td>
<td>139.198.127.220:30853</td>
</tr>
<tr>
<td>ElasticSearch</td>
<td>his-es.his:9200</td>
<td>139.198.127.220:30820</td>
</tr>
</tbody></table>
<p>配置nacos的配置文件</p>
<p>service-cmn-prod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">db-config:</span><br>      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">http://his-sentinel.his:8080</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">his-redis-node.his</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">1800000</span><br>    <span class="hljs-attr">password:</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span> <span class="hljs-comment">#最大连接数</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-number">-1</span>    <span class="hljs-comment">#最大阻塞等待时间(负数表示没限制)</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">5</span>    <span class="hljs-comment">#最大空闲</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span>     <span class="hljs-comment">#最小空闲</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://his-mysql-node.his:3306/yygh_cmn?characterEncoding=utf-8&amp;useSSL=false</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">hikari:</span><br>      <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">60000</span><br>      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">500000</span><br>      <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">540000</span><br>      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">12</span><br>      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">pool-name:</span> <span class="hljs-string">GuliHikariPool</span><br>  <span class="hljs-attr">jackson:</span><br>    <span class="hljs-attr">date-format:</span> <span class="hljs-string">yyyy-MM-dd</span> <span class="hljs-string">HH:mm:ss</span><br>    <span class="hljs-attr">time-zone:</span> <span class="hljs-string">GMT+8</span><br></code></pre></td></tr></table></figure>

<p>service-hosp-prod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">sentinel:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">30000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">50000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">his-sentinel.his:8080</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">mongodb:</span><br>      <span class="hljs-attr">host:</span> <span class="hljs-string">mongodb.his</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">27017</span><br>      <span class="hljs-attr">database:</span> <span class="hljs-string">yygh_hosps</span> <span class="hljs-comment">#指定操作的数据库</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">his-rabbitmq.his</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">admin</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://his-mysql-node.his:3306/yygh_hosp?characterEncoding=utf-8&amp;useSSL=false</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">hikari:</span><br>      <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">60000</span><br>      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">500000</span><br>      <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">540000</span><br>      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">12</span><br>      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">pool-name:</span> <span class="hljs-string">GuliHikariPool</span><br>  <span class="hljs-attr">jackson:</span><br>    <span class="hljs-attr">date-format:</span> <span class="hljs-string">yyyy-MM-dd</span> <span class="hljs-string">HH:mm:ss</span><br>    <span class="hljs-attr">time-zone:</span> <span class="hljs-string">GMT+8</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">his-redis-node.his</span><br></code></pre></td></tr></table></figure>

<p>service-order-prod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">sentinel:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">30000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">50000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">http://his-sentinel.his:8080</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">his-rabbitmq.his</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">admin</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://his-mysql-node.his:3306/yygh_order?characterEncoding=utf-8&amp;useSSL=false</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">hikari:</span><br>      <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">60000</span><br>      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">500000</span><br>      <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">540000</span><br>      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">12</span><br>      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">pool-name:</span> <span class="hljs-string">GuliHikariPool</span><br>  <span class="hljs-attr">jackson:</span><br>    <span class="hljs-attr">date-format:</span> <span class="hljs-string">yyyy-MM-dd</span> <span class="hljs-string">HH:mm:ss</span><br>    <span class="hljs-attr">time-zone:</span> <span class="hljs-string">GMT+8</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">his-redis-node.his</span><br><span class="hljs-comment"># 微信</span><br><span class="hljs-comment">#weixin:</span><br><span class="hljs-comment">#  appid: wx8397f8696b538317</span><br><span class="hljs-comment">#  partner: 1473426802</span><br><span class="hljs-comment">#  partnerkey: T6m9iK73b0kn9g5v426MKfHQH7X8rKwb</span><br><span class="hljs-comment">#  notifyurl: http://a31ef7db.ngrok.io/WeChatPay/WeChatPayNotify</span><br><span class="hljs-attr">weixin:</span><br>  <span class="hljs-attr">appid:</span> <span class="hljs-string">wx74862e0dfcf69954</span><br>  <span class="hljs-attr">partner:</span> <span class="hljs-number">1558950191</span><br>  <span class="hljs-attr">partnerkey:</span> <span class="hljs-string">T6m9iK73b0kn9g5v426MKfHQH7X8rKwb</span><br>  <span class="hljs-attr">notifyurl:</span> <span class="hljs-string">http://qyben.free.idcfengye.com/api/order/weixin/notify</span><br>  <span class="hljs-attr">cert:</span> <span class="hljs-string">C:\Users\lfy\Desktop\yygh-parent\service\service-order\src\main\resources\apiclient_cert.p12</span><br></code></pre></td></tr></table></figure>

<p>service-oss-prod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8205</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">http://his-sentinel.his:8080</span><br><span class="hljs-comment">#阿里云 OSS</span><br><span class="hljs-attr">aliyun:</span><br>  <span class="hljs-attr">oss:</span><br>    <span class="hljs-attr">file:</span><br>      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">oss-cn-beijing.aliyuncs.com</span><br>      <span class="hljs-attr">keyid:</span> <span class="hljs-string">LTAI4FhtGRtRGtPvmLBv8vxk</span><br>      <span class="hljs-attr">keysecret:</span> <span class="hljs-string">sq8e8WLYoKwJoCNLbjRdlSTaOaFumD</span><br>      <span class="hljs-comment">#bucket可以在控制台创建，也可以使用java代码创建</span><br>      <span class="hljs-attr">bucketname:</span> <span class="hljs-string">online-teach-file</span><br><br></code></pre></td></tr></table></figure>

<p>service-sms-prod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">http://his-sentinel.his:8080</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">his-rabbitmq.his</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">admin</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">his-redis-node.his</span><br><span class="hljs-comment">#阿里云 短信</span><br><span class="hljs-attr">aliyun:</span><br>  <span class="hljs-attr">sms:</span><br>    <span class="hljs-attr">regionId:</span> <span class="hljs-string">default</span><br>    <span class="hljs-attr">accessKeyId:</span> <span class="hljs-string">LTAI0YbQf3pX8WqC</span><br>    <span class="hljs-attr">secret:</span> <span class="hljs-string">jX8D04DmDI3gGKjW5kaFYSzugfqmmT</span><br><br></code></pre></td></tr></table></figure>

<p>service-statistics-prod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8208</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">sentinel:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">30000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">50000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">http://his-sentinel.his:8080</span><br></code></pre></td></tr></table></figure>

<p>service-task-prod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">his-sentinel.his:8080</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">his-rabbitmq.his</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">admin</span><br></code></pre></td></tr></table></figure>

<p>service-user-prod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">sentinel:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">30000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">50000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">http://his-sentinel.his:8080</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://his-mysql-node.his:3306/yygh_user?characterEncoding=utf-8&amp;useSSL=false</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">hikari:</span><br>      <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">60000</span><br>      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">500000</span><br>      <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">540000</span><br>      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">12</span><br>      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">pool-name:</span> <span class="hljs-string">GuliHikariPool</span><br>  <span class="hljs-attr">jackson:</span><br>    <span class="hljs-attr">date-format:</span> <span class="hljs-string">yyyy-MM-dd</span> <span class="hljs-string">HH:mm:ss</span><br>    <span class="hljs-attr">time-zone:</span> <span class="hljs-string">GMT+8</span><br><span class="hljs-attr">wx:</span><br>  <span class="hljs-attr">open:</span><br>    <span class="hljs-comment"># 微信开放平台 appid</span><br>    <span class="hljs-attr">app_id:</span> <span class="hljs-string">wxc606fb748aedee7c</span><br>    <span class="hljs-comment"># 微信开放平台 appsecret</span><br>    <span class="hljs-attr">app_secret:</span> <span class="hljs-string">073e8e1117c1054b14586c8aa922bc9c</span><br>    <span class="hljs-comment"># 微信开放平台 重定向url（需要在微信开放平台配置）</span><br>    <span class="hljs-attr">redirect_url:</span> <span class="hljs-string">http://qyben.free.idcfengye.com/api/user/weixin/callback</span><br>    <span class="hljs-comment">#redirect_url: http://qyben.free.idcfengye.com/api/user/weixin/callback</span><br><span class="hljs-comment">#wx:</span><br><span class="hljs-comment">#  open:</span><br><span class="hljs-comment">#    # 微信开放平台 appid</span><br><span class="hljs-comment">#    app_id: wxed9954c01bb89b47</span><br><span class="hljs-comment">#    # 微信开放平台 appsecret</span><br><span class="hljs-comment">#    app_secret: 2cf9a4a81b6151d560e9bbc625c3297b</span><br><span class="hljs-comment">#    # 微信开放平台 重定向url（需要在微信开放平台配置）</span><br><span class="hljs-comment">#    redirect_url: http://guli.shop/api/ucenter/wx/callback</span><br><span class="hljs-attr">yygh:</span><br>  <span class="hljs-comment">#预约挂号平台baserul</span><br>  <span class="hljs-attr">baseUrl:</span> <span class="hljs-string">http://localhost:3000</span><br></code></pre></td></tr></table></figure>

<p>server-gateway-prod.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">server-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">his-nacos.his:8848</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">discovery:</span>      <span class="hljs-comment">#是否与服务发现组件进行结合，通过 serviceId(必须设置成大写) 转发到具体的服务实例。默认为false，设为true便开启通过服务中心的自动根据 serviceId 创建路由的功能。</span><br>        <span class="hljs-attr">locator:</span>      <span class="hljs-comment">#路由访问方式：http://Gateway_HOST:Gateway_PORT/大写的serviceId/**，其中微服务应用名默认大写访问。</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">service-user</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-user</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/*/user/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">service-cmn</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-cmn</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/*/cmn/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">service-sms</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-sms</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/*/sms/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">service-hosp</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-hosp</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/*/hosp/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">service-order</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-order</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/*/order/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">service-statistics</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-statistics</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/*/statistics/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">service-cms</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-cms</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/*/cms/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">service-oss</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-oss</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/*/oss/**</span><br><br></code></pre></td></tr></table></figure>

<p>最后修改hospital-manage<br><img src="/assets/98cd720cf9484f5f81ca52d073b52d69.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="mysql导入sql文件"><a href="#mysql导入sql文件" class="headerlink" title="mysql导入sql文件"></a>mysql导入sql文件</h3><p>将项目中的data&#x2F;sql的sql文件导入到k8s搭建的mysql数据库<br><img src="/assets/628ad1e77d7f499b8ef3ae2bb3bb0c31.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="开启devops"><a href="#开启devops" class="headerlink" title="开启devops"></a>开启devops</h3><p>自定义资源 - 搜索”ClusterConfiguration”<br>ks-installer编辑, 将enabled的值改成true</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">devops:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<p>创建一个角色self-provisioner分配给账户<br>然后创建一个devops工程<br><img src="/assets/ac027d7d95fa46d0852a80aa056e963d.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/b0256bec2953407ab5f9078d6b4ae0ee.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/777dc402be4943c9aba7ad9e597d265f.png" srcset="/img/loading.gif" lazyload><br>使用xiamu普通账户创建devops工程, 然后切换到admin管理员进行编辑<br>点击一下空白处,然后设置label为maven<br><img src="/assets/f08b4eae414d4632a66a4219db3b1e49.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="拉取代码"><a href="#拉取代码" class="headerlink" title="拉取代码"></a>拉取代码</h3><p><img src="/assets/c64e84fcb02b4879ba7f4ace7d0e5f8a.png" srcset="/img/loading.gif" lazyload><br>然后编写一个shell<br><img src="/assets/d1e245379a5a4f19bea1ef8b579f1454.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/fb387906e6144d4bac1b25ad602b1dfb.png" srcset="/img/loading.gif" lazyload><br>然后点击运行<br><img src="/assets/f2ebb7dfa2d04964a603ec6ab42f7ca8.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/729d9b95246146ed8c4e47455a216221.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/cd8103e42c2d4b489b34e41911dd51f7.png" srcset="/img/loading.gif" lazyload><br>可以看见成功的把代码拉取下来了, 并且ls打印出了文件的目录结构</p>
<h3 id="项目打包"><a href="#项目打包" class="headerlink" title="项目打包"></a>项目打包</h3><p>编写两个shell命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span><br>mvn clean package -Dmaven.test.skip=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<p><img src="/assets/ec77dac191d64dbe926e078bbd547fac.png" srcset="/img/loading.gif" lazyload><br>配置阿里云镜像仓库<code>ks-devops-agent</code><br><img src="/assets/1f34cfd3fc144104afd9d96a3e5020b4.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/034dcadb085e427daf4c257f1a8ee3cb.png" srcset="/img/loading.gif" lazyload><br>然后运行, 查看运行日志, 下载的jar包都是从阿里云镜像下载的, 这说明了配置maven镜像仓库配置成功了<br><img src="/assets/95a9d17a80ef472ba02b3f923b8d8b1f.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><p>这部分直接复制下面的jkenis配置文件覆盖就可以了<br><img src="/assets/6aa784e255284153b0e6a58044e4de52.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><code class="hljs python">pipeline &#123;<br>  agent &#123;<br>    node &#123;<br>      label <span class="hljs-string">&#x27;maven&#x27;</span><br>    &#125;<br><br>  &#125;<br>  stages &#123;<br>    stage(<span class="hljs-string">&#x27;拉取代码&#x27;</span>) &#123;<br>      agent none<br>      steps &#123;<br>        container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>          git(url: <span class="hljs-string">&#x27;https://gitee.com/leifengyang/yygh-parent&#x27;</span>, branch: <span class="hljs-string">&#x27;master&#x27;</span>, changelog: true, poll: false)<br>          sh <span class="hljs-string">&#x27;ls -al&#x27;</span><br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;项目编译&#x27;</span>) &#123;<br>      agent none<br>      steps &#123;<br>        container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>          sh <span class="hljs-string">&#x27;ls -al&#x27;</span><br>          sh <span class="hljs-string">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span><br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;default-2&#x27;</span>) &#123;<br>      parallel &#123;<br>        stage(<span class="hljs-string">&#x27;构建hospital-manage镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;&#x27;ls hospital-manage/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t hospital-manage:latest -f hospital-manage/Dockerfile ./hospital-manage/&#x27;&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建server-gateway镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;&#x27;ls server-gateway/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t server-gateway:latest -f server-gateway/Dockerfile ./server-gateway/&#x27;&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-cmn镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;&#x27;ls service/service-cmn/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-cmn:latest -f service/service-cmn/Dockerfile ./service/service-cmn/&#x27;&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-hosp镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;&#x27;ls service/service-hosp/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-hosp:latest -f service/service-hosp/Dockerfile ./service/service-hosp/&#x27;&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-order镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;&#x27;ls service/service-order/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-order:latest -f service/service-order/Dockerfile ./service/service-order/&#x27;&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-oss镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;&#x27;ls service/service-oss/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-oss:latest -f service/service-oss/Dockerfile ./service/service-oss/&#x27;&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-sms镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;&#x27;ls service/service-sms/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-sms:latest -f service/service-sms/Dockerfile ./service/service-sms/&#x27;&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-statistics镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;&#x27;ls service/service-statistics/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-statistics:latest -f service/service-statistics/Dockerfile ./service/service-statistics/&#x27;&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-task镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;&#x27;ls service/service-task/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-task:latest -f service/service-task/Dockerfile ./service/service-task/&#x27;&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-user镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;&#x27;ls service/service-user/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-user:latest -f service/service-user/Dockerfile ./service/service-user/&#x27;&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;push latest&#x27;</span>) &#123;<br>      when &#123;<br>        branch <span class="hljs-string">&#x27;master&#x27;</span><br>      &#125;<br>      steps &#123;<br>        container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>          sh <span class="hljs-string">&#x27;docker tag  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:SNAPSHOT-$BRANCH_NAME-$BUILD_NUMBER $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:latest &#x27;</span><br>          sh <span class="hljs-string">&#x27;docker push  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:latest &#x27;</span><br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;deploy to dev&#x27;</span>) &#123;<br>      steps &#123;<br>        <span class="hljs-built_in">input</span>(<span class="hljs-built_in">id</span>: <span class="hljs-string">&#x27;deploy-to-dev&#x27;</span>, message: <span class="hljs-string">&#x27;deploy to dev?&#x27;</span>)<br>        kubernetesDeploy(configs: <span class="hljs-string">&#x27;deploy/dev-ol/**&#x27;</span>, enableConfigSubstitution: true, kubeconfigId: <span class="hljs-string">&quot;$KUBECONFIG_CREDENTIAL_ID&quot;</span>)<br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;deploy to production&#x27;</span>) &#123;<br>      steps &#123;<br>        <span class="hljs-built_in">input</span>(<span class="hljs-built_in">id</span>: <span class="hljs-string">&#x27;deploy-to-production&#x27;</span>, message: <span class="hljs-string">&#x27;deploy to production?&#x27;</span>)<br>        kubernetesDeploy(configs: <span class="hljs-string">&#x27;deploy/prod-ol/**&#x27;</span>, enableConfigSubstitution: true, kubeconfigId: <span class="hljs-string">&quot;$KUBECONFIG_CREDENTIAL_ID&quot;</span>)<br>      &#125;<br>    &#125;<br><br>  &#125;<br>  environment &#123;<br>    DOCKER_CREDENTIAL_ID = <span class="hljs-string">&#x27;dockerhub-id&#x27;</span><br>    GITHUB_CREDENTIAL_ID = <span class="hljs-string">&#x27;github-id&#x27;</span><br>    KUBECONFIG_CREDENTIAL_ID = <span class="hljs-string">&#x27;demo-kubeconfig&#x27;</span><br>    REGISTRY = <span class="hljs-string">&#x27;docker.io&#x27;</span><br>    DOCKERHUB_NAMESPACE = <span class="hljs-string">&#x27;docker_username&#x27;</span><br>    GITHUB_ACCOUNT = <span class="hljs-string">&#x27;kubesphere&#x27;</span><br>    APP_NAME = <span class="hljs-string">&#x27;devops-java-sample&#x27;</span><br>  &#125;<br>  parameters &#123;<br>    string(name: <span class="hljs-string">&#x27;TAG_NAME&#x27;</span>, defaultValue: <span class="hljs-string">&#x27;&#x27;</span>, description: <span class="hljs-string">&#x27;&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行测试:<br><img src="/assets/e63643e26756429fb7e2845f6ea99ce7.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="发布镜像"><a href="#发布镜像" class="headerlink" title="发布镜像"></a>发布镜像</h3><p><img src="/assets/670ad33ff22e4028b9bcb8830eb40790.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/c5c042a4ec28486c86175e6c65ab1883.png" srcset="/img/loading.gif" lazyload><br>推送镜像到阿里云远程仓库</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">pipeline</span> &#123;<br>  agent &#123;<br>    <span class="hljs-keyword">node</span> &#123;<br>      label <span class="hljs-string">&#x27;maven&#x27;</span><br>    &#125;<br><br>  &#125;<br>  <span class="hljs-keyword">stages</span> &#123;<br>    stage(<span class="hljs-string">&#x27;拉取代码&#x27;</span>) &#123;<br>      agent none<br>      steps &#123;<br>        container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>          git(url: <span class="hljs-string">&#x27;https://gitee.com/leifengyang/yygh-parent&#x27;</span>, branch: <span class="hljs-string">&#x27;master&#x27;</span>, changelog: <span class="hljs-keyword">true</span>, poll: <span class="hljs-keyword">false</span>)<br>          sh <span class="hljs-string">&#x27;ls -al&#x27;</span><br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;项目编译&#x27;</span>) &#123;<br>      agent none<br>      <span class="hljs-keyword">steps</span> &#123;<br>        container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>          sh <span class="hljs-string">&#x27;ls -al&#x27;</span><br>          sh <span class="hljs-string">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span><br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;default-2&#x27;</span>) &#123;<br>      <span class="hljs-keyword">parallel</span> &#123;<br>        stage(<span class="hljs-string">&#x27;构建hospital-manage镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls hospital-manage/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t hospital-manage:latest -f hospital-manage/Dockerfile ./hospital-manage/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建server-gateway镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls server-gateway/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t server-gateway:latest -f server-gateway/Dockerfile ./server-gateway/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-cmn镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-cmn/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-cmn:latest -f service/service-cmn/Dockerfile ./service/service-cmn/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-hosp镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-hosp/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-hosp:latest -f service/service-hosp/Dockerfile ./service/service-hosp/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-order镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-order/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-order:latest -f service/service-order/Dockerfile ./service/service-order/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-oss镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-oss/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-oss:latest -f service/service-oss/Dockerfile ./service/service-oss/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-sms镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-sms/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-sms:latest -f service/service-sms/Dockerfile ./service/service-sms/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-statistics镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-statistics/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-statistics:latest -f service/service-statistics/Dockerfile ./service/service-statistics/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-task镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-task/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-task:latest -f service/service-task/Dockerfile ./service/service-task/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-user镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-user/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-user:latest -f service/service-user/Dockerfile ./service/service-user/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;default-3&#x27;</span>) &#123;<br>      <span class="hljs-keyword">parallel</span> &#123;<br>        stage(<span class="hljs-string">&#x27;推送hospital-manage镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag hospital-manage:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/hospital-manage:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/hospital-manage:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送server-gateway镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag server-gateway:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/server-gateway:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/server-gateway:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-cmn镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-cmn:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-cmn:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-cmn:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-hosp镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-hosp:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-hosp:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-hosp:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-order镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-order:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-order:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-order:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-oss镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-oss:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-oss:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-oss:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-sms镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-sms:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-sms:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-sms:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-statistics镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-statistics:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-statistics:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-statistics:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br>        <br>        stage(<span class="hljs-string">&#x27;推送service-task镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-task:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-task:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-task:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-user镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-user:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-user:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-user:SNAPSHOP-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;deploy to dev&#x27;</span>) &#123;<br>      <span class="hljs-keyword">steps</span> &#123;<br>        input(<span class="hljs-built_in">id</span>: <span class="hljs-string">&#x27;deploy-to-dev&#x27;</span>, <span class="hljs-literal">message</span>: <span class="hljs-string">&#x27;deploy to dev?&#x27;</span>)<br>        kubernetesDeploy(configs: <span class="hljs-string">&#x27;deploy/dev-ol/**&#x27;</span>, enableConfigSubstitution: <span class="hljs-keyword">true</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>)<br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;deploy to production&#x27;</span>) &#123;<br>      <span class="hljs-keyword">steps</span> &#123;<br>        input(<span class="hljs-built_in">id</span>: <span class="hljs-string">&#x27;deploy-to-production&#x27;</span>, <span class="hljs-literal">message</span>: <span class="hljs-string">&#x27;deploy to production?&#x27;</span>)<br>        kubernetesDeploy(configs: <span class="hljs-string">&#x27;deploy/prod-ol/**&#x27;</span>, enableConfigSubstitution: <span class="hljs-keyword">true</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>)<br>      &#125;<br>    &#125;<br><br>  &#125;<br>  <span class="hljs-keyword">environment</span> &#123;<br>    DOCKER_CREDENTIAL_ID = <span class="hljs-string">&#x27;dockerhub-id&#x27;</span><br>    GITHUB_CREDENTIAL_ID = <span class="hljs-string">&#x27;github-id&#x27;</span><br>    KUBECONFIG_CREDENTIAL_ID = <span class="hljs-string">&#x27;demo-kubeconfig&#x27;</span><br>    REGISTRY = <span class="hljs-string">&#x27;registry.cn-shenzhen.aliyuncs.com&#x27;</span><br>    DOCKERHUB_NAMESPACE = <span class="hljs-string">&#x27;roudoukou-ruoyi&#x27;</span><br>    GITHUB_ACCOUNT = <span class="hljs-string">&#x27;kubesphere&#x27;</span><br>    APP_NAME = <span class="hljs-string">&#x27;devops-java-sample&#x27;</span><br>  &#125;<br>  <span class="hljs-keyword">parameters</span> &#123;<br>    string(<span class="hljs-literal">name</span>: <span class="hljs-string">&#x27;TAG_NAME&#x27;</span>, defaultValue: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-literal">description</span>: <span class="hljs-string">&#x27;&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="部署到dev环境"><a href="#部署到dev环境" class="headerlink" title="部署到dev环境"></a>部署到dev环境</h3><p>编辑流水线,创建一个凭证<br><img src="/assets/d05600e4402745a5a188c13244fd9650.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/60b2423747a34b1bae446eaa159cddaf.png" srcset="/img/loading.gif" lazyload><br>kubeconfig默认选择的是<code>$KUBECONFIG_CREDENTIAL_ID</code>(用默认有的)<br>修改配置文件路径<code>hospital-manage/deploy/**</code><br><img src="/assets/c72b23bf722542a49cc3da03e372c9e3.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/f2962f2e55e64272b7ae835f6de28b47.png" srcset="/img/loading.gif" lazyload><br>创建秘钥<code>aliyun-docker-hub</code>, 秘钥名应该跟deploy.yml中的name名一样<br><img src="/assets/d8c3ec0746c241a08654f1def24577eb.png" srcset="/img/loading.gif" lazyload><br>仓库地址<code>registry.cn-shenzhen.aliyuncs.com</code>, 然后填写阿里云的容器镜像服务的用户名和密码<br>顺带点击一下验证<br><img src="/assets/48bb9408323243c98c609ac533520f1c.png" srcset="/img/loading.gif" lazyload></p>
<p>把<code>&#39;$KUBECONFIG_CREDENTIAL_ID&#39;</code>替换成<code>&quot;$KUBECONFIG_CREDENTIAL_ID&quot;</code><br>添加一个环境变量<code>ALIYUNHUB_NAMESPACE = &#39;registry.cn-shenzhen.aliyuncs.com&#39;</code><br>在nacos的每一个文件中都添加上redis的配置</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">redis:</span><br><span class="hljs-symbol">    host:</span> his-redis-node.his<br></code></pre></td></tr></table></figure>
<p>如果使用的是阿里云的服务器,可以使用专有网络来推送镜像, 这样推送镜像走的流量是内网的流量, 更快<br><img src="/assets/01f355c5616e4f2c9847e8fb9f7f106f.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="配置邮箱提醒"><a href="#配置邮箱提醒" class="headerlink" title="配置邮箱提醒"></a>配置邮箱提醒</h3><blockquote>
<p>一个是流水线的邮箱通知, 另一个配置的是kubesphere系统的邮箱通知</p>
</blockquote>
<p>开启邮箱通知<br><img src="/assets/02c089f5f56a455685c1a4f5d434e890.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/e68f78abf0774188b41a83fa041de7cb.png" srcset="/img/loading.gif" lazyload><br>记得将body中的单引号换成双引号<br><img src="/assets/8babec576c824d61b70102e01194063c.png" srcset="/img/loading.gif" lazyload><br>配置ks-jenkins的邮箱地址, 这个相当于是系统通知, 刚刚上面配置的是流水线通知<br><img src="/assets/9ec95d31610548ea86143dd1c3fbb49d.png" srcset="/img/loading.gif" lazyload><br>然后平台设置邮件<br><img src="/assets/ca52e50dc834446f99e82f02c53c0c2f.png" srcset="/img/loading.gif" lazyload></p>
<p>然后创建一个devops工程进行测试邮箱服务<br><img src="/assets/a50d77b662cd467fa3a4a757033f9bda.png" srcset="/img/loading.gif" lazyload><br>记得将这个变量的单引号变成双引号<br><img src="/assets/d3dcae5cd5134b3eba46049e29997112.png" srcset="/img/loading.gif" lazyload><br>因为单引号不能读取这个变量<br><img src="/assets/3bac765128904cd9aa561b421e24e440.png" srcset="/img/loading.gif" lazyload></p>
<p>完整流水线代码: </p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">pipeline</span> &#123;<br>  agent &#123;<br>    <span class="hljs-keyword">node</span> &#123;<br>      label <span class="hljs-string">&#x27;maven&#x27;</span><br>    &#125;<br><br>  &#125;<br>  <span class="hljs-keyword">stages</span> &#123;<br>    stage(<span class="hljs-string">&#x27;拉取代码&#x27;</span>) &#123;<br>      agent none<br>      steps &#123;<br>        container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>          git(url: <span class="hljs-string">&#x27;https://gitee.com/leifengyang/yygh-parent&#x27;</span>, branch: <span class="hljs-string">&#x27;master&#x27;</span>, changelog: <span class="hljs-keyword">true</span>, poll: <span class="hljs-keyword">false</span>)<br>          sh <span class="hljs-string">&#x27;ls -al&#x27;</span><br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;项目编译&#x27;</span>) &#123;<br>      agent none<br>      <span class="hljs-keyword">steps</span> &#123;<br>        container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>          sh <span class="hljs-string">&#x27;ls -al&#x27;</span><br>          sh <span class="hljs-string">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span><br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;default-2&#x27;</span>) &#123;<br>      <span class="hljs-keyword">parallel</span> &#123;<br>        stage(<span class="hljs-string">&#x27;构建hospital-manage镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls hospital-manage/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t hospital-manage:latest -f hospital-manage/Dockerfile ./hospital-manage/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建server-gateway镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls server-gateway/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t server-gateway:latest -f server-gateway/Dockerfile ./server-gateway/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-cmn镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-cmn/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-cmn:latest -f service/service-cmn/Dockerfile ./service/service-cmn/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-hosp镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-hosp/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-hosp:latest -f service/service-hosp/Dockerfile ./service/service-hosp/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-order镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-order/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-order:latest -f service/service-order/Dockerfile ./service/service-order/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-oss镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-oss/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-oss:latest -f service/service-oss/Dockerfile ./service/service-oss/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-sms镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-sms/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-sms:latest -f service/service-sms/Dockerfile ./service/service-sms/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-statistics镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-statistics/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-statistics:latest -f service/service-statistics/Dockerfile ./service/service-statistics/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-task镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-task/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-task:latest -f service/service-task/Dockerfile ./service/service-task/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;构建service-user镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              sh <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;ls service/service-user/target</span><br><span class="hljs-string"></span><br><span class="hljs-string">docker build -t service-user:latest -f service/service-user/Dockerfile ./service/service-user/&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;default-3&#x27;</span>) &#123;<br>      <span class="hljs-keyword">parallel</span> &#123;<br>        stage(<span class="hljs-string">&#x27;推送hospital-manage镜像&#x27;</span>) &#123;<br>          agent none<br>          steps &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag hospital-manage:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/hospital-manage:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/hospital-manage:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送server-gateway镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag server-gateway:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/server-gateway:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/server-gateway:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-cmn镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-cmn:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-cmn:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-cmn:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-hosp镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-hosp:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-hosp:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-hosp:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-order镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-order:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-order:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-order:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-oss镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-oss:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-oss:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-oss:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-sms镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-sms:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-sms:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-sms:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-statistics镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-statistics:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-statistics:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-statistics:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-task镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-task:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-task:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-task:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;推送service-user镜像&#x27;</span>) &#123;<br>          agent none<br>          <span class="hljs-keyword">steps</span> &#123;<br>            container(<span class="hljs-string">&#x27;maven&#x27;</span>) &#123;<br>              withCredentials([usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,)]) &#123;<br>                sh <span class="hljs-string">&#x27;echo &quot;<span class="hljs-variable">$DOCKER_PWD_VAR</span>&quot; | docker login <span class="hljs-variable">$REGISTRY</span> -u &quot;<span class="hljs-variable">$DOCKER_USER_VAR</span>&quot; --password-stdin&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker tag service-user:latest <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-user:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push <span class="hljs-variable">$REGISTRY</span>/<span class="hljs-variable">$DOCKERHUB_NAMESPACE</span>/service-user:SNAPSHOT-<span class="hljs-variable">$BUILD_NUMBER</span>&#x27;</span><br>              &#125;<br><br>            &#125;<br><br>          &#125;<br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;default-4&#x27;</span>) &#123;<br>      <span class="hljs-keyword">parallel</span> &#123;<br>        stage(<span class="hljs-string">&#x27;hospital-manage - 部署到dev环境&#x27;</span>) &#123;<br>          steps &#123;<br>            kubernetesDeploy(enableConfigSubstitution: <span class="hljs-keyword">true</span>, deleteResource: <span class="hljs-keyword">false</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>, configs: <span class="hljs-string">&#x27;hospital-manage/deploy/**&#x27;</span>)<br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;server-gateway - 部署到dev环境&#x27;</span>) &#123;<br>          <span class="hljs-keyword">steps</span> &#123;<br>            kubernetesDeploy(enableConfigSubstitution: <span class="hljs-keyword">true</span>, deleteResource: <span class="hljs-keyword">false</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>, configs: <span class="hljs-string">&#x27;server-gateway/deploy/**&#x27;</span>)<br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;service-cmn - 部署到dev环境&#x27;</span>) &#123;<br>          <span class="hljs-keyword">steps</span> &#123;<br>            kubernetesDeploy(enableConfigSubstitution: <span class="hljs-keyword">true</span>, deleteResource: <span class="hljs-keyword">false</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>, configs: <span class="hljs-string">&#x27;service/service-cmn/deploy/**&#x27;</span>)<br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;service-hosp - 部署到dev环境&#x27;</span>) &#123;<br>          <span class="hljs-keyword">steps</span> &#123;<br>            kubernetesDeploy(enableConfigSubstitution: <span class="hljs-keyword">true</span>, deleteResource: <span class="hljs-keyword">false</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>, configs: <span class="hljs-string">&#x27;service/service-hosp/deploy/**&#x27;</span>)<br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;service-order - 部署到dev环境&#x27;</span>) &#123;<br>          <span class="hljs-keyword">steps</span> &#123;<br>            kubernetesDeploy(enableConfigSubstitution: <span class="hljs-keyword">true</span>, deleteResource: <span class="hljs-keyword">false</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>, configs: <span class="hljs-string">&#x27;service/service-order/deploy/**&#x27;</span>)<br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;service-oss - 部署到dev环境&#x27;</span>) &#123;<br>          <span class="hljs-keyword">steps</span> &#123;<br>            kubernetesDeploy(enableConfigSubstitution: <span class="hljs-keyword">true</span>, deleteResource: <span class="hljs-keyword">false</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>, configs: <span class="hljs-string">&#x27;service/service-oss/deploy/**&#x27;</span>)<br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;service-sms - 部署到dev环境&#x27;</span>) &#123;<br>          <span class="hljs-keyword">steps</span> &#123;<br>            kubernetesDeploy(enableConfigSubstitution: <span class="hljs-keyword">true</span>, deleteResource: <span class="hljs-keyword">false</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>, configs: <span class="hljs-string">&#x27;service/service-sms/deploy/**&#x27;</span>)<br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;service-statistics - 部署到dev环境&#x27;</span>) &#123;<br>          <span class="hljs-keyword">steps</span> &#123;<br>            kubernetesDeploy(enableConfigSubstitution: <span class="hljs-keyword">true</span>, deleteResource: <span class="hljs-keyword">false</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>, configs: <span class="hljs-string">&#x27;service/service-statistics/deploy/**&#x27;</span>)<br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;service-task - 部署到dev环境&#x27;</span>) &#123;<br>          <span class="hljs-keyword">steps</span> &#123;<br>            kubernetesDeploy(enableConfigSubstitution: <span class="hljs-keyword">true</span>, deleteResource: <span class="hljs-keyword">false</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>, configs: <span class="hljs-string">&#x27;service/service-task/deploy/**&#x27;</span>)<br>          &#125;<br>        &#125;<br><br>        stage(<span class="hljs-string">&#x27;service-user - 部署到dev环境&#x27;</span>) &#123;<br>          <span class="hljs-keyword">steps</span> &#123;<br>            kubernetesDeploy(enableConfigSubstitution: <span class="hljs-keyword">true</span>, deleteResource: <span class="hljs-keyword">false</span>, kubeconfigId: <span class="hljs-string">&quot;<span class="hljs-variable">$KUBECONFIG_CREDENTIAL_ID</span>&quot;</span>, configs: <span class="hljs-string">&#x27;service/service-user/deploy/**&#x27;</span>)<br>          &#125;<br>        &#125;<br><br>      &#125;<br>    &#125;<br><br>    stage(<span class="hljs-string">&#x27;发送确认邮件&#x27;</span>) &#123;<br>      agent none<br>      <span class="hljs-keyword">steps</span> &#123;<br>        mail(to: <span class="hljs-string">&#x27;1023876294@qq.com&#x27;</span>, subject: <span class="hljs-string">&#x27;构建结果&#x27;</span>, body: <span class="hljs-string">&quot;构建成功了 <span class="hljs-variable">$BUILD_NUMBER</span>&quot;</span>)<br>      &#125;<br>    &#125;<br><br>  &#125;<br>  <span class="hljs-keyword">environment</span> &#123;<br>    DOCKER_CREDENTIAL_ID = <span class="hljs-string">&#x27;dockerhub-id&#x27;</span><br>    GITHUB_CREDENTIAL_ID = <span class="hljs-string">&#x27;github-id&#x27;</span><br>    KUBECONFIG_CREDENTIAL_ID = <span class="hljs-string">&#x27;demo-kubeconfig&#x27;</span><br>    REGISTRY = <span class="hljs-string">&#x27;registry.cn-shenzhen.aliyuncs.com&#x27;</span><br>    DOCKERHUB_NAMESPACE = <span class="hljs-string">&#x27;roudoukou-ruoyi&#x27;</span><br>    GITHUB_ACCOUNT = <span class="hljs-string">&#x27;kubesphere&#x27;</span><br>    APP_NAME = <span class="hljs-string">&#x27;devops-java-sample&#x27;</span><br>    ALIYUNHUB_NAMESPACE = <span class="hljs-string">&#x27;roudoukou-ruoyi&#x27;</span><br>  &#125;<br>  <span class="hljs-keyword">parameters</span> &#123;<br>    string(<span class="hljs-literal">name</span>: <span class="hljs-string">&#x27;TAG_NAME&#x27;</span>, defaultValue: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-literal">description</span>: <span class="hljs-string">&#x27;&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="导入mongodb数据"><a href="#导入mongodb数据" class="headerlink" title="导入mongodb数据"></a>导入mongodb数据</h3><p>配置mongodb外网访问<br><img src="/assets/8c0f6769b38b45ae91a1fc5be9c1d0a8.png" srcset="/img/loading.gif" lazyload><br>连接mongodb<br><img src="/assets/303e1bc672df4212ae414bdf2c95d19a.png" srcset="/img/loading.gif" lazyload><br>导入如下的数据<br><img src="/assets/b600de6d8b044f0385871918e59e058f.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="本地运行尚医通后台项目"><a href="#本地运行尚医通后台项目" class="headerlink" title="本地运行尚医通后台项目"></a>本地运行尚医通后台项目</h3><blockquote>
<p>gitee仓库地址</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/xialonggui/yygh-admin">https://gitee.com/xialonggui/yygh-admin</a><br><a target="_blank" rel="noopener" href="https://gitee.com/xialonggui/yygh-site">https://gitee.com/xialonggui/yygh-site</a></p>
</blockquote>
<p>双击idea的shift键, 搜索到<code>JwtHelper</code><img src="/assets/0d7cfc4a1d214e45aa799a1e899f7651.png" srcset="/img/loading.gif" lazyload><br>将生成的token记录下来, 在src\store\modules\user.js文件修改<br><img src="/assets/8932d07cb2c045e6a408bb8fa540abfa.png" srcset="/img/loading.gif" lazyload><br>然后修改config&#x2F;dev.env.js 和 config&#x2F;prod.env.js<br>修改成暴露出来的server-gateway网关地址<br><img src="/assets/b6d15f88f83d4956af98dc6390e064f0.png" srcset="/img/loading.gif" lazyload></p>
<p>安装相关依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 建议将node版本降低到14版本, 不然会出来严重的历史残留bug, 比如sass版本的不匹配</span><br><span class="hljs-comment"># 所以最简单的办法就是降低nodejs的版本</span><br>node -v<br><span class="hljs-comment"># v14.21.3</span><br><br><span class="hljs-comment"># 安装node-sass</span><br>npm i node-sass --sass_binary_site=https://npm.taobao.org/mirrors/node-sass/<br><br><span class="hljs-comment"># 安装</span><br>npm install --registry=https://registry.npm.taobao.org<br><br><span class="hljs-comment"># 运行</span><br>npm run dev<br><br></code></pre></td></tr></table></figure>
<p>至此本地项目就运行起来了<br>然后在gitee上创建一个代码仓库, 为什么要创建仓库呢?<br>因为这个雷丰阳老师提供<a target="_blank" rel="noopener" href="https://gitee.com/leifengyang/yygh-admin">仓库</a>的地址的网关是没有修改的, 我们得修改成自己的网关地址, 也就是得使用自己的代码</p>
<h3 id="上云部署尚医通后台项目"><a href="#上云部署尚医通后台项目" class="headerlink" title="上云部署尚医通后台项目"></a>上云部署尚医通后台项目</h3><p><img src="/assets/4de6b45db70e41b2963d099d137680aa.png" srcset="/img/loading.gif" lazyload><br><img src="/assets/cfd9b8e78845494a8aa8de29894e2530.png" srcset="/img/loading.gif" lazyload><br>稍微等待一下, 会自动拉取代码</p>
<p>webhook</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">139.198</span>.<span class="hljs-number">117.67</span>:<span class="hljs-number">30880</span><span class="hljs-regexp">/devops_webhook/gi</span>t<span class="hljs-regexp">/?url=https:/</span><span class="hljs-regexp">/gitee.com/</span>xialonggui/yygh-admin.git<br></code></pre></td></tr></table></figure>
<p>然后修改Jenkinsfile</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs javascript">pipeline &#123;<br>    agent &#123;<br>        node &#123;<br>            label <span class="hljs-string">&#x27;nodejs&#x27;</span><br>        &#125;<br><br>    &#125;<br>    stages &#123;<br>        <span class="hljs-title function_">stage</span>(<span class="hljs-params"><span class="hljs-string">&#x27;拉取代码&#x27;</span></span>) &#123;<br>            agent none<br>            steps &#123;<br>                <span class="hljs-title function_">container</span>(<span class="hljs-params"><span class="hljs-string">&#x27;nodejs&#x27;</span></span>) &#123;<br>                    <span class="hljs-title function_">git</span>(<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://gitee.com/xialonggui/yygh-admin.git&#x27;</span>, <span class="hljs-attr">credentialsId</span>: <span class="hljs-string">&#x27;gitee-id&#x27;</span>, <span class="hljs-attr">branch</span>: <span class="hljs-string">&#x27;master&#x27;</span>, <span class="hljs-attr">changelog</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">poll</span>: <span class="hljs-literal">false</span>)<br>                    sh <span class="hljs-string">&#x27;ls -al&#x27;</span><br>                &#125;<br><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-title function_">stage</span>(<span class="hljs-params"><span class="hljs-string">&#x27;项目编译&#x27;</span></span>) &#123;<br>            agent none<br>            steps &#123;<br>                <span class="hljs-title function_">container</span>(<span class="hljs-params"><span class="hljs-string">&#x27;nodejs&#x27;</span></span>) &#123;<br>                    sh <span class="hljs-string">&#x27;npm i node-sass --sass_binary_site=https://npm.taobao.org/mirrors/node-sass/&#x27;</span><br>                    sh <span class="hljs-string">&#x27;npm install --registry=https://registry.npm.taobao.org&#x27;</span><br>                    sh <span class="hljs-string">&#x27;npm run build&#x27;</span><br>                    sh <span class="hljs-string">&#x27;ls&#x27;</span><br>                &#125;<br><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-title function_">stage</span>(<span class="hljs-params"><span class="hljs-string">&#x27;构建镜像&#x27;</span></span>) &#123;<br>            agent none<br>            steps &#123;<br>                <span class="hljs-title function_">container</span>(<span class="hljs-params"><span class="hljs-string">&#x27;nodejs&#x27;</span></span>) &#123;<br>                    sh <span class="hljs-string">&#x27;ls&#x27;</span><br>                    sh <span class="hljs-string">&#x27;docker build -t yygh-admin:latest -f Dockerfile  .&#x27;</span><br>                &#125;<br><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-title function_">stage</span>(<span class="hljs-params"><span class="hljs-string">&#x27;推送镜像&#x27;</span></span>) &#123;<br>            agent none<br>            steps &#123;<br>                <span class="hljs-title function_">container</span>(<span class="hljs-params"><span class="hljs-string">&#x27;nodejs&#x27;</span></span>) &#123;<br>                    <span class="hljs-title function_">withCredentials</span>(<span class="hljs-params">[usernamePassword(credentialsId : <span class="hljs-string">&#x27;aliyun-registry&#x27;</span> ,usernameVariable : <span class="hljs-string">&#x27;DOCKER_USER_VAR&#x27;</span> ,passwordVariable : <span class="hljs-string">&#x27;DOCKER_PWD_VAR&#x27;</span> ,)]</span>) &#123;<br>                        sh <span class="hljs-string">&#x27;echo &quot;$DOCKER_PWD_VAR&quot; | docker login $REGISTRY -u &quot;$DOCKER_USER_VAR&quot; --password-stdin&#x27;</span><br>                        sh <span class="hljs-string">&#x27;docker tag yygh-admin:latest $REGISTRY/$DOCKERHUB_NAMESPACE/yygh-admin:SNAPSHOT-$BUILD_NUMBER&#x27;</span><br>                        sh <span class="hljs-string">&#x27;docker push  $REGISTRY/$DOCKERHUB_NAMESPACE/yygh-admin:SNAPSHOT-$BUILD_NUMBER&#x27;</span><br>                    &#125;<br><br>                &#125;<br><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-title function_">stage</span>(<span class="hljs-params"><span class="hljs-string">&#x27;部署到dev环境&#x27;</span></span>) &#123;<br>            agent none<br>            steps &#123;<br>                <span class="hljs-title function_">kubernetesDeploy</span>(<span class="hljs-attr">configs</span>: <span class="hljs-string">&#x27;deploy/**&#x27;</span>, <span class="hljs-attr">enableConfigSubstitution</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">kubeconfigId</span>: <span class="hljs-string">&quot;$KUBECONFIG_CREDENTIAL_ID&quot;</span>)<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//1、配置全系统的邮件：                   全系统的监控</span><br>        <span class="hljs-comment">//2、修改ks-jenkins的配置，里面的邮件；   流水线发邮件</span><br>        <span class="hljs-title function_">stage</span>(<span class="hljs-params"><span class="hljs-string">&#x27;发送确认邮件&#x27;</span></span>) &#123;<br>            agent none<br>            steps &#123;<br>                <span class="hljs-title function_">mail</span>(<span class="hljs-attr">to</span>: <span class="hljs-string">&#x27;1023876294@qq.com&#x27;</span>, <span class="hljs-attr">subject</span>: <span class="hljs-string">&#x27;yygh-admin构建结果&#x27;</span>, <span class="hljs-attr">body</span>: <span class="hljs-string">&quot;构建成功了  $BUILD_NUMBER&quot;</span>)<br>            &#125;<br>        &#125;<br><br>    &#125;<br>    environment &#123;<br>        <span class="hljs-variable constant_">DOCKER_CREDENTIAL_ID</span> = <span class="hljs-string">&#x27;dockerhub-id&#x27;</span><br>        <span class="hljs-variable constant_">GITHUB_CREDENTIAL_ID</span> = <span class="hljs-string">&#x27;github-id&#x27;</span><br>        <span class="hljs-variable constant_">KUBECONFIG_CREDENTIAL_ID</span> = <span class="hljs-string">&#x27;demo-kubeconfig&#x27;</span><br>        <span class="hljs-variable constant_">REGISTRY</span> = <span class="hljs-string">&#x27;registry.cn-shenzhen.aliyuncs.com&#x27;</span><br>        <span class="hljs-variable constant_">DOCKERHUB_NAMESPACE</span> = <span class="hljs-string">&#x27;roudoukou-ruoyi&#x27;</span><br>        <span class="hljs-variable constant_">GITHUB_ACCOUNT</span> = <span class="hljs-string">&#x27;kubesphere&#x27;</span><br>        <span class="hljs-variable constant_">APP_NAME</span> = <span class="hljs-string">&#x27;devops-java-sample&#x27;</span><br>        <span class="hljs-variable constant_">ALIYUNHUB_NAMESPACE</span> = <span class="hljs-string">&#x27;roudoukou-ruoyi&#x27;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>记得推送代码到仓库上<br><img src="/assets/9bf2903e6b1b4c47bd3c68430addb2f1.png" srcset="/img/loading.gif" lazyload><br>然后访问这个端口, 此时已经说明了后台部署成功了<br><img src="/assets/ab334bafbcb24e34a15e71d40247025f.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="本地运行尚医通前台项目"><a href="#本地运行尚医通前台项目" class="headerlink" title="本地运行尚医通前台项目"></a>本地运行尚医通前台项目</h3><p>修改utils&#x2F;request.js成网关地址<br><img src="/assets/070e59d18ad049f1b1ede2e1ef94729f.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">npm i<br><br>npm <span class="hljs-built_in">run</span> build<br><br>npm <span class="hljs-built_in">run</span> start<br><br></code></pre></td></tr></table></figure>
<p>然后浏览器访问<a target="_blank" rel="noopener" href="http://127.0.0.1:3000/">http://127.0.0.1:3000/</a><br><img src="/assets/e0f7533ae6bc42868291fca836305647.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="上云部署尚医通前台项目"><a href="#上云部署尚医通前台项目" class="headerlink" title="上云部署尚医通前台项目"></a>上云部署尚医通前台项目</h3><p><img src="/assets/e56cb6d667424e43a53b362aaa6dbdd3.png" srcset="/img/loading.gif" lazyload><br>webhook</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">139.198</span>.<span class="hljs-number">117.67</span>:<span class="hljs-number">30880</span><span class="hljs-regexp">/devops_webhook/gi</span>t<span class="hljs-regexp">/?url=https:/</span><span class="hljs-regexp">/gitee.com/</span>xialonggui/yygh-site.git<br></code></pre></td></tr></table></figure>

<h3 id="设置webhook"><a href="#设置webhook" class="headerlink" title="设置webhook"></a>设置webhook</h3><p><img src="/assets/b836f0f668424be4b0e2fff34d914d17.png" srcset="/img/loading.gif" lazyload><br>当提交了代码之后, gitee就会通过webhook给流水线devops发送请求, 让流水线拉取代码运行<br><img src="/assets/89e220fe2a54404a8f6649af2db84cad.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="让master成为node节点工作-补充"><a href="#让master成为node节点工作-补充" class="headerlink" title="让master成为node节点工作(补充)"></a>让master成为node节点工作(补充)</h2><p><a target="_blank" rel="noopener" href="https://www.hangge.com/blog/cache/detail_2431.html">https://www.hangge.com/blog/cache/detail_2431.html</a></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">kubectl taint <span class="hljs-keyword">node</span> <span class="hljs-title">k8s-master</span> <span class="hljs-keyword">node</span><span class="hljs-title">-role</span>.kubernetes.io/<span class="hljs-literal">master</span>-<br></code></pre></td></tr></table></figure>
<h2 id="卸载kubernetes"><a href="#卸载kubernetes" class="headerlink" title="卸载kubernetes"></a>卸载kubernetes</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wangzy-Zj/p/13273351.html">https://www.cnblogs.com/wangzy-Zj/p/13273351.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubeadm reset -f<br>modprobe -r ipip<br>lsmod<br><span class="hljs-built_in">rm</span> -rf ~/.kube/<br><span class="hljs-built_in">rm</span> -rf /etc/kubernetes/<br><span class="hljs-built_in">rm</span> -rf /etc/systemd/system/kubelet.service.d<br><span class="hljs-built_in">rm</span> -rf /etc/systemd/system/kubelet.service<br><span class="hljs-built_in">rm</span> -rf /usr/bin/kube*<br><span class="hljs-built_in">rm</span> -rf /etc/cni<br><span class="hljs-built_in">rm</span> -rf /opt/cni<br><span class="hljs-built_in">rm</span> -rf /var/lib/etcd<br><span class="hljs-built_in">rm</span> -rf /var/etcd<br>yum clean all<br>yum remove kube*<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java/" class="category-chain-item">Java</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Docker/">#Docker</a>
      
        <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">#云原生</a>
      
        <a href="/tags/kubenetes/">#kubenetes</a>
      
        <a href="/tags/kubesphere/">#kubesphere</a>
      
        <a href="/tags/Jenkins/">#Jenkins</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>云原生实战</div>
      <div>https://xiamu.icu/Java/云原生实战/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>肉豆蔻吖</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年5月7日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/Java/%E5%BC%80%E5%90%AFrun-dashboard/" title="开启run dashboard">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">开启run dashboard</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/Java/SpringCloud/" title="SpringCloud">
                        <span class="hidden-mobile">SpringCloud</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"Haq24NRgHl4QheEi7oVqtAsM-gzGzoHsz","appKey":"kGbxzGaSiqqlFPxg24Tk3dVN","path":"window.location.pathname","placeholder":"来都来了, 不留下点啥吗?","avatar":"retro","meta":["nick","mail","link"],"requiredFields":["nick","mail"],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":true,"serverURLs":"","emojiCDN":"https://valinecdn.bili33.top","emojiMaps":{"Tieba-New2":"/Tieba-New/image_emoticon.png","Tieba-New3":"/Tieba-New/image_emoticon10.png","Tieba-New4":"/Tieba-New/image_emoticon100.png","Tieba-New5":"/Tieba-New/image_emoticon101.png","Tieba-New6":"/Tieba-New/image_emoticon102.png","Tieba-New7":"/Tieba-New/image_emoticon103.png","Tieba-New8":"/Tieba-New/image_emoticon104.png","Tieba-New9":"/Tieba-New/image_emoticon105.png","Tieba-New10":"/Tieba-New/image_emoticon106.png","Tieba-New11":"/Tieba-New/image_emoticon107.png","Tieba-New12":"/Tieba-New/image_emoticon108.png","Tieba-New13":"/Tieba-New/image_emoticon109.png","Tieba-New14":"/Tieba-New/image_emoticon11.png","Tieba-New15":"/Tieba-New/image_emoticon110.png","Tieba-New16":"/Tieba-New/image_emoticon111.png","Tieba-New17":"/Tieba-New/image_emoticon112.png","Tieba-New18":"/Tieba-New/image_emoticon113.png","Tieba-New19":"/Tieba-New/image_emoticon114.png","Tieba-New20":"/Tieba-New/image_emoticon115.png","Tieba-New21":"/Tieba-New/image_emoticon116.png","Tieba-New22":"/Tieba-New/image_emoticon117.png","Tieba-New23":"/Tieba-New/image_emoticon118.png","Tieba-New24":"/Tieba-New/image_emoticon119.png","Tieba-New25":"/Tieba-New/image_emoticon12.png","Tieba-New26":"/Tieba-New/image_emoticon120.png","Tieba-New27":"/Tieba-New/image_emoticon121.png","Tieba-New28":"/Tieba-New/image_emoticon122.png","Tieba-New29":"/Tieba-New/image_emoticon123.png","Tieba-New30":"/Tieba-New/image_emoticon124.png","Tieba-New31":"/Tieba-New/image_emoticon13.png","Tieba-New32":"/Tieba-New/image_emoticon14.png","Tieba-New33":"/Tieba-New/image_emoticon15.png","Tieba-New34":"/Tieba-New/image_emoticon16.png","Tieba-New35":"/Tieba-New/image_emoticon17.png","Tieba-New36":"/Tieba-New/image_emoticon18.png","Tieba-New37":"/Tieba-New/image_emoticon19.png","Tieba-New38":"/Tieba-New/image_emoticon2.png","Tieba-New39":"/Tieba-New/image_emoticon20.png","Tieba-New40":"/Tieba-New/image_emoticon21.png","Tieba-New41":"/Tieba-New/image_emoticon22.png","Tieba-New42":"/Tieba-New/image_emoticon23.png","Tieba-New43":"/Tieba-New/image_emoticon24.png","Tieba-New44":"/Tieba-New/image_emoticon25.png","Tieba-New45":"/Tieba-New/image_emoticon26.png","Tieba-New46":"/Tieba-New/image_emoticon27.png","Tieba-New47":"/Tieba-New/image_emoticon28.png","Tieba-New48":"/Tieba-New/image_emoticon29.png","Tieba-New49":"/Tieba-New/image_emoticon3.png","Tieba-New50":"/Tieba-New/image_emoticon30.png","Tieba-New51":"/Tieba-New/image_emoticon31.png","Tieba-New52":"/Tieba-New/image_emoticon32.png","Tieba-New53":"/Tieba-New/image_emoticon33.png","Tieba-New54":"/Tieba-New/image_emoticon34.png","Tieba-New55":"/Tieba-New/image_emoticon35.png","Tieba-New56":"/Tieba-New/image_emoticon36.png","Tieba-New57":"/Tieba-New/image_emoticon37.png","Tieba-New58":"/Tieba-New/image_emoticon38.png","Tieba-New59":"/Tieba-New/image_emoticon39.png","Tieba-New60":"/Tieba-New/image_emoticon4.png","Tieba-New61":"/Tieba-New/image_emoticon40.png","Tieba-New62":"/Tieba-New/image_emoticon41.png","Tieba-New63":"/Tieba-New/image_emoticon42.png","Tieba-New64":"/Tieba-New/image_emoticon43.png","Tieba-New65":"/Tieba-New/image_emoticon44.png","Tieba-New66":"/Tieba-New/image_emoticon45.png","Tieba-New67":"/Tieba-New/image_emoticon46.png","Tieba-New68":"/Tieba-New/image_emoticon47.png","Tieba-New69":"/Tieba-New/image_emoticon48.png","Tieba-New70":"/Tieba-New/image_emoticon49.png","Tieba-New71":"/Tieba-New/image_emoticon5.png","Tieba-New72":"/Tieba-New/image_emoticon50.png","Tieba-New73":"/Tieba-New/image_emoticon6.png","Tieba-New74":"/Tieba-New/image_emoticon66.png","Tieba-New75":"/Tieba-New/image_emoticon67.png","Tieba-New76":"/Tieba-New/image_emoticon68.png","Tieba-New77":"/Tieba-New/image_emoticon69.png","Tieba-New78":"/Tieba-New/image_emoticon7.png","Tieba-New79":"/Tieba-New/image_emoticon70.png","Tieba-New80":"/Tieba-New/image_emoticon71.png","Tieba-New81":"/Tieba-New/image_emoticon72.png","Tieba-New82":"/Tieba-New/image_emoticon73.png","Tieba-New83":"/Tieba-New/image_emoticon74.png","Tieba-New84":"/Tieba-New/image_emoticon75.png","Tieba-New85":"/Tieba-New/image_emoticon76.png","Tieba-New86":"/Tieba-New/image_emoticon77.png","Tieba-New87":"/Tieba-New/image_emoticon78.png","Tieba-New88":"/Tieba-New/image_emoticon79.png","Tieba-New89":"/Tieba-New/image_emoticon8.png","Tieba-New90":"/Tieba-New/image_emoticon80.png","Tieba-New91":"/Tieba-New/image_emoticon81.png","Tieba-New92":"/Tieba-New/image_emoticon82.png","Tieba-New93":"/Tieba-New/image_emoticon83.png","Tieba-New94":"/Tieba-New/image_emoticon84.png","Tieba-New95":"/Tieba-New/image_emoticon85.png","Tieba-New96":"/Tieba-New/image_emoticon86.png","Tieba-New97":"/Tieba-New/image_emoticon87.png","Tieba-New98":"/Tieba-New/image_emoticon88.png","Tieba-New99":"/Tieba-New/image_emoticon89.png","Tieba-New100":"/Tieba-New/image_emoticon9.png","Tieba-New101":"/Tieba-New/image_emoticon90.png","Tieba-New102":"/Tieba-New/image_emoticon91.png","Tieba-New103":"/Tieba-New/image_emoticon92.png","Tieba-New104":"/Tieba-New/image_emoticon93.png","Tieba-New105":"/Tieba-New/image_emoticon94.png","Tieba-New106":"/Tieba-New/image_emoticon95.png","Tieba-New107":"/Tieba-New/image_emoticon96.png","Tieba-New108":"/Tieba-New/image_emoticon97.png","Tieba-New109":"/Tieba-New/image_emoticon98.png","Tieba-New110":"/Tieba-New/image_emoticon99.png"},"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      湘ICP备2021007554号-1
    </a>
  </span>
  
</div>

  
  
</div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script>
  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/custom.js"></script>
<script src="/js/sakura.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <!-- 全局配置aplayer播放器 -->
  <div class="aplayer" 
    data-id="5237049130" 
    data-server="netease"   
    data-type="playlist" 
    data-fixed="true" 
    data-autoplay="false" 
    data-order="list" 
    data-volume="0.5" 
    data-theme="#1da496" 
    data-preload="auto"
    >
  </div>

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
